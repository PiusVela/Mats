<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Financial Tracker PRO - Multi-User Platform</title>
  <style>
    /* ===== DARK/LIGHT MODE CSS VARIABLES ===== */
    :root {
      /* Light Mode (Default) */
      --primary: #ff9800; /* Changed to orange */
      --primary-dark: #f57c00; /* Darker orange */
      --secondary: #f093fb;
      --accent: #f5576c;
      --success: #4ecdc4;
      --danger: #ff6b6b;
      --warning: #ffb74d; /* Orange-based warning */
      --info: #06d6a0;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border: #e9ecef;
      --card-bg: #ffffff;
      --shadow: rgba(0, 0, 0, 0.08);
      --gradient-1: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); /* Orange gradient */
      --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --gradient-income: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --gradient-balance: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
      --body-bg: linear-gradient(135deg, #fff8f0 0%, #ffe0b2 100%); /* Orange tint background */
      --text-color: #343a40;
      --text-secondary: #6c757d;
      --modal-bg: #ffffff;
      --input-bg: #ffffff;
      --header-gradient: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); /* Orange header */
      --form-bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      --income-form-bg: linear-gradient(135deg, #e9fdf5 0%, #d4f8e8 100%);
      --budget-color: #9c88ff;
      --reminder-color: #ff9ff3;
    }

    body.dark-mode {
      /* Dark Mode with orange accent */
      --primary: #ffb74d; /* Orange for dark mode */
      --primary-dark: #ff9800;
      --secondary: #c084fc;
      --accent: #f87171;
      --success: #34d399;
      --danger: #f87171;
      --warning: #ffcc80; /* Orange-based */
      --info: #22d3ee;
      --light: #1f2937;
      --dark: #f9fafb;
      --gray: #9ca3af;
      --border: #374151;
      --card-bg: #1f2937;
      --shadow: rgba(0, 0, 0, 0.3);
      --gradient-1: linear-gradient(135deg, #ffb74d 0%, #ff9800 100%); /* Orange gradient */
      --gradient-2: linear-gradient(135deg, #c084fc 0%, #f87171 100%);
      --gradient-3: linear-gradient(135deg, #60a5fa 0%, #22d3ee 100%);
      --gradient-4: linear-gradient(135deg, #34d399 0%, #22d3ee 100%);
      --gradient-income: linear-gradient(135deg, #34d399 0%, #22d3ee 100%);
      --gradient-balance: linear-gradient(135deg, #22d3ee 0%, #60a5fa 100%);
      --body-bg: linear-gradient(135deg, #1a1a1a 0%, #2d1f00 100%); /* Dark orange tint */
      --text-color: #f9fafb;
      --text-secondary: #9ca3af;
      --modal-bg: #1f2937;
      --input-bg: #374151;
      --header-gradient: linear-gradient(135deg, #ffb74d 0%, #ff9800 100%); /* Orange header */
      --form-bg: linear-gradient(135deg, #374151 0%, #1f2937 100%);
      --income-form-bg: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
      --budget-color: #a78bfa;
      --reminder-color: #d8b4fe;
    }

    /* ===== UPDATED AUTH PAGES STYLES - MOBILE FIXED ===== */
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--body-bg);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
      transition: background 0.3s ease;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .auth-container {
      display: flex;
      max-width: 1200px;
      width: 100%;
      min-height: 600px;
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: all 0.3s ease;
      position: relative;
    }
    
    body.dark-mode .auth-container {
      background: var(--card-bg);
    }
    
    /* Left Panel */
    .auth-left-panel {
      flex: 1;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white;
      padding: 40px 30px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      overflow: hidden;
      min-height: 400px;
    }
    
    .auth-left-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 80%, rgba(255, 152, 0, 0.15) 0%, transparent 50%);
    }
    
    .auth-left-content h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #ff9800, #ffb74d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .auth-left-content .tagline {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 30px;
      font-weight: 300;
    }
    
    .features-list {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }
    
    .features-list li {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.85);
    }
    
    .features-list li i {
      color: #ff9800;
      margin-right: 15px;
      font-size: 1rem;
      background: rgba(255, 152, 0, 0.1);
      padding: 6px;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .auth-footer-text {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.8rem;
      margin-top: 30px;
    }
    
    /* Right Panel */
    .auth-right-panel {
      flex: 1;
      padding: 40px 30px;
      background: var(--card-bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: background 0.3s ease;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .auth-right-content {
      max-width: 400px;
      width: 100%;
      margin: 0 auto;
    }
    
    .auth-welcome {
      margin-bottom: 30px;
    }
    
    .auth-welcome h2 {
      font-size: 1.8rem;
      color: var(--text-color);
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .auth-welcome p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .auth-tabs {
      display: flex;
      margin-bottom: 25px;
      background: var(--light);
      border-radius: 12px;
      padding: 4px;
      border: 1px solid var(--border);
    }
    
    .auth-tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      color: var(--gray);
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s;
      font-size: 0.9rem;
    }
    
    .auth-tab.active {
      background: var(--primary);
      color: white;
    }
    
    .auth-form {
      display: none;
      flex-direction: column;
      gap: 15px;
    }
    
    .auth-form.active {
      display: flex;
    }
    
    .auth-input-group {
      position: relative;
    }
    
    .auth-input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
      text-align: left;
      transition: color 0.3s ease;
      font-size: 0.85rem;
    }
    
    .auth-input-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
      background: var(--input-bg);
      color: var(--text-color);
      -webkit-appearance: none;
    }
    
    .auth-input-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }
    
    .auth-btn {
      background: var(--gradient-1);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
    }
    
    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(255, 152, 0, 0.3);
    }
    
    .google-btn {
      background: white;
      color: #333;
      border: 2px solid var(--border);
      margin-top: 15px;
    }
    
    .google-btn:hover {
      background: #f8f9fa;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--text-secondary);
    }
    
    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    
    .auth-divider span {
      padding: 0 12px;
      font-size: 0.85rem;
    }
    
    .auth-error {
      background: #fee2e2;
      color: #dc3545;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }
    
    body.dark-mode .auth-error {
      background: rgba(220, 53, 69, 0.1);
    }
    
    .auth-error.show {
      display: flex;
    }
    
    .auth-links {
      margin-top: 20px;
      text-align: center;
    }
    
    .auth-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      display: inline-block;
      margin: 5px;
      font-size: 0.85rem;
    }
    
    .auth-link:hover {
      text-decoration: underline;
    }
    
    /* Theme Toggle in Auth */
    .auth-theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10;
    }
    
    .auth-theme-toggle .theme-switch {
      width: 50px;
      height: 24px;
    }
    
    .auth-theme-toggle .theme-slider {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .auth-theme-toggle .theme-slider:before {
      background-color: white;
    }
    
    .auth-theme-toggle span {
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      display: none;
    }

    /* Theme Toggle Switch */
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .theme-toggle span {
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .theme-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .theme-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.3);
      transition: .4s;
      border-radius: 34px;
    }

    .theme-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .theme-slider {
      background-color: var(--primary);
    }

    input:checked + .theme-slider:before {
      transform: translateX(26px);
    }

    /* ===== OPTIMIZED CSS ===== */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }

    html {
      height: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--body-bg);
      min-height: 100vh;
      padding: 0;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      transition: background 0.3s ease, color 0.3s ease;
      overflow-x: hidden;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 20px 60px var(--shadow);
      overflow: hidden;
      position: relative;
      flex: 1;
      display: none; /* Hidden until login */
      transition: background 0.3s ease, box-shadow 0.3s ease;
      width: 100%;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 6px;
      background: var(--gradient-1); z-index: 1;
    }

    /* ===== HEADER & FOOTER ===== */
    .header {
      background: var(--header-gradient);
      color: white;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: ''; 
      position: absolute; 
      top: -50%; 
      right: -50%; 
      width: 100%; 
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 20px 20px; 
      opacity: 0.2;
    }
    
    .header-top { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 10px; 
      position: relative; 
      z-index: 2; 
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .header h1 { 
      font-size: 1.8rem; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      font-weight: 700;
      color: white;
      flex-wrap: wrap;
    }
    
    .header h1 i { 
      background: rgba(255, 255, 255, 0.2); 
      padding: 10px; 
      border-radius: 12px; 
      backdrop-filter: blur(10px); 
      font-size: 1.2rem;
    }
    
    .header p { 
      font-size: 0.9rem; 
      opacity: 0.9; 
      position: relative; 
      z-index: 2; 
      line-height: 1.4;
    }

    .status-indicator {
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.15); 
      border-radius: 20px;
      font-size: 0.8rem; 
      font-weight: 600; 
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      white-space: nowrap;
    }
    
    .theme-toggle-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 10px;
    }
    
    .theme-toggle-header .theme-slider {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .theme-toggle-header .theme-slider:before {
      background-color: white;
    }

    .status-dot { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      animation: pulse 2s infinite; 
    }
    
    .status-dot.online { 
      background: #10b981; 
      box-shadow: 0 0 10px #10b981; 
    }
    
    .status-dot.offline { 
      background: var(--danger); 
      box-shadow: 0 0 10px var(--danger); 
    }
    
    .status-dot.connecting { 
      background: var(--warning); 
      box-shadow: 0 0 10px var(--warning); 
      animation: blink 1.5s infinite; 
    }
    
    @keyframes pulse { 
      0%, 100% { 
        transform: scale(1); 
        opacity: 1; 
      } 
      50% { 
        transform: scale(1.1); 
        opacity: 0.8; 
      } 
    }
    
    @keyframes blink { 
      0%, 100% { 
        opacity: 1; 
      } 
      50% { 
        opacity: 0.3; 
      } 
    }

    .footer {
      text-align: center; 
      padding: 15px 20px; 
      margin-top: 20px;
      color: var(--gray); 
      font-size: 0.85rem; 
      border-top: 1px solid var(--border);
      background: var(--light); 
      border-radius: 0 0 24px 24px;
      transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    .footer-content { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 10px; 
      flex-wrap: wrap; 
    }
    
    .copyright { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      color: var(--primary); 
      font-weight: 600; 
      font-size: 0.85rem;
    }
    
    .footer-links { 
      display: flex; 
      gap: 12px; 
      margin-left: 15px; 
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .footer-links a { 
      color: var(--gray); 
      text-decoration: none; 
      transition: color 0.3s; 
      font-size: 0.85rem;
    }
    
    .footer-links a:hover { 
      color: var(--primary); 
    }

    /* ===== DASHBOARD LAYOUT ===== */
    .dashboard {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      padding: 20px;
      background: var(--light);
      align-items: start;
      transition: background 0.3s ease;
    }
    
    /* New wrapper for stacking forms */
    .forms-wrapper {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Stats Section */
    .stats-section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 25px var(--shadow);
      transition: background 0.3s ease, box-shadow 0.3s ease;
      min-height: 0;
      overflow: visible;
    }
    
    .stats-section h3 { 
      color: var(--primary); 
      margin-bottom: 15px; 
      font-size: 1.3rem; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
    }

    /* Cards - FIXED: Improved grid and card sizing */
    .main-stats-grid { 
      display: grid; 
      grid-template-columns: repeat(2, 1fr);
      gap: 12px; 
      margin-bottom: 20px;
    }
    
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(2, 1fr);
      gap: 12px; 
      margin-bottom: 20px; 
    }
    
    .stat-card {
      background: var(--card-bg); 
      border-radius: 12px; 
      padding: 15px;
      position: relative;
      overflow: hidden; 
      transition: all 0.3s ease; 
      border: 1px solid var(--border);
      cursor: pointer; 
      user-select: none; 
      min-height: 90px;
      display: flex; 
      flex-direction: column; 
      justify-content: center;
    }
    
    .stat-card:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 12px 30px var(--shadow); 
    }
    
    .stat-card.tapped { 
      animation: tapReveal 0.5s ease; 
    }
    
    @keyframes tapReveal { 
      0% { 
        transform: scale(1); 
      } 
      50% { 
        transform: scale(0.98); 
      } 
      100% { 
        transform: scale(1); 
      } 
    }
    
    .stat-card::before { 
      content: ''; 
      position: absolute; 
      top: 0; 
      left: 0; 
      right: 0; 
      height: 4px; 
      background: var(--gradient-1); 
    }
    
    #totalIncomeCard::before { 
      background: var(--gradient-income); 
    }
    
    #totalExpenseCard::before { 
      background: var(--gradient-2); 
    }
    
    #availableBalanceCard::before { 
      background: var(--gradient-balance); 
    }
    
    #monthlyBudgetCard::before { 
      background: linear-gradient(135deg, var(--budget-color), #8c7ae6); 
    }
    
    #savingsGoalCard::before { 
      background: linear-gradient(135deg, var(--success), #2ecc71); 
    }
    
    .stat-card.expense-card:nth-child(1)::before { 
      background: var(--gradient-1); 
    }
    
    .stat-card.expense-card:nth-child(2)::before { 
      background: var(--gradient-2); 
    }
    
    .stat-card.expense-card:nth-child(3)::before { 
      background: var(--gradient-3); 
    }
    
    .stat-card.expense-card:nth-child(4)::before { 
      background: var(--gradient-4); 
    }

    .stat-label { 
      color: var(--gray); 
      font-size: 0.75rem;
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      margin-bottom: 6px;
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    
    .stat-value {
      font-size: 1.3rem;
      font-weight: 800; 
      color: var(--dark); 
      font-family: 'SF Mono', 'Courier New', monospace;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent;
      margin: 3px 0;
      position: relative; 
      transition: all 0.3s ease;
      line-height: 1.2;
      word-break: break-word;
    }
    
    #totalIncomeValue { 
      background: var(--gradient-income); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    
    #totalExpenseValue { 
      background: var(--gradient-2); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    
    #availableBalanceValue { 
      background: var(--gradient-balance); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    
    #monthlyBudgetValue { 
      background: linear-gradient(135deg, var(--budget-color), #8c7ae6); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    
    #savingsGoalValue { 
      background: linear-gradient(135deg, var(--success), #2ecc71); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    
    .stat-value.hidden { 
      filter: blur(8px); 
      -webkit-filter: blur(8px); 
      background: var(--gray); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
    }
    
    
    .stat-tooltip {
      position: absolute; 
      top: -30px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: var(--dark);
      color: white; 
      padding: 5px 10px; 
      border-radius: 6px; 
      font-size: 0.7rem; 
      opacity: 0;
      transition: opacity 0.3s; 
      pointer-events: none; 
      white-space: nowrap; 
      z-index: 100;
    }
    
    .stat-card:hover .stat-tooltip { 
      opacity: 1; 
    }
    
    .stat-change { 
      font-size: 0.65rem; 
      color: var(--gray); 
      margin-top: 3px; 
      display: flex; 
      gap: 5px; 
    }
    
    .stat-change.positive { 
      color: #10b981; 
    } 
    
    .stat-change.negative { 
      color: var(--danger); 
    }

    .charts-section { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 15px; 
      margin-top: 20px; 
    }
    
    .chart-container { 
      background: var(--card-bg); 
      border-radius: 16px; 
      padding: 15px; 
      box-shadow: 0 8px 25px var(--shadow); 
      transition: background 0.3s ease; 
      min-height: 250px;
    }
    
    .chart-container h4 { 
      color: var(--primary); 
      margin-bottom: 12px; 
      font-size: 1rem; 
      display: flex; 
      gap: 8px; 
      align-items: center; 
    }

    /* ===== FORMS SECTION (Collapse) - MOBILE FIXED ===== */
    .form-section {
      background: var(--form-bg);
      border-radius: 16px; 
      padding: 20px; 
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      width: 100%;
      overflow: hidden;
    }
    
    .income-form-section {
      background: var(--income-form-bg);
      border: 1px solid var(--success);
    }
    
    .budget-form-section {
      background: linear-gradient(135deg, #f9f0ff 0%, #e6d4ff 100%);
      border: 1px solid var(--budget-color);
    }
    
    body.dark-mode .budget-form-section {
      background: linear-gradient(135deg, #2d1b69 0%, #3b2a7a 100%);
    }
    
    /* Header for collapsing */
    .form-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      cursor: pointer; 
      user-select: none; 
      margin-bottom: 15px;
    }
    
    .form-header:hover { 
      opacity: 0.8; 
    }
    
    .form-title {
      color: var(--primary-dark); 
      font-size: 1.2rem; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin: 0;
    }
    
    .income-form-section .form-title { 
      color: var(--success); 
    }
    
    .budget-form-section .form-title { 
      color: var(--budget-color); 
    }
    
    .toggle-icon {
      font-size: 1rem; 
      color: var(--gray); 
      transition: transform 0.3s ease;
    }
    
    /* Collapsible Body */
    .form-body {
      overflow: hidden; 
      transition: all 0.3s ease;
    }
    
    /* Collapsed State */
    .form-section.collapsed .form-body { 
      display: none; 
    }
    
    .form-section.collapsed .form-header { 
      margin-bottom: 0; 
    }
    
    .form-section.collapsed .toggle-icon { 
      transform: rotate(-180deg); 
    }
    
    /* FIXED FORM GRID FOR MOBILE - NO OVERLAPPING */
    .form-grid { 
      display: grid; 
      grid-template-columns: 1fr; /* Always 1 column on mobile */
      gap: 15px; 
      margin-bottom: 15px; 
    }
    
    .form-group { 
      position: relative; 
      width: 100%;
    }
    
    .form-group label { 
      display: block; 
      margin-bottom: 6px; 
      font-weight: 600; 
      color: var(--dark); 
      font-size: 0.9rem; 
    }
    
    .form-group i { 
      position: absolute; 
      left: 12px; 
      top: 38px; 
      color: var(--primary); 
      font-size: 0.9rem;
    }
    
    .income-form-section .form-group i { 
      color: var(--success); 
    }
    
    .budget-form-section .form-group i { 
      color: var(--budget-color); 
    }
    
    .form-group input, 
    .form-group select, 
    .form-group textarea {
      width: 100%; 
      padding: 12px 12px 12px 40px; 
      border: 2px solid var(--border);
      border-radius: 10px; 
      font-size: 14px; 
      transition: all 0.3s; 
      background: var(--input-bg);
      color: var(--text-color);
      -webkit-appearance: none;
      appearance: none;
      min-height: 44px; /* Better touch target */
    }
    
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
      padding-top: 12px;
    }
    
    .form-group input:focus, 
    .form-group select:focus, 
    .form-group textarea:focus { 
      outline: none; 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1); 
    }
    
    .income-form-section .form-group input:focus { 
      border-color: var(--success); 
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2); 
    }
    
    .budget-form-section .form-group input:focus { 
      border-color: var(--budget-color); 
      box-shadow: 0 0 0 3px rgba(156, 136, 255, 0.2); 
    }

    /* Buttons */
    .btn {
      padding: 12px 20px; 
      border: none; 
      border-radius: 10px; 
      font-size: 14px; 
      font-weight: 600;
      cursor: pointer; 
      transition: all 0.3s; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 8px; 
      position: relative; 
      overflow: hidden;
      min-height: 44px; /* Better touch target */
    }
    
    .btn:hover::after { 
      width: 300px; 
      height: 300px; 
    }
    
    .btn-primary { 
      background: var(--gradient-1); 
      color: white; 
    }
    
    .btn-primary:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 10px 25px rgba(255, 152, 0, 0.3); 
    }
    
    .btn-success { 
      background: var(--gradient-income); 
      color: white; 
    }
    
    .btn-success:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 10px 25px rgba(78, 205, 196, 0.3); 
    }
    
    .btn-budget { 
      background: linear-gradient(135deg, var(--budget-color), #8c7ae6); 
      color: white; 
    }
    
    .btn-budget:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 10px 25px rgba(156, 136, 255, 0.3); 
    }
    
    .btn-cancel { 
      background: var(--gray); 
      color: white; 
      margin-left: 10px; 
    }
    
    .btn-balance { 
      background: var(--light); 
      color: var(--primary); 
      border: 2px solid var(--primary); 
      padding: 8px 14px; 
      font-size: 0.8rem; 
    }
    
    .btn-balance:hover, 
    .btn-balance.active { 
      background: var(--primary); 
      color: white; 
    }
    
    .reveal-all-btn { 
      margin-top: 15px; 
      width: 100%; 
      background: linear-gradient(135deg, #ff980022, #f57c0022); 
      color: var(--primary); 
      border: 2px dashed var(--primary); 
      padding: 12px; 
      font-weight: 600; 
    }
    
    .reveal-all-btn:hover { 
      background: var(--gradient-1); 
      color: white; 
      border-style: solid; 
    }
    
    .btn-actions-container { 
      display: flex; 
      align-items: center; 
      flex-wrap: wrap;
      gap: 10px;
    }

    /* ===== REPORTS & LISTS (Updated) ===== */
    .content { 
      padding: 20px; 
    }
    
    .report-section { 
      background: var(--card-bg); 
      border-radius: 16px; 
      padding: 20px; 
      margin: 20px 0; 
      border: 1px solid var(--border); 
      transition: background 0.3s ease;
      box-shadow: 0 5px 15px var(--shadow);
    }
    
    .report-section h3 { 
      margin-bottom: 15px; 
      font-size: 1.3rem;
    } 

    /* New List Header styles for collapse functionality */
    .expenses-list, 
    .income-list, 
    .reminders-list, 
    .budgets-list { 
      background: var(--card-bg); 
      border-radius: 16px; 
      padding: 20px; 
      margin-top: 20px; 
      box-shadow: 0 8px 25px var(--shadow); 
      transition: background 0.3s ease; 
    }
    
    .list-header {
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px;
      cursor: pointer;
      user-select: none;
    }
    
    .list-header:hover { 
      opacity: 0.8; 
    }
    
    .expenses-list h3 { 
      color: var(--primary); 
      font-size: 1.2rem; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin: 0; 
    }
    
    .income-list h3 { 
      color: var(--success); 
      font-size: 1.2rem; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin: 0; 
    }
    
    .reminders-list h3 { 
      color: var(--reminder-color); 
      font-size: 1.2rem; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin: 0; 
    }
    
    .budgets-list h3 { 
      color: var(--budget-color); 
      font-size: 1.2rem; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin: 0; 
    }
    
    .expenses-list.collapsed .toggle-icon,
    .income-list.collapsed .toggle-icon,
    .reminders-list.collapsed .toggle-icon,
    .budgets-list.collapsed .toggle-icon {
        transform: rotate(-180deg);
    }
    
    .expenses-list.collapsed .list-body,
    .income-list.collapsed .list-body,
    .reminders-list.collapsed .list-body,
    .budgets-list.collapsed .list-body {
        display: none;
    }
    
    .expenses-list.collapsed .list-header,
    .income-list.collapsed .list-header,
    .reminders-list.collapsed .list-header,
    .budgets-list.collapsed .list-header {
        margin-bottom: 0;
    }
    
    .list-body {
        overflow: hidden; 
        transition: all 0.3s ease;
    }
    /* End New List Header styles */
    
    .report-controls { 
      display: flex; 
      gap: 8px; 
      margin-bottom: 15px; 
      flex-wrap: wrap; 
      overflow-x: auto;
      padding-bottom: 5px;
      -webkit-overflow-scrolling: touch;
    }
    
    .btn-report { 
      background: var(--light); 
      color: var(--primary); 
      border: 2px solid var(--primary); 
      padding: 8px 14px;
      font-size: 0.85rem;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .btn-report:hover, 
    .btn-report.active { 
      background: var(--primary); 
      color: white; 
      transform: translateY(-2px); 
    }
    
    #expenseReportSection .btn-report { 
      color: var(--danger); 
      border: 2px solid var(--danger); 
    }
    
    #expenseReportSection .btn-report:hover, 
    #expenseReportSection .btn-report.active { 
      background: var(--danger); 
      color: white; 
    }

    #incomeReportSection .btn-report { 
      color: var(--success); 
      border: 2px solid var(--success); 
    }
    
    #incomeReportSection .btn-report:hover, 
    #incomeReportSection .btn-report.active { 
      background: var(--success); 
      color: white; 
    }
    
    .report-period {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-bottom: 15px;
        padding: 15px;
        background: #fff5e6;
        border-radius: 10px;
        border: 1px solid #ffe0b2;
    }
    
    body.dark-mode .report-period {
      background: #374151;
      border-color: #4b5563;
    }
    
    .report-period label { 
      font-size: 0.8rem; 
      font-weight: 600; 
      color: var(--gray); 
    }
    
    .report-period input[type="date"] {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
        width: 100%;
        font-size: 14px;
        background: var(--input-bg);
        color: var(--text-color);
        min-height: 44px;
    }
    
    .report-results { 
      margin-top: 20px; 
    }
    
    .report-summary { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 12px; 
      margin-bottom: 20px; 
    }
    
    .report-summary-item { 
      background: var(--light); 
      padding: 12px; 
      border-radius: 8px; 
      border: 1px solid var(--border); 
    }
    
    .report-summary-item .label { 
      font-size: 0.75rem; 
      color: var(--gray); 
      margin-bottom: 5px; 
    }
    
    .report-summary-item .value { 
      font-size: 1.3rem; 
      font-weight: 700; 
      color: var(--primary-dark); 
      font-family: 'Courier New', monospace; 
    }
    
    .category-breakdown { 
      margin-top: 15px; 
    }
    
    .category-item { 
      display: flex; 
      align-items: center; 
      margin-bottom: 6px; 
      padding: 6px; 
      background: var(--light); 
      border-radius: 4px; 
      flex-wrap: wrap;
    }
    
    .category-name { 
      flex: 0 0 120px; 
      font-size: 0.8rem; 
      font-weight: 600; 
    }
    
    .category-bar { 
      flex: 1; 
      height: 16px; 
      background: #e5e7eb; 
      border-radius: 4px; 
      overflow: hidden; 
      margin: 0 10px; 
      min-width: 50px;
    }
    
    body.dark-mode .category-bar { 
      background: #4b5563; 
    }
    
    .category-fill { 
      height: 100%; 
      background: linear-gradient(90deg, var(--primary), var(--secondary)); 
      border-radius: 4px; 
    }
    
    .category-fill-income { 
      background: linear-gradient(90deg, #43e97b, #38f9d7); 
    }
    
    body.dark-mode .category-fill-income { 
      background: linear-gradient(90deg, #34d399, #22d3ee); 
    }
    
    .category-amount { 
      flex: 0 0 80px; 
      text-align: right; 
      font-family: 'Courier New', monospace; 
      font-size: 0.85rem; 
      font-weight: 600; 
    }
    
    .category-percentage { 
      flex: 0 0 40px; 
      text-align: right; 
      font-size: 0.75rem; 
      color: var(--gray); 
    }

    .expense-item, 
    .reminder-item, 
    .budget-item { 
      display: flex; 
	  flex-direction: column;
      padding: 4px 6px; 
      border-bottom: 1px solid var(--border); 
      transition: all 0.4s; 
      border-radius: 4px; 
      margin-bottom: 2px; 
      background: var(--light); 
      gap: 4px;
    }
    
    .expense-item:hover, 
    .reminder-item:hover, 
    .budget-item:hover { 
      transform: translateX(5px); 
      box-shadow: 0 5px 15px var(--shadow); 
    }
    
    .item-content { 
      flex: 1; 
      width: 100%;
    }
    
    .expense-amount { 
      font-weight: 700; 
      font-size: 1rem; 
      font-family: 'SF Mono', 'Courier New', monospace; 
      background: var(--gradient-1); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      text-align: right; 
      margin-top: 2px;
    }
    
    .income-amount { 
      background: var(--gradient-income); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent;
	  margin-top: 2px; 
    }
    
    .item-actions { 
      display: flex; 
      gap: 6px; 
      justify-content: flex-end;
      width: 100%;
	  margin-top: 4px;
    }
    
    .action-btn { 
      width: 36px; 
      height: 36px; 
      border-radius: 8px; 
      border: none; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      transition: all 0.2s; 
      font-size: 0.9rem; 
      flex-shrink: 0;
    }
    
    .action-btn.edit { 
      background: #ffe0b2; 
      color: var(--primary); 
    } 
    
    body.dark-mode .action-btn.edit { 
      background: #374151; 
    }
    
    .action-btn.edit:hover { 
      background: var(--primary); 
      color: white; 
    }
    
    .action-btn.delete { 
      background: #fee2e2; 
      color: var(--danger); 
    } 
    
    body.dark-mode .action-btn.delete { 
      background: #374151; 
    }
    
    .action-btn.delete:hover { 
      background: var(--danger); 
      color: white; 
    }
    
    .action-btn.complete { 
      background: #d4edda; 
      color: var(--success); 
    }
    
    body.dark-mode .action-btn.complete { 
      background: #374151; 
    }
    
    .action-btn.complete:hover { 
      background: var(--success); 
      color: white; 
    }

    /* Category Badges */
    .category-badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 4px; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-size: 0.7rem; 
      font-weight: 600; 
      margin-right: 6px; 
      transition: all 0.3s; 
      margin-bottom: 3px;
    }
    
    .category-badge:hover { 
      transform: scale(1.05); 
    }

    /* Rest of category colors remain the same */
    .category-yaka { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; }
    .category-water { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
    .category-groceries { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
    .category-food { background: linear-gradient(135deg, #ff9a9e, #fecfef); color: var(--dark); }
    .category-fuel { background: linear-gradient(135deg, #ffecd2, #fcb69f); color: var(--dark); }
    .category-transport { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); color: var(--dark); }
    .category-internet { background: linear-gradient(135deg, #ff9a9e, #fecfef); color: var(--dark); }
    .category-airtime { background: linear-gradient(135deg, #a6c0fe, #f68084); color: white; }
    .category-rent { background: linear-gradient(135deg, #ffcc80, #ffb74d); color: var(--dark); }
    .category-laundry { background: linear-gradient(135deg, #d299c2, #fef9d7); color: var(--dark); }
    .category-clothing { background: linear-gradient(135deg, #fbc2eb, #a6c1ee); color: var(--dark); }
    .category-school-fees { background: linear-gradient(135deg, #89f7fe, #66a6ff); color: white; }
    .category-medical { background: linear-gradient(135deg, #ff6b6b, #ffa8a8); color: white; }
    .category-savings { background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; }
    .category-debt { background: linear-gradient(135deg, #ff6b6b, #ffa8a8); color: white; }
    .category-giving { background: linear-gradient(135deg, #ffd166, #ff9a9e); color: var(--dark); }
    .category-entertainment { background: linear-gradient(135deg, #cd9cf2, #f6f3ff); color: var(--dark); }
    .category-general { background: linear-gradient(135deg, #f6f3ff, #cd9cf2); color: var(--dark); }
    .category-payments { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
    .category-purchases { background: linear-gradient(135deg, #a8edea, #fed6e3); color: var(--dark); }
    .category-salary { background: linear-gradient(135deg, #ffcc80, #ffb74d); color: var(--dark); }
    .category-freelance { background: linear-gradient(135deg, #a8edea, #fed6e3); color: var(--dark); }
    .category-investment { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
    .category-gift { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
    .category-other { background: var(--gray); color: white; }

    /* Progress Bar for Budget */
    .budget-progress {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    
    .budget-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--budget-color), #8c7ae6);
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .budget-progress-fill.over {
      background: linear-gradient(90deg, var(--danger), #ff6b6b);
    }
    
    .budget-status {
      font-size: 0.75rem;
      margin-top: 5px;
      display: flex;
      justify-content: space-between;
    }
    
    .budget-status .remaining {
      color: var(--success);
    }
    
    .budget-status .exceeded {
      color: var(--danger);
    }

    /* Reminder Item */
    .reminder-due {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      display: inline-block;
      margin-top: 3px;
    }
    
    .reminder-due.today {
      background: #ffeb3b;
      color: #333;
    }
    
    .reminder-due.upcoming {
      background: #4caf50;
      color: white;
    }
    
    .reminder-due.overdue {
      background: #f44336;
      color: white;
    }
    
    .reminder-completed {
      text-decoration: line-through;
      opacity: 0.7;
    }

    /* Messages & Loader */
    .message { 
      padding: 12px 16px; 
      border-radius: 10px; 
      margin: 10px 0; 
      display: none; 
      align-items: center; 
      gap: 10px; 
      animation: slideIn 0.3s ease; 
      font-size: 0.9rem; 
    }
    
    @keyframes slideIn { 
      from { 
        opacity: 0; 
        transform: translateY(-10px); 
      } 
      to { 
        opacity: 1; 
        transform: translateY(0); 
      } 
    }
    
    .message.show { 
      display: flex; 
    }
    
    .message.success { 
      background: linear-gradient(135deg, #d4edda, #c3e6cb); 
      color: #155724; 
      border-left: 4px solid #28a745; 
    }
    
    .message.error { 
      background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
      color: #721c24; 
      border-left: 4px solid #dc3545; 
    }
    
    .message.info { 
      background: linear-gradient(135deg, #d1ecf1, #bee5eb); 
      color: #0c5460; 
      border-left: 4px solid #17a2b8; 
    }
    
    .message.warning { 
      background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
      color: #856404; 
      border-left: 4px solid #ffc107; 
    }
    
    body.dark-mode .message.success { 
      background: linear-gradient(135deg, #064e3b, #065f46); 
      color: #d1fae5; 
      border-left: 4px solid #10b981; 
    }
    
    body.dark-mode .message.error { 
      background: linear-gradient(135deg, #7f1d1d, #991b1b); 
      color: #fecaca; 
      border-left: 4px solid #ef4444; 
    }
    
    body.dark-mode .message.info { 
      background: linear-gradient(135deg, #164e63, #155e75); 
      color: #cffafe; 
      border-left: 4px solid #06b6d4; 
    }
    
    body.dark-mode .message.warning { 
      background: linear-gradient(135deg, #78350f, #92400e); 
      color: #fef3c7; 
      border-left: 4px solid #f59e0b; 
    }
    
    .loading { 
      text-align: center; 
      padding: 30px; 
      color: var(--gray); 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 12px; 
    }
    
    .spinner { 
      width: 30px; 
      height: 30px; 
      border: 3px solid var(--border); 
      border-top-color: var(--primary); 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    
    @keyframes spin { 
      to { 
        transform: rotate(360deg); 
      } 
    }
    
    .empty-state { 
      text-align: center; 
      padding: 30px; 
      color: var(--gray); 
    }

    /* Modal */
    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0, 0, 0, 0.5); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 1000; 
      backdrop-filter: blur(5px); 
      padding: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .modal { 
      background: var(--modal-bg); 
      border-radius: 16px; 
      padding: 20px; 
      max-width: 500px; 
      width: 100%; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
      animation: modalSlide 0.3s ease; 
      color: var(--text-color); 
      max-height: 85vh; 
      overflow-y: auto;
    }
    
    @keyframes modalSlide { 
      from { 
        opacity: 0; 
        transform: translateY(-20px); 
      } 
      to { 
        opacity: 1; 
        transform: translateY(0); 
      } 
    }
    
    .modal-actions { 
      display: flex; 
      gap: 10px; 
      justify-content: flex-end; 
      margin-top: 20px; 
      flex-wrap: wrap;
    }
    
    .modal h3 { 
      margin-bottom: 15px; 
      color: var(--primary); 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      font-size: 1.3rem;
    }

    /* Specific Report Filter Styles */
    .specific-report-filter {
        background: var(--light);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        border: 1px solid var(--border);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 15px;
    }
    
    .filter-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Search and Filter - FIXED: Improved styling */
    .search-filter-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .search-box {
      flex: 1;
      width: 100%;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 12px 12px 40px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 14px;
      transition: all 0.3s;
      min-height: 44px;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }
    
    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 14px;
    }
    
    .filter-select {
      width: 100%;
    }
    
    .filter-select select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .filter-select select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }
    
    .filter-select select option {
      background: var(--input-bg);
      color: var(--text-color);
      padding: 10px;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 5px;
      -webkit-overflow-scrolling: touch;
    }
    
    .quick-action-btn {
      padding: 10px 14px;
      background: var(--light);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      white-space: nowrap;
      flex-shrink: 0;
      min-height: 40px;
    }
    
    .quick-action-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    /* User Profile */
    .user-profile {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }
    
    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--gradient-1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .user-email {
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }

    /* ===== RESPONSIVE BREAKPOINTS ===== */
    
    /* Large screens - default styles already applied */
    
    /* Medium screens (tablets) */
    @media (max-width: 1024px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .forms-wrapper {
        order: -1;
      }
      
      .main-stats-grid,
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .charts-section {
        grid-template-columns: 1fr;
      }
    }
    
    /* Tablets and smaller screens */
    @media (max-width: 992px) {
      .auth-container {
        flex-direction: column;
        height: auto;
        min-height: auto;
        max-width: 500px;
        margin: 20px auto;
      }
      
      .auth-left-panel,
      .auth-right-panel {
        flex: none;
        padding: 30px 25px;
      }
      
      .auth-left-panel {
        min-height: 300px;
      }
      
      .auth-right-panel {
        overflow-y: visible;
      }
      
      .auth-left-content h1 {
        font-size: 2rem;
      }
      
      .auth-left-content .tagline {
        font-size: 1.1rem;
      }
      
      .auth-welcome h2 {
        font-size: 1.6rem;
      }
      
      .container {
        border-radius: 16px;
        margin: 10px;
        width: calc(100% - 20px);
      }
      
      .header {
        padding: 15px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .dashboard {
        padding: 15px;
      }
      
      .content {
        padding: 15px;
      }
      
      .modal {
        max-width: 90%;
        padding: 15px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Mobile screens */
    @media (max-width: 768px) {
      body {
        padding: 0;
      }
      
      .auth-overlay {
        padding: 10px;
        align-items: flex-start;
      }
      
      .auth-container {
        margin: 10px auto;
        border-radius: 16px;
        max-width: 100%;
      }
      
      .auth-left-panel,
      .auth-right-panel {
        padding: 25px 20px;
      }
      
      .auth-left-panel {
        min-height: 250px;
      }
      
      .auth-left-content h1 {
        font-size: 1.8rem;
      }
      
      .auth-left-content .tagline {
        font-size: 1rem;
      }
      
      .features-list li {
        font-size: 0.9rem;
        margin-bottom: 12px;
      }
      
      .features-list li i {
        width: 26px;
        height: 26px;
        font-size: 0.9rem;
      }
      
      .auth-welcome h2 {
        font-size: 1.4rem;
      }
      
      .auth-tab {
        padding: 10px;
        font-size: 0.85rem;
      }
      
      .auth-input-group input {
        padding: 12px 14px;
        font-size: 16px;
      }
      
      .auth-btn {
        padding: 12px;
        font-size: 15px;
      }
      
      .header {
        padding: 15px;
      }
      
      .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header h1 {
        font-size: 1.4rem;
        width: 100%;
      }
      
      .header p {
        font-size: 0.85rem;
      }
      
      .status-indicator {
        align-self: flex-start;
      }
      
      .theme-toggle-header {
        position: absolute;
        top: 15px;
        right: 15px;
        margin-left: 0;
      }
      
      .dashboard {
        padding: 15px;
        gap: 15px;
      }
      
      .stats-section,
      .form-section,
      .expenses-list,
      .income-list,
      .reminders-list,
      .budgets-list,
      .report-section {
        padding: 15px;
        border-radius: 12px;
      }
      
      .main-stats-grid,
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .stat-card {
        padding: 12px;
        min-height: 80px;
      }
      
      .stat-value {
        font-size: 1.2rem;
      }
      
      .stat-label {
        font-size: 0.7rem;
      }
      
      .charts-section {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .chart-container {
        padding: 15px;
        min-height: 220px;
      }
      
      .content {
        padding: 15px;
      }
      
      .expense-item,
      .reminder-item,
      .budget-item {
        flex-direction: column;
        padding: 12px;
        gap: 10px;
      }
      
      .item-actions {
        justify-content: flex-end;
      }
      
      .footer {
        padding: 15px;
      }
      
      .footer-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .footer-links {
        margin-left: 0;
        justify-content: center;
        gap: 10px;
      }
      
      .copyright {
        font-size: 0.8rem;
      }
      
      .footer-links a {
        font-size: 0.8rem;
      }
      
      .btn-actions-container {
        flex-direction: column;
      }
      
      .btn-cancel {
        margin-left: 0;
        margin-top: 10px;
      }
      
      .report-period {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      
      .report-period > div:last-child {
        align-self: auto;
        margin-top: 10px;
      }
      
      .report-controls {
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .btn-report {
        padding: 8px 12px;
        font-size: 0.8rem;
      }
      
      .quick-actions {
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .quick-action-btn {
        padding: 8px 12px;
        font-size: 0.8rem;
      }
      
      .search-filter-container {
        flex-direction: column;
      }
      
      .search-box,
      .filter-select {
        width: 100%;
      }
      
      .user-profile {
        padding: 6px 10px;
        font-size: 0.75rem;
      }
      
      .user-email {
        max-width: 100px;
      }
      
      .modal {
        padding: 15px;
        max-height: 80vh;
      }
      
      .modal h3 {
        font-size: 1.2rem;
      }
      
      .modal-actions {
        flex-direction: column;
      }
      
      .modal-actions .btn {
        width: 100%;
      }
      
      /* NEW: Category Report Modal */
      .category-report-modal .filter-grid {
        grid-template-columns: 1fr;
      }
      
      .category-report-modal .filter-actions {
        flex-direction: column;
      }
      
      .category-report-modal .filter-actions .btn {
        width: 100%;
      }
    }
    
    /* Small mobile screens */
    @media (max-width: 480px) {
      .auth-left-content h1 {
        font-size: 1.6rem;
      }
      
      .auth-left-content .tagline {
        font-size: 0.95rem;
      }
      
      .auth-left-panel {
        padding: 20px 15px;
        min-height: 200px;
      }
      
      .auth-right-panel {
        padding: 20px 15px;
      }
      
      .auth-welcome h2 {
        font-size: 1.3rem;
      }
      
      .auth-input-group input {
        padding: 11px 13px;
        font-size: 15px;
      }
      
      .auth-btn {
        padding: 11px;
        font-size: 14px;
      }
      
      .header h1 {
        font-size: 1.3rem;
      }
      
      .header h1 i {
        padding: 8px;
        font-size: 1rem;
      }
      
      .stat-value {
        font-size: 1.1rem;
      }
      
      .form-title {
        font-size: 1.1rem;
      }
      
      .btn {
        padding: 11px 16px;
        font-size: 13px;
      }
      
      .expense-amount {
        font-size: 1rem;
      }
      
      .category-name {
        flex: 0 0 100px;
        font-size: 0.75rem;
      }
      
      .category-amount {
        flex: 0 0 70px;
        font-size: 0.8rem;
      }
      
      .category-percentage {
        flex: 0 0 35px;
        font-size: 0.7rem;
      }
      
      .chart-container {
        min-height: 200px;
      }
      
      .chart-container h4 {
        font-size: 0.95rem;
      }
      
      .auth-theme-toggle span {
        display: none;
      }
      
      .auth-theme-toggle {
        top: 15px;
        right: 15px;
      }
      
      .status-indicator {
        font-size: 0.75rem;
      }
      
      .user-email {
        max-width: 80px;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 360px) {
      .auth-left-content h1 {
        font-size: 1.4rem;
      }
      
      .auth-left-content .tagline {
        font-size: 0.9rem;
      }
      
      .features-list li {
        font-size: 0.85rem;
      }
      
      .auth-welcome h2 {
        font-size: 1.2rem;
      }
      
      .header h1 {
        font-size: 1.2rem;
      }
      
      .stat-value {
        font-size: 1rem;
      }
      
      .form-title {
        font-size: 1rem;
      }
      
      .user-email {
        display: none;
      }
      
      .user-profile {
        padding: 6px;
      }
      
      .quick-action-btn span {
        display: none;
      }
      
      .quick-action-btn {
        padding: 10px;
        justify-content: center;
      }
      
      .btn-report span {
        display: none;
      }
      
      .btn-report {
        padding: 8px;
        justify-content: center;
      }
      
      .btn-report i {
        margin: 0;
      }
    }
    
    /* Landscape mode fixes */
    @media (max-height: 600px) and (orientation: landscape) {
      .auth-overlay {
        align-items: flex-start;
        padding-top: 20px;
      }
      
      .auth-container {
        height: auto;
        min-height: auto;
        margin: 20px auto;
      }
      
      .auth-left-panel {
        min-height: auto;
        padding: 20px;
      }
      
      .auth-right-panel {
        padding: 20px;
      }
      
      .features-list {
        display: none;
      }
      
      .auth-footer-text {
        margin-top: 20px;
        font-size: 0.7rem;
      }
    }
    
    /* Prevent zoom on input focus for mobile */
    @media screen and (max-width: 768px) {
      input, select, textarea {
        font-size: 16px !important;
      }
    }
    
    /* iOS specific fixes */
    @supports (-webkit-touch-callout: none) {
      .auth-overlay {
        height: -webkit-fill-available;
      }
      
      body {
        min-height: -webkit-fill-available;
      }
      
      input, select, textarea {
        -webkit-appearance: none;
        border-radius: 10px;
      }
    }
	
	/* ===== UPDATED COMPACT LIST STYLES ===== */
/* Make all list items more compact */
.expense-item,
.reminder-item,
.income-item , 
.budget-item {
    padding: 6px 8px !important; /* Reduced from 8px 12px */
    margin-bottom: 3px !important; /* Reduced from 4px */
    border-radius: 6px !important; /* Slightly smaller radius */
    gap: 4px !important; /* Reduced from 6px */
    min-height: auto !important;
}

/* Reduce inner spacing for list items */
.expense-item .item-content,
.income-item .income-item,
.reminder-item .item-content,
.budget-item .item-content {
    gap: 3px !important;
}

/* Make category badges more compact */
.category-badge { 
    padding: 3px 6px !important; /* Reduced from 4px 8px */
    font-size: 0.65rem !important; /* Smaller font */
    margin-right: 4px !important; /* Reduced spacing */
    margin-bottom: 2px !important; /* Reduced spacing */
}

/* Make date text smaller and tighter */
.expense-item strong,
.reminder-item strong {
    font-size: 0.8rem !important;
    display: block;
    margin-top: 1px !important;
}

/* Reduce description text size and spacing */
.expense-item .item-content div,
.reminder-item .item-content div {
    font-size: 0.75rem !important;
    margin-top: 1px !important;
    line-height: 1.1 !important;
}

/* Make amount display more compact */
.expense-amount,
.income-amount {
    font-size: 0.95rem !important; /* Reduced from 1rem */
    margin-top: 0 !important;
    padding: 1px 0 !important;
}

/* Make action buttons smaller and tighter */
.item-actions {
    gap: 4px !important; /* Reduced from 6px */
    margin-top: 2px !important;
}

.action-btn {
    width: 28px !important; /* Reduced from 32px */
    height: 28px !important; /* Reduced from 32px */
    font-size: 0.8rem !important; /* Smaller icons */
}

/* Reduce list container padding */
.expenses-list,
.income-list,
.reminders-list,
.budgets-list {
    padding: 8px !important; /* Reduced from 15px */
}

/* Reduce list header spacing */
.list-header {
    margin-bottom: 10px !important; /* Reduced from 12px */
}

/* Make budget progress bars more compact */
.budget-progress {
    margin-top: 3px !important; /* Reduced from 4px */
    height: 5px !important; /* Reduced from 6px */
}

.budget-status {
    font-size: 0.65rem !important; /* Smaller text */
    margin-top: 2px !important; /* Reduced spacing */
}

/* Make reminder due dates more compact */
.reminder-due {
    font-size: 0.65rem !important; /* Smaller text */
    padding: 2px 4px !important; /* Reduced padding */
}

/* Reduce gap in category breakdown items */
.category-item {
    padding: 5px 6px !important; /* Reduced from 6px 8px */
    margin-bottom: 3px !important; /* Reduced from 4px */
}

/* Make quick actions more compact */
.quick-actions {
    gap: 5px !important; /* Reduced from 6px */
    margin-bottom: 10px !important; /* Reduced from 12px */
}

.quick-action-btn {
    padding: 6px 8px !important; /* Reduced from 8px 10px */
    font-size: 0.75rem !important; /* Smaller text */
    min-height: 36px !important; /* Reduced from 40px */
}

/* Make report items more compact */
.report-section {
    padding: 12px !important; /* Reduced from 15px */
    margin: 12px 0 !important; /* Reduced from 15px 0 */
}

/* Reduce spacing in search/filter container */
.search-filter-container {
    gap: 6px !important; /* Reduced from 8px */
    margin-bottom: 10px !important; /* Reduced from 12px */
}



/* Extra small screens - super compact */
@media (max-width: 480px) {
    .expense-item,
    .reminder-item,
    .budget-item {
        padding: 4px 5px !important;
        margin-bottom: 1px !important;
        gap: 2px !important;
    }
    
    .category-badge {
        padding: 1px 3px !important;
        font-size: 0.55rem !important;
        margin-right: 2px !important;
        margin-bottom: 1px !important;
    }
    
    .expense-amount,
    .income-amount {
        font-size: 0.85rem !important;
    }
    
    .action-btn {
        width: 24px !important;
        height: 24px !important;
        font-size: 0.7rem !important;
    }
    
    .expense-item strong,
    .reminder-item strong {
        font-size: 0.75rem !important;
    }
    
    .expense-item .item-content div,
    .reminder-item .item-content div {
        font-size: 0.7rem !important;
        line-height: 1 !important;
    }
}

/* ===== MOBILE-SPECIFIC COMPACT STYLES ===== */
@media (max-width: 768px) {
    /* Even more compact on mobile */
    .expense-item,
    .reminder-item,
    .budget-item {
        padding: 6px 10px !important;
        margin-bottom: 3px !important;
        gap: 4px !important;
    }
    
    .category-badge {
        padding: 3px 6px !important;
        font-size: 0.65rem !important;
    }
    
    .expense-amount,
    .income-amount {
        font-size: 0.95rem !important;
    }
    
    .item-actions {
        gap: 4px !important;
    }
    
    .action-btn {
        width: 28px !important;
        height: 28px !important;
    }
    
    .expenses-list,
    .income-list,
    .reminders-list,
    .budgets-list {
        padding: px !important;
    }
}
	/* ===== ULTRA-COMPACT LIST SECTIONS WITH DISTINCT SEPARATORS ===== */
/* Target all 3 list sections */
.expenses-list,
.reminders-list {
    padding: 8px 10px !important; /* Further reduced */
    margin-top: 10px !important; /* Further reduced */
    border-radius: 10px !important; /* Slightly smaller radius */
}



/* DISTINCT LINES BETWEEN ITEMS IN REMINDERS SECTION */
.reminders-list .reminder-item {
    border-bottom: 1px solid var(--border) !important; /* Solid separator */
    border-left: 2px solid transparent !important; /* Left accent border */
    border-right: 1px solid rgba(255, 152, 0, 0.05) !important; /* Right subtle border */
    background: linear-gradient(to right, var(--card-bg), var(--light)) !important;
    margin-bottom: 1px !important; /* Minimal separation */
}

/* Add alternating background for better distinction */
.reminders-list .reminder-item:nth-child(odd) {
    background: linear-gradient(to right, var(--light), var(--card-bg)) !important;
}

.reminders-list .reminder-item:hover {
    border-left-color: var(--primary) !important; /* Color accent on hover */
    border-bottom-color: var(--primary) !important;
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.05), var(--card-bg)) !important;
}

/* Reduce space between list header and content */
.expenses-list .list-header,
.income-list .list-header,
.reminders-list .list-header {
    margin-bottom: 6px !important; /* Further reduced */
    padding-bottom: 3px !important;
}

/* Ultra-compact category badges */
.expenses-list .category-badge,
.income-list .category-badge,
.reminders-list .category-badge {
    padding: 1px 4px !important; /* Minimal padding */
    font-size: 0.6rem !important; /* Very small font */
    margin-bottom: 1px !important;
    margin-right: 2px !important;
    border-radius: 4px !important;
    line-height: 1.1 !important;
}

/* ULTRA-COMPACT SEARCH BARS */
.expenses-list .search-filter-container,
.income-list .search-filter-container,
.reminders-list .search-filter-container {
    margin-bottom: 6px !important; /* Minimal spacing */
    gap: 4px !important; /* Extremely tight */
}

.expenses-list .search-box input,
.income-list .search-box input,
.reminders-list .search-box input {
    padding: 6px 6px 6px 26px !important; /* Very compact */
    font-size: 12px !important; /* Smaller font */
    border-radius: 6px !important; /* Smaller radius */
    min-height: 36px !important; /* Fixed height */
}

.expenses-list .search-box i,
.income-list .search-box i,
.reminders-list .search-box i {
    left: 8px !important; /* Adjusted position */
    font-size: 11px !important; /* Smaller icon */
    top: 50% !important;
    transform: translateY(-50%) !important;
}

/* Ultra-compact filter selects */
.expenses-list .filter-select select,
.income-list .filter-select select,
.reminders-list .filter-select select {
    padding: 6px !important; /* Minimal */
    font-size: 12px !important;
    border-radius: 6px !important;
    min-height: 36px !important; /* Fixed height */
}

/* Ultra-compact list headers */
.expenses-list h3,
.reminders-list h3 {
    font-size: 0.9rem !important; /* Smaller */
    margin: 0 !important;
}

/* ULTRA-COMPACT ITEM CONTENT - COLUMNS REDUCED */
.expenses-list .item-content,
.income-list .item-content,
.reminders-list .item-content {
    gap: 1px !important; /* Minimal gap between elements */
    padding: 0 !important;
    margin: 0 !important;
}

/* Ultra-compact amount display */
.expenses-list .expense-amount,
.income-list .income-amount,
.reminders-list .reminder-amount {
    font-size: 0.85rem !important; /* Very small */
    margin-top: 0 !important;
    padding: 0 !important;
    line-height: 1 !important;
}

/* Ultra-compact description text */
.expenses-list .expense-item .item-content div,
.income-list .income-item .item-content div,
.reminders-list .reminder-item .item-content div {
    font-size: 0.75rem !important; /* Very small */
    line-height: 1.1 !important; /* Tight */
    margin-top: 0 !important;
    padding: 0 !important;
}


/* Ultra-compact action buttons */
.expenses-list .item-actions,
.income-list .item-actions,
.reminders-list .item-actions {
    gap: 2px !important; /* Minimal spacing */
    margin-top: 0 !important;
    padding-top: 0 !important;
}

.expenses-list .action-btn,
.income-list .action-btn,
.reminders-list .action-btn {
    width: 24px !important; /* Very small */
    height: 24px !important;
    font-size: 0.7rem !important; /* Tiny icons */
    border-radius: 5px !important;
}

/* Loading spinner adjustments for ultra-compact */
.expenses-list .loading,
.income-list .loading,
.reminders-list .loading {
    padding: 8px !important; /* Minimal */
}

.expenses-list .spinner,
.income-list .spinner,
.reminders-list .spinner {
    width: 20px !important; /* Smaller */
    height: 20px !important;
    border-width: 2px !important; /* Thinner */
}

/* Empty state adjustments */
.expenses-list .empty-state,
.income-list .empty-state,
.reminders-list .empty-state {
    padding: 12px !important; /* Minimal */
    font-size: 0.85rem !important; /* Smaller text */
}

/* Ultra-compact toggle icons */
.expenses-list .toggle-icon,
.income-list .toggle-icon,
.reminders-list .toggle-icon {
    font-size: 0.8rem !important; /* Smaller icon */
}



/* Shimmer effect for all items */
.expenses-list .expense-item::before,
.income-list .income-item::before,
.reminders-list .reminder-item::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: -100% !important;
    width: 100% !important;
    height: 100% !important;
    background: linear-gradient(90deg, transparent, rgba(255, 152, 0, 0.08), transparent) !important;
    transition: left 0.4s ease !important;
    pointer-events: none !important;
}

.expenses-list .expense-item:hover::before,
.income-list .income-item:hover::before,
.reminders-list .reminder-item:hover::before {
    left: 100% !important;
}

/* Mobile responsiveness for ultra-compact design */
@media (max-width: 768px) {
    .expenses-list,
    .income-list,
    .reminders-list {
        padding: 6px 8px !important; /* Even more compact on mobile */
        margin-top: 8px !important;
    }
    
    .expenses-list .expense-item,
    .income-list .income-item,
    .reminders-list .reminder-item {
        padding: 3px 4px !important; /* Minimal padding on mobile */
        margin-bottom: 0 !important; /* No margin between items on mobile */
        border-bottom: 1px solid rgba(255, 152, 0, 0.05) !important; /* Add subtle separator */
        min-height: 40px !important; /* Even shorter on mobile */
    }
    
    .expenses-list .expense-amount,
    .income-list .income-amount,
    .reminders-list .reminder-amount {
        font-size: 0.8rem !important; /* Smaller on mobile */
    }
    
    .expenses-list .category-badge,
    .income-list .category-badge,
    .reminders-list .category-badge {
        padding: 1px 3px !important;
        font-size: 0.55rem !important;
    }
    
    .expenses-list .action-btn,
    .income-list .action-btn,
    .reminders-list .action-btn {
        width: 22px !important;
        height: 22px !important;
    }
    
    /* Stack search and filter on mobile for better space usage */
    .expenses-list .search-filter-container,
    .income-list .search-filter-container,
    .reminders-list .search-filter-container {
        flex-direction: column !important;
        gap: 3px !important;
    }
    
    .expenses-list .search-box,
    .income-list .search-box,
    .reminders-list .search-box {
        width: 100% !important;
    }
    
    .expenses-list .filter-select,
    .income-list .filter-select,
    .reminders-list .filter-select {
        width: 100% !important;
    }
}

/* Small screen adjustments */
@media (max-width: 480px) {
    .expenses-list h3,
    .income-list h3,
    .reminders-list h3 {
        font-size: 0.85rem !important;
    }
    
    .expenses-list .expense-item strong,
    .income-list .income-item strong,
    .reminders-list .reminder-item strong {
        font-size: 0.7rem !important;
    }
    
    .expenses-list .expense-item .item-content div,
    .income-list .income-item .item-content div,
    .reminders-list .reminder-item .item-content div {
        font-size: 0.7rem !important;
    }
    
    /* Hide some text on very small screens */
    .expenses-list .category-badge span,
    .income-list .category-badge span,
    .reminders-list .category-badge span {
        display: none !important;
    }
    
    .expenses-list .category-badge i,
    .income-list .category-badge i,
    .reminders-list .category-badge i {
        margin-right: 0 !important;
    }
}

/* ===== MOBILE-OPTIMIZED FUTURISTIC SEARCH BARS ===== */
/* Mobile-first approach for search containers */
.expenses-list .search-filter-container,
.income-list .search-filter-container,
.reminders-list .search-filter-container {
    margin-bottom: 6px !important;
    gap: 6px !important; /* Slightly larger gap for touch */
    padding: 8px !important; /* Better touch target */
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.08), 
        rgba(255, 255, 255, 0.03)) !important;
    backdrop-filter: blur(15px) !important;
    -webkit-backdrop-filter: blur(15px) !important; /* iOS support */
    border-radius: 10px !important;
    border: 1px solid rgba(255, 152, 0, 0.1) !important;
    box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
    position: relative !important;
    max-width: 100% !important;
}

/* Responsive search box layout */
.expenses-list .search-box input,
.income-list .search-box input,
.reminders-list .search-box input {
    padding: 10px 10px 10px 36px !important; /* Better touch target */
    font-size: 16px !important; /* Prevent iOS zoom on focus */
    font-weight: 500 !important;
    color: var(--text-color) !important;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.12), 
        rgba(255, 255, 255, 0.05)) !important;
    backdrop-filter: blur(12px) !important;
    -webkit-backdrop-filter: blur(12px) !important; /* iOS support */
    border: 1px solid rgba(255, 152, 0, 0.2) !important;
    border-radius: 10px !important;
    box-shadow: 
        0 4px 14px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(0, 0, 0, 0.04) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    outline: none !important;
    position: relative !important;
    overflow: hidden !important;
    min-height: 44px !important; /* Minimum touch target for iOS */
    -webkit-tap-highlight-color: transparent !important; /* Remove tap highlight */
    -webkit-appearance: none !important; /* Remove iOS default styling */
    appearance: none !important;
    width: 100% !important; /* Full width within container */
    box-sizing: border-box !important;
}

/* Enhanced search icon for touch */
.expenses-list .search-box i,
.income-list .search-box i,
.reminders-list .search-box i {
    left: 14px !important; /* Better touch target */
    font-size: 16px !important; /* Larger for visibility */
    top: 50% !important;
    transform: translateY(-50%) !important;
    color: var(--primary) !important;
    text-shadow: 0 0 10px rgba(255, 152, 0, 0.5) !important;
    z-index: 2 !important;
    transition: all 0.3s ease !important;
    pointer-events: none !important;
    padding: 4px !important; /* Add touch padding */
}

/* Modern filter selects - Touch optimized */
.expenses-list .filter-select select,
.income-list .filter-select select,
.reminders-list .filter-select select {
    padding: 12px 40px 12px 14px !important; /* Better touch target */
    font-size: 16px !important; /* Prevent iOS zoom */
    font-weight: 500 !important;
    color: var(--text-color) !important;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.12), 
        rgba(255, 255, 255, 0.05)) !important;
    backdrop-filter: blur(12px) !important;
    -webkit-backdrop-filter: blur(12px) !important;
    border: 1px solid rgba(255, 152, 0, 0.2) !important;
    border-radius: 10px !important;
    box-shadow: 
        0 4px 14px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    outline: none !important;
    -webkit-appearance: none !important;
    appearance: none !important;
    cursor: pointer !important;
    position: relative !important;
    z-index: 2 !important;
    min-height: 44px !important; /* Minimum touch target */
    -webkit-tap-highlight-color: transparent !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* Custom arrow with better visibility */
.expenses-list .filter-select::after,
.income-list .filter-select::after,
.reminders-list .filter-select::after {
    content: '' !important;
    position: absolute !important;
    right: 16px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    font-size: 14px !important; /* Larger for visibility */
    color: var(--primary) !important;
    text-shadow: 0 0 10px rgba(255, 152, 0, 0.5) !important;
    pointer-events: none !important;
    z-index: 3 !important;
    transition: all 0.3s ease !important;
    padding: 4px !important; /* Touch area */
}

/* ===== MOBILE SPECIFIC ADJUSTMENTS ===== */


    /* Each search/filter item takes half of the container */
    .expenses-list .search-box,
    .income-list .search-box,
    .reminders-list .search-box,
    .expenses-list .filter-select,
    .income-list .filter-select,
    .reminders-list .filter-select {
        flex: 1 !important; /* Each takes equal space */
        min-width: 0 !important; /* Allow shrinking */
    }
    
    /* Stack vertically on very small screens */
    @media (max-width: 480px) {
        .expenses-list .search-filter-container,
        .income-list .search-filter-container,
        .reminders-list .search-filter-container {
            flex-direction: column !important;
            width: 60% !important; /* Slightly wider on very small screens */
            margin-left: auto !important;
            margin-right: 0 !important;
        }
    }
    
    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {
        .expenses-list .search-box input,
        .income-list .search-box input,
        .reminders-list .search-box input,
        .expenses-list .filter-select select,
        .income-list .filter-select select,
        .reminders-list .filter-select select {
            font-size: 16px !important; /* Prevent auto-zoom */
            line-height: 1.2 !important;
            padding-top: 12px !important;
            padding-bottom: 12px !important;
        }
        
        /* Fix for iOS input shadows */
        .expenses-list .search-box input,
        .income-list .search-box input,
        .reminders-list .search-box input {
            -webkit-appearance: none !important;
            border-radius: 10px !important;
        }
    }
    
    /* Fix for Chrome on Android */
    @supports (-webkit-appearance: none) and (not (-ms-accelerator: true)) {
        .expenses-list .search-box input,
        .income-list .search-box input,
        .reminders-list .search-box input {
            line-height: 1.5 !important;
        }
    }
}

/* Tablet landscape and larger phones */
@media (min-width: 769px) and (max-width: 1024px) {
    .expenses-list .search-filter-container,
    .income-list .search-filter-container,
    .reminders-list .search-filter-container {
        width: 40% !important; /* Smaller width on tablets */
        margin-left: auto !important;
        margin-right: 0 !important;
        gap: 8px !important;
    }
}

/* Desktop - Full width */
@media (min-width: 1025px) {
    .expenses-list .search-filter-container,
    .income-list .search-filter-container,
    .reminders-list .search-filter-container {
        width: 100% !important; /* Full width on desktop */
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

/* Safe area insets for iPhone X+ notches */
@supports (padding: max(0px)) {
    .expenses-list .search-filter-container,
    .income-list .search-filter-container,
    .reminders-list .search-filter-container {
        padding-left: max(10px, env(safe-area-inset-left, 10px)) !important;
        padding-right: max(10px, env(safe-area-inset-right, 10px)) !important;
    }
}

/* Hover effects only for non-touch devices */
@media (hover: hover) and (pointer: fine) {
    .expenses-list .search-filter-container:hover,
    .income-list .search-filter-container:hover,
    .reminders-list .search-filter-container:hover {
        border-color: rgba(255, 152, 0, 0.25) !important;
        animation: container-pulse 3s infinite ease-in-out !important;
    }
    
    .expenses-list .search-box input:hover,
    .income-list .search-box input:hover,
    .reminders-list .search-box input:hover,
    .expenses-list .filter-select select:hover,
    .income-list .filter-select select:hover,
    .reminders-list .filter-select select:hover {
        border-color: rgba(255, 152, 0, 0.3) !important;
        transform: translateY(-1px) !important;
    }
}

/* Remove blue highlight on iOS tap */
.expenses-list .search-box input,
.income-list .search-box input,
.reminders-list .search-box input,
.expenses-list .filter-select select,
.income-list .filter-select select,
.reminders-list .filter-select select {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0) !important;
    -webkit-touch-callout: none !important;
    -webkit-user-select: none !important;
    user-select: none !important;
}

/* Focus effects for accessibility */
.expenses-list .search-box input:focus,
.income-list .search-box input:focus,
.reminders-list .search-box input:focus,
.expenses-list .filter-select select:focus,
.income-list .filter-select select:focus,
.reminders-list .filter-select select:focus {
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.25), 
        rgba(255, 255, 255, 0.12)) !important;
    border-color: var(--primary) !important;
    box-shadow: 
        0 0 20px rgba(255, 152, 0, 0.4),
        0 8px 25px rgba(255, 152, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.25) !important;
    transform: translateY(-2px) !important;
    animation: neon-pulse 2s infinite alternate !important;
}

/* Active state for touch feedback */
.expenses-list .search-box input:active,
.income-list .search-box input:active,
.reminders-list .search-box input:active,
.expenses-list .filter-select select:active,
.income-list .filter-select select:active,
.reminders-list .filter-select select:active {
    transform: translateY(0) !important;
    transition: transform 0.1s ease !important;
}

/* Placeholder text adjustments */
.expenses-list .search-box input::placeholder,
.income-list .search-box input::placeholder,
.reminders-list .search-box input::placeholder {
    color: var(--gray) !important;
    opacity: 0.7 !important;
    font-weight: 400 !important;
    font-size: 14px !important;
    transition: all 0.3s ease !important;
}

/* Dark mode adjustments for mobile */
body.dark-mode .expenses-list .search-filter-container,
body.dark-mode .income-list .search-filter-container,
body.dark-mode .reminders-list .search-filter-container {
    background: linear-gradient(135deg, 
        rgba(31, 41, 55, 0.8), 
        rgba(31, 41, 55, 0.6)) !important;
    border-color: rgba(255, 183, 77, 0.2) !important;
}

body.dark-mode .expenses-list .search-box input,
body.dark-mode .income-list .search-box input,
body.dark-mode .reminders-list .search-box input,
body.dark-mode .expenses-list .filter-select select,
body.dark-mode .income-list .filter-select select,
body.dark-mode .reminders-list .filter-select select {
    background: linear-gradient(135deg, 
        rgba(31, 41, 55, 0.7), 
        rgba(31, 41, 55, 0.5)) !important;
    border-color: rgba(255, 183, 77, 0.25) !important;
    color: var(--dark) !important;
}

body.dark-mode .expenses-list .search-box input::placeholder,
body.dark-mode .income-list .search-box input::placeholder,
body.dark-mode .reminders-list .search-box input::placeholder {
    color: var(--gray) !important;
}

/* Reduced motion preferences */
@media (prefers-reduced-motion: reduce) {
    .expenses-list .search-box input,
    .income-list .search-box input,
    .reminders-list .search-box input,
    .expenses-list .filter-select select,
    .income-list .filter-select select,
    .reminders-list .filter-select select {
        transition: none !important;
    }
    
    .expenses-list .search-filter-container:hover,
    .income-list .search-filter-container:hover,
    .reminders-list .search-filter-container:hover {
        animation: none !important;
    }
}
	
	/* Income source badges */
.source-salary { background: linear-gradient(135deg, #ffcc80, #ffb74d); color: var(--dark); }
.source-freelance { background: linear-gradient(135deg, #a8edea, #fed6e3); color: var(--dark); }
.source-investment { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
.source-business { background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; }
.source-gift { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
.source-rental-income { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; }
.source-bonus { background: linear-gradient(135deg, #ffd166, #ff9a9e); color: var(--dark); }
.source-commission { background: linear-gradient(135deg, #a78bfa, #7c3aed); color: white; }
.source-allowances { background: linear-gradient(135deg, #ff9a9e, #fecfef); color: var(--dark); }
.source-dividends { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
.source-interest { background: linear-gradient(135deg, #a8edea, #fed6e3); color: var(--dark); }
.source-royalties { background: linear-gradient(135deg, #cd9cf2, #f6f3ff); color: var(--dark); }
.source-pension { background: linear-gradient(135deg, #ffcc80, #ffb74d); color: var(--dark); }
.source-social-security { background: linear-gradient(135deg, #89f7fe, #66a6ff); color: white; }
.source-child-support { background: linear-gradient(135deg, #a8edea, #fed6e3); color: var(--dark); }
.source-alimony { background: linear-gradient(135deg, #ff6b6b, #ffa8a8); color: white; }
.source-scholarship { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
.source-grant { background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; }
.source-rebate { background: linear-gradient(135deg, #ffd166, #ff9a9e); color: var(--dark); }
.source-refund { background: linear-gradient(135deg, #a8edea, #fed6e3); color: var(--dark); }
.source-lottery { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; }
.source-inheritance { background: linear-gradient(135deg, #cd9cf2, #f6f3ff); color: var(--dark); }
.source-sale { background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; }
.source-other { background: var(--gray); color: white; }













/* ===== INCOME LIST STYLES - SINGLE SOURCE OF TRUTH ===== */
.income-item {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  padding: 4px 6px !important;
  border-bottom: 1px solid var(--border);
  transition: all 0.4s;
  border-radius: 4px;
  margin-bottom: 1px !important;
  background: var(--light);
  gap: 6px !important;
  min-height: 40px !important;
  position: relative;
}

.income-item:hover {
  transform: translateX(5px);
  box-shadow: 0 5px 15px var(--shadow);
}

.income-item .item-content {
  flex: 1 !important;
  width: auto !important;
  min-width: 0;
}

.income-item .income-amount {
  font-weight: 700;
  font-size: 0.95rem !important;
  font-family: 'SF Mono', 'Courier New', monospace;
  background: var(--gradient-income);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: right;
  margin: 0 !important;
  padding: 0 !important;
  white-space: nowrap;
  flex-shrink: 0;
}

.income-item .item-actions {
  display: flex !important;
  gap: 4px !important;
  margin: 0 !important;
  padding: 0 !important;
  justify-content: flex-start !important;
  width: auto !important;
  flex-shrink: 0;
}

.income-item .action-btn {
  width: 28px !important;
  height: 28px !important;
  border-radius: 6px !important;
  font-size: 0.8rem !important;
  display: flex;
  align-items: center;
  justify-content: center;
}

.income-item .category-badge {
  padding: 2px 5px !important;
  font-size: 0.65rem !important;
  margin-right: 4px !important;
  margin-bottom: 0 !important;
}

.income-item strong {
  font-size: 0.8rem !important;
  display: block;
  margin-top: 1px !important;
}

.income-item .item-content div {
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
  margin-top: 1px !important;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
  .income-item {
    padding: 3px 5px !important;
    margin-bottom: 1px !important;
    gap: 4px !important;
    min-height: 36px !important;
  }
  
  .income-item .income-amount {
    font-size: 0.85rem !important;
  }
  
  .income-item .action-btn {
    width: 26px !important;
    height: 26px !important;
    font-size: 0.75rem !important;
  }
  
  .income-item .category-badge {
    padding: 1px 4px !important;
    font-size: 0.6rem !important;
  }
  
  .income-item strong {
    font-size: 0.75rem !important;
  }
  
  .income-item .item-content div {
    font-size: 0.7rem !important;
  }
}

@media (max-width: 480px) {
  .income-item {
    flex-direction: column !important;
    align-items: flex-start !important;
    padding: 4px !important;
    gap: 3px !important;
  }
  
  .income-item .income-amount {
    width: 100%;
    text-align: left !important;
    order: 2;
  }
  
  .income-item .item-actions {
    width: 100%;
    justify-content: flex-end !important;
    order: 3;
  }
}




/* Ensure proper display for income items */
#incomeList .income-item,
.income-list .income-item {
  display: flex !important;
}





















/* ===== UPDATED EXPENSE ITEM LAYOUT ===== */
.expense-item {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  padding: 4px 6px !important;
  border-bottom: 1px solid var(--border);
  transition: all 0.4s;
  border-radius: 4px;
  margin-bottom: 1px !important; /* Reduced from 2px */
  background: var(--light);
  gap: 6px !important; /* Reduced from gap */
  min-height: 40px !important;
  position: relative;
}

/* Content takes available space */
.expense-item .item-content {
  flex: 1 !important;
  width: auto !important;
  min-width: 0; /* Allows text truncation */
}

/* Amount on the right */
.expense-item .expense-amount {
  font-weight: 700;
  font-size: 0.95rem !important;
  font-family: 'SF Mono', 'Courier New', monospace;
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: right;
  margin: 0 !important;
  padding: 0 !important;
  white-space: nowrap;
  flex-shrink: 0;
}

/* Buttons next to amount */
.expense-item .item-actions {
  display: flex !important;
  gap: 4px !important;
  margin: 0 !important;
  padding: 0 !important;
  justify-content: flex-start !important;
  width: auto !important;
  flex-shrink: 0;
}

/* Compact action buttons */
.expense-item .action-btn {
  width: 28px !important;
  height: 28px !important;
  border-radius: 6px !important;
  font-size: 0.8rem !important;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Make category badges more compact */
.expense-item .category-badge {
  padding: 2px 5px !important;
  font-size: 0.65rem !important;
  margin-right: 4px !important;
  margin-bottom: 0 !important;
}

/* Compact date display */
.expense-item strong {
  font-size: 0.8rem !important;
  display: block;
  margin-top: 1px !important;
}

/* Compact description */
.expense-item .item-content div {
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
  margin-top: 1px !important;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}



/* ===== REMINDER ITEM LAYOUT (for consistency) ===== */
.reminder-item {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  padding: 4px 6px !important;
  border-bottom: 1px solid var(--border);
  transition: all 0.4s;
  border-radius: 4px;
  margin-bottom: 1px !important;
  background: var(--light);
  gap: 6px !important;
  min-height: 40px !important;
}

.reminder-item .item-content {
  flex: 1 !important;
  width: auto !important;
}

.reminder-item .reminder-amount {
  font-weight: 700;
  font-size: 0.95rem !important;
  font-family: 'SF Mono', 'Courier New', monospace;
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: right;
  margin: 0 !important;
  padding: 0 !important;
  white-space: nowrap;
  flex-shrink: 0;
}

.reminder-item .item-actions {
  display: flex !important;
  gap: 4px !important;
  margin: 0 !important;
  padding: 0 !important;
  justify-content: flex-start !important;
  width: auto !important;
  flex-shrink: 0;
}

/* ===== MOBILE RESPONSIVE ADJUSTMENTS ===== */
@media (max-width: 768px) {
  .expense-item,
  .income-item,
  .reminder-item {
    padding: 3px 5px !important;
    margin-bottom: 1px !important;
    gap: 4px !important;
    min-height: 36px !important;
  }
  
  .expense-item .expense-amount,
  .income-item .income-amount,
  .reminder-item .reminder-amount {
    font-size: 0.85rem !important;
  }
  
  .expense-item .action-btn,
  .income-item .action-btn,
  .reminder-item .action-btn {
    width: 26px !important;
    height: 26px !important;
    font-size: 0.75rem !important;
  }
  
  .expense-item .category-badge {
    padding: 1px 4px !important;
    font-size: 0.6rem !important;
  }
  
  .expense-item strong {
    font-size: 0.75rem !important;
  }
  
  .expense-item .item-content div {
    font-size: 0.7rem !important;
  }
}

@media (max-width: 480px) {
  /* Stack on very small screens */
  .expense-item,
  .income-item,
  .reminder-item {
    flex-direction: column !important;
    align-items: flex-start !important;
    padding: 4px !important;
    gap: 3px !important;
  }
  
  .expense-item .expense-amount,
  .income-item .income-amount,
  .reminder-item .reminder-amount {
    width: 100%;
    text-align: left !important;
    order: 2;
  }
  
  .expense-item .item-actions,
  .income-item .item-actions,
  .reminder-item .item-actions {
    width: 100%;
    justify-content: flex-end !important;
    order: 3;
  }
}




/* Blur effect for hidden balances */
.balance-value.blurred {
    filter: blur(8px) !important;
    color: transparent !important;
    text-shadow: 0 0 12px rgba(0,0,0,0.5) !important;
    opacity: 0.8 !important;
    user-select: none !important;
    pointer-events: none !important;
}

/* Normal state for revealed balances */
.balance-value.revealed {
    filter: none !important;
    color: inherit !important;
    text-shadow: none !important;
    opacity: 1 !important;
    user-select: auto !important;
    pointer-events: auto !important;
}

/* Optional: Add a shimmer effect to blurred text */
.balance-value.blurred::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255,255,255,0.2), 
        transparent);
    animation: shimmer 2s infinite;
}







/* ===== FIXED SHIMMER EFFECT FOR BLURRED BALANCES ===== */
/* Remove the old shimmer effect */
.balance-value.blurred::after {
    display: none;
}

/* Alternative: Subtle pulsing effect instead of shimmer */
.balance-value.blurred {
    position: relative;
    overflow: hidden;
}

.balance-value.blurred::before {
    content: ' Tap to reveal';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: var(--primary);
    font-weight: 600;
    background: linear-gradient(135deg, 
        rgba(255, 152, 0, 0.1), 
        rgba(245, 124, 0, 0.1));
    border-radius: 4px;
    z-index: 1;
    animation: gentle-pulse 2s ease-in-out infinite;
}




@keyframes gentle-pulse {
    0%, 100% { 
        opacity: 0.7;
        background: linear-gradient(135deg, 
            rgba(255, 152, 0, 0.1), 
            rgba(245, 124, 0, 0.1));
    }
    50% { 
        opacity: 1;
        background: linear-gradient(135deg, 
            rgba(255, 152, 0, 0.15), 
            rgba(245, 124, 0, 0.15));
    }
}







/* ===== ENHANCED EXPENSE TIMEFRAME CARDS ===== */
.stat-card.expense-card {
    background: linear-gradient(135deg, #fff9f0 0%, #ffedd5 100%) !important;
    border: 2px solid #ff9800 !important;
    border-radius: 12px !important;
    box-shadow: 
        0 6px 20px rgba(255, 152, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative !important;
    overflow: hidden !important;
}

/* Optional accent line at top */
.stat-card.expense-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #ff9800, #ffb74d) !important;
    opacity: 0.9;
}

.stat-card.expense-card:hover {
    background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%) !important;
    border-color: #f57c00 !important;
    transform: translateY(-6px) scale(1.01) !important;
    box-shadow: 
        0 12px 30px rgba(255, 152, 0, 0.25),
        0 4px 12px rgba(255, 152, 0, 0.15) !important;
}

/* Card content styling for better readability */
.stat-card.expense-card .stat-title {
    color: #e65100 !important;
    font-weight: 600 !important;
}

.stat-card.expense-card .stat-value {
    color: #bf360c !important;
    font-weight: 700 !important;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5) !important;
}

/* Dark mode adjustments - refined colors */
body.dark-mode .stat-card.expense-card {
    background: linear-gradient(135deg, #4a2308 0%, #7c2d12 100%) !important;
    border: 2px solid #ffb74d !important;
    box-shadow: 
        0 6px 20px rgba(255, 183, 77, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
}

body.dark-mode .stat-card.expense-card::before {
    background: linear-gradient(90deg, #ffb74d, #ffcc80) !important;
}

body.dark-mode .stat-card.expense-card:hover {
    background: linear-gradient(135deg, #7c2d12 0%, #9a3412 100%) !important;
    border-color: #ff9800 !important;
    box-shadow: 
        0 15px 35px rgba(255, 183, 77, 0.25),
        0 5px 15px rgba(255, 183, 77, 0.15) !important;
}

/* Dark mode text colors */
body.dark-mode .stat-card.expense-card .stat-title {
    color: #ffb74d !important;
    opacity: 0.9;
}

body.dark-mode .stat-card.expense-card .stat-value {
    color: #ffcc80 !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
}

/* Focus state for accessibility */
.stat-card.expense-card:focus-within {
    outline: 3px solid rgba(255, 152, 0, 0.4) !important;
    outline-offset: 2px !important;
}

/* Optional: Add a subtle shine effect on hover */
.stat-card.expense-card:hover::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        to right,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.1) 50%,
        rgba(255, 255, 255, 0) 100%
    ) !important;
    transform: rotate(30deg);
    animation: shine 1.5s ease-out;
}

@keyframes shine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(30deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(30deg); }
}








/* ===== ULTRA-PREMIUM STAT CARD ANIMATIONS ===== */
.main-stats-grid .stat-card {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(255, 255, 255, 0.03) 50%, 
        var(--card-bg) 100%
    );
    border-radius: 12px;
    padding: 18px;
    border: 1px solid var(--border);
    transition: all 0.15s cubic-bezier(0.32, 0.94, 0.6, 1);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transform: translateY(0);
    backdrop-filter: blur(10px);
}

/* Premium gradient accents - subtle but elegant */
#totalIncomeCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(72, 187, 120, 0.04) 100%
    );
    border-left: 4px solid #48bb78;
}

#totalExpenseCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(245, 101, 101, 0.04) 100%
    );
    border-left: 4px solid #f56565;
}

#availableBalanceCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(66, 153, 225, 0.04) 100%
    );
    border-left: 4px solid #4299e1;
}

#monthlyBudgetCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(159, 122, 234, 0.04) 100%
    );
    border-left: 4px solid #9f7aea;
}

#savingsGoalCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(56, 178, 172, 0.04) 100%
    );
    border-left: 4px solid #38b2ac;
}


/* Subtle glow effect on hover */
.main-stats-grid .stat-card:hover::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 12px;
    box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.1);
    pointer-events: none;
}

/* Premium reveal animation - smooth and elegant */
.main-stats-grid .stat-card.revealed {
    animation: premiumReveal 0.8s cubic-bezier(0.19, 1, 0.22, 1);
}

@keyframes premiumReveal {
    0% {
        transform: scale(0.98);
        opacity: 0.9;
    }
    50% {
        transform: scale(1.02);
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Premium press effect */
.main-stats-grid .stat-card:active {
    transform: scale(0.99) translateY(1px);
    transition: transform 0.08s cubic-bezier(0.32, 0.94, 0.6, 1);
}

/* Premium value reveal */
.main-stats-grid .stat-value.revealed {
    animation: valueRevealPremium 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes valueRevealPremium {
    0% {
        opacity: 0;
        transform: translateY(8px);
        filter: blur(2px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
        filter: blur(0);
    }
}

/* Premium hidden state */
.main-stats-grid .stat-value.hidden {
    color: transparent;
    text-shadow: 0 0 6px rgba(0, 0, 0, 0.15);
    position: relative;
    background: none;
    -webkit-background-clip: initial;
    -webkit-text-fill-color: initial;
}

.main-stats-grid .stat-value.hidden::after {
    content: 'Tap to reveal';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--primary);
    font-size: 0.7rem;
    font-weight: 600;
    background: rgba(255, 152, 0, 0.06);
    padding: 4px 10px;
    border-radius: 4px;
    white-space: nowrap;
    border: 1px solid rgba(255, 152, 0, 0.1);
    opacity: 0.9;
}

/* Enhanced stat labels */
.main-stats-grid .stat-label {
    color: var(--text-secondary);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    margin-bottom: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s ease;
}

.main-stats-grid .stat-card:hover .stat-label {
    color: var(--primary);
    transform: translateX(1px);
}

/* Premium stat values - clear and elegant */
.main-stats-grid .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 10px 0;
    font-family: 'SF Mono', 'Courier New', monospace;
    letter-spacing: -0.3px;
    line-height: 1.2;
    transition: all 0.15s ease;
}

/* Premium color palette */
#totalIncomeValue {
    color: #2d7d46;
}

#totalExpenseValue {
    color: #c62828;
}

#availableBalanceValue {
    color: #1a56db;
}

#monthlyBudgetValue {
    color: #7e3af2;
}

#savingsGoalValue {
    color: #0e9f6e;
}

/* Enhanced stat change */
.main-stats-grid .stat-change {
    font-size: 0.65rem;
    color: var(--text-secondary);
    margin-top: 6px;
    font-weight: 500;
    opacity: 0.8;
    transition: all 0.15s ease;
}

.main-stats-grid .stat-card:hover .stat-change {
    opacity: 1;
    transform: translateX(1px);
}

/* Premium entrance animation */
@keyframes premiumEntrance {
    from {
        opacity: 0;
        transform: translateY(20px) rotateX(-5deg);
    }
    to {
        opacity: 1;
        transform: translateY(0) rotateX(0);
    }
}

.main-stats-grid .stat-card {
    animation: premiumEntrance 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    opacity: 0;
    transform-origin: center bottom;
}

/* Stagger with proper timing */
.main-stats-grid .stat-card:nth-child(1) { animation-delay: 0.05s; }
.main-stats-grid .stat-card:nth-child(2) { animation-delay: 0.1s; }
.main-stats-grid .stat-card:nth-child(3) { animation-delay: 0.15s; }
.main-stats-grid .stat-card:nth-child(4) { animation-delay: 0.2s; }
.main-stats-grid .stat-card:nth-child(5) { animation-delay: 0.25s; }

/* Update animation */
@keyframes valueUpdate {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
    100% {
        transform: scale(1);
    }
}

.main-stats-grid .stat-value.updated {
    animation: valueUpdate 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}


/* ===== DARK MODE PREMIUM ADJUSTMENTS ===== */
body.dark-mode .main-stats-grid .stat-card {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(255, 255, 255, 0.02) 50%, 
        var(--card-bg) 100%
    );
    backdrop-filter: blur(20px);
}

body.dark-mode #totalIncomeCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(72, 187, 120, 0.08) 100%
    );
}

body.dark-mode #totalExpenseCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(245, 101, 101, 0.08) 100%
    );
}

body.dark-mode #availableBalanceCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(66, 153, 225, 0.08) 100%
    );
}

body.dark-mode #monthlyBudgetCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(159, 122, 234, 0.08) 100%
    );
}

body.dark-mode #savingsGoalCard {
    background: linear-gradient(135deg, 
        var(--card-bg) 0%, 
        rgba(56, 178, 172, 0.08) 100%
    );
}

body.dark-mode .main-stats-grid .stat-card:hover::before {
    box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.05);
}


/* Dark mode text colors */
body.dark-mode #totalIncomeValue {
    color: #81c784;
}

body.dark-mode #totalExpenseValue {
    color: #ef9a9a;
}

body.dark-mode #availableBalanceValue {
    color: #90caf9;
}

body.dark-mode #monthlyBudgetValue {
    color: #b39ddb;
}

body.dark-mode #savingsGoalValue {
    color: #80cbc4;
}

body.dark-mode .main-stats-grid .stat-value.hidden::after {
    background: rgba(255, 183, 77, 0.1);
    border-color: rgba(255, 183, 77, 0.2);
    color: #ffb74d;
}

/* ===== MOBILE OPTIMIZATIONS ===== */
@media (max-width: 768px) {
    .main-stats-grid .stat-card {
        padding: 16px;
        backdrop-filter: blur(5px);
    }
    
    .main-stats-grid .stat-value {
        font-size: 1.3rem;
    }
    
    .main-stats-grid .stat-card:hover {
        transform: translateY(-2px) scale(1.005);
    }
    
    .income-item {
        padding: 8px 10px;
    }
    
    .income-item .income-amount {
        font-size: 0.85rem;
        min-width: 80px;
    }
    
    .income-item .action-btn {
        width: 26px;
        height: 26px;
    }
}

@media (max-width: 480px) {
    .main-stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .main-stats-grid .stat-card {
        padding: 14px;
    }
    
    .main-stats-grid .stat-value {
        font-size: 1.2rem;
    }
    
    .income-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .income-item .item-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .income-item .income-amount {
        width: 100%;
        text-align: left;
        min-width: auto;
    }
}

/* ===== PERFORMANCE OPTIMIZATIONS ===== */
@media (prefers-reduced-motion: reduce) {
    .main-stats-grid .stat-card,
    .main-stats-grid .stat-value,
    .income-item,
    .income-item .action-btn {
        animation: none !important;
        transition: none !important;
    }
    
    .main-stats-grid .stat-card {
        transform: none !important;
        opacity: 1 !important;
    }
    
    .income-item:hover {
        transform: none !important;
    }
}

/* ===== ADDITIONAL PREMIUM EFFECTS ===== */
/* Subtlet shine on stat cards */
.main-stats-grid .stat-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.3), 
        transparent
    );
    border-radius: 12px 12px 0 0;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.main-stats-grid .stat-card:hover::after {
    opacity: 1;
}

/* Enhanced focus states for accessibility */
.main-stats-grid .stat-card:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
    transform: translateY(-2px);
}

.income-item:focus-within {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Loading shimmer effect for empty states */
.stat-card.loading {
    position: relative;
    overflow: hidden;
}

.stat-card.loading::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.1), 
        transparent
    );
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% {
        left: -100%;
    }
    100% {
        left: 100%;
    }
}

/* Enhanced border animation on hover */
.main-stats-grid .stat-card {
    border-image: linear-gradient(
        var(--border),
        var(--border),
        var(--border),
        var(--border)
    ) 1;
    transition: border-image 0.3s ease;
}

.main-stats-grid .stat-card:hover {
    border-image: linear-gradient(
        var(--primary),
        rgba(255, 152, 0, 0.3),
        rgba(255, 152, 0, 0.1),
        var(--primary)
    ) 1;
}



.income-item .item-content {
  flex: 1;
  width: auto;
  min-width: 0;
  overflow: hidden;
}

  
  .income-item .income-amount {
  font-weight: 700;
  font-size: 0.95rem;
  font-family: 'SF Mono', 'Courier New', monospace;
  background: var(--gradient-income);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: right;
  margin: 0;
  padding: 0;
  white-space: nowrap;
  flex-shrink: 0;
  overflow: hidden;
}

.income-item .item-actions {
  display: flex;
  gap: 4px;
  margin: 0;
  padding: 0;
  justify-content: flex-start;
  width: auto;
  flex-shrink: 0;
}
  
  
  .income-item .category-badge {
  max-width: 80%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 6px;
  font-size: 0.65rem;
  margin-right: 4px;
  margin-bottom: 0;
}

.income-item strong {
  font-size: 0.85rem;
  color: var(--primary-dark);
  margin-bottom: 2px;
  display: block;
}

.income-item .item-content div {
  font-size: 0.75rem;
  line-height: 1.2;
  margin-top: 1px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
  
  



  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
















  
  
  
  

  
  .income-item .category-badge {
  max-width: 80%; /* Limit badge width to prevent overflow */
  white-space: nowrap; /* Prevent text wrapping */
  overflow: hidden; /* Hide overflow */
  text-overflow: ellipsis; /* Add ... for long text */
  display: inline-flex; /* Ensure it's flexible */
  align-items: center;
  gap: 4px;
  padding: 2px 6px; /* Slightly smaller padding */
  font-size: 0.65rem;
  margin-right: 4px;
  margin-bottom: 0;
}
  

  
  
  
  

/* ===== FIX PAYMENT REMINDERS FILTER ===== */
#filterReminderStatus {
  width: 100% !important;
  padding: 10px 12px !important;
  border-radius: 8px !important;
  border: 1px solid var(--border) !important;
  background: var(--input-bg) !important;
  color: var(--text-color) !important;
  font-size: 14px !important;
  cursor: pointer !important;
  -webkit-appearance: none !important;
  appearance: none !important;
  min-height: 44px !important;
  box-sizing: border-box !important;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23ff9800' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
  background-repeat: no-repeat !important;
  background-position: right 12px center !important;
  background-size: 12px !important;
  padding-right: 35px !important;
}

#filterReminderStatus:focus {
  outline: none !important;
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1) !important;
}

#filterReminderStatus option {
  padding: 10px !important;
  background: var(--input-bg) !important;
  color: var(--text-color) !important;
}

/* ===== REDUCE HEADER BANNER SIZE ===== */
.header {
  padding: 12px 16px !important;
  min-height: auto !important;
}

.header-top {
  margin-bottom: 6px !important;
  gap: 8px !important;
}

.header h1 {
  font-size: 1.4rem !important;
  gap: 8px !important;
  margin: 0 !important;
}

.header h1 i {
  padding: 6px !important;
  font-size: 1rem !important;
  border-radius: 8px !important;
}

.header p {
  font-size: 0.8rem !important;
  line-height: 1.2 !important;
  margin: 0 !important;
  opacity: 0.9 !important;
}

.status-indicator {
  padding: 4px 8px !important;
  font-size: 0.7rem !important;
}

.user-profile {
  padding: 4px 8px !important;
  font-size: 0.8rem !important;
}

.user-avatar {
  width: 24px !important;
  height: 24px !important;
  font-size: 0.8rem !important;
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .header {
    padding: 10px 12px !important;
  }
  
  .header h1 {
    font-size: 1.2rem !important;
  }
  
  .header h1 i {
    padding: 4px !important;
    font-size: 0.9rem !important;
  }
  
  .header p {
    font-size: 0.75rem !important;
  }


 
}





  
  
  
  
  
  
  
  
  
  
  
* ===== FORCE CONSISTENT INCOME ITEM STYLE ===== */
.income-item {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  padding: 4px 6px !important;
  border-bottom: 1px solid var(--border) !important;
  transition: all 0.4s !important;
  border-radius: 4px !important;
  margin-bottom: 1px !important;
  background: var(--light) !important;
  gap: 6px !important;
  min-height: 40px !important;
  position: relative !important;
  overflow: hidden;
}

.income-item .item-content {
  flex: 1 !important;
  width: auto !important;
  min-width: 0 !important;
  overflow: hidden;
}  
  
  
  
  .income-item .income-amount {
  font-weight: 700 !important;
  font-size: 0.95rem !important;
  font-family: 'SF Mono', 'Courier New', monospace !important;
  background: var(--gradient-income) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  text-align: right !important;
  margin: 0 !important;
  padding: 0 !important;
  white-space: nowrap !important;
  flex-shrink: 0 !important;
  overflow: hidden;
}

.income-item .item-actions {
  display: flex !important;
  gap: 4px !important;
  margin: 0 !important;
  padding: 0 !important;
  justify-content: flex-start !important;
  width: auto !important;
  flex-shrink: 0 !important;
  overflow: hidden;
}



  .income-item .category-badge {
  max-width: 80%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 6px;
  font-size: 0.65rem;
  margin-right: 4px;
  margin-bottom: 0;
}

.income-item strong {
  font-size: 0.85rem !important;
  color: var(--primary-dark) !important;
  margin-bottom: 2px !important;
  display: block !important;
}

.income-item .item-content div {
  font-size: 0.75rem !important;
  line-height: 1.2 !important;
  margin-top: 1px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

  
  
  
  
  
 








/* Rental-specific form styling */
.rental-fields-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 10px;
    padding: 15px;
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.05), rgba(245, 124, 0, 0.05));
    border-radius: 10px;
    border: 1px solid rgba(255, 152, 0, 0.2);
}

.rental-field-group {
    display: flex;
    flex-direction: column;
}

.rental-field-group label {
    color: var(--primary-dark);
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 6px;
}

.rental-field-group input,
.rental-field-group select {
    padding: 10px;
    border: 2px solid rgba(255, 152, 0, 0.3);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
    transition: all 0.3s;
}

.rental-field-group input:focus,
.rental-field-group select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
}

/* Rental balance amount input styling */
#rentalBalanceAmount {
    margin-top: 8px;
}

/* Rental income badge */
.source-rental-income {
    background: linear-gradient(135deg, #ff9800, #f57c00) !important;
    color: white !important;
    border: 1px solid rgba(255, 152, 0, 0.3);
}

/* Rental balance display in income items */
.rental-balance-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    background: linear-gradient(135deg, #ffeb3b, #ffc107);
    color: #333;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 600;
    margin-left: 8px;
}

/* Rental end date display */
.rental-end-date {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    background: rgba(255, 152, 0, 0.1);
    color: var(--primary-dark);
    border-radius: 4px;
    font-size: 0.65rem;
    margin-left: 8px;
}

/* Report styling for rental balances */
.rental-balance-section {
    margin-top: 15px;
    padding: 12px;
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.05), rgba(245, 124, 0, 0.05));
    border-radius: 8px;
    border: 1px solid rgba(255, 152, 0, 0.2);
}

.rental-balance-header {
    color: var(--primary-dark);
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.rental-balance-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255, 152, 0, 0.1);
}

.rental-balance-item:last-child {
    border-bottom: none;
}

.rental-balance-month {
    color: var(--text-color);
    font-size: 0.8rem;
}

.rental-balance-amount {
    color: var(--warning);
    font-weight: 600;
    font-size: 0.85rem;
    font-family: 'SF Mono', 'Courier New', monospace;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
    .rental-fields-container {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .rental-balance-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
}





























 
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  




	
  </style>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- Authentication Page -->
  <div class="auth-overlay" id="authPage">
    <div class="auth-container">
      <!-- Left Panel with branding and features -->
      <div class="auth-left-panel">
        <div class="auth-left-content">
          <h1>Financial Tracker PRO</h1>
          <p class="tagline">Your Life,Your Money, in Harmony  Live Fully, Finance Wisely.</p>
          <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 20px; font-size: 0.95rem;">
            Financial Tracker PRO helps you create balance and meaning by bringing all aspects of your financial life together in one beautiful, intuitive platform.
          </p>
          
          <ul class="features-list">
            <li><i class="fas fa-check"></i> Track expenses and income</li>
            <li><i class="fas fa-check"></i> Nurture your financial growth</li>
            <li><i class="fas fa-check"></i> Strengthen your savings goals</li>
            <li><i class="fas fa-check"></i> Visualize your financial balance</li>
            <li><i class="fas fa-check"></i> Personalized financial insights</li>
          </ul>
          
          <p class="auth-footer-text">
            Secure multi-user platform  Real-time sync  Bank-level encryption
          </p>
        </div>
        
        <!-- Theme Toggle -->
        <div class="auth-theme-toggle" onclick="toggleTheme()">
          <span id="themeLabel">Light Mode</span>
          <label class="theme-switch">
            <input type="checkbox" id="themeToggle">
            <span class="theme-slider"></span>
          </label>
        </div>
      </div>
      
      <!-- Right Panel with login/signup forms -->
      <div class="auth-right-panel">
        <div class="auth-right-content">
          <div class="auth-welcome">
            <h2>Welcome Back</h2>
            <p>Sign in to your financial dashboard</p>
          </div>
          
          <div class="auth-tabs">
            <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
            <button class="auth-tab" onclick="showAuthTab('signup')">Sign Up</button>
          </div>
          
          <!-- Login Form -->
          <div class="auth-form active" id="loginForm">
            <div class="auth-input-group">
              <label for="loginEmail">Email Address</label>
              <input type="email" id="loginEmail" placeholder="Enter your email" required>
            </div>
            
            <div class="auth-input-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" placeholder="Enter your password" required>
            </div>
            
            <button class="auth-btn" id="loginBtn">
              <i class="fas fa-sign-in-alt"></i> Login to Dashboard
            </button>
            
            <div class="auth-divider">
              <span>or</span>
            </div>
            
            <button class="auth-btn google-btn" onclick="showMessage('Google login coming soon!', 'info')">
              <i class="fab fa-google"></i> Continue with Google
            </button>
            
            <div class="auth-error" id="loginError">
              <i class="fas fa-exclamation-circle"></i>
              <span>Invalid email or password. Please try again.</span>
            </div>
            
            <div class="auth-links">
              <a class="auth-link" onclick="showMessage('Password reset feature coming soon!', 'info')">Forgot your password?</a>
              <span style="color: var(--text-secondary);"></span>
              <a class="auth-link" onclick="showAuthTab('signup')">Don't have an account? Sign up here</a>
            </div>
          </div>
          
          <!-- Sign Up Form -->
          <div class="auth-form" id="signupForm">
            <div class="auth-input-group">
              <label for="signupName">Full Name</label>
              <input type="text" id="signupName" placeholder="Enter your full name" required>
            </div>
            
            <div class="auth-input-group">
              <label for="signupEmail">Email Address</label>
              <input type="email" id="signupEmail" placeholder="Enter your email" required>
            </div>
            
            <div class="auth-input-group">
              <label for="signupPassword">Password (min. 6 characters)</label>
              <input type="password" id="signupPassword" placeholder="Create a password" required minlength="6">
            </div>
            
            <div class="auth-input-group">
              <label for="signupConfirmPassword">Confirm Password</label>
              <input type="password" id="signupConfirmPassword" placeholder="Confirm your password" required>
            </div>
            
            <button class="auth-btn" id="signupBtn">
              <i class="fas fa-user-plus"></i> Create Account
            </button>
            
            <div class="auth-divider">
              <span>or</span>
            </div>
            
            <button class="auth-btn google-btn" onclick="showMessage('Google signup coming soon!', 'info')">
              <i class="fab fa-google"></i> Continue with Google
            </button>
            
            <div class="auth-error" id="signupError">
              <i class="fas fa-exclamation-circle"></i>
              <span>Please check your information and try again.</span>
            </div>
            
            <div class="auth-links">
              <a class="auth-link" onclick="showAuthTab('login')">Already have an account? Login here</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Application (hidden until login) -->
  <div class="container" id="mainApp">
    <div class="header">
      <div class="header-top">
        <h1><i class="fas fa-wallet"></i><span id="appTitle">Financial Tracker PRO</span></h1>
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end; width: 100%;">
          <div class="user-profile" id="userProfile">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-email" id="userEmail">user@example.com</div>
          </div>
          <div class="status-indicator" id="statusIndicator">
            <div class="status-dot connecting" id="statusDot"></div>
            <span id="statusText">Initializing...</span>
          </div>
          <div class="theme-toggle-header">
            <label class="theme-switch">
              <input type="checkbox" id="themeToggleHeader">
              <span class="theme-slider"></span>
            </label>
          </div>
        </div>
      </div>
      <p>Tap on balance cards to reveal amounts  Multi-user secure platform  Track, analyze, and visualize your finances</p>
    </div>

    <div class="dashboard">
      <div class="stats-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
          <h3><i class="fas fa-chart-line"></i> Quick Stats</h3>
          <div class="balance-controls" style="display: flex; gap: 8px;">
            <button class="btn btn-balance" onclick="revealAllBalances()"><i class="fas fa-eye"></i> Reveal All</button>
            <button class="btn btn-balance" onclick="hideAllBalances()"><i class="fas fa-eye-slash"></i> Hide All</button>
          </div>
        </div>
        
        <div class="main-stats-grid">
          <div class="stat-card" id="totalIncomeCard" onclick="toggleBalance('totalIncome')">
            <div class="stat-label"><span><i class="fas fa-arrow-alt-circle-up"></i> Total Income</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="totalIncomeValue">UGX 0</div>
            <div class="stat-change" style="color: var(--success); font-weight: 600;">Overall Total</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
          
          <div class="stat-card" id="totalExpenseCard" onclick="toggleBalance('totalExpense')">
            <div class="stat-label"><span><i class="fas fa-arrow-alt-circle-down"></i> Total Expenses</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="totalExpenseValue">UGX 0</div>
            <div class="stat-change" id="totalExpenseChange" style="color: var(--danger); font-weight: 600;">Overall Total</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
          
          <div class="stat-card" id="availableBalanceCard" onclick="toggleBalance('availableBalance')">
            <div class="stat-label"><span><i class="fas fa-balance-scale"></i> Available Balance</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="availableBalanceValue">UGX 0</div>
            <div class="stat-change" style="color: var(--primary); font-weight: 600;">Income - Expenses</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
          
          <!-- NEW: Monthly Budget Card -->
          <div class="stat-card" id="monthlyBudgetCard" onclick="toggleBalance('monthlyBudget')">
            <div class="stat-label"><span><i class="fas fa-chart-pie"></i> Monthly Budget</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="monthlyBudgetValue">UGX 0</div>
            <div class="stat-change" id="monthlyBudgetStatus" style="color: var(--budget-color); font-weight: 600;">Set a budget</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
          
          <!-- NEW: Savings Goal Card -->
          <div class="stat-card" id="savingsGoalCard" onclick="toggleBalance('savingsGoal')">
            <div class="stat-label"><span><i class="fas fa-bullseye"></i> Savings Goal</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="savingsGoalValue">UGX 0</div>
            <div class="stat-change" id="savingsGoalProgress" style="color: var(--success); font-weight: 600;">Set a goal</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
        </div>
        
        <h4 style="color: var(--primary); margin-bottom: 12px; margin-top: 20px; font-size: 1rem;"><i class="fas fa-calendar-day"></i> Expense Timeframes</h4>
        <div class="stats-grid">
          <div class="stat-card expense-card" id="todayCard" onclick="toggleBalance('today')">
            <div class="stat-label"><span><i class="fas fa-calendar-day"></i> Today</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="todayTotal">UGX 0</div>
            <div class="stat-change" id="todayChange">--</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
          <div class="stat-card expense-card" id="weekCard" onclick="toggleBalance('week')">
            <div class="stat-label"><span><i class="fas fa-calendar-week"></i> This Week</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="weekTotal">UGX 0</div>
            <div class="stat-change" id="weekChange">--</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
          <div class="stat-card expense-card" id="monthCard" onclick="toggleBalance('month')">
            <div class="stat-label"><span><i class="fas fa-calendar-alt"></i> This Month</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="monthTotal">UGX 0</div>
            <div class="stat-change" id="monthChange">--</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
          <div class="stat-card expense-card" id="yearCard" onclick="toggleBalance('year')">
            <div class="stat-label"><span><i class="fas fa-calendar"></i> This Year</span><i class="fas fa-hand-pointer"></i></div>
            <div class="stat-value hidden" id="yearTotal">UGX 0</div>
            <div class="stat-change" id="yearChange">--</div>
            <div class="stat-tooltip">Click to reveal/hide</div>
          </div>
        </div>
<button class="btn reveal-all-btn" onclick="toggleAllBalances()"><i class="fas fa-unlock"></i> Tap here to reveal all balances</button>
        <div class="charts-section">
          <div class="chart-container"><h4><i class="fas fa-chart-pie"></i> Category Distribution</h4><canvas id="pieChart"></canvas></div>
          <div class="chart-container"><h4><i class="fas fa-chart-bar"></i> Weekly Trend</h4><canvas id="barChart"></canvas></div>
        </div>

        <!-- === ADD VIEW CONTROLS HERE === -->
        <div style="text-align: center; margin: 20px 0; padding: 15px; background: var(--light); border-radius: 10px;">
          <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-filter"></i> View Controls</h4>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
            <button class="btn" onclick="showCurrentMonthItems()" style="background: var(--success); color: white;">
              <i class="fas fa-calendar-alt"></i> Show Current Month Only
            </button>
            <button class="btn" onclick="showAllItems('both')" style="background: var(--primary); color: white;">
              <i class="fas fa-list"></i> Show All Months
            </button>
            <button class="btn" onclick="showAllItems('expense')" style="background: var(--danger); color: white;">
              <i class="fas fa-receipt"></i> Show All Expenses
            </button>
            <button class="btn" onclick="showAllItems('income')" style="background: var(--info); color: white;">
              <i class="fas fa-money-bill-alt"></i> Show All Income
            </button>
          </div>
        </div>
        <!-- === END VIEW CONTROLS === -->
		
		
		
		        <!-- === FINANCIAL SNAPSHOT - CURRENT MONTH === -->
        <div style="margin: 25px 0 15px 0;">
          <h4 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-size: 1.1rem;">
            <i class="fas fa-chart-line"></i> Financial Snapshot - Current Month
          </h4>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px;">
            <!-- Current Month Income -->
            <div style="background: linear-gradient(135deg, rgba(67, 233, 123, 0.1), rgba(56, 249, 215, 0.1)); border: 1px solid rgba(67, 233, 123, 0.2); border-radius: 10px; padding: 15px; position: relative; overflow: hidden;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size: 0.75rem; color: var(--success); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Income</div>
                <div style="width: 30px; height: 30px; background: rgba(67, 233, 123, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--success);">
                  <i class="fas fa-arrow-up"></i>
                </div>
              </div>
              <div id="currentMonthIncome" style="font-size: 1.3rem; font-weight: 800; color: var(--success); font-family: 'SF Mono', 'Courier New', monospace;">UGX 0</div>
              <div style="font-size: 0.7rem; color: var(--gray); margin-top: 4px;">This month's total</div>
            </div>
            
            <!-- Current Month Expenses -->
            <div style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 168, 168, 0.1)); border: 1px solid rgba(255, 107, 107, 0.2); border-radius: 10px; padding: 15px; position: relative; overflow: hidden;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size: 0.75rem; color: var(--danger); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Expenses</div>
                <div style="width: 30px; height: 30px; background: rgba(255, 107, 107, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--danger);">
                  <i class="fas fa-arrow-down"></i>
                </div>
              </div>
              <div id="currentMonthExpenses" style="font-size: 1.3rem; font-weight: 800; color: var(--danger); font-family: 'SF Mono', 'Courier New', monospace;">UGX 0</div>
              <div style="font-size: 0.7rem; color: var(--gray); margin-top: 4px;">This month's total</div>
            </div>
            
            <!-- Net Balance -->
            <div style="background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(34, 211, 238, 0.1)); border: 1px solid rgba(66, 153, 225, 0.2); border-radius: 10px; padding: 15px; position: relative; overflow: hidden;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size: 0.75rem; color: var(--primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Net Balance</div>
                <div style="width: 30px; height: 30px; background: rgba(66, 153, 225, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                  <i class="fas fa-balance-scale"></i>
                </div>
              </div>
              <div id="currentMonthNet" style="font-size: 1.3rem; font-weight: 800; color: var(--primary); font-family: 'SF Mono', 'Courier New', monospace;">UGX 0</div>
              <div id="netStatus" style="font-size: 0.7rem; margin-top: 4px; font-weight: 600;">Calculating...</div>
            </div>
            
            <!-- Daily Average -->
            <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(245, 124, 0, 0.1)); border: 1px solid rgba(255, 152, 0, 0.2); border-radius: 10px; padding: 15px; position: relative; overflow: hidden;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size: 0.75rem; color: var(--warning); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Daily Average</div>
                <div style="width: 30px; height: 30px; background: rgba(255, 152, 0, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--warning);">
                  <i class="fas fa-calendar-day"></i>
                </div>
              </div>
              <div id="dailyAverage" style="font-size: 1.3rem; font-weight: 800; color: var(--warning); font-family: 'SF Mono', 'Courier New', monospace;">UGX 0</div>
              <div style="font-size: 0.7rem; color: var(--gray); margin-top: 4px;">Per day this month</div>
            </div>
          </div>
          
          <!-- Progress Bar for Month Progress -->
          <div style="background: var(--light); border-radius: 10px; padding: 15px; margin-top: 10px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <div style="font-size: 0.8rem; font-weight: 600; color: var(--primary);">Month Progress</div>
              <div id="monthProgressPercent" style="font-size: 0.8rem; font-weight: 600; color: var(--primary);">0%</div>
            </div>
            <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
              <div id="monthProgressBar" style="height: 100%; background: var(--gradient-1); border-radius: 4px; width: 0%; transition: width 0.5s ease;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
              <div style="font-size: 0.7rem; color: var(--gray);">Start of month</div>
              <div style="font-size: 0.7rem; color: var(--gray);" id="daysRemaining">0 days remaining</div>
            </div>
          </div>
        </div>
        <!-- === END FINANCIAL SNAPSHOT === -->
		
		
		
		
		
		        <!-- === SMART AI FINANCIAL ASSISTANT === -->
        <div style="margin: 25px 0; padding: 20px; background: linear-gradient(135deg, rgba(72, 52, 212, 0.08), rgba(108, 99, 255, 0.08)); border: 1px solid rgba(72, 52, 212, 0.2); border-radius: 12px; position: relative; overflow: hidden;">
          <!-- Background pattern -->
          <div style="position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: radial-gradient(circle, rgba(72, 52, 212, 0.1) 0%, transparent 70%); border-radius: 50%;"></div>
          
          <div style="position: relative; z-index: 2;">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #4834d4, #6c63ff); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                  <i class="fas fa-robot"></i>
                </div>
                <div>
                  <h4 style="color: #4834d4; margin: 0; font-size: 1.1rem; font-weight: 700;">Smart AI Assistant</h4>
                  <div style="font-size: 0.75rem; color: var(--gray);">Analyzing your financial patterns...</div>
                </div>
              </div>
              <div id="aiStatus" style="font-size: 0.7rem; padding: 4px 8px; background: rgba(72, 52, 212, 0.1); color: #4834d4; border-radius: 12px; font-weight: 600;">
                <i class="fas fa-circle" style="font-size: 0.5rem;"></i> Active
              </div>
            </div>
            
            <!-- AI Insights Container -->
            <div id="aiInsightsContainer" style="min-height: 120px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; padding: 15px; border: 1px solid rgba(72, 52, 212, 0.1); margin-bottom: 15px;">
              <div id="aiLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 120px;">
                <div class="spinner" style="width: 30px; height: 30px; border: 3px solid rgba(72, 52, 212, 0.2); border-top-color: #4834d4;"></div>
                <div style="margin-top: 10px; font-size: 0.85rem; color: var(--gray);">Analyzing your financial data...</div>
              </div>
              <div id="aiInsights" style="display: none;">
                <!-- AI insights will be inserted here -->
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
              <button onclick="analyzeSpendingPatterns()" style="padding: 10px; background: rgba(72, 52, 212, 0.1); border: 1px solid rgba(72, 52, 212, 0.2); border-radius: 8px; color: #4834d4; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i class="fas fa-chart-pie"></i> Analyze Patterns
              </button>
              <button onclick="getSavingsAdvice()" style="padding: 10px; background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.2); border-radius: 8px; color: #2ecc71; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i class="fas fa-piggy-bank"></i> Savings Tips
              </button>
              <button onclick="detectOverspending()" style="padding: 10px; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.2); border-radius: 8px; color: #e74c3c; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i class="fas fa-exclamation-triangle"></i> Check Overspending
              </button>
              <button onclick="generateFinancialReport()" style="padding: 10px; background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.2); border-radius: 8px; color: #3498db; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                <i class="fas fa-file-alt"></i> Generate Report
              </button>
            </div>
          </div>
        </div>
        <!-- === END SMART AI ASSISTANT === -->
		
		
		

      </div> <!-- This closes the stats-section div -->
	  
	  










	
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	  
	

      <div class="forms-wrapper">
        <div class="form-section" id="expenseFormSection">
          <div class="form-header" onclick="toggleForm('expenseFormSection')">
            <h3 class="form-title" id="expenseFormTitle"><i class="fas fa-plus-circle"></i> Add New Expense</h3>
            <i class="fas fa-chevron-up toggle-icon"></i>
          </div>
          <div class="form-body">
            <div class="form-grid">
              <div class="form-group">
                <label><i class="fas fa-money-bill-wave"></i> Amount (UGX)</label>
                <input type="number" id="amount" placeholder="e.g. 50000" min="0" step="100" required>
              </div>
              <div class="form-group">
                <label><i class="fas fa-tags"></i> Category</label>
                <select id="category" required>
                  <!-- RESTORED FULL CATEGORY LIST -->
                <option value="Yaka"> Yaka (Electricity)</option>
                  <option value="Water"> Water Bill</option>
                  <option value="Groceries" selected> Groceries</option>
                  <option value="Food"> Food & Dining</option>
                  <option value="Fuel"> Fuel</option>
                  <option value="Transport"> Transport</option>
                  <option value="Internet"> Internet</option>
                  <option value="Airtime"> Airtime</option>
                  <option value="Rent"> Rent</option>
                  <option value="Laundry"> Laundry</option>
                  <option value="Clothing"> Clothing</option>
                  <option value="School Fees"> School Fees</option>
                  <option value="Medical"> Medical</option>
                  <option value="Savings"> Savings</option>
                  <option value="Debt"> Debt Repayment</option>
                  <option value="Giving"> Giving/Donations</option>
                  <option value="Entertainment"> Entertainment</option>
                  <option value="General"> General</option>
                  <option value="Mortgage"> Mortgage</option>
                  <option value="Insurance"> Insurance</option>
                  <option value="Taxes"> Taxes</option>
                  <option value="Home Maintenance"> Home Maintenance</option>
                  <option value="Car Payment"> Car Payment</option>
				  <option value="Car Repair"> Car Repair</option>
                  <option value="Health Insurance"> Health Insurance</option>
                  <option value="Gym Membership"> Gym Membership</option>
                  <option value="Streaming Services"> Streaming Services</option>
                  <option value="Mobile Data"> Mobile Data</option>
                  <option value="Household Supplies"> Household Supplies</option>
                  <option value="Personal Care"> Personal Care</option>
                  <option value="Childcare"> Childcare</option>
                  <option value="Education"> Education</option>
                  <option value="Gifts"> Gifts</option>
                  <option value="Donations"> Donations</option>
                  <option value="Travel"> Travel</option>
                  <option value="Vacation"> Vacation</option>
                  <option value="Hobbies"> Hobbies</option>
                  <option value="Subscriptions"> Subscriptions</option>
                  <option value="Bank Fees"> Bank Fees</option>
                  <option value="Business Expenses"> Business Expenses</option>
                  <option value="Office Supplies"> Office Supplies</option>
                  <option value="Pet Care"> Pet Care</option>
                  <option value="Electronics"> Electronics</option>
                  <option value="Software"> Software</option>
                  <option value="Books"> Books</option>
                  <option value="Alcohol"> Alcohol</option>
                  <option value="Fast Food"> Fast Food</option>
                  <option value="Coffee"> Coffee</option>
                  <option value="Restaurants"> Restaurants</option>
                  <option value="Parking"> Parking</option>
                  <option value="Public Transport"> Public Transport</option>
                  <option value="Taxi"> Taxi</option>
                  <option value="Hotel"> Hotel</option>
                  <option value="Sports"> Sports</option>
                  <option value="Fitness"> Fitness</option>
                  <option value="Music"> Music</option>
                  <option value="Movies"> Movies</option>
                  <option value="Concerts"> Concerts</option>
                  <option value="Museums"> Museums</option>
                  <option value="Amusement Parks"> Amusement Parks</option>
                  <option value="Events"> Events</option>
                  <option value="Parties"> Parties</option>
                  <option value="Wedding"> Wedding</option>
                  <option value="Medical Bills"> Medical Bills</option>
                  <option value="Dental"> Dental</option>
                  <option value="Vision"> Vision</option>
                  <option value="Pharmacy"> Pharmacy</option>
                  <option value="Therapy"> Therapy</option>
                  <option value="Massage"> Massage</option>
                  <option value="Spa"> Spa</option>
                  <option value="Salon"> Salon</option>
                  <option value="Barber"> Barber</option>
                  <option value="Cosmetics"> Cosmetics</option>
                  <option value="Skincare"> Skincare</option>
                  <option value="Haircare"> Haircare</option>
                  <option value="Fragrances"> Fragrances</option>
                  <option value="Utilities"> Utilities</option>
                  <option value="Allowances"> Allowances</option>
				   <option value="Azzaro"> Azzaro Expenses</option>
                  <option value="Other"> Other</option>
                </select>
              </div>
              <div class="form-group">
                <label><i class="fas fa-calendar"></i> Date</label>
                <input type="date" id="date" required>
              </div>
              <div class="form-group">
                <label><i class="fas fa-sticky-note"></i> Description</label>
                <input type="text" id="description" placeholder="What was this expense for?">
              </div>
            </div>
            <div class="btn-actions-container">
              <button class="btn btn-primary" id="addBtn" type="button" disabled><i class="fas fa-plus"></i> Add Expense</button>
              <button class="btn btn-cancel" id="cancelExpenseBtn" style="display: none;"><i class="fas fa-times"></i> Cancel Edit</button>
            </div>
          </div>
        </div>
        
<!-- Income Form Section -->
<div class="form-section income-form-section" id="incomeFormSection">
  <div class="form-header" onclick="toggleForm('incomeFormSection')">
    <h3 class="form-title" id="incomeFormTitle"><i class="fas fa-money-bill-alt"></i> Add New Income</h3>
    <i class="fas fa-chevron-up toggle-icon"></i>
  </div>
  <div class="form-body">
    <div class="form-grid">
      <div class="form-group">
        <label><i class="fas fa-money-bill-wave"></i> Amount (UGX)</label>
        <input type="number" id="incomeAmount" placeholder="e.g. 1000000" min="0" step="100" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-briefcase"></i> Source</label>
        <select id="incomeSource" required onchange="toggleRentalFields()">
          <!-- RESTORED FULL INCOME SOURCES -->
          <option value="Salary" selected> Salary</option>
          <option value="Freelance"> Freelance/Side-Hustle</option>
          <option value="Investment"> Investment/Dividends</option>
          <option value="Business"> Business</option>
          <option value="Gift"> Gift</option>
          <option value="Rental Income"> Rental Income</option>
          <option value="Bonus"> Bonus</option>
          <option value="Commission"> Commission</option>
          <option value="Allowances"> Allowances</option>
          <option value="Dividends"> Dividends</option>
          <option value="Interest"> Interest Income</option>
          <option value="Royalties"> Royalties</option>
          <option value="Pension"> Pension</option>
          <option value="Social Security"> Social Security</option>
          <option value="Child Support"> Child Support</option>
          <option value="Alimony"> Alimony</option>
          <option value="Scholarship"> Scholarship</option>
          <option value="Grant"> Grant</option>
          <option value="Rebate"> Rebate</option>
          <option value="Refund"> Refund</option>
          <option value="Lottery"> Lottery/Winnings</option>
          <option value="Inheritance"> Inheritance</option>
          <option value="Sale"> Sale of Items</option>
          <option value="Other"> Other</option>
        </select>
      </div>
      <div class="form-group">
        <label><i class="fas fa-calendar"></i> Date Received</label>
        <input type="date" id="incomeDate" required onchange="updateRentalEndDate()">
      </div>
      
      <!-- Rental-specific fields - hidden by default -->
      <div class="form-group" id="rentalEndDateGroup" style="display: none;">
        <label><i class="fas fa-calendar-times"></i> Rent End Date (30 days)</label>
        <input type="date" id="rentalEndDate" placeholder="End date of rental period">
      </div>
      
      <div class="form-group" id="rentalBalanceGroup" style="display: none;">
        <label><i class="fas fa-balance-scale"></i> Rent Balance</label>
        <select id="rentalBalance" onchange="toggleRentalBalanceInput()">
          <option value="NIL">NIL</option>
          <option value="Custom">Input Balance Amount</option>
        </select>
        <input type="number" id="rentalBalanceAmount" 
               placeholder="Enter balance amount" 
               style="display: none; margin-top: 8px;"
               min="0" step="100">
      </div>
      
      <div class="form-group">
        <label><i class="fas fa-sticky-note"></i> Notes</label>
        <input type="text" id="incomeNotes" placeholder="Source details or month">
      </div>
    </div>
    <div class="btn-actions-container">
      <button class="btn btn-success" id="addIncomeBtn" type="button" disabled><i class="fas fa-arrow-alt-circle-up"></i> Record Income</button>
      <button class="btn btn-cancel" id="cancelIncomeBtn" style="display: none;"><i class="fas fa-times"></i> Cancel Edit</button>
    </div>
  </div>
</div>
        
        <!-- NEW: Budget Form Section -->
        <div class="form-section budget-form-section" id="budgetFormSection">
          <div class="form-header" onclick="toggleForm('budgetFormSection')">
            <h3 class="form-title" id="budgetFormTitle"><i class="fas fa-chart-pie"></i> Set Monthly Budget</h3>
            <i class="fas fa-chevron-up toggle-icon"></i>
          </div>
          <div class="form-body">
            <div class="form-grid">
              <div class="form-group">
                <label><i class="fas fa-money-bill-wave"></i> Budget Amount (UGX)</label>
                <input type="number" id="budgetAmount" placeholder="e.g. 500000" min="0" step="1000" required>
              </div>
              <div class="form-group">
                <label><i class="fas fa-calendar"></i> Month</label>
                <input type="month" id="budgetMonth" required>
              </div>
              <div class="form-group">
                <label><i class="fas fa-tags"></i> Category (Optional)</label>
                <select id="budgetCategory">
                  <option value="">All Categories</option>
                  <option value="Groceries"> Groceries</option>
                  <option value="Food"> Food & Dining</option>
                  <option value="Transport"> Transport</option>
                  <option value="Entertainment"> Entertainment</option>
                  <option value="Utilities"> Utilities</option>
                  <option value="Rent"> Rent</option>
                  <option value="Shopping"> Shopping</option>
                  <option value="Travel"> Travel</option>
				  <option value="Azzaro"> Azzaro Expenses</option>
				  <option value="Household Supplies"> Household Supplies</option>
				  <option value="Car Payment"> Car Payment</option>
				  <option value="Laundry"> Laundry</option>
                  <option value="Clothing"> Clothing</option>
                  <option value="School Fees"> School Fees</option>
                  <option value="Medical"> Medical</option>
                  <option value="Savings"> Savings</option>
                  <option value="Debt"> Debt Repayment</option>
				  <option value="Electronics"> Electronics</option>
                  <option value="Software"> Software</option>
                  <option value="Books"> Books</option>
                  <option value="Alcohol"> Alcohol</option>
                  <option value="Fast Food"> Fast Food</option>
                  <option value="Coffee"> Coffee</option>
                  <option value="Restaurants"> Restaurants</option>
                  <option value="Parking"> Parking</option>
                  <option value="Public Transport"> Public Transport</option>
                  <option value="Taxi"> Taxi</option>
                  <option value="Hotel"> Hotel</option>
                  <option value="Sports"> Sports</option>
                  <option value="Fitness"> Fitness</option>
                  <option value="Music"> Music</option>
                  <option value="Movies"> Movies</option>
                  <option value="Concerts"> Concerts</option>
                  <option value="Museums"> Museums</option>
                  <option value="Amusement Parks"> Amusement Parks</option>
                  <option value="Events"> Events</option>
                  <option value="Parties"> Parties</option>
                  <option value="Wedding"> Wedding</option>
                  <option value="Medical Bills"> Medical Bills</option>
                  <option value="Dental"> Dental</option>
                  <option value="Vision"> Vision</option>
                  <option value="Pharmacy"> Pharmacy</option>
                  <option value="Therapy"> Therapy</option>
                  <option value="Massage"> Massage</option>
                  <option value="Spa"> Spa</option>
                  <option value="Salon"> Salon</option>
                  <option value="Barber"> Barber</option>
                  <option value="Cosmetics"> Cosmetics</option>
                  <option value="Skincare"> Skincare</option>
                  <option value="Haircare"> Haircare</option>
                  <option value="Fragrances"> Fragrances</option>
                  <option value="Utilities"> Utilities</option>
				  <option value="Other"> Other</option>
                </select>
              </div>
              <div class="form-group">
                <label><i class="fas fa-sticky-note"></i> Notes</label>
                <input type="text" id="budgetNotes" placeholder="Budget description">
              </div>
            </div>
            <div class="btn-actions-container">
              <button class="btn btn-budget" id="addBudgetBtn" type="button" disabled><i class="fas fa-plus"></i> Set Budget</button>
              <button class="btn btn-cancel" id="cancelBudgetBtn" style="display: none;"><i class="fas fa-times"></i> Cancel Edit</button>
            </div>
          </div>
        </div>
        
        <!-- NEW: Reminder Form Section -->
        <div class="form-section" id="reminderFormSection">
          <div class="form-header" onclick="toggleForm('reminderFormSection')">
            <h3 class="form-title" id="reminderFormTitle"><i class="fas fa-bell"></i> Add Payment Reminder</h3>
            <i class="fas fa-chevron-up toggle-icon"></i>
          </div>
          <div class="form-body">
            <div class="form-grid">
              <div class="form-group">
                <label><i class="fas fa-sticky-note"></i> Title</label>
                <input type="text" id="reminderTitle" placeholder="e.g. Rent Payment" required>
              </div>
              <div class="form-group">
                <label><i class="fas fa-money-bill-wave"></i> Amount (UGX)</label>
                <input type="number" id="reminderAmount" placeholder="e.g. 300000" min="0" step="1000" required>
              </div>
              <div class="form-group">
                <label><i class="fas fa-calendar"></i> Due Date</label>
                <input type="date" id="reminderDueDate" required>
              </div>
              <div class="form-group">
                <label><i class="fas fa-tags"></i> Category</label>
                <select id="reminderCategory">
                  <option value="Rent"> Rent</option>
                  <option value="Utilities"> Utilities</option>
                  <option value="Loan"> Loan Payment</option>
                  <option value="Subscription"> Subscription</option>
                  <option value="Insurance"> Insurance</option>
                  <option value="Other"> Other</option>
                </select>
              </div>
            </div>
            <div class="btn-actions-container">
              <button class="btn btn-primary" id="addReminderBtn" type="button" disabled><i class="fas fa-bell"></i> Add Reminder</button>
              <button class="btn btn-cancel" id="cancelReminderBtn" style="display: none;"><i class="fas fa-times"></i> Cancel Edit</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="statusMessage" class="message"></div>

    <div class="content">
      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="quick-action-btn" onclick="showQuickAddExpense()">
          <i class="fas fa-bolt"></i> <span>Quick Expense</span>
        </button>
        <button class="quick-action-btn" onclick="showQuickAddIncome()">
          <i class="fas fa-money-bill-wave"></i> <span>Quick Income</span>
        </button>
        <button class="quick-action-btn" onclick="exportAllData()">
          <i class="fas fa-file-export"></i> <span>Export All Data</span>
        </button>
        <button class="quick-action-btn" onclick="showSavingsCalculator()">
          <i class="fas fa-calculator"></i> <span>Savings Calculator</span>
        </button>
        <button class="quick-action-btn" onclick="showYearlyOverview()">
          <i class="fas fa-chart-bar"></i> <span>Yearly Overview</span>
        </button>
        <button class="quick-action-btn" onclick="showDebtTracker()">
          <i class="fas fa-credit-card"></i> <span>Debt Tracker</span>
        </button>
        <button class="quick-action-btn" onclick="showCategoryReportModal('expense')">
          <i class="fas fa-filter"></i> <span>Category Report</span>
        </button>
        <button class="quick-action-btn" onclick="showCategoryReportModal('income')">
          <i class="fas fa-filter"></i> <span>Source Report</span>
        </button>
      </div>

      <div class="report-section" id="expenseReportSection">
        <h3 class="form-title" style="color: var(--danger);"><i class="fas fa-chart-bar"></i> <span id="expenseReportTitle">Expense Reports</span></h3>
        <div class="report-controls" id="expenseReportControls">
          <button class="btn btn-report active" onclick="generateReport('today', 'expense', this)"><i class="fas fa-calendar-day"></i> <span>Today</span></button>
          <button class="btn btn-report" onclick="generateReport('yesterday', 'expense', this)"><i class="fas fa-calendar-minus"></i> <span>Yesterday</span></button>
          <button class="btn btn-report" onclick="generateReport('week', 'expense', this)"><i class="fas fa-calendar-week"></i> <span>This Week</span></button>
          <button class="btn btn-report" onclick="generateReport('month', 'expense', this)"><i class="fas fa-calendar-alt"></i> <span>This Month</span></button>
          <button class="btn btn-report" onclick="generateReport('lastMonth', 'expense', this)"><i class="fas fa-calendar-alt"></i> <span>Last Month</span></button>
          <button class="btn btn-report" onclick="generateReport('year', 'expense', this)"><i class="fas fa-calendar"></i> <span>This Year</span></button>
          <button class="btn btn-report" onclick="showCustomRange('expense', this)"><i class="fas fa-calendar-range"></i> <span>Custom Range</span></button>
          <button class="btn btn-report" onclick="showCategoryReportModal('expense')"><i class="fas fa-filter"></i> <span>By Category</span></button>
        </div>

        <div class="report-period" id="expenseCustomRange" style="display: none;">
          <div><label>From Date</label><input type="date" id="expenseFromDate"></div>
          <div><label>To Date</label><input type="date" id="expenseToDate"></div>
          <div style="align-self: flex-end;"><button class="btn btn-danger" onclick="generateCustomReport('expense')"><i class="fas fa-play"></i> Generate</button></div>
        </div>

        <div class="report-results" id="expenseReportResults">
          <div class="loading"><div class="spinner"></div><p>Select a period or click 'Today' to generate an Expense Report</p></div>
        </div>
        <div class="report-actions" id="expenseReportActions" style="display: none;">
          <button class="btn btn-danger" onclick="downloadPDF('expense')"><i class="fas fa-file-pdf"></i> Download Expense PDF</button>
          <button class="btn btn-primary" onclick="exportCSV('expense')"><i class="fas fa-file-csv"></i> Export Expense CSV</button>
        </div>
      </div>

      <div class="report-section" id="incomeReportSection">
        <h3 class="form-title" style="color: var(--success);"><i class="fas fa-chart-line"></i> <span id="incomeReportTitle">Income Reports</span></h3>
        <div class="report-controls" id="incomeReportControls">
          <button class="btn btn-report active" onclick="generateReport('today', 'income', this)"><i class="fas fa-calendar-day"></i> <span>Today</span></button>
          <button class="btn btn-report" onclick="generateReport('yesterday', 'income', this)"><i class="fas fa-calendar-minus"></i> <span>Yesterday</span></button>
          <button class="btn btn-report" onclick="generateReport('week', 'income', this)"><i class="fas fa-calendar-week"></i> <span>This Week</span></button>
          <button class="btn btn-report" onclick="generateReport('month', 'income', this)"><i class="fas fa-calendar-alt"></i> <span>This Month</span></button>
          <button class="btn btn-report" onclick="generateReport('lastMonth', 'income', this)"><i class="fas fa-calendar-alt"></i> <span>Last Month</span></button>
          <button class="btn btn-report" onclick="generateReport('year', 'income', this)"><i class="fas fa-calendar"></i> <span>This Year</span></button>
          <button class="btn btn-report" onclick="showCustomRange('income', this)"><i class="fas fa-calendar-range"></i> <span>Custom Range</span></button>
          <button class="btn btn-report" onclick="showCategoryReportModal('income')"><i class="fas fa-filter"></i> <span>By Source</span></button>
        </div>

        <div class="report-period" id="incomeCustomRange" style="display: none;">
          <div><label>From Date</label><input type="date" id="incomeFromDate"></div>
          <div><label>To Date</label><input type="date" id="incomeToDate"></div>
          <div style="align-self: flex-end;"><button class="btn btn-success" onclick="generateCustomReport('income')"><i class="fas fa-play"></i> Generate</button></div>
        </div>

        <div class="report-results" id="incomeReportResults">
          <div class="loading"><div class="spinner"></div><p>Select a period or click 'Today' to generate an Income Report</p></div>
        </div>
        <div class="report-actions" id="incomeReportActions" style="display: none;">
          <button class="btn btn-success" onclick="downloadPDF('income')"><i class="fas fa-file-pdf"></i> Download Income PDF</button>
          <button class="btn btn-primary" onclick="exportCSV('income')"><i class="fas fa-file-csv"></i> Export Income CSV</button>
        </div>
      </div>

      <!-- NEW: Budgets List -->
      <div class="budgets-list" id="budgetsListSection">
        <div class="list-header" onclick="toggleList('budgetsListSection')">
          <h3><i class="fas fa-chart-pie"></i> Monthly Budgets</h3>
          <i class="fas fa-chevron-up toggle-icon"></i>
        </div>
        <div class="list-body">
          <div class="search-filter-container">
            <div class="search-box" style="position: relative;">
              <i class="fas fa-search"></i>
              <input type="text" id="searchBudgets" placeholder="Search budgets..." onkeyup="searchBudgets()">
            </div>
            <div class="filter-select">
              <select id="filterBudgetMonth" onchange="filterBudgets()">
                <option value="">All Months</option>
              </select>
            </div>
          </div>
          <div id="budgetsList"><div class="loading"><div class="spinner"></div><p>Loading budgets...</p></div></div>
        </div>
      </div>
      
      <!-- NEW: Reminders List -->
      <div class="reminders-list" id="remindersListSection">
        <div class="list-header" onclick="toggleList('remindersListSection')">
          <h3><i class="fas fa-bell"></i> Payment Reminders</h3>
          <i class="fas fa-chevron-up toggle-icon"></i>
        </div>
        <div class="list-body">
          <div class="search-filter-container">
            <div class="search-box" style="position: relative;">
              <i class="fas fa-search"></i>
              <input type="text" id="searchReminders" placeholder="Search reminders..." onkeyup="searchReminders()">
            </div>
            <div class="filter-select">
              <select id="filterReminderStatus" onchange="filterReminders()">
                <option value="">All Status</option>
                <option value="upcoming">Upcoming</option>
                <option value="today">Due Today</option>
                <option value="overdue">Overdue</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
          <div id="remindersList"><div class="loading"><div class="spinner"></div><p>Loading reminders...</p></div></div>
        </div>
      </div>

      <div class="expenses-list" id="expensesListSection">
        <div class="list-header" onclick="toggleList('expensesListSection')">
          <h3><i class="fas fa-receipt"></i> Recent Expenses</h3>
          <i class="fas fa-chevron-up toggle-icon"></i>
        </div>
        <div class="list-body">
          <div class="search-filter-container">
            <div class="search-box" style="position: relative;">
              <i class="fas fa-search"></i>
              <input type="text" id="searchExpenses" placeholder="Search expenses..." onkeyup="searchExpenses()">
            </div>
            <div class="filter-select">
              <select id="filterExpenseCategory" onchange="filterExpenses()">
                <option value="">All Categories</option>
              </select>
            </div>
            <div class="filter-select">
              <select id="filterExpenseMonth" onchange="filterExpenses()">
                <option value="">All Months</option>
              </select>
            </div>
          </div>
          <div id="expensesList"><div class="loading"><div class="spinner"></div><p>Loading expenses...</p></div></div>
        </div>
      </div>
      
      <div class="income-list" id="incomeListSection">
        <div class="list-header" onclick="toggleList('incomeListSection')">
          <h3><i class="fas fa-money-check-alt"></i> Recent Income</h3>
          <i class="fas fa-chevron-up toggle-icon"></i>
        </div>
        <div class="list-body">
          <div class="search-filter-container">
            <div class="search-box" style="position: relative;">
              <i class="fas fa-search"></i>
              <input type="text" id="searchIncome" placeholder="Search income..." onkeyup="searchIncome()">
            </div>
            <div class="filter-select">
              <select id="filterIncomeSource" onchange="filterIncome()">
                <option value="">All Sources</option>
              </select>
            </div>
            <div class="filter-select">
              <select id="filterIncomeMonth" onchange="filterIncome()">
                <option value="">All Months</option>
              </select>
            </div>
          </div>
          <div id="incomeList"><div class="loading"><div class="spinner"></div><p>Loading income...</p></div></div>
        </div>
      </div>
    </div>




    <div class="footer">
      <div class="footer-content">
        <div class="copyright"><i class="fas fa-copyright"></i><span>Copyright @2025 Financial Tracker PRO - Multi-User Platform</span></div>
        <div class="footer-links">
          <a href="javascript:void(0)" onclick="showAbout()"><i class="fas fa-info-circle"></i> About</a>
          <a href="javascript:void(0)" onclick="showPrivacy()"><i class="fas fa-shield-alt"></i> Privacy</a>
          <a href="javascript:void(0)" onclick="showContact()"><i class="fas fa-envelope"></i> Contact</a>
          <a href="javascript:void(0)" onclick="exportAllData()"><i class="fas fa-file-export"></i> Export Data</a>
          <a href="javascript:void(0)" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <h3><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h3>
      <p>Are you sure you want to delete this item?</p>
      <p id="deleteExpenseDetails" style="font-weight: 600; margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 0.85rem;"></p>
      <div class="modal-actions">
        <button class="btn" style="background: var(--gray); color: white;" id="cancelDelete"><i class="fas fa-times"></i> Cancel</button>
        <button class="btn" style="background: var(--danger); color: white;" id="confirmDelete"><i class="fas fa-trash"></i> Delete</button>
      </div>
    </div>
  </div>

  <!-- Rest of the modal HTML remains the same as original -->
  <div class="modal-overlay" id="aboutModal">
    <div class="modal">
      <h3><i class="fas fa-info-circle"></i> About Financial Tracker PRO</h3>
      <p>A modern multi-user expense and income tracking application designed for secure financial management.</p>
      <div style="margin-top: 15px;">
        <p><strong>Advanced Features:</strong></p>
        <ul style="margin-left: 20px; margin-top: 10px;">
          <li> Multi-User Support with Individual Data Isolation</li>
          <li> Monthly Budget Tracking with Progress Bars</li>
          <li> Payment Reminders with Due Dates</li>
          <li> Savings Goals Tracking</li>
          <li> Advanced Search and Filter for All Lists</li>
          <li> Category/Source Specific Reports</li>
          <li> CSV Export for Reports</li>
          <li> Quick Actions for Common Tasks</li>
          <li> Enhanced Dashboard with More Stats</li>
          <li> Data Export (JSON Backup)</li>
          <li> Yearly Financial Overview</li>
          <li> Savings Calculator</li>
          <li> Debt Tracker</li>
          <li> Dark/Light Mode Toggle</li>
          <li> Real-time Firebase Sync</li>
        </ul>
        <p style="margin-top: 15px;"><strong>Security Features:</strong></p>
        <ul style="margin-left: 20px; margin-top: 10px;">
          <li> Individual user accounts with secure authentication</li>
          <li> Data isolation between users</li>
          <li> Tap-to-reveal balance privacy</li>
          <li> Secure Firebase backend</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="document.getElementById('aboutModal').style.display = 'none'"><i class="fas fa-times"></i> Close</button>
      </div>
    </div>
  </div>

  <!-- NEW: Savings Calculator Modal -->
  <div class="modal-overlay" id="savingsCalculatorModal">
    <div class="modal">
      <h3><i class="fas fa-calculator"></i> Savings Goal Calculator</h3>
      <div class="form-grid">
        <div class="form-group">
          <label><i class="fas fa-bullseye"></i> Goal Amount (UGX)</label>
          <input type="number" id="goalAmount" placeholder="e.g. 5000000" min="0" step="1000" value="5000000">
        </div>
        <div class="form-group">
          <label><i class="fas fa-calendar"></i> Target Date</label>
          <input type="date" id="targetDate" value="">
        </div>
        <div class="form-group">
          <label><i class="fas fa-piggy-bank"></i> Monthly Savings (UGX)</label>
          <input type="number" id="monthlySavings" placeholder="e.g. 200000" min="0" step="1000" value="200000">
        </div>
        <div class="form-group">
          <label><i class="fas fa-chart-line"></i> Expected Growth Rate (%)</label>
          <input type="number" id="growthRate" placeholder="e.g. 5" min="0" max="50" step="0.1" value="5">
        </div>
      </div>
      <div id="savingsCalculationResult" style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 10px; display: none;">
        <h4 style="color: var(--success); margin-bottom: 10px;">Calculation Results</h4>
        <div id="savingsResultDetails"></div>
      </div>
      <div class="modal-actions">
        <button class="btn" style="background: var(--gray); color: white;" onclick="document.getElementById('savingsCalculatorModal').style.display = 'none'"><i class="fas fa-times"></i> Close</button>
        <button class="btn btn-success" onclick="calculateSavingsGoal()"><i class="fas fa-calculator"></i> Calculate</button>
        <button class="btn btn-primary" onclick="setSavingsGoal()"><i class="fas fa-bullseye"></i> Set as Goal</button>
      </div>
    </div>
  </div>

  <!-- NEW: Yearly Overview Modal -->
  <div class="modal-overlay" id="yearlyOverviewModal">
    <div class="modal" style="max-width: 800px;">
      <h3><i class="fas fa-chart-bar"></i> Yearly Financial Overview</h3>
      <div style="margin-bottom: 20px;">
        <label><i class="fas fa-calendar"></i> Select Year:</label>
        <select id="yearSelect" onchange="loadYearlyOverview()" style="margin-left: 10px; padding: 8px; border-radius: 8px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border);">
  <option value="2022">2022</option>
  <option value="2023">2023</option>
  <option value="2024">2024</option>
  <option value="2025" selected>2025</option>
  <option value="2026">2026</option>
</select>
      </div>
      <div id="yearlyOverviewContent">
        <div class="loading"><div class="spinner"></div><p>Loading yearly overview...</p></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="document.getElementById('yearlyOverviewModal').style.display = 'none'"><i class="fas fa-times"></i> Close</button>
        <button class="btn btn-success" onclick="downloadYearlyPDF()"><i class="fas fa-file-pdf"></i> Download PDF</button>
      </div>
    </div>
  </div>

  <!-- NEW: Debt Tracker Modal -->
  <div class="modal-overlay" id="debtTrackerModal">
    <div class="modal">
      <h3><i class="fas fa-credit-card"></i> Debt Tracker</h3>
      <div class="form-grid">
        <div class="form-group">
          <label><i class="fas fa-sticky-note"></i> Debt Name</label>
          <input type="text" id="debtName" placeholder="e.g. Credit Card, Personal Loan" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-money-bill-wave"></i> Total Amount (UGX)</label>
          <input type="number" id="debtTotalAmount" placeholder="e.g. 1000000" min="0" step="1000" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-money-bill-wave"></i> Amount Paid (UGX)</label>
          <input type="number" id="debtPaidAmount" placeholder="e.g. 200000" min="0" step="1000" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-calendar"></i> Due Date</label>
          <input type="date" id="debtDueDate" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-percentage"></i> Interest Rate (%)</label>
          <input type="number" id="debtInterestRate" placeholder="e.g. 12" min="0" max="100" step="0.1" value="0">
        </div>
      </div>
      <div id="debtCalculationResult" style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 10px; display: none;">
        <h4 style="color: var(--warning); margin-bottom: 10px;">Debt Status</h4>
        <div id="debtResultDetails"></div>
      </div>
      <div class="modal-actions">
        <button class="btn" style="background: var(--gray); color: white;" onclick="document.getElementById('debtTrackerModal').style.display = 'none'"><i class="fas fa-times"></i> Close</button>
        <button class="btn btn-warning" onclick="calculateDebt()"><i class="fas fa-calculator"></i> Calculate</button>
        <button class="btn btn-danger" onclick="saveDebt()"><i class="fas fa-save"></i> Save Debt</button>
      </div>
    </div>
  </div>

  <!-- NEW: Category Report Modal -->
  <div class="modal-overlay" id="categoryReportModal">
    <div class="modal category-report-modal">
      <h3><i class="fas fa-filter"></i> <span id="categoryReportTitle">Generate Category Report</span></h3>
      <div class="specific-report-filter">
        <div class="filter-grid">
          <div class="form-group">
            <label><i class="fas fa-tags"></i> <span id="categoryReportLabel">Select Category</span></label>
            <select id="reportCategorySelect">
              <option value="">-- Select --</option>
            </select>
          </div>
          <div class="form-group">
            <label><i class="fas fa-calendar"></i> From Date</label>
            <input type="date" id="categoryReportFromDate">
          </div>
          <div class="form-group">
            <label><i class="fas fa-calendar"></i> To Date</label>
            <input type="date" id="categoryReportToDate">
          </div>
        </div>
        <div class="filter-actions">
          <button class="btn" style="background: var(--gray); color: white;" onclick="document.getElementById('categoryReportModal').style.display = 'none'">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button class="btn btn-primary" onclick="generateCategoryReport()">
            <i class="fas fa-chart-bar"></i> Generate Report
          </button>
        </div>
      </div>
      <div id="categoryReportResults" style="margin-top: 20px; display: none;">
        <h4 style="color: var(--primary); margin-bottom: 15px;">Report Results</h4>
        <div id="categoryReportContent"></div>
      </div>
    </div>
  </div>
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  


  <script>
    // ===== JAVASCRIPT =====
    // Firebase Configuration
  const firebaseConfig = {
  apiKey: "AIzaSyDda1g38Xmm0euvidr4FVe5HWcM9ozrMks",
  authDomain: "matsande-bd989.firebaseapp.com",
  projectId: "matsande-bd989",
  storageBucket: "matsande-bd989.firebasestorage.app",
  messagingSenderId: "1092457131514",
  appId: "1:1092457131514:web:8ad017b4ece06ef23e8843"
};


    // Global variables
    let db = null;
    let auth = null;
    let currentUser = null;
    let isFirestoreReady = false;
    let itemToDeleteId = null, collectionToDelete = null;
    let isEditingExpense = false, editingExpenseId = null;
    let isEditingIncome = false, editingIncomeId = null;
    let isEditingBudget = false, editingBudgetId = null;
    let isEditingReminder = false, editingReminderId = null;
    let currentReportPeriod = { expense: 'today', income: 'today' };
    let currentReportData = { expense: null, income: null };
    let pieChart = null, barChart = null, previousStats = {};
    let revealedBalances = { 
      today: false, week: false, month: false, year: false, 
      totalIncome: false, totalExpense: false, availableBalance: false,
      monthlyBudget: false, savingsGoal: false 
    };
	
	
	
	
	
	// ===== LOAD EXPENSES (REPLACE THIS EXISTING FUNCTION) =====
function loadExpenses() {
  if (!currentUser || !isFirestoreReady) {
    setTimeout(loadExpenses, 500);
    return;
  }
  
  const expensesRef = db.collection('users').doc(currentUser.uid).collection('expenses');
  expensesRef.orderBy('date', 'desc').get().then((querySnapshot) => {
    allExpenses = [];
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      allExpenses.push({
        id: doc.id,
        amount: data.amount,
        category: data.category,
        date: data.date,
        description: data.description,
        timestamp: data.date ? new Date(data.date) : new Date()
      });
    });
    
    // === MODIFIED: Filter to show only current month by default ===
    const currentMonthYear = getCurrentMonthYear();
    const currentMonthExpenses = allExpenses.filter(expense => {
      const expenseDate = new Date(expense.date);
      const expenseMonthYear = `${expenseDate.getFullYear()}-${String(expenseDate.getMonth() + 1).padStart(2, '0')}`;
      return expenseMonthYear === currentMonthYear;
    });
    
    populateExpenseFilters();
    displayExpenses(currentMonthExpenses); // Show filtered expenses
    updateDashboardStats();
	updateFinancialSnapshot();
    analyzeFinancialData();	
  }).catch((error) => {
    console.error("Error loading expenses:", error);
    showMessage('Failed to load expenses. Please try again.', 'error');
  });
}



// ===== LOAD INCOME (REPLACE THIS EXISTING FUNCTION) =====
function loadIncome() {
  if (!currentUser || !isFirestoreReady) {
    setTimeout(loadIncome, 500);
    return;
  }
  
  const incomeRef = db.collection('users').doc(currentUser.uid).collection('income');
  incomeRef.orderBy('date', 'desc').get().then((querySnapshot) => {
    allIncome = [];
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      allIncome.push({
        id: doc.id,
        amount: data.amount,
        source: data.source,
        date: data.date,
        notes: data.notes,
        timestamp: data.date ? new Date(data.date) : new Date()
      });
    });
    
    // Get current month
    const now = new Date();
    currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    
    // Filter for current month only
    const currentMonthIncome = allIncome.filter(income => {
      const incomeDate = new Date(income.date);
      const incomeMonthYear = `${incomeDate.getFullYear()}-${String(incomeDate.getMonth() + 1).padStart(2, '0')}`;
      return incomeMonthYear === currentMonthYear;
    });
    
    populateIncomeFilters();
    displayIncome(currentMonthIncome);
    updateDashboardStats();
	updateFinancialSnapshot();
	analyzeFinancialData();
  }).catch((error) => {
    console.error("Error loading income:", error);
    showMessage('Failed to load income. Please try again.', 'error');
  });
}	
	
	
	
// ===== HELPER FUNCTIONS (ADD THESE NEW ONES) =====
function getCurrentMonthYear() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  return `${year}-${month}`;
}

function showAllItems(type = 'both') {
  if (type === 'expense' || type === 'both') {
    displayExpenses(allExpenses);
    document.getElementById('filterExpenseMonth').value = '';
  }
  
  if (type === 'income' || type === 'both') {
    displayIncome(allIncome);
    document.getElementById('filterIncomeMonth').value = '';
  }
  
  showMessage('Showing all items from all months', 'info');
}

function showCurrentMonthItems() {
  const currentMonthYear = getCurrentMonthYear();
  
  const currentMonthExpenses = allExpenses.filter(expense => {
    const expenseDate = new Date(expense.date);
    const expenseMonthYear = `${expenseDate.getFullYear()}-${String(expenseDate.getMonth() + 1).padStart(2, '0')}`;
    return expenseMonthYear === currentMonthYear;
  });
  
  const currentMonthIncome = allIncome.filter(income => {
    const incomeDate = new Date(income.date);
    const incomeMonthYear = `${incomeDate.getFullYear()}-${String(incomeDate.getMonth() + 1).padStart(2, '0')}`;
    return incomeMonthYear === currentMonthYear;
  });
  
  displayExpenses(currentMonthExpenses);
  displayIncome(currentMonthIncome);
  
  document.getElementById('filterExpenseMonth').value = currentMonthYear;
  document.getElementById('filterIncomeMonth').value = currentMonthYear;
  
  showMessage('Showing current month items only', 'info');
}	
	
	
	
	
	
	
	

// ===== FINANCIAL SNAPSHOT FUNCTIONS =====
function updateFinancialSnapshot() {
  const now = new Date();
  const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  
  // Calculate current month stats
  const currentMonthExpenses = allExpenses.filter(exp => {
    const date = new Date(exp.date);
    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    return monthYear === currentMonthYear;
  });
  
  const currentMonthIncome = allIncome.filter(inc => {
    const date = new Date(inc.date);
    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    return monthYear === currentMonthYear;
  });
  
  // Calculate totals
  const totalIncome = currentMonthIncome.reduce((sum, inc) => sum + (parseFloat(inc.amount) || 0), 0);
  const totalExpenses = currentMonthExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
  const netBalance = totalIncome - totalExpenses;
  
  // Calculate daily average (based on days passed in current month)
  const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const dayOfMonth = now.getDate();
  const dailyAverage = dayOfMonth > 0 ? totalExpenses / dayOfMonth : 0;
  
  // Update display
  document.getElementById('currentMonthIncome').textContent = formatCurrency(totalIncome);
  document.getElementById('currentMonthExpenses').textContent = formatCurrency(totalExpenses);
  document.getElementById('currentMonthNet').textContent = formatCurrency(netBalance);
  document.getElementById('dailyAverage').textContent = formatCurrency(dailyAverage);
  
  // Update net status
  const netStatus = document.getElementById('netStatus');
  if (netBalance > 0) {
    netStatus.textContent = `+${formatCurrency(netBalance)} surplus`;
    netStatus.style.color = 'var(--success)';
  } else if (netBalance < 0) {
    netStatus.textContent = `${formatCurrency(Math.abs(netBalance))} deficit`;
    netStatus.style.color = 'var(--danger)';
  } else {
    netStatus.textContent = 'Balanced';
    netStatus.style.color = 'var(--gray)';
  }
  
  // Update month progress
  const monthProgress = (dayOfMonth / daysInMonth) * 100;
  document.getElementById('monthProgressBar').style.width = `${monthProgress}%`;
  document.getElementById('monthProgressPercent').textContent = `${Math.round(monthProgress)}%`;
  document.getElementById('daysRemaining').textContent = `${daysInMonth - dayOfMonth} days remaining`;
}

// Helper function to format currency
function formatCurrency(amount) {
  return `UGX ${amount.toLocaleString('en-US', { 
    minimumFractionDigits: 0, 
    maximumFractionDigits: 0 
  })}`;
}

// Call this function whenever expenses or income are updated
// Add this line to the end of your loadExpenses() and loadIncome() functions:
// updateFinancialSnapshot();
	
	
	
	
	

function clearExpenseForm() {
    document.getElementById('amount').value = '';
    document.getElementById('category').value = 'Groceries';
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    document.getElementById('description').value = '';
    document.getElementById('expenseFormTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add New Expense';
    document.getElementById('addBtn').innerHTML = '<i class="fas fa-plus"></i> Add Expense';
    document.getElementById('cancelExpenseBtn').style.display = 'none';
    isEditingExpense = false;
    editingExpenseId = null;
}

function clearIncomeForm() {
    document.getElementById('incomeAmount').value = '';
    document.getElementById('incomeSource').value = 'Salary';
    document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('incomeNotes').value = '';
    document.getElementById('incomeFormTitle').innerHTML = '<i class="fas fa-money-bill-alt"></i> Add New Income';
    document.getElementById('addIncomeBtn').innerHTML = '<i class="fas fa-arrow-alt-circle-up"></i> Record Income';
    document.getElementById('cancelIncomeBtn').style.display = 'none';
    isEditingIncome = false;
    editingIncomeId = null;
}

function clearBudgetForm() {
    document.getElementById('budgetAmount').value = '';
    
    // Set default budget month to current month
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('budgetMonth').value = currentMonth;
    
    document.getElementById('budgetCategory').value = '';
    document.getElementById('budgetNotes').value = '';
    document.getElementById('budgetFormTitle').innerHTML = '<i class="fas fa-chart-pie"></i> Set Monthly Budget';
    document.getElementById('addBudgetBtn').innerHTML = '<i class="fas fa-plus"></i> Set Budget';
    document.getElementById('cancelBudgetBtn').style.display = 'none';
    isEditingBudget = false;
    editingBudgetId = null;
}

function clearReminderForm() {
    document.getElementById('reminderTitle').value = '';
    document.getElementById('reminderAmount').value = '';
    
    // Set reminder date to today
    document.getElementById('reminderDueDate').value = new Date().toISOString().split('T')[0];
    
    document.getElementById('reminderCategory').value = 'Rent';
    document.getElementById('reminderFormTitle').innerHTML = '<i class="fas fa-bell"></i> Add Payment Reminder';
    document.getElementById('addReminderBtn').innerHTML = '<i class="fas fa-bell"></i> Add Reminder';
    document.getElementById('cancelReminderBtn').style.display = 'none';
    isEditingReminder = false;
    editingReminderId = null;
}



// ========== EXPENSE HANDLERS ==========


// ========== INCOME HANDLERS ==========

async function handleIncomeSubmit() {
    if (!isFirestoreReady || !currentUser) {
        showMessage(' Please wait, app is still initializing...', 'warning');
        return;
    }
    
    const amount = parseFloat(document.getElementById('incomeAmount').value);
    const sourceSelect = document.getElementById('incomeSource');
    const sourceDisplay = sourceSelect.options[sourceSelect.selectedIndex].text;
    const source = getSourceValue(sourceDisplay);
    const date = document.getElementById('incomeDate').value;
    const notes = document.getElementById('incomeNotes').value.trim();
    
    // Validation
 
    if (!source) {
        showMessage(' Please select a source', 'error');
        return;
    }
    if (!date) {
        showMessage(' Please select a date', 'error');
        return;
    }
    
    // Disable button to prevent double submission
    const addBtn = document.getElementById('addIncomeBtn');
    addBtn.disabled = true;
    addBtn.innerHTML = isEditingIncome ? 
        '<i class="fas fa-spinner fa-spin"></i> Updating...' : 
        '<i class="fas fa-spinner fa-spin"></i> Adding...';
    
    try {
        const incomeData = {
            amount: amount,
            source: source,
            sourceDisplay: sourceDisplay,
            date: date,
            notes: notes || 'No notes',
            userId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (isEditingIncome && editingIncomeId) {
            await db.collection('income').doc(editingIncomeId).update(incomeData);
            showMessage(' Income updated successfully!', 'success');
        } else {
            await db.collection('income').add(incomeData);
            showMessage(' Income added successfully!', 'success');
        }
        
        // Clear the form after successful submission
        clearIncomeForm();
        
        // Refresh data
        setTimeout(() => {
            loadAllData();
        }, 500);
        
    } catch (error) {
        console.error('Error saving income:', error);
        showMessage(' Failed to save income: ' + error.message, 'error');
    } finally {
        addBtn.disabled = false;
        addBtn.innerHTML = isEditingIncome ? 
            '<i class="fas fa-save"></i> Update Income' : 
            '<i class="fas fa-arrow-alt-circle-up"></i> Record Income';
    }
}



// Make sure you're setting the value correctly when editing
function populateEditForm(item, type) {
    if (type === 'expense') {
        document.getElementById('amount').value = item.amount || '';
        document.getElementById('category').value = item.category || '';
        document.getElementById('date').value = item.date || '';
        document.getElementById('description').value = item.description || '';
    }
    
    if (type === 'income') {
        document.getElementById('incomeAmount').value = item.amount || '';
        document.getElementById('incomeSource').value = item.source || '';
        document.getElementById('incomeDate').value = item.date || '';
        document.getElementById('incomeNotes').value = item.notes || '';
    }
}



// Add this to your form submission handlers
function handleFormSubmit(type) {
    // Get amount based on form type
    let amount;
    if (type === 'expense') {
        amount = document.getElementById('amount').value;
    } else if (type === 'income') {
        amount = document.getElementById('incomeAmount').value;
    } else if (type === 'budget') {
        amount = document.getElementById('budgetAmount').value;
    } else if (type === 'reminder') {
        amount = document.getElementById('reminderAmount').value;
    }
    
    // Convert to number and check
    amount = parseFloat(amount);
    
    // More lenient validation
    if (isNaN(amount)) {
        showMessage(' Please enter a valid amount', 'error');
        return false;
    }
    
    // Allow zero values if needed
    if (amount < 0) {
        showMessage(' Amount cannot be negative', 'error');
        return false;
    }
    
    // Continue with form submission...
    return true;
}









// ========== BUDGET HANDLERS ==========

async function handleBudgetSubmit() {
    if (!isFirestoreReady || !currentUser) {
        showMessage(' Please wait, app is still initializing...', 'warning');
        return;
    }
    
    const amount = parseFloat(document.getElementById('budgetAmount').value);
    const month = document.getElementById('budgetMonth').value;
    const category = document.getElementById('budgetCategory').value;
    const notes = document.getElementById('budgetNotes').value.trim();
    
    // Validation
    if (!amount || amount <= 0) {
        showMessage(' Please enter a valid budget amount', 'error');
        return;
    }
    if (!month) {
        showMessage(' Please select a month', 'error');
        return;
    }
    
    // Disable button to prevent double submission
    const addBtn = document.getElementById('addBudgetBtn');
    addBtn.disabled = true;
    addBtn.innerHTML = isEditingBudget ? 
        '<i class="fas fa-spinner fa-spin"></i> Updating...' : 
        '<i class="fas fa-spinner fa-spin"></i> Adding...';
    
    try {
        const budgetData = {
            amount: amount,
            month: month,
            category: category || 'All Categories',
            notes: notes || 'No notes',
            userId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (isEditingBudget && editingBudgetId) {
            await db.collection('budgets').doc(editingBudgetId).update(budgetData);
            showMessage(' Budget updated successfully!', 'success');
        } else {
            await db.collection('budgets').add(budgetData);
            showMessage(' Budget set successfully!', 'success');
        }
        
        // Clear the form after successful submission
        clearBudgetForm();
        
        // Refresh data
        setTimeout(() => {
            loadAllData();
        }, 500);
        
    } catch (error) {
        console.error('Error saving budget:', error);
        showMessage(' Failed to save budget: ' + error.message, 'error');
    } finally {
        addBtn.disabled = false;
        addBtn.innerHTML = isEditingBudget ? 
            '<i class="fas fa-save"></i> Update Budget' : 
            '<i class="fas fa-plus"></i> Set Budget';
    }
}

// ========== REMINDER HANDLERS ==========

async function handleReminderSubmit() {
    if (!isFirestoreReady || !currentUser) {
        showMessage(' Please wait, app is still initializing...', 'warning');
        return;
    }
    
    const title = document.getElementById('reminderTitle').value.trim();
    const amount = parseFloat(document.getElementById('reminderAmount').value);
    const dueDate = document.getElementById('reminderDueDate').value;
    const category = document.getElementById('reminderCategory').value;
    
    // Validation
    if (!title) {
        showMessage(' Please enter a reminder title', 'error');
        return;
    }
    
    if (!dueDate) {
        showMessage(' Please select a due date', 'error');
        return;
    }
    
    // Calculate status based on due date
    const today = new Date().toISOString().split('T')[0];
    let status = 'upcoming';
    if (dueDate === today) status = 'today';
    else if (dueDate < today) status = 'overdue';
    
    // Disable button to prevent double submission
    const addBtn = document.getElementById('addReminderBtn');
    addBtn.disabled = true;
    addBtn.innerHTML = isEditingReminder ? 
        '<i class="fas fa-spinner fa-spin"></i> Updating...' : 
        '<i class="fas fa-spinner fa-spin"></i> Adding...';
    
    try {
        const reminderData = {
            title: title,
            amount: amount,
            dueDate: dueDate,
            category: category,
            status: status,
            completed: false,
            userId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (isEditingReminder && editingReminderId) {
            await db.collection('reminders').doc(editingReminderId).update(reminderData);
            showMessage(' Reminder updated successfully!', 'success');
        } else {
            await db.collection('reminders').add(reminderData);
            showMessage(' Reminder added successfully!', 'success');
        }
        
        // Clear the form after successful submission
        clearReminderForm();
        
        // Refresh data
        setTimeout(() => {
            loadAllData();
        }, 500);
        
    } catch (error) {
        console.error('Error saving reminder:', error);
        showMessage(' Failed to save reminder: ' + error.message, 'error');
    } finally {
        addBtn.disabled = false;
        addBtn.innerHTML = isEditingReminder ? 
            '<i class="fas fa-save"></i> Update Reminder' : 
            '<i class="fas fa-bell"></i> Add Reminder';
    }
}




// ========== EDIT FUNCTIONS ==========

// Edit Expense
async function editExpense(expenseId) {
    try {
        const expenseDoc = await db.collection('expenses').doc(expenseId).get();
        if (!expenseDoc.exists) {
            showMessage(' Expense not found', 'error');
            return;
        }

        const expense = expenseDoc.data();
        isEditingExpense = true;
        editingExpenseId = expenseId;

        // Set form values
        document.getElementById('amount').value = expense.amount || '';
        document.getElementById('date').value = expense.date || '';
        document.getElementById('description').value = expense.description || '';
        
        // Handle category selection
        const categoryValue = expense.categoryDisplay || expense.category;
        const categorySelect = document.getElementById('category');
        
        // Find the option with matching text
        let found = false;
        for (let i = 0; i < categorySelect.options.length; i++) {
            if (categorySelect.options[i].text === categoryValue || 
                getCategoryValue(categorySelect.options[i].text) === categoryValue) {
                categorySelect.selectedIndex = i;
                found = true;
                break;
            }
        }
        
        // If not found, default to Groceries
        if (!found) {
            categorySelect.value = 'Groceries';
        }
        
        // Update UI
        document.getElementById('expenseFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Expense';
        document.getElementById('addBtn').innerHTML = '<i class="fas fa-save"></i> Update Expense';
        document.getElementById('cancelExpenseBtn').style.display = 'inline-flex';
        
        // Expand the form if collapsed
        const formSection = document.getElementById('expenseFormSection');
        if (formSection.classList.contains('collapsed')) {
            formSection.classList.remove('collapsed');
        }
        
        // Scroll to form
        formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        showMessage(' Editing expense...', 'info');
    } catch (error) {
        console.error('Error fetching expense:', error);
        showMessage(' Failed to load expense for editing: ' + error.message, 'error');
    }
}

// Edit Income
async function editIncome(incomeId) {
    try {
        const incomeDoc = await db.collection('income').doc(incomeId).get();
        if (!incomeDoc.exists) {
            showMessage(' Income not found', 'error');
            return;
        }

        const income = incomeDoc.data();
        isEditingIncome = true;
        editingIncomeId = incomeId;

        // Set form values
        document.getElementById('incomeAmount').value = income.amount || '';
        document.getElementById('incomeDate').value = income.date || '';
        document.getElementById('incomeNotes').value = income.notes || '';
        
        // Handle source selection
        const sourceValue = income.sourceDisplay || income.source;
        const sourceSelect = document.getElementById('incomeSource');
        
        // Find the option with matching text
        let found = false;
        for (let i = 0; i < sourceSelect.options.length; i++) {
            if (sourceSelect.options[i].text === sourceValue) {
                sourceSelect.selectedIndex = i;
                found = true;
                break;
            }
        }
        
        // If not found, default to Salary
        if (!found) {
            sourceSelect.value = 'Salary';
        }
        
        // Update UI
        document.getElementById('incomeFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Income';
        document.getElementById('addIncomeBtn').innerHTML = '<i class="fas fa-save"></i> Update Income';
        document.getElementById('cancelIncomeBtn').style.display = 'inline-flex';
        
        // Expand the form if collapsed
        const formSection = document.getElementById('incomeFormSection');
        if (formSection.classList.contains('collapsed')) {
            formSection.classList.remove('collapsed');
        }
        
        // Scroll to form
        formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        showMessage(' Editing income...', 'info');
    } catch (error) {
        console.error('Error fetching income:', error);
        showMessage(' Failed to load income for editing: ' + error.message, 'error');
    }
}

// Edit Budget
async function editBudget(budgetId) {
    try {
        const budgetDoc = await db.collection('budgets').doc(budgetId).get();
        if (!budgetDoc.exists) {
            showMessage(' Budget not found', 'error');
            return;
        }

        const budget = budgetDoc.data();
        isEditingBudget = true;
        editingBudgetId = budgetId;

        // Set form values
        document.getElementById('budgetAmount').value = budget.amount || '';
        document.getElementById('budgetMonth').value = budget.month || '';
        document.getElementById('budgetNotes').value = budget.notes || '';
        
        // Set category if exists
        if (budget.category && budget.category !== 'All Categories') {
            document.getElementById('budgetCategory').value = budget.category;
        }
        
        // Update UI
        document.getElementById('budgetFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Budget';
        document.getElementById('addBudgetBtn').innerHTML = '<i class="fas fa-save"></i> Update Budget';
        document.getElementById('cancelBudgetBtn').style.display = 'inline-flex';
        
        // Expand the form if collapsed
        const formSection = document.getElementById('budgetFormSection');
        if (formSection.classList.contains('collapsed')) {
            formSection.classList.remove('collapsed');
        }
        
        // Scroll to form
        formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        showMessage(' Editing budget...', 'info');
    } catch (error) {
        console.error('Error fetching budget:', error);
        showMessage(' Failed to load budget for editing: ' + error.message, 'error');
    }
}

// Edit Reminder
async function editReminder(reminderId) {
    try {
        const reminderDoc = await db.collection('reminders').doc(reminderId).get();
        if (!reminderDoc.exists) {
            showMessage(' Reminder not found', 'error');
            return;
        }

        const reminder = reminderDoc.data();
        isEditingReminder = true;
        editingReminderId = reminderId;

        // Set form values
        document.getElementById('reminderTitle').value = reminder.title || '';
        document.getElementById('reminderAmount').value = reminder.amount || '';
        document.getElementById('reminderDueDate').value = reminder.dueDate || '';
        
        // Set category
        if (reminder.category) {
            document.getElementById('reminderCategory').value = reminder.category;
        }
        
        // Update UI
        document.getElementById('reminderFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Reminder';
        document.getElementById('addReminderBtn').innerHTML = '<i class="fas fa-save"></i> Update Reminder';
        document.getElementById('cancelReminderBtn').style.display = 'inline-flex';
        
        // Expand the form if collapsed
        const formSection = document.getElementById('reminderFormSection');
        if (formSection.classList.contains('collapsed')) {
            formSection.classList.remove('collapsed');
        }
        
        // Scroll to form
        formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        showMessage(' Editing reminder...', 'info');
    } catch (error) {
        console.error('Error fetching reminder:', error);
        showMessage(' Failed to load reminder for editing: ' + error.message, 'error');
    }
}





// ========== CANCEL EDIT FUNCTIONS ==========

function cancelEditExpense() {
    clearExpenseForm();
    showMessage(' Expense edit cancelled', 'info');
}

function cancelEditIncome() {
    clearIncomeForm();
    showMessage(' Income edit cancelled', 'info');
}

function cancelEditBudget() {
    clearBudgetForm();
    showMessage(' Budget edit cancelled', 'info');
}

function cancelEditReminder() {
    clearReminderForm();
    showMessage(' Reminder edit cancelled', 'info');
}

// Connect cancel buttons to their functions
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('cancelExpenseBtn').addEventListener('click', cancelEditExpense);
    document.getElementById('cancelIncomeBtn').addEventListener('click', cancelEditIncome);
    document.getElementById('cancelBudgetBtn').addEventListener('click', cancelEditBudget);
    document.getElementById('cancelReminderBtn').addEventListener('click', cancelEditReminder);
});



// ========== HELPER FUNCTIONS ==========

// Convert display name to value (removes emoji)
function getCategoryValue(displayName) {
    return displayName.replace(/[^\w\s]/g, '').trim();
}

function getSourceValue(displayName) {
    return displayName.replace(/[^\w\s]/g, '').trim();
}

// Initialize all forms with default values
function initializeForms() {
    const today = new Date().toISOString().split('T')[0];
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    
    // Expense form
    document.getElementById('date').value = today;
    
    // Income form
    document.getElementById('incomeDate').value = today;
    
    // Budget form
    document.getElementById('budgetMonth').value = currentMonth;
    
    // Reminder form
    document.getElementById('reminderDueDate').value = today;
}

// Show error message
function showError(message) {
    showMessage(message, 'error');
}

// Show success message
function showSuccess(message) {
    showMessage(message, 'success');
}

// Generic message function (you should already have this)
function showMessage(message, type = 'info') {
    // Your existing showMessage implementation
    console.log(`[${type.toUpperCase()}] ${message}`);
}






// ========== DELETE MODAL FUNCTIONS ==========

// Function to show delete confirmation modal
function showDeleteModal(itemId, collection, itemType = 'item') {
    itemToDeleteId = itemId;
    collectionToDelete = collection;
    
    // Get item details for display
    let itemDetails = '';
    
    if (collection === 'expenses') {
        const expense = allExpenses.find(exp => exp.id === itemId);
        if (expense) {
            itemDetails = `${expense.categoryDisplay || expense.category} - UGX ${expense.amount.toLocaleString()} on ${expense.date}`;
        }
    } else if (collection === 'income') {
        const income = allIncome.find(inc => inc.id === itemId);
        if (income) {
            itemDetails = `${income.sourceDisplay || income.source} - UGX ${income.amount.toLocaleString()} on ${income.date}`;
        }
    } else if (collection === 'budgets') {
        const budget = allBudgets.find(b => b.id === itemId);
        if (budget) {
            itemDetails = `Budget for ${budget.month} - UGX ${budget.amount.toLocaleString()}`;
        }
    } else if (collection === 'reminders') {
        const reminder = allReminders.find(r => r.id === itemId);
        if (reminder) {
            itemDetails = `${reminder.title} - UGX ${reminder.amount.toLocaleString()} due on ${reminder.dueDate}`;
        }
    }
    
    document.getElementById('deleteExpenseDetails').textContent = itemDetails || `${itemType} details not available`;
    document.getElementById('deleteModal').style.display = 'flex';
}

// Function to delete item (connected to modal confirm button)
async function deleteItem() {
    if (!itemToDeleteId || !collectionToDelete || !currentUser) {
        showMessage(' Unable to delete: Missing information', 'error');
        return;
    }
    
    const confirmBtn = document.getElementById('confirmDelete');
    const cancelBtn = document.getElementById('cancelDelete');
    
    // Disable buttons during deletion
    confirmBtn.disabled = true;
    cancelBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    try {
        await db.collection(collectionToDelete).doc(itemToDeleteId).delete();
        showMessage(' Item deleted successfully!', 'success');
        
        // Refresh data after deletion
        setTimeout(() => {
            loadAllData();
        }, 500);
        
    } catch (error) {
        console.error('Error deleting item:', error);
        showMessage(' Failed to delete item: ' + error.message, 'error');
    } finally {
        // Reset modal and buttons
        document.getElementById('deleteModal').style.display = 'none';
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        itemToDeleteId = null;
        collectionToDelete = null;
    }
}

// Connect delete modal buttons
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('cancelDelete').addEventListener('click', function() {
        document.getElementById('deleteModal').style.display = 'none';
    });
    
    document.getElementById('confirmDelete').addEventListener('click', deleteItem);
});





// ========== DATA LOADING FUNCTION ==========

async function loadAllData() {
    if (!currentUser) return;
    
    try {
        // Load all collections
        await Promise.all([
            loadExpenses(),
            loadIncome(),
            loadBudgets(),
            loadReminders()
        ]);
        
        // Update stats
        updateDashboardStats();
        
        // Update charts
        updateCharts();
        
        // Update lists
        loadExpensesList(allExpenses);
        loadIncomeList(allIncome);
        loadBudgetsList(allBudgets);
        loadRemindersList(allReminders);
        
    } catch (error) {
        console.error('Error loading data:', error);
        showMessage(' Failed to load data: ' + error.message, 'error');
    }
}










// ========== INITIALIZATION ==========

document.addEventListener('DOMContentLoaded', function() {
    // Initialize forms with default values
    initializeForms();
    
    // Set up event listeners for submit buttons
    document.getElementById('addBtn').addEventListener('click', handleExpenseSubmit);
    document.getElementById('addIncomeBtn').addEventListener('click', handleIncomeSubmit);
    document.getElementById('addBudgetBtn').addEventListener('click', handleBudgetSubmit);
    document.getElementById('addReminderBtn').addEventListener('click', handleReminderSubmit);
    
    // Set up form inputs to enable/disable submit buttons
    setupFormValidation();
});


// Add this at the end of your initialization
function attachFormEventListeners() {
    // Expense Form
    document.getElementById('addBtn').addEventListener('click', handleExpenseSubmit);
    
    // Income Form
    document.getElementById('addIncomeBtn').addEventListener('click', handleIncomeSubmit);
    
    // Budget Form
    document.getElementById('addBudgetBtn').addEventListener('click', handleBudgetSubmit);
    
    // Reminder Form
    document.getElementById('addReminderBtn').addEventListener('click', handleReminderSubmit);
}

// Call this after Firebase initialization
attachFormEventListeners();






// Debounce function to prevent multiple submissions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Then modify your handlers
const debouncedExpenseSubmit = debounce(handleExpenseSubmit, 500);
const debouncedIncomeSubmit = debounce(handleIncomeSubmit, 500);

// Update event listeners
document.getElementById('addBtn').addEventListener('click', debouncedExpenseSubmit);
document.getElementById('addIncomeBtn').addEventListener('click', debouncedIncomeSubmit);





function handleExpenseSubmit(event) {
    if (event) event.preventDefault();
    
    const addBtn = document.getElementById('addBtn');
    
    // Disable button to prevent double click
    addBtn.disabled = true;
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    
    try {
        // ... your existing code
    } catch (error) {
        console.error('Error:', error);
    } finally {
        // Re-enable button after 1 second
        setTimeout(() => {
            addBtn.disabled = false;
            addBtn.innerHTML = '<i class="fas fa-plus"></i> Add Expense';
        }, 1000);
    }
}























































	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	

	

function searchIncome() {
  const searchTerm = document.getElementById('searchIncome').value.toLowerCase();
  let filteredIncome = allIncome;
  
  if (searchTerm) {
    filteredIncome = filteredIncome.filter(income => 
      (income.source && income.source.toLowerCase().includes(searchTerm)) ||
      (income.notes && income.notes.toLowerCase().includes(searchTerm)) ||
      (income.amount && income.amount.toString().includes(searchTerm))
    );
  }
  
  // Apply the current filters on the search result
  const selectedSource = document.getElementById('filterIncomeSource').value;
  const selectedMonth = document.getElementById('filterIncomeMonth').value;
  
  if (selectedSource) {
    filteredIncome = filteredIncome.filter(income => income.source === selectedSource);
  }
  
  if (selectedMonth) {
    filteredIncome = filteredIncome.filter(income => {
      const incomeDate = new Date(income.date);
      const incomeMonth = incomeDate.getFullYear() + '-' + (incomeDate.getMonth() + 1).toString().padStart(2, '0');
      return incomeMonth === selectedMonth;
    });
  }
  
  displayIncome(filteredIncome);
}

	
function getSourceDisplayName(source) {
  const sourceMap = {
    'Salary': ' Salary',
    'Freelance': ' Freelance/Side-Hustle',
    'Investment': ' Investment/Dividends',
    'Business': ' Business',
    'Gift': ' Gift',
    'Rental Income': ' Rental Income',
    'Bonus': ' Bonus',
    'Commission': ' Commission',
    'Allowances': ' Allowances',
    'Dividends': ' Dividends',
    'Interest': ' Interest Income',
    'Royalties': ' Royalties',
    'Pension': ' Pension',
    'Social Security': ' Social Security',
    'Child Support': ' Child Support',
    'Alimony': ' Alimony',
    'Scholarship': ' Scholarship',
    'Grant': ' Grant',
    'Rebate': ' Rebate',
    'Refund': ' Refund',
    'Lottery': ' Lottery/Winnings',
    'Inheritance': ' Inheritance',
    'Sale': ' Sale of Items',
    'Other': ' Other'
  };
  return sourceMap[source] || source;
}



function populateIncomeFilters() {
  const sourceSelect = document.getElementById('filterIncomeSource');
  const monthSelect = document.getElementById('filterIncomeMonth');
  
  // Clear existing options except the first one
  while (sourceSelect.options.length > 1) {
    sourceSelect.remove(1);
  }
  while (monthSelect.options.length > 1) {
    monthSelect.remove(1);
  }
  
  // Get unique sources from allIncome
  const sources = [...new Set(allIncome.map(inc => inc.source))].sort();
  sources.forEach(source => {
    if (source) {
      const option = document.createElement('option');
      option.value = source;
      option.textContent = getSourceDisplayName(source);
      sourceSelect.appendChild(option);
    }
  });
  
  // === MODIFIED: Get unique months from allIncome with current month as default ===
  const months = [];
  const currentMonthYear = getCurrentMonthYear();
  
  // Always add current month even if there are no income for it
  const currentDate = new Date();
  const currentDisplayMonth = currentDate.toLocaleDateString('en-US', { 
    month: 'long', 
    year: 'numeric' 
  });
  
  // Add current month first
  if (!months.some(m => m.value === currentMonthYear)) {
    months.push({ 
      value: currentMonthYear, 
      display: currentDisplayMonth,
      isCurrent: true 
    });
  }
  
  // Add months from existing income
  allIncome.forEach(income => {
    if (income.date) {
      try {
        const date = new Date(income.date);
        if (!isNaN(date.getTime())) {
          const monthStr = date.getFullYear() + '-' + 
                         String(date.getMonth() + 1).padStart(2, '0');
          const displayMonth = date.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
          });
          
          if (!months.some(m => m.value === monthStr)) {
            months.push({ 
              value: monthStr, 
              display: displayMonth,
              isCurrent: monthStr === currentMonthYear 
            });
          }
        }
      } catch (e) {
        console.error('Error parsing date:', e);
      }
    }
  });
  
  // Sort months chronologically (newest first)
  months.sort((a, b) => b.value.localeCompare(a.value));
  
  // Add month options
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month.value;
    option.textContent = month.display;
    if (month.isCurrent) {
      option.selected = true; // Set current month as default
    }
    monthSelect.appendChild(option);
  });
}

// ===== FIXED: CONSISTENT INCOME RENDERING (USE THIS ONLY) =====
function displayIncome(incomeArray) {
  const container = document.getElementById('incomeList');
  if (!container) return;

  if (!incomeArray || incomeArray.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-money-bill-alt"></i><p>No income records found</p></div>';
    return;
  }

  // Sort by date (newest first)
  const sortedIncome = [...incomeArray].sort((a, b) => {
    const dateA = new Date(a.date || a.timestamp?.toDate?.() || 0);
    const dateB = new Date(b.date || b.timestamp?.toDate?.() || 0);
    return dateB - dateA;
  });

  let html = '';
  sortedIncome.forEach(income => {
    const date = getFormattedDate(income);
    const amount = parseFloat(income.amount) || 0;
    const source = income.source || 'Other';
    const notes = income.notes || '';
    const sourceClass = 'source-' + source.toLowerCase().replace(/\s+/g, '-').replace('/', '-');

    html += `
    <div class="income-item" data-id="${income.id}">
      <div class="item-content">
        <strong>${date}</strong>
        <div>${notes}</div>
        <span class="category-badge ${sourceClass}">
          <i class="fas fa-briefcase"></i> ${source}
        </span>
      </div>
      <div class="income-amount">UGX ${amount.toLocaleString('en-US')}</div>
      <div class="item-actions">
        <button class="action-btn edit" onclick="editIncome('${income.id}')" title="Edit">
          <i class="fas fa-edit"></i>
        </button>
        <button class="action-btn delete" onclick="showDeleteModal('${income.id}', 'income')" title="Delete">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
    `;
  });

  container.innerHTML = html;
}

function getFormattedDate(item) {
  if (!item) return 'Invalid Date';
  let date;
  if (item.date) {
    if (item.date.toDate) date = item.date.toDate();
    else if (item.date instanceof Date) date = item.date;
    else date = new Date(item.date);
  } else if (item.timestamp?.toDate) {
    date = item.timestamp.toDate();
  } else {
    date = new Date(0);
  }
  if (isNaN(date.getTime())) return 'Invalid Date';
  return date.toLocaleDateString('en-US', {
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}





// Helper function to get source display name with emoji
function getSourceDisplayNameWithEmoji(source) {
  const sourceMap = {
    'Salary': ' Salary',
    'Freelance': ' Freelance',
    'Investment': ' Investment',
    'Business': ' Business',
    'Gift': ' Gift',
    'Rental Income': ' Rental Income',
    'Bonus': ' Bonus',
    'Commission': ' Commission',
    'Allowances': ' Allowances',
    'Dividends': ' Dividends',
    'Interest': ' Interest',
    'Royalties': ' Royalties',
    'Pension': ' Pension',
    'Social Security': ' Social Security',
    'Child Support': ' Child Support',
    'Alimony': ' Alimony',
    'Scholarship': ' Scholarship',
    'Grant': ' Grant',
    'Rebate': ' Rebate',
    'Refund': ' Refund',
    'Lottery': ' Lottery',
    'Inheritance': ' Inheritance',
    'Sale': ' Sale',
    'Other': ' Other'
  };
  
  return sourceMap[source] || source;
}

// Helper function to get just the emoji
function getSourceEmoji(source) {
  const emojiMap = {
    'Salary': '',
    'Freelance': '',
    'Investment': '',
    'Business': '',
    'Gift': '',
    'Rental Income': '',
    'Bonus': '',
    'Commission': '',
    'Allowances': '',
    'Dividends': '',
    'Interest': '',
    'Royalties': '',
    'Pension': '',
    'Social Security': '',
    'Child Support': '',
    'Alimony': '',
    'Scholarship': '',
    'Grant': '',
    'Rebate': '',
    'Refund': '',
    'Lottery': '',
    'Inheritance': '',
    'Sale': '',
    'Other': ''
  };
  
  return emojiMap[source] || '';
}
// ===== INCOME SOURCE HELPER FUNCTIONS =====

// Helper function to get source CSS class
function getSourceClass(source) {
    const sourceMap = {
        'Salary': 'source-salary',
        'Freelance': 'source-freelance',
        'Investment': 'source-investment',
        'Business': 'source-business',
        'Gift': 'source-gift',
        'Rental Income': 'source-rental-income',
        'Bonus': 'source-bonus',
        'Commission': 'source-commission',
        'Allowances': 'source-allowances',
        'Dividends': 'source-dividends',
        'Interest': 'source-interest',
        'Royalties': 'source-royalties',
        'Pension': 'source-pension',
        'Social Security': 'source-social-security',
        'Child Support': 'source-child-support',
        'Alimony': 'source-alimony',
        'Scholarship': 'source-scholarship',
        'Grant': 'source-grant',
        'Rebate': 'source-rebate',
        'Refund': 'source-refund',
        'Lottery': 'source-lottery',
        'Inheritance': 'source-inheritance',
        'Sale': 'source-sale',
        'Other': 'source-other'
    };
    
    return sourceMap[source] || 'source-other';
}

// Helper function for source icon
function getSourceIcon(source) {
    const iconMap = {
        'Salary': 'fas fa-money-check-alt',
        'Freelance': 'fas fa-laptop-code',
        'Investment': 'fas fa-chart-line',
        'Business': 'fas fa-briefcase',
        'Gift': 'fas fa-gift',
        'Rental Income': 'fas fa-home',
        'Bonus': 'fas fa-star',
        'Commission': 'fas fa-handshake',
        'Allowances': 'fas fa-hand-holding-usd',
        'Dividends': 'fas fa-coins',
        'Interest': 'fas fa-percentage',
        'Royalties': 'fas fa-copyright',
        'Pension': 'fas fa-umbrella-beach',
        'Social Security': 'fas fa-shield-alt',
        'Child Support': 'fas fa-child',
        'Alimony': 'fas fa-heart-broken',
        'Scholarship': 'fas fa-graduation-cap',
        'Grant': 'fas fa-award',
        'Rebate': 'fas fa-undo',
        'Refund': 'fas fa-reply',
        'Lottery': 'fas fa-dice',
        'Inheritance': 'fas fa-landmark',
        'Sale': 'fas fa-tag',
        'Other': 'fas fa-money-bill-wave'
    };
    
    return iconMap[source] || 'fas fa-money-bill-wave';
}

// Helper function to get source display name with emoji
function getSourceDisplayName(source) {
    const sourceMap = {
        'Salary': ' Salary',
        'Freelance': ' Freelance/Side-Hustle',
        'Investment': ' Investment/Dividends',
        'Business': ' Business',
        'Gift': ' Gift',
        'Rental Income': ' Rental Income',
        'Bonus': ' Bonus',
        'Commission': ' Commission',
        'Allowances': ' Allowances',
        'Dividends': ' Dividends',
        'Interest': ' Interest Income',
        'Royalties': ' Royalties',
        'Pension': ' Pension',
        'Social Security': ' Social Security',
        'Child Support': ' Child Support',
        'Alimony': ' Alimony',
        'Scholarship': ' Scholarship',
        'Grant': ' Grant',
        'Rebate': ' Rebate',
        'Refund': ' Refund',
        'Lottery': ' Lottery/Winnings',
        'Inheritance': ' Inheritance',
        'Sale': ' Sale of Items',
        'Other': ' Other'
    };
    
    return sourceMap[source] || source;
}

// Reverse mapping: display name to value
function getSourceValue(displayName) {
    const reverseMap = {
        ' Salary': 'Salary',
        ' Freelance/Side-Hustle': 'Freelance',
        ' Investment/Dividends': 'Investment',
        ' Business': 'Business',
        ' Gift': 'Gift',
        ' Rental Income': 'Rental Income',
        ' Bonus': 'Bonus',
        ' Commission': 'Commission',
        ' Allowances': 'Allowances',
        ' Dividends': 'Dividends',
        ' Interest Income': 'Interest',
        ' Royalties': 'Royalties',
        ' Pension': 'Pension',
        ' Social Security': 'Social Security',
        ' Child Support': 'Child Support',
        ' Alimony': 'Alimony',
        ' Scholarship': 'Scholarship',
        ' Grant': 'Grant',
        ' Rebate': 'Rebate',
        ' Refund': 'Refund',
        ' Lottery/Winnings': 'Lottery',
        ' Inheritance': 'Inheritance',
        ' Sale of Items': 'Sale',
        ' Other': 'Other'
    };
    
    return reverseMap[displayName] || displayName;
}

	
    // ===== UPDATED FIREBASE & AUTH FUNCTIONS =====

// Add this function at the beginning of your JavaScript (after global variables)
function setupIOSCompatibility() {
  // Detect iOS devices
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isChromeOnIOS = /CriOS/.test(navigator.userAgent);
  
  if (isIOS) {
    console.log('iOS device detected, applying compatibility fixes');
    
    // Prevent default zoom on focus for iOS
    document.addEventListener('touchstart', function() {}, {passive: true});
    
    // Fix for iOS input focus issues
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.addEventListener('focus', function() {
        setTimeout(() => {
          this.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    });
  }
}

// Update the DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', () => {
  initFirebase();
  setupEventListeners();
  checkLoginState();
  initTheme();
  setDefaultDates();
  setDefaultTargetDate();
  setupIOSCompatibility(); // ADD THIS LINE
  setupTouchEvents();
});

// Replace the initFirebase function with this improved version
function initFirebase() {
  if (typeof firebase === 'undefined') { 
    showAuthError('Firebase SDK not loaded. Please check your internet connection.'); 
    
    // Try to reload Firebase after 3 seconds
    setTimeout(() => {
      if (typeof firebase === 'undefined') {
        console.log('Attempting to reload Firebase SDK...');
        // Dynamically load Firebase if not loaded
        loadFirebaseSDK();
      }
    }, 3000);
    return; 
  }
  
  try {
    // Check if Firebase is already initialized
    if (firebase.apps.length === 0) {
      const app = firebase.initializeApp(firebaseConfig);
      console.log('Firebase initialized successfully');
    } else {
      console.log('Firebase already initialized');
    }
    
    // Initialize services
    db = firebase.firestore();
    auth = firebase.auth();
    
    // IMPORTANT: Set persistence for iOS compatibility
    if (typeof auth !== 'undefined') {
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => {
          console.log('Auth persistence set to LOCAL');
          setupAuthListeners();
        })
        .catch((error) => {
          console.error('Error setting auth persistence:', error);
          // Try SESSION persistence if LOCAL fails (for private browsing)
          auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(() => {
              console.log('Auth persistence set to SESSION (fallback)');
              setupAuthListeners();
            })
            .catch((error2) => {
              console.error('Failed to set any auth persistence:', error2);
              showAuthError('Authentication setup failed. Please try clearing browser cache.');
            });
        });
    } else {
      console.error('Firebase Auth not available');
      showAuthError('Authentication service unavailable. Please refresh the page.');
    }
    
  } catch (error) { 
    console.error('Firebase initialization error:', error);
    showAuthError('Firebase initialization failed: ' + error.message);
    
    // Provide user-friendly guidance for iOS
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      setTimeout(() => {
        alert('For best experience on iOS:\n1. Make sure "Block All Cookies" is disabled in Safari settings\n2. Try using Safari instead of Chrome\n3. Ensure you have stable internet connection');
      }, 1000);
    }
  }
}





// Add this to your main.js or script section
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.type === 'attributes' && 
        (mutation.attributeName === 'style' || 
         mutation.attributeName === 'class')) {
      const target = mutation.target;
      if (target.closest('.income-list')) {
        fixIncomeItemStyles();
      }
    }
    
    if (mutation.addedNodes.length) {
      mutation.addedNodes.forEach(node => {
        if (node.nodeType === 1 && node.closest('.income-list')) {
          setTimeout(fixIncomeItemStyles, 100);
        }
      });
    }
  });
});

// Start observing when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  const incomeList = document.querySelector('.income-list');
  if (incomeList) {
    observer.observe(incomeList, {
      attributes: true,
      childList: true,
      subtree: true,
      attributeFilter: ['style', 'class']
    });
  }
});






// Add this function to dynamically load Firebase if needed
function loadFirebaseSDK() {
  const scripts = [
    'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js',
    'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js',
    'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js'
  ];
  
  let loaded = 0;
  scripts.forEach(src => {
    const script = document.createElement('script');
    script.src = src;
    script.async = true;
    script.onload = () => {
      loaded++;
      if (loaded === scripts.length) {
        console.log('All Firebase SDKs loaded dynamically');
        initFirebase(); // Re-initialize Firebase
      }
    };
    script.onerror = () => {
      console.error('Failed to load script:', src);
      showAuthError('Failed to load required resources. Please check your internet connection.');
    };
    document.head.appendChild(script);
  });
}

// Update the setupAuthListeners function for better iOS handling
function setupAuthListeners() {
  if (!auth) {
    console.error('Auth not initialized in setupAuthListeners');
    return;
  }
  
  // Add a small delay for iOS to handle auth state properly
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const delay = isIOS ? 500 : 100;
  
  setTimeout(() => {
    auth.onAuthStateChanged((user) => {
      console.log('Auth state changed:', user ? 'User logged in' : 'No user');
      
      if (user) {
        currentUser = user;
        showMainApp();
        initAppAfterLogin();
        
        // Update last login time with error handling for iOS
        if (db) {
          db.collection('users').doc(user.uid).set({
            uid: user.uid,
            email: user.email,
            name: user.displayName || formatNameFromEmail(user.email),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            deviceInfo: navigator.userAgent.substring(0, 100)
          }, { merge: true })
          .then(() => console.log('User document updated'))
          .catch(error => {
            console.error("Error updating user document:", error);
            // Don't show error to user for this non-critical operation
          });
        }
      } else {
        currentUser = null;
        showAuthPage();
        cleanupListeners();
      }
    }, (error) => {
      console.error('Auth state listener error:', error);
      
      // iOS-specific error handling
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        if (error.code === 'auth/network-request-failed') {
          showAuthError('Network error. Please check your connection and try again.');
        } else if (error.code === 'auth/too-many-requests') {
          showAuthError('Too many attempts. Please wait a few minutes and try again.');
        }
      }
    });
  }, delay);
}

// Update the handleLogin function with improved iOS error handling
async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const loginBtn = document.getElementById('loginBtn');
  const errorDiv = document.getElementById('loginError');

  if (!email || !password) {
    showAuthError('Please enter both email and password', 'login');
    return;
  }

  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showAuthError('Please enter a valid email address', 'login');
    return;
  }

  loginBtn.disabled = true;
  loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

  try {
    // Add a small timeout for iOS to process
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    
    // Verify the user was actually signed in
    if (userCredential.user) {
      showMessage(' Login successful!', 'success');
      
      // Small delay for iOS to update UI properly
      setTimeout(() => {
        if (loginBtn) {
          loginBtn.disabled = false;
          loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Dashboard';
        }
      }, 500);
    } else {
      throw new Error('No user returned from sign in');
    }
    
  } catch (error) {
    console.error('Login error:', error);
    
    // iOS-specific error messages
    let errorMessage = 'Login failed. Please try again.';
    
    switch(error.code) {
      case 'auth/user-not-found':
      case 'auth/wrong-password':
        errorMessage = 'Invalid email or password. Please try again.';
        break;
      case 'auth/invalid-email':
        errorMessage = 'Invalid email format.';
        break;
      case 'auth/too-many-requests':
        errorMessage = 'Too many failed attempts. Please try again later or reset your password.';
        break;
      case 'auth/network-request-failed':
        errorMessage = 'Network error. Please check your internet connection.';
        break;
      case 'auth/user-disabled':
        errorMessage = 'This account has been disabled. Please contact support.';
        break;
      case 'auth/invalid-credential':
        errorMessage = 'Invalid credentials. Please check your email and password.';
        break;
      default:
        errorMessage = `Login failed: ${error.message}`;
    }
    
    showAuthError(errorMessage, 'login');
    
    loginBtn.disabled = false;
    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Dashboard';
    
    // For iOS network errors, suggest solutions
    if (error.code === 'auth/network-request-failed' && /iPad|iPhone|iPod/.test(navigator.userAgent)) {
      setTimeout(() => {
        showMessage(' iOS Tip: Try switching to Safari or disabling "Block All Cookies" in Settings', 'info');
      }, 2000);
    }
  }
}

// Update the handleSignup function similarly
async function handleSignup() {
  const name = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupConfirmPassword').value;
  const signupBtn = document.getElementById('signupBtn');
  const errorDiv = document.getElementById('signupError');

  if (!name || !email || !password || !confirmPassword) {
    showAuthError('Please fill in all fields', 'signup');
    return;
  }

  if (password.length < 6) {
    showAuthError('Password must be at least 6 characters long', 'signup');
    return;
  }

  if (password !== confirmPassword) {
    showAuthError('Passwords do not match', 'signup');
    return;
  }

  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showAuthError('Please enter a valid email address', 'signup');
    return;
  }

  signupBtn.disabled = true;
  signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';

  try {
    // Small delay for iOS
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    
    // Update profile
    await userCredential.user.updateProfile({
      displayName: name
    });
    
    // Create user document with timeout for iOS
    if (db) {
      await Promise.race([
        db.collection('users').doc(userCredential.user.uid).set({
          uid: userCredential.user.uid,
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        }),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Database timeout')), 10000)
        )
      ]);
    }
    
    showMessage(' Account created successfully!', 'success');
    
    // Small delay for iOS UI update
    setTimeout(() => {
      if (signupBtn) {
        signupBtn.disabled = false;
        signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
      }
    }, 500);
    
  } catch (error) {
    console.error('Signup error:', error);
    
    let errorMessage = 'Signup failed. Please try again.';
    
    switch(error.code) {
      case 'auth/email-already-in-use':
        errorMessage = 'Email already in use. Please login instead.';
        break;
      case 'auth/invalid-email':
        errorMessage = 'Invalid email format.';
        break;
      case 'auth/weak-password':
        errorMessage = 'Password is too weak. Please use a stronger password.';
        break;
      case 'auth/operation-not-allowed':
        errorMessage = 'Email/password accounts are not enabled. Please contact support.';
        break;
      case 'auth/network-request-failed':
        errorMessage = 'Network error. Please check your internet connection.';
        break;
      default:
        errorMessage = `Signup failed: ${error.message}`;
    }
    
    showAuthError(errorMessage, 'signup');
    
    signupBtn.disabled = false;
    signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
  }
}

// Add this function for iOS-specific fixes
function applyIOSCSSFixes() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  if (!isIOS) return;
  
  // Add specific CSS fixes for iOS
  const style = document.createElement('style');
  style.textContent = `
    /* iOS specific fixes */
    @supports (-webkit-touch-callout: none) {
      /* Prevent elastic scrolling on auth page */
      .auth-overlay {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: none;
      }
      
      /* Better input handling for iOS */
      input, select, textarea {
        font-size: 16px !important; /* Prevents zoom on focus */
        transform: translateZ(0); /* Hardware acceleration */
        -webkit-transform: translateZ(0);
      }
      
      /* Fix for Chrome on iOS */
      .auth-container {
        max-height: 90vh;
        overflow-y: auto;
      }
      
      /* Fix button tap highlights */
      button, .btn, .auth-btn {
        -webkit-tap-highlight-color: rgba(0,0,0,0.1);
      }
    }
    
    /* iOS Safari 15+ fixes */
    @supports (-webkit-touch-callout: none) and (aspect-ratio: 1/1) {
      .auth-input-group input {
        min-height: 44px; /* Minimum touch target for iOS */
      }
    }
  `;
  document.head.appendChild(style);
}

// Call this function in DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // ... existing code ...
  applyIOSCSSFixes(); // ADD THIS LINE
});

// Add this retry mechanism for Firebase operations
function withRetry(operation, maxRetries = 3, delay = 1000) {
  return new Promise((resolve, reject) => {
    let attempts = 0;
    
    function attempt() {
      attempts++;
      operation()
        .then(resolve)
        .catch(error => {
          if (attempts < maxRetries && 
              (error.code === 'network-request-failed' || 
               error.message.includes('network') ||
               error.message.includes('timeout'))) {
            console.log(`Retrying operation (${attempts}/${maxRetries})...`);
            setTimeout(attempt, delay * attempts);
          } else {
            reject(error);
          }
        });
    }
    
    attempt();
  });
}

// Update the testFirestoreConnection function to use retry
async function testFirestoreConnection() {
  try {
    await withRetry(async () => {
      // Test with a simple query
      await db.collection('expenses').where('userId', '==', currentUser.uid).limit(1).get();
    }, 2, 1500);
    
    isFirestoreReady = true;
    updateStatus('online', 'Connected ');
    showMessage(' Successfully connected to Firebase!', 'success');
    setupApp();
    
    updateDashboardFromRealtimeData();
    loadBudgets();
    loadReminders();
    
    setTimeout(() => {
      generateReport('today', 'expense', document.querySelector('#expenseReportControls .btn.active'));
      generateReport('today', 'income', document.querySelector('#incomeReportControls .btn.active'));
    }, 1000);
    
  } catch (error) {
    console.error('Firestore connection error:', error);
    updateStatus('offline', 'Connection failed');
    
    // User-friendly error for iOS
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      showError('Connection issue detected. This may be due to:\n1. Weak internet connection\n2. VPN or content blocker\n3. iOS privacy settings\n\nPlease try switching to Safari or checking your network.');
    } else {
      showError('Could not connect to database: ' + error.message);
    }
  }
}

// Add a network status monitor
function setupNetworkMonitor() {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  
  if (isIOS) {
    // Listen for online/offline events
    window.addEventListener('online', () => {
      console.log('Device came online');
      updateStatus('connecting', 'Reconnecting...');
      setTimeout(() => {
        if (currentUser) {
          testFirestoreConnection();
        }
      }, 2000);
    });
    
    window.addEventListener('offline', () => {
      console.log('Device went offline');
      updateStatus('offline', 'No connection');
      showError('Lost internet connection. Some features may not work.');
    });
    
    // Check initial network status
    if (!navigator.onLine) {
      updateStatus('offline', 'No internet');
      showError('You appear to be offline. Please check your connection.');
    }
  }
}


    // New variables for category reports
    let currentCategoryReportType = null; // 'expense' or 'income'
    
    // Real-time listeners
    let expensesListener = null;
    let incomeListener = null;
    let budgetsListener = null;
    let remindersListener = null;
    
    // New data structures
    let monthlyBudget = 0;
    let savingsGoal = { amount: 0, targetDate: '', currentSavings: 0 };
    let reminders = [];
    let budgets = [];
    let debts = [];
    
    // Store real-time data
    let allExpenses = [];
    let allIncome = [];
	let currentMonthYear = null;

    // Theme Management
    let currentTheme = 'light';

    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        enableDarkMode();
      } else {
        enableLightMode();
      }
      updateThemeToggle();
    }

    function enableDarkMode() {
      document.body.classList.add('dark-mode');
      currentTheme = 'dark';
      localStorage.setItem('theme', 'dark');
      updateThemeLabel();
    }

    function enableLightMode() {
      document.body.classList.remove('dark-mode');
      currentTheme = 'light';
      localStorage.setItem('theme', 'light');
      updateThemeLabel();
    }

    function toggleTheme() {
      if (currentTheme === 'light') {
        enableDarkMode();
      } else {
        enableLightMode();
      }
      updateThemeToggle();
    }

    function updateThemeToggle() {
      const isDarkMode = currentTheme === 'dark';
      const loginToggle = document.getElementById('themeToggle');
      const headerToggle = document.getElementById('themeToggleHeader');
      
      if (loginToggle) loginToggle.checked = isDarkMode;
      if (headerToggle) headerToggle.checked = isDarkMode;
    }

    function updateThemeLabel() {
      const themeLabel = document.getElementById('themeLabel');
      if (themeLabel) {
        themeLabel.textContent = currentTheme === 'dark' ? 'Dark Mode' : 'Light Mode';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initFirebase();
      setupEventListeners();
      checkLoginState();
      initTheme();
      setDefaultDates();
      setDefaultTargetDate();
      
      // Add touch event listeners for better mobile interaction
      setupTouchEvents();
    });
    
    function setupTouchEvents() {
      // Prevent double-tap zoom on mobile
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      
      // Improve button tap feedback on mobile
      document.querySelectorAll('.btn, .action-btn, .quick-action-btn, .btn-report').forEach(btn => {
        btn.addEventListener('touchstart', function() {
          this.style.transform = 'scale(0.98)';
        });
        
        btn.addEventListener('touchend', function() {
          this.style.transform = '';
        });
      });
    }

    function initFirebase() {
      if (typeof firebase === 'undefined') { 
        showAuthError('Firebase SDK not loaded. Please check your internet connection.'); 
        return; 
      }
      try {
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        setupAuthListeners();
        console.log('Firebase initialized successfully');
      } catch (error) { 
        console.error('Firebase initialization error:', error);
        showAuthError('Firebase initialization failed: ' + error.message); 
      }
    }

    function setupAuthListeners() {
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          showMainApp();
          initAppAfterLogin();
          
          // Update last login time in users collection
          if (db) {
            db.collection('users').doc(user.uid).set({
              uid: user.uid,
              email: user.email,
              name: user.displayName || formatNameFromEmail(user.email),
              lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
              lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).catch(error => {
              console.error("Error updating user document:", error);
            });
          }
        } else {
          currentUser = null;
          showAuthPage();
          cleanupListeners();
        }
      });
    }

    // Helper function to format name from email
    function formatNameFromEmail(email) {
      if (!email) return 'User';
      
      // Extract the part before @
      const emailPrefix = email.split('@')[0];
      
      // Remove numbers and special characters
      const cleanName = emailPrefix.replace(/[0-9._-]/g, ' ');
      
      // Capitalize first letter of each word
      const formattedName = cleanName.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ')
        .trim();
      
      // If name is empty after cleaning, return a generic name
      return formattedName || 'User';
    }

    function cleanupListeners() {
      if (expensesListener) {
        expensesListener();
        expensesListener = null;
      }
      if (incomeListener) {
        incomeListener();
        incomeListener = null;
      }
      if (budgetsListener) {
        budgetsListener();
        budgetsListener = null;
      }
      if (remindersListener) {
        remindersListener();
        remindersListener = null;
      }
      allExpenses = [];
      allIncome = [];
      budgets = [];
      reminders = [];
    }

    function checkLoginState() {
      const user = auth ? auth.currentUser : null;
      if (user) {
        showMainApp();
        initAppAfterLogin();
      } else {
        showAuthPage();
      }
    }

    function showAuthPage() {
      document.getElementById('authPage').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    }

    function showMainApp() {
      document.getElementById('authPage').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      updateUserProfile();
    }

    function updateUserProfile() {
      if (currentUser) {
        // Show email in user profile
        document.getElementById('userEmail').textContent = currentUser.email;
        
        // Get display name with proper formatting
        let displayName = currentUser.displayName;
        
        // If no display name, format from email
        if (!displayName || displayName.trim() === '') {
          displayName = formatNameFromEmail(currentUser.email);
        }
        
        // Set avatar initial (first character of display name)
        const initial = displayName.charAt(0).toUpperCase();
        document.getElementById('userAvatar').textContent = initial;
        document.getElementById('userAvatar').title = displayName;
        
        // Set app title - just use generic name without possessive
        document.getElementById('appTitle').textContent = "Financial Tracker PRO";
        
        // Set report titles - professional without personal names
        document.getElementById('expenseReportTitle').textContent = "Expense Reports";
        document.getElementById('incomeReportTitle').textContent = "Income Reports";
      }
    }

    function initAppAfterLogin() {
      // Set default dates only when first loading
      setDefaultDates();
      setDefaultTargetDate();
      loadRevealedState();
      loadSavingsGoal();
      setupEventListeners();
      testFirestoreConnection();
      setupRealtimeListeners();
	  setupNetworkMonitor(); // ADD THIS LINE 
	     setTimeout(() => {
        if (allIncome && allIncome.length > 0) {
            updateIncomeList();
			populateIncomeFilters();
        }
    }, 1000);
    
    }

    function setupRealtimeListeners() {
      if (!currentUser || !db) return;
      
      // FIXED: Expenses real-time listener - preserve original date
      expensesListener = db.collection('expenses')
        .where('userId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
          allExpenses = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            // FIXED: Don't overwrite the date if it already exists as a string
            // Only convert if it's a Firestore timestamp
            if (data.date) {
              // If date is a Firestore timestamp, convert to string
              if (data.date.toDate) {
                data.date = data.date.toDate().toISOString().split('T')[0];
              }
              // If it's already a string, leave it as is
            }
            allExpenses.push({ id: doc.id, ...data });
          });
          console.log('Expenses updated:', allExpenses.length, 'items');
          updateDashboardFromRealtimeData();
          displayExpenses(allExpenses);
		  populateExpenseFilters();
		  
          
          if (currentReportPeriod.expense) {
            generateReport(currentReportPeriod.expense, 'expense', document.querySelector(`#expenseReportControls button.active`));
          }
        }, (error) => {
          console.error('Expenses listener error:', error);
          showError('Failed to sync expenses: ' + error.message);
          updateStatus('offline', 'Sync error');
        });

      // FIXED: Income real-time listener - preserve original date
	let lastIncomeUpdate = null;
incomeListener = db.collection('income')
  .where('userId', '==', currentUser.uid)
  .onSnapshot((snapshot) => {
    const newIncome = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.date && data.date.toDate) {
        data.date = data.date.toDate().toISOString().split('T')[0];
      }
      newIncome.push({ id: doc.id, ...data });
    });
    
    // Only update if data actually changed (not just timestamp)
    const incomeChanged = JSON.stringify(newIncome) !== JSON.stringify(allIncome);
    
    if (incomeChanged) {
      console.log('Income updated:', newIncome.length, 'items');
      allIncome = newIncome;
      updateDashboardFromRealtimeData();
      
      // Use the fixed display function
      displayIncome(allIncome);
      populateIncomeFilters();
      
      if (currentReportPeriod.income) {
        generateReport(currentReportPeriod.income, 'income', document.querySelector('#incomeReportControls button.active'));
      }
    }
  }, (error) => {
    console.error('Income listener error:', error);
    showError('Failed to sync income: ' + error.message);
    updateStatus('offline', 'Sync error');
  });

      // Setup real-time listener for budgets
      budgetsListener = db.collection('budgets')
        .where('userId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
          budgets = [];
          snapshot.forEach(doc => budgets.push({ id: doc.id, ...doc.data() }));
          loadBudgets();
        }, (error) => {
          console.error('Budgets listener error:', error);
        });

      // Setup real-time listener for reminders
      remindersListener = db.collection('reminders')
        .where('userId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
          reminders = [];
          snapshot.forEach(doc => reminders.push({ id: doc.id, ...doc.data() }));
          displayReminders();
        }, (error) => {
          console.error('Reminders listener error:', error);
        });
    }
	
	function resetAuthState() {
  if (auth) {
    auth.signOut().then(() => {
      localStorage.removeItem('revealedBalances_' + currentUser?.uid);
      localStorage.removeItem('savingsGoal_' + currentUser?.uid);
      window.location.reload();
    });
  }
}

function fixIncomeListDOM() {
  // Remove any element with "income-item-clean" OR any .income-item with background gradient
  const badItems = document.querySelectorAll('.income-item-clean, .income-item[style*="gradient"], .income-item[style*="background"]');
  badItems.forEach(el => {
    if (!el.classList.contains('income-item') || el.classList.contains('income-item-clean')) {
      el.remove();
    }
  });
}
setInterval(fixIncomeListDOM, 1000); // Run every 1 second




    // FIXED: Improved date extraction function
    function getDateFromExpense(item) {
      if (!item) return new Date(0);
      
      // Try to get date from different possible fields
      let dateValue;
      
      // Check date field first
      if (item.date) {
        if (item.date instanceof Date) {
          dateValue = item.date;
        } else if (item.date.toDate) {
          // Firestore Timestamp
          dateValue = item.date.toDate();
        } else if (typeof item.date === 'string') {
          // Parse string date - handle multiple formats
          if (item.date.includes('/')) {
            const [day, month, year] = item.date.split('/');
            dateValue = new Date(year, month - 1, day);
          } else if (item.date.includes('-')) {
            // Handle ISO format or YYYY-MM-DD
            const dateParts = item.date.split('-');
            if (dateParts[0].length === 4) {
              // YYYY-MM-DD format
              const [year, month, day] = dateParts;
              dateValue = new Date(year, month - 1, day);
            } else {
              // DD-MM-YYYY format
              const [day, month, year] = dateParts;
              dateValue = new Date(year, month - 1, day);
            }
          } else {
            dateValue = new Date(item.date);
          }
        }
      }
      
      // If no date field, check timestamp
      if (!dateValue && item.timestamp) {
        if (item.timestamp.toDate) {
          dateValue = item.timestamp.toDate();
        } else if (item.timestamp instanceof Date) {
          dateValue = item.timestamp;
        }
      }
      
      // If still no date, check createdAt
      if (!dateValue && item.createdAt) {
        if (item.createdAt.toDate) {
          dateValue = item.createdAt.toDate();
        } else if (item.createdAt instanceof Date) {
          dateValue = item.createdAt;
        } else if (typeof item.createdAt === 'string') {
          dateValue = new Date(item.createdAt);
        }
      }
      
      // If still no valid date, return epoch
      if (!dateValue || isNaN(dateValue.getTime())) {
        return new Date(0);
      }
      
      return dateValue;
    }
	
	  // Function to add a new expense
    async function addExpense(expenseData) {
      try {
        const docRef = await db.collection('expenses').add({
          ...expenseData,
          userId: currentUser.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showMessage(' Expense added successfully!', 'success');
        resetExpenseForm();
        return docRef.id;
      } catch (error) {
        console.error('Error adding expense:', error);
        showMessage(' Failed to add expense: ' + error.message, 'error');
      }
    }
	
	// Function to update an existing expense
    async function updateExpense(expenseId, expenseData) {
      try {
        await db.collection('expenses').doc(expenseId).update({
          ...expenseData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showMessage(' Expense updated successfully!', 'success');
        resetExpenseForm();
        return true;
      } catch (error) {
        console.error('Error updating expense:', error);
        showMessage(' Failed to update expense: ' + error.message, 'error');
        return false;
      }
    }
    

    // ===== INCOME CRUD OPERATIONS =====
    
    // Function to add a new income
    async function addIncome(incomeData) {
      try {
        const docRef = await db.collection('income').add({
          ...incomeData,
          userId: currentUser.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showMessage(' Income added successfully!', 'success');
        resetIncomeForm();
        return docRef.id;
      } catch (error) {
        console.error('Error adding income:', error);
        showMessage(' Failed to add income: ' + error.message, 'error');
      }
    }
    
    // Function to update an existing income
    async function updateIncome(incomeId, incomeData) {
      try {
        await db.collection('income').doc(incomeId).update({
          ...incomeData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showMessage(' Income updated successfully!', 'success');
        resetIncomeForm();
        return true;
      } catch (error) {
        console.error('Error updating income:', error);
        showMessage(' Failed to update income: ' + error.message, 'error');
        return false;
      }
    }
    
    // Function to edit an income
    function editIncome(incomeId) {
      const income = allIncome.find(inc => inc.id === incomeId);
      if (!income) {
        showMessage(' Income not found', 'error');
        return;
      }
      
      // Populate the form with income data
      document.getElementById('incomeAmount').value = income.amount;
      document.getElementById('incomeSource').value = income.source;
      document.getElementById('incomeDate').value = income.date;
      document.getElementById('incomeNotes').value = income.notes || '';
      
      // Change form to edit mode
      isEditingIncome = true;
      editingIncomeId = incomeId;
      
      // Update UI for edit mode
      document.getElementById('incomeFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Income';
      document.getElementById('addIncomeBtn').innerHTML = '<i class="fas fa-save"></i> Update Income';
      document.getElementById('addIncomeBtn').onclick = () => handleIncomeSubmit();
      document.getElementById('cancelIncomeBtn').style.display = 'inline-flex';
      
      // Ensure form is expanded
      const formSection = document.getElementById('incomeFormSection');
      formSection.classList.remove('collapsed');
      
      // Scroll to form
      formSection.scrollIntoView({ behavior: 'smooth' });
      
      showMessage(' Editing income...', 'info');
    }
    
    // Function to reset income form
    function resetIncomeForm() {
      document.getElementById('incomeAmount').value = '';
      document.getElementById('incomeSource').value = 'Salary';
      document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('incomeNotes').value = '';
      
      // Reset to add mode
      isEditingIncome = false;
      editingIncomeId = null;
      
      // Reset UI to add mode
      document.getElementById('incomeFormTitle').innerHTML = '<i class="fas fa-money-bill-alt"></i> Add New Income';
      document.getElementById('addIncomeBtn').innerHTML = '<i class="fas fa-arrow-alt-circle-up"></i> Record Income';
      document.getElementById('addIncomeBtn').onclick = () => handleIncomeSubmit();
      document.getElementById('cancelIncomeBtn').style.display = 'none';
    }
    
    // Updated handleIncomeSubmit function
    async function handleIncomeSubmit() {
      if (!currentUser || !isFirestoreReady) {
        showMessage(' Please wait, app is still initializing...', 'warning');
        return;
      }
      
      const amount = parseFloat(document.getElementById('incomeAmount').value);
      const source = document.getElementById('incomeSource').value;
      const date = document.getElementById('incomeDate').value;
      const notes = document.getElementById('incomeNotes').value.trim();
      
    
      
      if (!date) {
        showMessage(' Please select a date', 'error');
        return;
      }
      
      // Prepare income data
      const incomeData = {
        amount: amount,
        source: source,
        date: date,
        notes: notes || 'No notes',
        userId: currentUser.uid
      };
      
      // Disable button to prevent double submission
      const addBtn = document.getElementById('addIncomeBtn');
      addBtn.disabled = true;
      addBtn.innerHTML = isEditingIncome ? 
        '<i class="fas fa-spinner fa-spin"></i> Updating...' : 
        '<i class="fas fa-spinner fa-spin"></i> Adding...';
      
      try {
        if (isEditingIncome && editingIncomeId) {
          await updateIncome(editingIncomeId, incomeData);
        } else {
          await addIncome(incomeData);
        }
      } finally {
        addBtn.disabled = false;
        addBtn.innerHTML = isEditingIncome ? 
          '<i class="fas fa-save"></i> Update Income' : 
          '<i class="fas fa-arrow-alt-circle-up"></i> Record Income';
      }
    }
    
    // Also add these event listeners to your setupEventListeners function:
    function setupEventListeners() {
      // Existing event listeners...
      
      // Add these new event listeners:
      document.getElementById('cancelExpenseBtn').addEventListener('click', resetExpenseForm);
      document.getElementById('cancelIncomeBtn').addEventListener('click', resetIncomeForm);
      document.getElementById('confirmDelete').addEventListener('click', deleteItem);
      document.getElementById('cancelDelete').addEventListener('click', () => {
        document.getElementById('deleteModal').style.display = 'none';
        itemToDeleteId = null;
        collectionToDelete = null;
      });
	  
	      // Enable form buttons when Firebase is ready
      document.getElementById('addBtn').disabled = !isFirestoreReady;
      document.getElementById('addIncomeBtn').disabled = !isFirestoreReady;
      // ... existing code ...
    }
	
	

// Add this function to map category names to their display versions with emojis
function getCategoryDisplayName(categoryValue) {
    const categoryMap = {
        'Yaka': ' Yaka (Electricity)',
        'Water': ' Water Bill',
        'Groceries': ' Groceries',
        'Food': ' Food & Dining',
        'Fuel': ' Fuel',
        'Transport': ' Transport',
        'Internet': ' Internet',
        'Airtime': ' Airtime',
        'Rent': ' Rent',
        'Laundry': ' Laundry',
        'Clothing': ' Clothing',
        'School Fees': ' School Fees',
        'Medical': ' Medical',
        'Savings': ' Savings',
        'Debt': ' Debt Repayment',
        'Giving': ' Giving/Donations',
        'Entertainment': ' Entertainment',
        'General': ' General',
        'Mortgage': ' Mortgage',
        'Insurance': ' Insurance',
        'Taxes': ' Taxes',
        'Home Maintenance': ' Home Maintenance',
        'Car Payment': ' Car Payment',
        'Car Repair': ' Car Repair',
        'Health Insurance': ' Health Insurance',
        'Gym Membership': ' Gym Membership',
        'Streaming Services': ' Streaming Services',
        'Mobile Data': ' Mobile Data',
        'Household Supplies': ' Household Supplies',
        'Personal Care': ' Personal Care',
        'Childcare': ' Childcare',
        'Education': ' Education',
        'Gifts': ' Gifts',
        'Donations': ' Donations',
        'Travel': ' Travel',
        'Vacation': ' Vacation',
        'Hobbies': ' Hobbies',
        'Subscriptions': ' Subscriptions',
        'Bank Fees': ' Bank Fees',
        'Business Expenses': ' Business Expenses',
        'Office Supplies': ' Office Supplies',
        'Pet Care': ' Pet Care',
        'Electronics': ' Electronics',
        'Software': ' Software',
        'Books': ' Books',
        'Alcohol': ' Alcohol',
        'Fast Food': ' Fast Food',
        'Coffee': ' Coffee',
        'Restaurants': ' Restaurants',
        'Parking': ' Parking',
        'Public Transport': ' Public Transport',
        'Taxi': ' Taxi',
        'Hotel': ' Hotel',
        'Sports': ' Sports',
        'Fitness': ' Fitness',
        'Music': ' Music',
        'Movies': ' Movies',
        'Concerts': ' Concerts',
        'Museums': ' Museums',
        'Amusement Parks': ' Amusement Parks',
        'Events': ' Events',
        'Parties': ' Parties',
        'Wedding': ' Wedding',
        'Medical Bills': ' Medical Bills',
        'Dental': ' Dental',
        'Vision': ' Vision',
        'Pharmacy': ' Pharmacy',
        'Therapy': ' Therapy',
        'Massage': ' Massage',
        'Spa': ' Spa',
        'Salon': ' Salon',
        'Barber': ' Barber',
        'Cosmetics': ' Cosmetics',
        'Skincare': ' Skincare',
        'Haircare': ' Haircare',
        'Fragrances': ' Fragrances',
        'Utilities': ' Utilities',
        'Allowances': ' Allowances',
        'Azzaro': ' Azzaro Expenses',
        'Other': ' Other'
    };
    
    return categoryMap[categoryValue] || categoryValue;
}

// Add this function for income sources too
function getSourceDisplayName(sourceValue) {
    const sourceMap = {
        'Salary': ' Salary',
        'Freelance': ' Freelance/Side-Hustle',
        'Investment': ' Investment/Dividends',
        'Business': ' Business',
        'Gift': ' Gift',
        'Rental Income': ' Rental Income',
        'Bonus': ' Bonus',
        'Commission': ' Commission',
        'Allowances': ' Allowances',
        'Dividends': ' Dividends',
        'Interest': ' Interest Income',
        'Royalties': ' Royalties',
        'Pension': ' Pension',
        'Social Security': ' Social Security',
        'Child Support': ' Child Support',
        'Alimony': ' Alimony',
        'Scholarship': ' Scholarship',
        'Grant': ' Grant',
        'Rebate': ' Rebate',
        'Refund': ' Refund',
        'Lottery': ' Lottery/Winnings',
        'Inheritance': ' Inheritance',
        'Sale': ' Sale of Items',
        'Other': ' Other'
    };
    
    return sourceMap[sourceValue] || sourceValue;
}






// Function to toggle rental fields based on income source
function toggleRentalFields() {
  const source = document.getElementById('incomeSource').value;
  const rentalEndDateGroup = document.getElementById('rentalEndDateGroup');
  const rentalBalanceGroup = document.getElementById('rentalBalanceGroup');
  
  if (source === 'Rental Income') {
    rentalEndDateGroup.style.display = 'block';
    rentalBalanceGroup.style.display = 'block';
    
    // Auto-populate rental end date (30 days from today or selected date)
    updateRentalEndDate();
  } else {
    rentalEndDateGroup.style.display = 'none';
    rentalBalanceGroup.style.display = 'none';
  }
}

// Function to update rental end date (30 days from date received)
function updateRentalEndDate() {
  const source = document.getElementById('incomeSource').value;
  const dateReceivedInput = document.getElementById('incomeDate');
  const rentalEndDateInput = document.getElementById('rentalEndDate');
  
  // Only update if source is Rental Income and date received has a value
  if (source === 'Rental Income' && dateReceivedInput.value) {
    const dateReceived = new Date(dateReceivedInput.value);
    
    // Add 30 days to the date received
    const rentalEndDate = new Date(dateReceived);
    rentalEndDate.setDate(rentalEndDate.getDate() + 30);
    
    // Format the date as YYYY-MM-DD for the input field
    const formattedDate = rentalEndDate.toISOString().split('T')[0];
    rentalEndDateInput.value = formattedDate;
  }
}

// Function to toggle rental balance input field
function toggleRentalBalanceInput() {
  const rentalBalanceSelect = document.getElementById('rentalBalance');
  const rentalBalanceAmount = document.getElementById('rentalBalanceAmount');
  
  if (rentalBalanceSelect.value === 'Custom') {
    rentalBalanceAmount.style.display = 'block';
    rentalBalanceAmount.required = true;
  } else {
    rentalBalanceAmount.style.display = 'none';
    rentalBalanceAmount.required = false;
    rentalBalanceAmount.value = '';
  }
}

// Set default date to today for date received
window.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('incomeDate').value = today;
  
  // Initialize form validation for addIncomeBtn
  const incomeAmount = document.getElementById('incomeAmount');
  const incomeSource = document.getElementById('incomeSource');
  const incomeDate = document.getElementById('incomeDate');
  const addIncomeBtn = document.getElementById('addIncomeBtn');
  
  function validateIncomeForm() {
    if (incomeAmount.value && incomeSource.value && incomeDate.value) {
      addIncomeBtn.disabled = false;
    } else {
      addIncomeBtn.disabled = true;
    }
  }
  
  incomeAmount.addEventListener('input', validateIncomeForm);
  incomeSource.addEventListener('change', validateIncomeForm);
  incomeDate.addEventListener('change', validateIncomeForm);
  
  // Initial validation
  validateIncomeForm();
});


// Function to save rental balance for a specific month
async function saveRentalBalance(monthYear, balanceAmount) {
    if (!currentUser) return;
    
    try {
        const rentalBalanceDoc = {
            userId: currentUser.uid,
            monthYear: monthYear, // Format: "YYYY-MM"
            balanceAmount: balanceAmount,
            type: 'rental_balance',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Check if rental balance already exists for this month
        const existingQuery = await db.collection('rentalBalances')
            .where('userId', '==', currentUser.uid)
            .where('monthYear', '==', monthYear)
            .limit(1)
            .get();
        
        if (!existingQuery.empty) {
            // Update existing balance
            const docId = existingQuery.docs[0].id;
            await db.collection('rentalBalances').doc(docId).update({
                balanceAmount: balanceAmount,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            // Create new balance record
            await db.collection('rentalBalances').add(rentalBalanceDoc);
        }
        
        console.log(`Rental balance saved for ${monthYear}: ${balanceAmount}`);
    } catch (error) {
        console.error('Error saving rental balance:', error);
        showMessage('Error saving rental balance: ' + error.message, 'error');
    }
}

// Function to get rental balance for a specific month
async function getRentalBalance(monthYear) {
    if (!currentUser) return 0;
    
    try {
        const query = await db.collection('rentalBalances')
            .where('userId', '==', currentUser.uid)
            .where('monthYear', '==', monthYear)
            .limit(1)
            .get();
        
        if (!query.empty) {
            const data = query.docs[0].data();
            return data.balanceAmount || 0;
        }
        return 0;
    } catch (error) {
        console.error('Error getting rental balance:', error);
        return 0;
    }
}

// Function to get all rental balances for income report
async function getAllRentalBalances(startDate, endDate) {
    if (!currentUser) return [];
    
    try {
        const query = await db.collection('rentalBalances')
            .where('userId', '==', currentUser.uid)
            .orderBy('monthYear')
            .get();
        
        const balances = [];
        query.forEach(doc => {
            const data = doc.data();
            const balanceDate = new Date(data.monthYear + '-01');
            
            // Filter by date range if provided
            if ((!startDate || balanceDate >= startDate) && (!endDate || balanceDate <= endDate)) {
                balances.push({
                    id: doc.id,
                    ...data,
                    date: balanceDate,
                    amount: data.balanceAmount
                });
            }
        });
        
        return balances;
    } catch (error) {
        console.error('Error getting rental balances:', error);
        return [];
    }
}

// Modify the income saving function to handle rental income
async function saveIncome(incomeData, isEdit = false, editId = null) {
    try {
        let rentalBalanceAmount = 0;
        let rentalMonthYear = null;
        
        // Handle rental-specific fields
        if (incomeData.source === 'Rental Income') {
            const rentalBalance = document.getElementById('rentalBalance').value;
            
            if (rentalBalance === 'Custom') {
                rentalBalanceAmount = parseInt(document.getElementById('rentalBalanceAmount').value) || 0;
            } else if (rentalBalance === 'NIL') {
                rentalBalanceAmount = 0;
            }
            
            // Extract month-year from income date
            const incomeDate = new Date(incomeData.date);
            rentalMonthYear = `${incomeDate.getFullYear()}-${String(incomeDate.getMonth() + 1).padStart(2, '0')}`;
            
            // Save rental balance for the month
            if (rentalBalanceAmount > 0) {
                await saveRentalBalance(rentalMonthYear, rentalBalanceAmount);
            }
            
            // Add rental end date if provided
            const rentalEndDate = document.getElementById('rentalEndDate').value;
            if (rentalEndDate) {
                incomeData.rentalEndDate = rentalEndDate;
            }
            
            incomeData.rentalBalance = rentalBalanceAmount;
            incomeData.rentalMonthYear = rentalMonthYear;
        }
        
        // Add type field for filtering
        incomeData.type = 'income';
        
        if (isEdit && editId) {
            // Update existing income
            await db.collection('expenses').doc(editId).update({
                ...incomeData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage('Income updated successfully!', 'success');
        } else {
            // Add new income
            await db.collection('expenses').add({
                ...incomeData,
                userId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showMessage('Income recorded successfully!', 'success');
        }
        
        // Reset form and update displays
        resetIncomeForm();
        updateAllDisplays();
        updateCharts();
        
    } catch (error) {
        console.error('Error saving income:', error);
        showMessage('Error saving income: ' + error.message, 'error');
    }
}

// Modify income report generation to include rental balances
async function generateReport(period, type, element) {
    try {
        // Get rental balances for the period
        const rentalBalances = await getAllRentalBalances();
        
        // Calculate total rental balance for the period
        let totalRentalBalance = 0;
        if (period === 'month') {
            const currentDate = new Date();
            const currentMonthYear = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            totalRentalBalance = await getRentalBalance(currentMonthYear);
        } else if (period === 'year') {
            const currentDate = new Date();
            const yearStart = new Date(currentDate.getFullYear(), 0, 1);
            const yearEnd = new Date(currentDate.getFullYear(), 11, 31);
            const yearBalances = await getAllRentalBalances(yearStart, yearEnd);
            totalRentalBalance = yearBalances.reduce((sum, balance) => sum + (balance.amount || 0), 0);
        }
        
        // Add rental balance to report
        const reportResults = document.getElementById(type === 'income' ? 'incomeReportResults' : 'expenseReportResults');
        
        // In your existing report generation code, add:
        let rentalBalanceHTML = '';
        if (type === 'income' && totalRentalBalance > 0) {
            rentalBalanceHTML = `
                <div class="report-summary-item" style="border-left: 4px solid #ff9800;">
                    <div class="label">Rental Balances</div>
                    <div class="value" style="color: #ff9800;">UGX ${totalRentalBalance.toLocaleString()}</div>
                    <div style="font-size: 0.7rem; color: var(--gray);">Unpaid rent amounts</div>
                </div>
            `;
        }
        
        // Insert this HTML into your report summary
        // You'll need to modify your existing report generation to include this
        
    } catch (error) {
        console.error('Error generating report:', error);
        showMessage('Error generating report: ' + error.message, 'error');
    }
}

// Function to display rental balance in income items
function createIncomeItemHTML(doc) {
    const data = doc.data();
    const date = data.date ? new Date(data.date.seconds * 1000).toLocaleDateString() : 'No date';
    const amount = data.amount || 0;
    const source = data.source || 'Unknown';
    const notes = data.notes || '';
    const rentalBalance = data.rentalBalance || 0;
    const rentalEndDate = data.rentalEndDate ? new Date(data.rentalEndDate).toLocaleDateString() : '';
    
    let rentalHTML = '';
    if (source === 'Rental Income') {
        rentalHTML = `
            <div style="display: flex; gap: 8px; margin-top: 3px; font-size: 0.7rem;">
                ${rentalBalance > 0 ? `<span style="color: var(--warning); font-weight: 600;">
                    <i class="fas fa-money-bill-wave"></i> Balance: UGX ${rentalBalance.toLocaleString()}
                </span>` : ''}
                ${rentalEndDate ? `<span style="color: var(--gray);">
                    <i class="fas fa-calendar-times"></i> Ends: ${rentalEndDate}
                </span>` : ''}
            </div>
        `;
    }
    
    return `
        <div class="income-item" data-id="${doc.id}">
            <div class="item-content">
                <strong>${date}</strong>
                <div>
                    <span class="category-badge source-${source.toLowerCase().replace(/\s+/g, '-')}">
                        <i class="fas fa-briefcase"></i> ${source}
                    </span>
                    ${notes ? `<span style="color: var(--gray);">${notes}</span>` : ''}
                </div>
                ${rentalHTML}
            </div>
            <div class="income-amount">UGX ${amount.toLocaleString()}</div>
            <div class="item-actions">
                <button class="action-btn edit" onclick="editIncome('${doc.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete" onclick="showDeleteModal('${doc.id}', 'income')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
}

// Initialize rental fields on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener to income source dropdown
    const incomeSourceSelect = document.getElementById('incomeSource');
    if (incomeSourceSelect) {
        incomeSourceSelect.addEventListener('change', toggleRentalFields);
    }
    
    // Add event listener to rental balance dropdown
    const rentalBalanceSelect = document.getElementById('rentalBalance');
    if (rentalBalanceSelect) {
        rentalBalanceSelect.addEventListener('change', function() {
            const rentalBalanceAmount = document.getElementById('rentalBalanceAmount');
            rentalBalanceAmount.style.display = this.value === 'Custom' ? 'block' : 'none';
        });
    }
});































































































// Helper function to get category class
function getCategoryClass(category) {
    const categoryMap = {
        'Yaka': 'category-yaka',
        'Water': 'category-water',
        'Groceries': 'category-groceries',
        'Food': 'category-food',
        'Fuel': 'category-fuel',
        'Transport': 'category-transport',
        'Internet': 'category-internet',
        'Airtime': 'category-airtime',
        'Rent': 'category-rent',
        'Laundry': 'category-laundry',
        'Clothing': 'category-clothing',
        'School Fees': 'category-school-fees',
        'Medical': 'category-medical',
        'Savings': 'category-savings',
        'Debt': 'category-debt',
        'Giving': 'category-giving',
        'Entertainment': 'category-entertainment',
        'General': 'category-general',
        'Mortgage': 'category-rent', // Map to rent
        'Insurance': 'category-other',
        'Taxes': 'category-other',
        'Home Maintenance': 'category-other',
        'Car Payment': 'category-transport',
        'Car Repair': 'category-transport',
        'Health Insurance': 'category-medical',
        'Gym Membership': 'category-entertainment',
        'Streaming Services': 'category-entertainment',
        'Mobile Data': 'category-internet',
        'Household Supplies': 'category-groceries',
        'Personal Care': 'category-general',
        'Childcare': 'category-general',
        'Education': 'category-school-fees',
        'Gifts': 'category-giving',
        'Donations': 'category-giving',
        'Travel': 'category-transport',
        'Vacation': 'category-entertainment',
        'Hobbies': 'category-entertainment',
        'Subscriptions': 'category-general',
        'Bank Fees': 'category-other',
        'Business Expenses': 'category-other',
        'Office Supplies': 'category-general',
        'Pet Care': 'category-general',
        'Electronics': 'category-general',
        'Software': 'category-general',
        'Books': 'category-entertainment',
        'Alcohol': 'category-food',
        'Fast Food': 'category-food',
        'Coffee': 'category-food',
        'Restaurants': 'category-food',
        'Parking': 'category-transport',
        'Public Transport': 'category-transport',
        'Taxi': 'category-transport',
        'Hotel': 'category-transport',
        'Sports': 'category-entertainment',
        'Fitness': 'category-entertainment',
        'Music': 'category-entertainment',
        'Movies': 'category-entertainment',
        'Concerts': 'category-entertainment',
        'Museums': 'category-entertainment',
        'Amusement Parks': 'category-entertainment',
        'Events': 'category-entertainment',
        'Parties': 'category-entertainment',
        'Wedding': 'category-giving',
        'Medical Bills': 'category-medical',
        'Dental': 'category-medical',
        'Vision': 'category-medical',
        'Pharmacy': 'category-medical',
        'Therapy': 'category-medical',
        'Massage': 'category-medical',
        'Spa': 'category-general',
        'Salon': 'category-general',
        'Barber': 'category-general',
        'Cosmetics': 'category-general',
        'Skincare': 'category-general',
        'Haircare': 'category-general',
        'Fragrances': 'category-general',
        'Utilities': 'category-water',
        'Azzaro': 'category-azzaro',
        'Other': 'category-other'
    };
    
    return categoryMap[category] || 'category-other';
}

// Helper function for category icon
function getCategoryIcon(category) {
    const iconMap = {
        'Yaka': 'fas fa-bolt',
        'Water': 'fas fa-tint',
        'Groceries': 'fas fa-shopping-basket',
        'Food': 'fas fa-utensils',
        'Fuel': 'fas fa-gas-pump',
        'Transport': 'fas fa-car',
        'Internet': 'fas fa-wifi',
        'Airtime': 'fas fa-mobile-alt',
        'Rent': 'fas fa-home',
        'Laundry': 'fas fa-tshirt',
        'Clothing': 'fas fa-tshirt',
        'School Fees': 'fas fa-graduation-cap',
        'Medical': 'fas fa-hospital',
        'Savings': 'fas fa-piggy-bank',
        'Debt': 'fas fa-credit-card',
        'Giving': 'fas fa-gift',
        'Entertainment': 'fas fa-film',
        'General': 'fas fa-box',
        'Azzaro': 'fas fa-network-wired',
        'Other': 'fas fa-ellipsis-h'
    };
    
    return iconMap[category] || 'fas fa-box';
}


	// ===== FIXED: CATEGORY MAPPING FUNCTION =====
function getCategoryDisplayName(categoryValue) {
  // Map backend category values to display names
  const categoryMap = {
    'Yaka': ' Yaka (Electricity)',
    'Water': ' Water Bill',
    'Groceries': ' Groceries',
    'Food': ' Food & Dining',
    'Fuel': ' Fuel',
    'Transport': ' Transport',
    'Internet': ' Internet',
    'Airtime': ' Airtime',
    'Rent': ' Rent',
    'Laundry': ' Laundry',
    'Clothing': ' Clothing',
    'School Fees': ' School Fees',
    'Medical': ' Medical',
    'Savings': ' Savings',
    'Debt': ' Debt Repayment',
    'Giving': ' Giving/Donations',
    'Entertainment': ' Entertainment',
    'General': ' General',
    'Mortgage': ' Mortgage',
    'Insurance': ' Insurance',
    'Taxes': ' Taxes',
    'Home Maintenance': ' Home Maintenance',
    'Car Payment': ' Car Payment',
    'Car Repair': ' Car Repair',
    'Health Insurance': ' Health Insurance',
    'Gym Membership': ' Gym Membership',
    'Streaming Services': ' Streaming Services',
    'Mobile Data': ' Mobile Data',
    'Household Supplies': ' Household Supplies',
    'Personal Care': ' Personal Care',
    'Childcare': ' Childcare',
    'Education': ' Education',
    'Gifts': ' Gifts',
    'Donations': ' Donations',
    'Travel': ' Travel',
    'Vacation': ' Vacation',
    'Hobbies': ' Hobbies',
    'Subscriptions': ' Subscriptions',
    'Bank Fees': ' Bank Fees',
    'Business Expenses': ' Business Expenses',
    'Office Supplies': ' Office Supplies',
    'Pet Care': ' Pet Care',
    'Electronics': ' Electronics',
    'Software': ' Software',
    'Books': ' Books',
    'Alcohol': ' Alcohol',
    'Fast Food': ' Fast Food',
    'Coffee': ' Coffee',
    'Restaurants': ' Restaurants',
    'Parking': ' Parking',
    'Public Transport': ' Public Transport',
    'Taxi': ' Taxi',
    'Hotel': ' Hotel',
    'Sports': ' Sports',
    'Fitness': ' Fitness',
    'Music': ' Music',
    'Movies': ' Movies',
    'Concerts': ' Concerts',
    'Museums': ' Museums',
    'Amusement Parks': ' Amusement Parks',
    'Events': ' Events',
    'Parties': ' Parties',
    'Wedding': ' Wedding',
    'Medical Bills': ' Medical Bills',
    'Dental': ' Dental',
    'Vision': ' Vision',
    'Pharmacy': ' Pharmacy',
    'Therapy': ' Therapy',
    'Massage': ' Massage',
    'Spa': ' Spa',
    'Salon': ' Salon',
    'Barber': ' Barber',
    'Cosmetics': ' Cosmetics',
    'Skincare': ' Skincare',
    'Haircare': ' Haircare',
    'Fragrances': ' Fragrances',
    'Utilities': ' Utilities',
    'Allowances': ' Allowances',
    'Azzaro': ' Azzaro Expenses',
    'Other': ' Other'
  };
  
  // Return the display name or the original if not found
  return categoryMap[categoryValue] || categoryValue;
}

// Reverse mapping: display name to value
function getCategoryValue(displayName) {
  const reverseMap = {
    ' Yaka (Electricity)': 'Yaka',
    ' Water Bill': 'Water',
    ' Groceries': 'Groceries',
    ' Food & Dining': 'Food',
    ' Fuel': 'Fuel',
    ' Transport': 'Transport',
    ' Internet': 'Internet',
    ' Airtime': 'Airtime',
    ' Rent': 'Rent',
    ' Laundry': 'Laundry',
    ' Clothing': 'Clothing',
    ' School Fees': 'School Fees',
    ' Medical': 'Medical',
    ' Savings': 'Savings',
    ' Debt Repayment': 'Debt',
    ' Giving/Donations': 'Giving',
    ' Entertainment': 'Entertainment',
    ' General': 'General',
    ' Mortgage': 'Mortgage',
    ' Insurance': 'Insurance',
    ' Taxes': 'Taxes',
    ' Home Maintenance': 'Home Maintenance',
    ' Car Payment': 'Car Payment',
    ' Car Repair': 'Car Repair',
    ' Health Insurance': 'Health Insurance',
    ' Gym Membership': 'Gym Membership',
    ' Streaming Services': 'Streaming Services',
    ' Mobile Data': 'Mobile Data',
    ' Household Supplies': 'Household Supplies',
    ' Personal Care': 'Personal Care',
    ' Childcare': 'Childcare',
    ' Education': 'Education',
    ' Gifts': 'Gifts',
    ' Donations': 'Donations',
    ' Travel': 'Travel',
    ' Vacation': 'Vacation',
    ' Hobbies': 'Hobbies',
    ' Subscriptions': 'Subscriptions',
    ' Bank Fees': 'Bank Fees',
    ' Business Expenses': 'Business Expenses',
    ' Office Supplies': 'Office Supplies',
    ' Pet Care': 'Pet Care',
    ' Electronics': 'Electronics',
    ' Software': 'Software',
    ' Books': 'Books',
    ' Alcohol': 'Alcohol',
    ' Fast Food': 'Fast Food',
    ' Coffee': 'Coffee',
    ' Restaurants': 'Restaurants',
    ' Parking': 'Parking',
    ' Public Transport': 'Public Transport',
    ' Taxi': 'Taxi',
    ' Hotel': 'Hotel',
    ' Sports': 'Sports',
    ' Fitness': 'Fitness',
    ' Music': 'Music',
    ' Movies': 'Movies',
    ' Concerts': 'Concerts',
    ' Museums': 'Museums',
    ' Amusement Parks': 'Amusement Parks',
    ' Events': 'Events',
    ' Parties': 'Parties',
    ' Wedding': 'Wedding',
    ' Medical Bills': 'Medical Bills',
    ' Dental': 'Dental',
    ' Vision': 'Vision',
    ' Pharmacy': 'Pharmacy',
    ' Therapy': 'Therapy',
    ' Massage': 'Massage',
    ' Spa': 'Spa',
    ' Salon': 'Salon',
    ' Barber': 'Barber',
    ' Cosmetics': 'Cosmetics',
    ' Skincare': 'Skincare',
    ' Haircare': 'Haircare',
    ' Fragrances': 'Fragrances',
    ' Utilities': 'Utilities',
    ' Allowances': 'Allowances',
    ' Azzaro Expenses': 'Azzaro',
    ' Other': 'Other'
  };
  
  return reverseMap[displayName] || displayName;
}



	

    function updateDashboardFromRealtimeData() {
      if (!currentUser) return;
      
      try {
        const now = new Date();
        
        // Create start and end of today in local time
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
        const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
        
        // Create start and end of this week (Sunday to Saturday)
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay()); // Start of week (Sunday)
        weekStart.setHours(0, 0, 0, 0);
        
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6); // End of week (Saturday)
        weekEnd.setHours(23, 59, 59, 999);
        
        // Create start and end of this month
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
        
        // Create start and end of this year
        const yearStart = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);
        const yearEnd = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
        
        const stats = { today: 0, week: 0, month: 0, year: 0, totalExpense: 0, totalIncome: 0, availableBalance: 0 };
        const categories = {}, weeklyData = Array(7).fill(0);
		
        // Process expenses
        allExpenses.forEach(expense => {
          const expenseDate = getDateFromExpense(expense);
          
          // Skip if invalid date
          if (isNaN(expenseDate.getTime())) return;
          
          const expenseAmount = parseFloat(expense.amount) || 0;
          stats.totalExpense += expenseAmount;
          
          // Check if it's today
          if (expenseDate >= todayStart && expenseDate <= todayEnd) {
            stats.today += expenseAmount;
          }
          
          // Check if it's within this week
          if (expenseDate >= weekStart && expenseDate <= weekEnd) {
            stats.week += expenseAmount;
          }
          
          // Check if it's this month
          if (expenseDate >= monthStart && expenseDate <= monthEnd) {
            stats.month += expenseAmount;
          }
          
          // Check if it's this year
          if (expenseDate >= yearStart && expenseDate <= yearEnd) {
            stats.year += expenseAmount;
          }
          
          // Category breakdown
          const category = expense.category || 'Other';
          categories[category] = (categories[category] || 0) + expenseAmount;
          
          // Weekly data
          const dayOfWeek = expenseDate.getDay();
          weeklyData[dayOfWeek] += expenseAmount;
        });
        
        // Process income
        allIncome.forEach(inc => { 
          stats.totalIncome += parseFloat(inc.amount) || 0; 
        });
        
        stats.availableBalance = stats.totalIncome - stats.totalExpense;
        
        updateStatsUI(stats); 
        updateCharts(categories, weeklyData);
		
	// === NEW: Update the lists and filters ===
		loadExpensesList(allExpenses);
		loadIncomeList(allIncome);
		populateFilterDropdowns();
		
        // Update savings goal with current savings
        if (savingsGoal.amount > 0) {
          savingsGoal.currentSavings = Math.max(0, stats.availableBalance);
          updateSavingsGoalUI();
        }
        
        updateStatus('online', 'Connected ');
      } catch (error) { 
        console.error('Dashboard update error:', error);
        console.error('Error details:', error.stack);
        updateStatus('offline', 'Update error');
      }
    }
	
	// ===== FIXED: EXPENSES LIST LOADING FUNCTION =====
function loadExpensesList(expensesArray) {
  const expensesList = document.getElementById('expensesList');
  if (!expensesList) return;
  
  if (!expensesArray || expensesArray.length === 0) {
    expensesList.innerHTML = '<div class="empty-state"><i class="fas fa-receipt"></i><p>No expenses found. Add your first expense above!</p></div>';
    return;
  }
  
  // Sort by date (newest first)
  const sortedExpenses = [...expensesArray].sort((a, b) => {
    const dateA = new Date(a.date || a.timestamp?.toDate?.() || a.createdAt?.toDate?.());
    const dateB = new Date(b.date || b.timestamp?.toDate?.() || b.createdAt?.toDate?.());
    return dateB - dateA;
  });
  
  let html = '';
  
  sortedExpenses.forEach(expense => {
    const amount = parseFloat(expense.amount) || 0;
    const category = expense.category || 'Other';
    const description = expense.description || 'No description';
    const date = expense.date ? new Date(expense.date).toLocaleDateString('en-US', { 
      weekday: 'short', 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    }) : 'Unknown date';
    
    // Determine category badge class
    const categoryClass = 'category-' + category.toLowerCase().replace(/\s+/g, '-');
    
    html += `
      <div class="expense-item" id="expense-${expense.id}">
        <div class="item-content">
          <strong>${date}</strong>
          <div>${description}</div>
          <span class="category-badge ${categoryClass}"><i class="fas fa-tag"></i> ${category}</span>
        </div>
        <div class="expense-amount">UGX ${amount.toLocaleString('en-US')}</div>
        <div class="item-actions">
          <button class="action-btn edit" onclick="editExpense('${expense.id}')" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="action-btn delete" onclick="showDeleteModal('${expense.id}', 'expenses')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
  });
  
  expensesList.innerHTML = html;
}

// ===== FIXED: INCOME LIST LOADING FUNCTION =====
function loadIncomeList(incomeData = allIncome) {
  const incomeListContainer = document.getElementById('incomeList');
  if (!incomeListContainer) return;
  
  if (!incomeData || incomeData.length === 0) {
    incomeListContainer.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-money-bill-alt"></i>
        <p>No income recorded yet. Add your first income above!</p>
      </div>`;
    return;
  }
  // Sort by date (newest first)
  const sortedIncome = [...incomeData].sort((a, b) => {
    const dateA = getIncomeDate(a);
    const dateB = getIncomeDate(b);
    return dateB - dateA;
  });
  
  
  let html = '';
  
   sortedIncome.forEach(income => {
    const amount = parseFloat(income.amount) || 0;
    const source = income.source || 'Other';
    const notes = income.notes || 'No notes';
    
    // Format date for display
    const dateObj = getIncomeDate(income);
    const dateStr = dateObj.toLocaleDateString('en-US', { 
      weekday: 'short', 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
    
    // Determine source badge class
    const sourceClass = 'source-' + source.toLowerCase().replace(/\s+/g, '-').replace('/', '-');
    
    html += `
      <div class="income-item" id="income-${income.id}">
        <div class="item-content">
          <strong>${dateStr}</strong>
          <div>${notes}</div>
          <span class="category-badge ${sourceClass}">
            <i class="fas fa-briefcase"></i> ${source}
          </span>
        </div>
        <div class="item-actions">
          <button class="action-btn edit" onclick="editIncome('${income.id}')" title="Edit">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn delete" onclick="showDeleteModal('${income.id}', 'income')" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `;
  });
  
  
  incomeListContainer.innerHTML = html;
  
}


// 3. Search income function
// FIXED: Search income function
function searchIncome() {
    const searchTerm = document.getElementById('searchIncome').value.toLowerCase();
    const source = document.getElementById('filterIncomeSource').value;
    const month = document.getElementById('filterIncomeMonth').value;
    
    let filtered = allIncome;
    
    // Apply source filter if set
    if (source) {
        filtered = filtered.filter(income => {
            return income.source === source || 
                   (income.source && income.source.includes(source));
        });
    }
    
    // Apply month filter if set
    if (month) {
        filtered = filtered.filter(income => {
            if (!income.date) return false;
            try {
                const incomeDate = new Date(income.date);
                const incomeMonth = incomeDate.getFullYear() + '-' + 
                                   String(incomeDate.getMonth() + 1).padStart(2, '0');
                return incomeMonth === month;
            } catch (e) {
                return false;
            }
        });
    }
    
    // Apply search term
    if (searchTerm) {
        filtered = filtered.filter(income => 
            income.notes?.toLowerCase().includes(searchTerm) ||
            income.source?.toLowerCase().includes(searchTerm) ||
            income.amount?.toString().includes(searchTerm) ||
            income.date?.toLowerCase().includes(searchTerm)
        );
    }
    
    displayIncome(filtered);
}

// FIXED: Income filtering function
function filterIncome() {
  const selectedSource = document.getElementById('filterIncomeSource').value;
  const selectedMonth = document.getElementById('filterIncomeMonth').value;
  
  let filtered = allIncome;
  
  // Apply source filter
  if (selectedSource) {
    filtered = filtered.filter(inc => inc.source === selectedSource);
  }
  
  // Apply month filter
  if (selectedMonth) {
    filtered = filtered.filter(inc => {
      const date = new Date(inc.date);
      const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      return monthYear === selectedMonth;
    });
  } else {
    // If no month selected, show current month by default
    const now = new Date();
    const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    filtered = filtered.filter(inc => {
      const date = new Date(inc.date);
      const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      return monthYear === currentMonthYear;
    });
  }
  
  displayIncome(filtered);
}












function showAllItems(type = 'both') {
  if (type === 'expense' || type === 'both') {
    displayExpenses(allExpenses);
    document.getElementById('filterExpenseMonth').value = '';
  }
  
  if (type === 'income' || type === 'both') {
    displayIncome(allIncome);
    document.getElementById('filterIncomeMonth').value = '';
  }
  
  showMessage('Showing all items from all months', 'info');
}

function showCurrentMonthItems() {
  const now = new Date();
  const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  
  // Set month filter to current month
  document.getElementById('filterExpenseMonth').value = currentMonthYear;
  document.getElementById('filterIncomeMonth').value = currentMonthYear;
  
  // Trigger filtering
  filterExpenses();
  filterIncome();
  
  showMessage('Showing current month items only', 'info');
}








// ===== SMART AI ASSISTANT FUNCTIONS =====

function analyzeFinancialData() {
  // This function runs automatically when data loads
  setTimeout(() => {
    const insightsContainer = document.getElementById('aiInsightsContainer');
    const loadingElement = document.getElementById('aiLoading');
    const insightsElement = document.getElementById('aiInsights');
    
    if (!allExpenses.length && !allIncome.length) {
      insightsElement.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 2rem; color: var(--gray); margin-bottom: 10px;">
            <i class="fas fa-database"></i>
          </div>
          <div style="font-size: 0.9rem; color: var(--text-color); margin-bottom: 8px;">
            <strong>No Data Yet</strong>
          </div>
          <div style="font-size: 0.75rem; color: var(--gray);">
            Start adding expenses and income to get personalized insights
          </div>
        </div>
      `;
    } else {
      // Calculate insights
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      
      // Current month expenses
      const currentMonthExpenses = allExpenses.filter(exp => {
        const date = new Date(exp.date);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
      });
      
      // Current month income
      const currentMonthIncome = allIncome.filter(inc => {
        const date = new Date(inc.date);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
      });
      
      // Calculate totals
      const totalIncome = currentMonthIncome.reduce((sum, inc) => sum + (parseFloat(inc.amount) || 0), 0);
      const totalExpenses = currentMonthExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
      const netBalance = totalIncome - totalExpenses;
      
      // Find top spending category
      const categoryTotals = {};
      currentMonthExpenses.forEach(exp => {
        const cat = exp.category || 'Other';
        categoryTotals[cat] = (categoryTotals[cat] || 0) + (parseFloat(exp.amount) || 0);
      });
      
      let topCategory = 'None';
      let topCategoryAmount = 0;
      Object.entries(categoryTotals).forEach(([cat, amount]) => {
        if (amount > topCategoryAmount) {
          topCategory = cat;
          topCategoryAmount = amount;
        }
      });
      
      // Generate insight based on data
      let insightMessage = '';
      let insightType = 'info';
      
      if (netBalance > 0) {
        const savingsRate = ((netBalance / totalIncome) * 100).toFixed(1);
        insightMessage = `Great! You're saving <strong style="color: #2ecc71;">${savingsRate}%</strong> of your income this month.`;
        insightType = 'success';
      } else if (netBalance < 0) {
        insightMessage = `You're overspending by <strong style="color: #e74c3c;">UGX ${Math.abs(netBalance).toLocaleString()}</strong> this month.`;
        insightType = 'danger';
      } else if (totalIncome === 0 && totalExpenses === 0) {
        insightMessage = 'Start tracking your finances to get personalized insights!';
        insightType = 'info';
      } else {
        insightMessage = 'Your income and expenses are balanced this month.';
        insightType = 'info';
      }
      
      // Build insights HTML
      insightsElement.innerHTML = `
        <div style="margin-bottom: 15px;">
          <div style="font-size: 0.85rem; color: var(--text-color); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
            <div style="width: 6px; height: 6px; background: #4834d4; border-radius: 50%;"></div>
            <strong>Current Month Insight</strong>
          </div>
          <div style="font-size: 0.95rem; padding: 10px; background: ${insightType === 'success' ? 'rgba(46, 204, 113, 0.1)' : insightType === 'danger' ? 'rgba(231, 76, 60, 0.1)' : 'rgba(52, 152, 219, 0.1)'}; border-radius: 8px; color: var(--text-color);">
            ${insightMessage}
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
          <div style="background: rgba(255, 255, 255, 0.5); border-radius: 8px; padding: 10px; border: 1px solid var(--border);">
            <div style="font-size: 0.7rem; color: var(--gray); margin-bottom: 4px;">Top Category</div>
            <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-color);">${getCategoryDisplayName(topCategory)}</div>
            <div style="font-size: 0.75rem; color: var(--gray);">UGX ${topCategoryAmount.toLocaleString()}</div>
          </div>
          
          <div style="background: rgba(255, 255, 255, 0.5); border-radius: 8px; padding: 10px; border: 1px solid var(--border);">
            <div style="font-size: 0.7rem; color: var(--gray); margin-bottom: 4px;">Transactions</div>
            <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-color);">${currentMonthExpenses.length + currentMonthIncome.length}</div>
            <div style="font-size: 0.75rem; color: var(--gray);">This month</div>
          </div>
        </div>
        
        <div style="margin-top: 15px; font-size: 0.75rem; color: var(--gray); text-align: center;">
          <i class="fas fa-lightbulb"></i> Click buttons below for detailed analysis
        </div>
      `;
    }
    
    // Hide loading, show insights
    loadingElement.style.display = 'none';
    insightsElement.style.display = 'block';
    
  }, 1500); // Simulate AI processing time
}

// AI Assistant Actions
function analyzeSpendingPatterns() {
  if (allExpenses.length === 0) {
    showMessage('Add some expenses first to analyze patterns.', 'warning');
    return;
  }
  
  const currentMonth = new Date().getMonth();
  const currentYear = new Date().getFullYear();
  
  // Get current month expenses
  const currentMonthExpenses = allExpenses.filter(exp => {
    const date = new Date(exp.date);
    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
  });
  
  // Get last month expenses for comparison
  let lastMonth = currentMonth - 1;
  let lastYear = currentYear;
  if (lastMonth < 0) {
    lastMonth = 11;
    lastYear = currentYear - 1;
  }
  
  const lastMonthExpenses = allExpenses.filter(exp => {
    const date = new Date(exp.date);
    return date.getMonth() === lastMonth && date.getFullYear() === lastYear;
  });
  
  // Calculate category breakdown
  const currentCategories = {};
  currentMonthExpenses.forEach(exp => {
    const cat = exp.category || 'Other';
    currentCategories[cat] = (currentCategories[cat] || 0) + (parseFloat(exp.amount) || 0);
  });
  
  const lastCategories = {};
  lastMonthExpenses.forEach(exp => {
    const cat = exp.category || 'Other';
    lastCategories[cat] = (lastCategories[cat] || 0) + (parseFloat(exp.amount) || 0);
  });
  
  // Find biggest change
  let biggestIncrease = { category: '', amount: 0, percent: 0 };
  let biggestDecrease = { category: '', amount: 0, percent: 0 };
  
  Object.keys(currentCategories).forEach(cat => {
    const current = currentCategories[cat] || 0;
    const last = lastCategories[cat] || 0;
    
    if (last > 0) {
      const change = ((current - last) / last) * 100;
      if (change > biggestIncrease.percent) {
        biggestIncrease = { category: cat, amount: current - last, percent: change };
      }
      if (change < biggestDecrease.percent) {
        biggestDecrease = { category: cat, amount: current - last, percent: change };
      }
    }
  });
  
  // Generate analysis report
  let analysis = '';
  
  if (biggestIncrease.percent > 20) {
    analysis += ` <strong>${getCategoryDisplayName(biggestIncrease.category)}</strong> spending increased by <strong style="color: #e74c3c;">${biggestIncrease.percent.toFixed(1)}%</strong> from last month.<br><br>`;
  }
  
  if (biggestDecrease.percent < -20) {
    analysis += ` You reduced spending on <strong>${getCategoryDisplayName(biggestDecrease.category)}</strong> by <strong style="color: #2ecc71;">${Math.abs(biggestDecrease.percent).toFixed(1)}%</strong>.<br><br>`;
  }
  
  if (!analysis) {
    analysis = 'Your spending patterns are stable compared to last month. No significant changes detected.';
  }
  
  // Show modal with analysis
  showAIModal('Spending Pattern Analysis', analysis, 'fas fa-chart-pie', '#4834d4');
}

function getSavingsAdvice() {
  const tips = [
    " <strong>Tip:</strong> Set aside 20% of every income immediately. Pay yourself first!",
    " <strong>Strategy:</strong> Use the 50/30/20 rule: 50% needs, 30% wants, 20% savings.",
    " <strong>Reminder:</strong> Cancel unused subscriptions. Save UGX 10,000/month? That's UGX 120,000/year!",
    " <strong>Goal:</strong> Build an emergency fund of 3-6 months expenses first.",
    " <strong>Idea:</strong> Round up purchases to nearest thousand and save the difference.",
    " <strong>Advice:</strong> Automate your savings. Make it invisible to your spending habits.",
    " <strong>Saving:</strong> Plan meals weekly to reduce food waste and impulse grocery spending.",
    " <strong>Transport:</strong> Consider carpooling or public transport 2 days/week to save fuel.",
    " <strong>Daily:</strong> Make coffee at home instead of buying. Save UGX 5,000/day = UGX 150,000/month!",
    " <strong>Debt:</strong> Pay off high-interest debt first. It's like earning that interest rate risk-free."
  ];
  
  const randomTip = tips[Math.floor(Math.random() * tips.length)];
  showAIModal('Savings Tips & Strategies', randomTip, 'fas fa-piggy-bank', '#2ecc71');
}

function detectOverspending() {
  const currentMonth = new Date().getMonth();
  const currentYear = new Date().getFullYear();
  
  const currentMonthExpenses = allExpenses.filter(exp => {
    const date = new Date(exp.date);
    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
  });
  
  const currentMonthIncome = allIncome.filter(inc => {
    const date = new Date(inc.date);
    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
  });
  
  const totalIncome = currentMonthIncome.reduce((sum, inc) => sum + (parseFloat(inc.amount) || 0), 0);
  const totalExpenses = currentMonthExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
  
  let message = '';
  const warningColor = '#e74c3c';
  
  if (totalIncome === 0) {
    message = 'No income recorded for this month. Add income to check overspending.';
  } else {
    const spendingRatio = (totalExpenses / totalIncome) * 100;
    
    if (spendingRatio > 100) {
      message = ` <strong>CRITICAL:</strong> You've spent <strong style="color: ${warningColor};">${spendingRatio.toFixed(1)}%</strong> of your income this month!<br><br>`;
      message += `You're overspending by <strong style="color: ${warningColor};">UGX ${(totalExpenses - totalIncome).toLocaleString()}</strong>.`;
    } else if (spendingRatio > 90) {
      message = ` <strong>WARNING:</strong> You're spending <strong style="color: ${warningColor};">${spendingRatio.toFixed(1)}%</strong> of your income.<br><br>`;
      message += `You have only <strong>UGX ${(totalIncome - totalExpenses).toLocaleString()}</strong> remaining this month.`;
    } else if (spendingRatio > 70) {
      message = ` <strong>ALERT:</strong> You've used <strong>${spendingRatio.toFixed(1)}%</strong> of your income.<br><br>`;
      message += `You're on track but watch your spending.`;
    } else {
      message = ` <strong>GOOD NEWS:</strong> You're spending only <strong style="color: #2ecc71;">${spendingRatio.toFixed(1)}%</strong> of your income.<br><br>`;
      message += `You have <strong style="color: #2ecc71;">UGX ${(totalIncome - totalExpenses).toLocaleString()}</strong> available this month.`;
    }
  }
  
  showAIModal('Overspending Detection', message, 'fas fa-exclamation-triangle', warningColor);
}

function generateFinancialReport() {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  const currentMonthExpenses = allExpenses.filter(exp => {
    const date = new Date(exp.date);
    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
  });
  
  const currentMonthIncome = allIncome.filter(inc => {
    const date = new Date(inc.date);
    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
  });
  
  const totalIncome = currentMonthIncome.reduce((sum, inc) => sum + (parseFloat(inc.amount) || 0), 0);
  const totalExpenses = currentMonthExpenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
  const netBalance = totalIncome - totalExpenses;
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                     'July', 'August', 'September', 'October', 'November', 'December'];
  
  let report = `
    <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 8px;">
      <div style="font-size: 1.2rem; font-weight: 700; color: #4834d4; margin-bottom: 10px;">${monthNames[currentMonth]} ${currentYear} Financial Report</div>
      
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
        <div style="text-align: center;">
          <div style="font-size: 0.7rem; color: var(--gray);">Income</div>
          <div style="font-size: 1.1rem; font-weight: 700; color: #2ecc71;">UGX ${totalIncome.toLocaleString()}</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 0.7rem; color: var(--gray);">Expenses</div>
          <div style="font-size: 1.1rem; font-weight: 700; color: #e74c3c;">UGX ${totalExpenses.toLocaleString()}</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 0.7rem; color: var(--gray);">Net Balance</div>
          <div style="font-size: 1.1rem; font-weight: 700; color: ${netBalance >= 0 ? '#2ecc71' : '#e74c3c'};">UGX ${netBalance.toLocaleString()}</div>
        </div>
      </div>
      
      <div style="font-size: 0.8rem; color: var(--text-color);">
        <strong>Summary:</strong> ${netBalance >= 0 ? 'Positive cash flow this month.' : 'Negative cash flow - expenses exceed income.'}
      </div>
    </div>
    
    <div style="font-size: 0.75rem; color: var(--gray);">
      <i class="fas fa-lightbulb"></i> For detailed reports, use the Export Data feature or PDF reports above.
    </div>
  `;
  
  showAIModal('Financial Report', report, 'fas fa-file-alt', '#3498db');
}

// Helper function to show AI modal
function showAIModal(title, content, icon, color) {
  // Create modal if it doesn't exist
  if (!document.getElementById('aiModal')) {
    const modalHTML = `
      <div class="modal-overlay" id="aiModal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
          <h3 style="color: ${color};"><i class="${icon}"></i> ${title}</h3>
          <div id="aiModalContent" style="max-height: 300px; overflow-y: auto; padding: 10px 0;"></div>
          <div class="modal-actions">
            <button class="btn btn-primary" onclick="document.getElementById('aiModal').style.display = 'none'">
              <i class="fas fa-times"></i> Close
            </button>
            <button class="btn" style="background: ${color}; color: white;" onclick="copyAIContent()">
              <i class="fas fa-copy"></i> Copy
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  // Update content and show
  document.getElementById('aiModalContent').innerHTML = content;
  document.getElementById('aiModal').style.display = 'flex';
}

function copyAIContent() {
  const content = document.getElementById('aiModalContent').innerText;
  navigator.clipboard.writeText(content).then(() => {
    showMessage('AI analysis copied to clipboard!', 'success');
  });
}

// Initialize AI Assistant when data loads
// Add this to the end of your loadExpenses() and loadIncome() functions:
// analyzeFinancialData();



























































// ===== UPDATED: EXPENSE FILTERING =====
 function filterExpenses() {
  const selectedCategory = document.getElementById('filterExpenseCategory').value;
  const selectedMonth = document.getElementById('filterExpenseMonth').value;
  
  let filtered = allExpenses;
  
  // Apply category filter
  if (selectedCategory) {
    filtered = filtered.filter(exp => exp.category === selectedCategory);
  }
  
  // Apply month filter
  if (selectedMonth) {
    filtered = filtered.filter(exp => {
      const date = new Date(exp.date);
      const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      return monthYear === selectedMonth;
    });
  } else {
    // If no month selected, show current month by default
    const now = new Date();
    const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    filtered = filtered.filter(exp => {
      const date = new Date(exp.date);
      const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      return monthYear === currentMonthYear;
    });
  }
  
  displayExpenses(filtered);
}

   // Extracts "YYYY-MM" string from any date format (Timestamp, String, Object)
    function getYearMonthFromItem(item) {
        if (!item) return null;
        
        let dateObj;
        
        // 1. Check 'date' field
        if (item.date) {
            if (item.date.toDate) {
                // Firestore Timestamp
                dateObj = item.date.toDate();
            } else if (item.date instanceof Date) {
                // Native Date object
                dateObj = item.date;
            } else if (typeof item.date === 'string') {
                // String date (YYYY-MM-DD or DD/MM/YYYY)
                if (item.date.includes('-')) {
                    // Assume YYYY-MM-DD
                    const parts = item.date.split('-');
                    if (parts[0].length === 4) { // YYYY-MM-DD
                        dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                    } else { // DD-MM-YYYY
                        dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                } else if (item.date.includes('/')) {
                    // Assume DD/MM/YYYY
                    const parts = item.date.split('/');
                    dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
        }
        
        // 2. Fallback to 'timestamp' if date failed
        if ((!dateObj || isNaN(dateObj.getTime())) && item.timestamp) {
            dateObj = item.timestamp.toDate ? item.timestamp.toDate() : item.timestamp;
        }

        // 3. Fallback to 'createdAt'
        if ((!dateObj || isNaN(dateObj.getTime())) && item.createdAt) {
            dateObj = item.createdAt.toDate ? item.createdAt.toDate() : item.createdAt;
        }

        // Final check if we have a valid date
        if (dateObj && !isNaN(dateObj.getTime())) {
            // Return YYYY-MM format to match dropdown values
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        return null;
    }
	
	
	

// 5. Populate income filters dropdowns
function populateIncomeFilters() {
  const sourceSelect = document.getElementById('filterIncomeSource');
  const monthSelect = document.getElementById('filterIncomeMonth');
  
  // Clear existing options except the first one
  while (sourceSelect.options.length > 1) {
    sourceSelect.remove(1);
  }
  while (monthSelect.options.length > 1) {
    monthSelect.remove(1);
  }
  
  // Get unique sources from allIncome
  const sources = [...new Set(allIncome.map(inc => inc.source))].sort();
  sources.forEach(source => {
    if (source) {
      const option = document.createElement('option');
      option.value = source;
      option.textContent = getSourceDisplayName(source);
      sourceSelect.appendChild(option);
    }
  });
  
  // === MODIFIED: Get unique months from allIncome with current month as default ===
  const months = [];
  const currentMonthYear = getCurrentMonthYear();
  
  // Always add current month even if there are no income for it
  const currentDate = new Date();
  const currentDisplayMonth = currentDate.toLocaleDateString('en-US', { 
    month: 'long', 
    year: 'numeric' 
  });
  
  // Add current month first
  if (!months.some(m => m.value === currentMonthYear)) {
    months.push({ 
      value: currentMonthYear, 
      display: currentDisplayMonth,
      isCurrent: true 
    });
  }
  
  // Add months from existing income
  allIncome.forEach(income => {
    if (income.date) {
      try {
        const date = new Date(income.date);
        if (!isNaN(date.getTime())) {
          const monthStr = date.getFullYear() + '-' + 
                         String(date.getMonth() + 1).padStart(2, '0');
          const displayMonth = date.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
          });
          
          if (!months.some(m => m.value === monthStr)) {
            months.push({ 
              value: monthStr, 
              display: displayMonth,
              isCurrent: monthStr === currentMonthYear 
            });
          }
        }
      } catch (e) {
        console.error('Error parsing date:', e);
      }
    }
  });
  
  // Sort months chronologically (newest first)
  months.sort((a, b) => b.value.localeCompare(a.value));
  
  // Add month options
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month.value;
    option.textContent = month.display;
    if (month.isCurrent) {
      option.selected = true; // Set current month as default
    }
    monthSelect.appendChild(option);
  });
}

// 6. Helper function for income date (similar to expenses)
function getIncomeDate(item) {
  if (!item) return new Date(0);
  
  let dateValue;
  
  // Check date field first
  if (item.date) {
    if (item.date instanceof Date) {
      dateValue = item.date;
    } else if (item.date.toDate) {
      // Firestore Timestamp
      dateValue = item.date.toDate();
    } else if (typeof item.date === 'string') {
      // Parse string date
      if (item.date.includes('/')) {
        const [day, month, year] = item.date.split('/');
        dateValue = new Date(year, month - 1, day);
      } else if (item.date.includes('-')) {
        const dateParts = item.date.split('-');
        if (dateParts[0].length === 4) {
          // YYYY-MM-DD format
          const [year, month, day] = dateParts;
          dateValue = new Date(year, month - 1, day);
        } else {
          // DD-MM-YYYY format
          const [day, month, year] = dateParts;
          dateValue = new Date(year, month - 1, day);
        }
      } else {
        dateValue = new Date(item.date);
      }
    }
  }
  
  // If no date field, check timestamp
  if (!dateValue && item.timestamp) {
    if (item.timestamp.toDate) {
      dateValue = item.timestamp.toDate();
    } else if (item.timestamp instanceof Date) {
      dateValue = item.timestamp;
    }
  }
  
  // If still no date, check createdAt
  if (!dateValue && item.createdAt) {
    if (item.createdAt.toDate) {
      dateValue = item.createdAt.toDate();
    } else if (item.createdAt instanceof Date) {
      dateValue = item.createdAt;
    }
  }
  
  // If still no valid date, return epoch
  if (!dateValue || isNaN(dateValue.getTime())) {
    return new Date(0);
  }
  
  return dateValue;
}


// Function to load income list initially
function loadIncomeList(incomeArray = allIncome) {
    displayIncome(incomeArray);
    
    // Populate source filter dropdown
    const sourceFilter = document.getElementById('filterIncomeSource');
    if (sourceFilter) {
        // Get unique sources
        const sources = [...new Set(incomeArray.map(item => item.source).filter(Boolean))];
        sources.sort();
        
        // Clear existing options except the first one
        sourceFilter.innerHTML = '<option value="">All Sources</option>';
        
        // Add source options
        sources.forEach(source => {
            const option = document.createElement('option');
            option.value = source;
            option.textContent = source;
            sourceFilter.appendChild(option);
        });
    }
    
    // Populate month filter dropdown
    const monthFilter = document.getElementById('filterIncomeMonth');
    if (monthFilter) {
        // Get unique months (YYYY-MM format)
        const months = [...new Set(incomeArray.map(item => {
            if (!item.date) return null;
            const date = new Date(item.date);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }).filter(Boolean))];
        
        months.sort().reverse(); // Most recent first
        
        // Clear existing options except the first one
        monthFilter.innerHTML = '<option value="">All Months</option>';
        
        // Add month options
        months.forEach(month => {
            const [year, monthNum] = month.split('-');
            const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const option = document.createElement('option');
            option.value = month;
            option.textContent = monthName;
            monthFilter.appendChild(option);
        });
    }
}

// ===== INCOME LIST MANAGEMENT & FILTERING =====

// Function to update income list with filtering
function updateIncomeList(incomeArray = allIncome) {
    const incomeListDiv = document.getElementById('incomeList');
    if (!incomeListDiv) return;

    if (incomeArray.length === 0) {
        incomeListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-money-bill-alt fa-2x"></i><p>No income records found</p></div>';
        return;
    }

    // Sort by date descending
    incomeArray.sort((a, b) => new Date(b.date) - new Date(a.date));

    let html = '';
    incomeArray.forEach(income => {
        const date = new Date(income.date);
        const formattedDate = date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
        const sourceClass = 'source-' + income.source.toLowerCase().replace(/ /g, '-');
        
        html += `
            <div class="income-item" id="income-${income.id}">
                <div class="item-content">
                    <div>
                        <strong>${formattedDate}</strong>
                        <span class="category-badge ${sourceClass}"><i class="fas fa-${getSourceIcon(income.source)}"></i> ${income.source}</span>
                    </div>
                    <div>${income.notes || ''}</div>
                </div>
                <div class="income-amount">UGX ${income.amount.toLocaleString()}</div>
                <div class="item-actions">
                    <button class="action-btn edit" onclick="editIncome('${income.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete" onclick="showDeleteModal('${income.id}', 'income')"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
    });

    incomeListDiv.innerHTML = html;
}

// ===== FIXED INCOME FILTER FUNCTIONS =====

function populateIncomeFilters() {
  const sourceSelect = document.getElementById('filterIncomeSource');
  const monthSelect = document.getElementById('filterIncomeMonth');
  
  // Clear existing options except the first one
  while (sourceSelect.options.length > 1) {
    sourceSelect.remove(1);
  }
  while (monthSelect.options.length > 1) {
    monthSelect.remove(1);
  }
  
  // Get unique sources from allIncome
  const sources = [...new Set(allIncome.map(inc => inc.source))].sort();
  sources.forEach(source => {
    if (source) {
      const option = document.createElement('option');
      option.value = source;
      option.textContent = getSourceDisplayName(source);
      sourceSelect.appendChild(option);
    }
  });
  
  // === MODIFIED: Get unique months from allIncome with current month as default ===
  const months = [];
  const currentMonthYear = getCurrentMonthYear();
  
  // Always add current month even if there are no income for it
  const currentDate = new Date();
  const currentDisplayMonth = currentDate.toLocaleDateString('en-US', { 
    month: 'long', 
    year: 'numeric' 
  });
  
  // Add current month first
  if (!months.some(m => m.value === currentMonthYear)) {
    months.push({ 
      value: currentMonthYear, 
      display: currentDisplayMonth,
      isCurrent: true 
    });
  }
  
  // Add months from existing income
  allIncome.forEach(income => {
    if (income.date) {
      try {
        const date = new Date(income.date);
        if (!isNaN(date.getTime())) {
          const monthStr = date.getFullYear() + '-' + 
                         String(date.getMonth() + 1).padStart(2, '0');
          const displayMonth = date.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
          });
          
          if (!months.some(m => m.value === monthStr)) {
            months.push({ 
              value: monthStr, 
              display: displayMonth,
              isCurrent: monthStr === currentMonthYear 
            });
          }
        }
      } catch (e) {
        console.error('Error parsing date:', e);
      }
    }
  });
  
  // Sort months chronologically (newest first)
  months.sort((a, b) => b.value.localeCompare(a.value));
  
  // Add month options
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month.value;
    option.textContent = month.display;
    if (month.isCurrent) {
      option.selected = true; // Set current month as default
    }
    monthSelect.appendChild(option);
  });
}

// Updated searchIncome function with proper filtering
function searchIncome() {
    const searchText = document.getElementById('searchIncome').value.toLowerCase();
    const selectedSource = document.getElementById('filterIncomeSource').value;
    const selectedMonth = document.getElementById('filterIncomeMonth').value;
    
    let filtered = allIncome;
    
    // Apply search text filter
    if (searchText) {
        filtered = filtered.filter(income => {
            return income.notes?.toLowerCase().includes(searchText) ||
                   income.source?.toLowerCase().includes(searchText) ||
                   income.amount?.toString().includes(searchText);
        });
    }
    
    // Apply source filter
    if (selectedSource) {
        filtered = filtered.filter(income => income.source === selectedSource);
    }
    
    // Apply month filter
    if (selectedMonth) {
        filtered = filtered.filter(income => {
            if (!income.date) return false;
            
            const [year, month] = selectedMonth.split('-');
            const incomeDate = new Date(income.date);
            
            if (isNaN(incomeDate.getTime())) return false;
            
            return incomeDate.getFullYear() === parseInt(year) &&
                   (incomeDate.getMonth() + 1) === parseInt(month);
        });
    }
    
    // Sort by date (most recent first)
    filtered.sort((a, b) => {
        const dateA = a.date ? new Date(a.date) : new Date(0);
        const dateB = b.date ? new Date(b.date) : new Date(0);
        return dateB - dateA;
    });
    
    // Display filtered results
    displayIncome(filtered);
}




/// FIXED: Search expenses function
function searchExpenses() {
  const searchTerm = document.getElementById('searchExpenses').value.toLowerCase();
  let filteredExpenses = allExpenses; // You need to ensure 'allExpenses' is a global variable
  
  if (searchTerm) {
    filteredExpenses = filteredExpenses.filter(expense => 
      (expense.category && expense.category.toLowerCase().includes(searchTerm)) ||
      (expense.description && expense.description.toLowerCase().includes(searchTerm)) ||
      (expense.amount && expense.amount.toString().includes(searchTerm))
    );
  }
  
  // Apply the current filters on the search result
  const selectedCategory = document.getElementById('filterExpenseCategory').value;
  const selectedMonth = document.getElementById('filterExpenseMonth').value;
  
  if (selectedCategory) {
    filteredExpenses = filteredExpenses.filter(expense => expense.category === selectedCategory);
  }
  
  if (selectedMonth) {
    filteredExpenses = filteredExpenses.filter(expense => {
      const expenseDate = new Date(expense.date);
      const expenseMonth = expenseDate.getFullYear() + '-' + (expenseDate.getMonth() + 1).toString().padStart(2, '0');
      return expenseMonth === selectedMonth;
    });
  }
  
  displayExpenses(filteredExpenses);
}

// FIXED: Search income function
function searchIncome() {
    const searchTerm = document.getElementById('searchIncome').value.toLowerCase();
    const source = document.getElementById('filterIncomeSource').value;
    const month = document.getElementById('filterIncomeMonth').value;
    
    let filtered = allIncome;
    
    // Apply source filter if set
    if (source) {
        filtered = filtered.filter(income => {
            return income.source === source || 
                   (income.source && income.source.includes(source));
        });
    }
    
    // Apply month filter if set
    if (month) {
        filtered = filtered.filter(income => {
            if (!income.date) return false;
            try {
                const incomeDate = new Date(income.date);
                const incomeMonth = incomeDate.getFullYear() + '-' + 
                                   String(incomeDate.getMonth() + 1).padStart(2, '0');
                return incomeMonth === month;
            } catch (e) {
                return false;
            }
        });
    }
    
    // Apply search term
    if (searchTerm) {
        filtered = filtered.filter(income => 
            income.notes?.toLowerCase().includes(searchTerm) ||
            income.source?.toLowerCase().includes(searchTerm) ||
            income.amount?.toString().includes(searchTerm) ||
            income.date?.toLowerCase().includes(searchTerm)
        );
    }
    
    displayIncome(filtered);
}

// ===== FIXED: FILTER DROPDOWN POPULATION =====
function populateFilterDropdowns() {
  // Populate expense category filter
  const categoryFilter = document.getElementById('filterExpenseCategory');
  if (categoryFilter) {
    const categories = new Set(['All Categories']);
    allExpenses.forEach(expense => {
      if (expense.category) {
        // Use display name if available, otherwise convert value to display name
        const displayName = expense.categoryDisplay || getCategoryDisplayName(expense.category) || expense.category;
        categories.add(displayName);
      }
    });
    
    const categoriesArray = Array.from(categories);
    categoryFilter.innerHTML = categoriesArray.map(cat => {
      if (cat === 'All Categories') {
        return '<option value="">All Categories</option>';
      }
      const value = getCategoryValue(cat) || cat;
      return `<option value="${value}">${cat}</option>`;
    }).join('');
  }
  
  // Populate expense month filter
  const monthFilter = document.getElementById('filterExpenseMonth');
  if (monthFilter) {
    const months = ['All Months'];
    allExpenses.forEach(expense => {
      if (expense.date) {
        const date = new Date(expense.date);
        const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        if (!months.some(m => m.includes(monthYear))) {
          months.push(monthYear);
        }
      }
    });
    
    monthFilter.innerHTML = months.map(month => {
      if (month === 'All Months') return '<option value="">All Months</option>';
      const [year, monthNum] = month.split('-');
      const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      return `<option value="${month}">${monthName}</option>`;
    }).join('');
  }
  
  // Populate income source filter
  const sourceFilter = document.getElementById('filterIncomeSource');
  if (sourceFilter) {
    const sources = ['All Sources'];
    allIncome.forEach(income => {
      if (income.source && !sources.includes(income.source)) {
        sources.push(income.source);
      }
    });
    
    sourceFilter.innerHTML = sources.map(src => 
      `<option value="${src === 'All Sources' ? '' : src}">${src}</option>`
    ).join('');
  }
  
  // Populate income month filter
  const incomeMonthFilter = document.getElementById('filterIncomeMonth');
  if (incomeMonthFilter) {
    const months = ['All Months'];
    allIncome.forEach(income => {
      if (income.date) {
        const date = new Date(income.date);
        const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        if (!months.some(m => m.includes(monthYear))) {
          months.push(monthYear);
        }
      }
    });
    
    incomeMonthFilter.innerHTML = months.map(month => {
      if (month === 'All Months') return '<option value="">All Months</option>';
      const [year, monthNum] = month.split('-');
      const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      return `<option value="${month}">${monthName}</option>`;
    }).join('');
  }
}

	

    // ===== AUTH FUNCTIONS =====
    function showAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      if (tab === 'login') {
        document.querySelector('.auth-tab:nth-child(1)').classList.add('active');
        document.getElementById('loginForm').classList.add('active');
      } else {
        document.querySelector('.auth-tab:nth-child(2)').classList.add('active');
        document.getElementById('signupForm').classList.add('active');
      }
    }

    async function handleLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      const errorDiv = document.getElementById('loginError');

      if (!email || !password) {
        showAuthError('Please enter both email and password', 'login');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

      try {
        await auth.signInWithEmailAndPassword(email, password);
        showMessage(' Login successful!', 'success');
      } catch (error) {
        console.error('Login error:', error);
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          showAuthError('Invalid email or password. Please try again.', 'login');
        } else if (error.code === 'auth/invalid-email') {
          showAuthError('Invalid email format.', 'login');
        } else if (error.code === 'auth/too-many-requests') {
          showAuthError('Too many failed attempts. Please try again later.', 'login');
        } else if (error.code === 'auth/invalid-credential') {
          showAuthError('Invalid credentials. Please check your email and password.', 'login');
        } else {
          showAuthError('Login failed: ' + error.message, 'login');
        }
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Dashboard';
      }
    }

    async function handleSignup() {
      const name = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('signupConfirmPassword').value;
      const signupBtn = document.getElementById('signupBtn');
      const errorDiv = document.getElementById('signupError');

      if (!name || !email || !password || !confirmPassword) {
        showAuthError('Please fill in all fields', 'signup');
        return;
      }

      if (password.length < 6) {
        showAuthError('Password must be at least 6 characters long', 'signup');
        return;
      }

      if (password !== confirmPassword) {
        showAuthError('Passwords do not match', 'signup');
        return;
      }

      signupBtn.disabled = true;
      signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        await userCredential.user.updateProfile({
          displayName: name
        });
        
        // Create user document with proper permissions
        await db.collection('users').doc(userCredential.user.uid).set({
          uid: userCredential.user.uid,
          name: name,
          email: email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showMessage(' Account created successfully!', 'success');
      } catch (error) {
        console.error('Signup error:', error);
        if (error.code === 'auth/email-already-in-use') {
          showAuthError('Email already in use. Please login instead.', 'signup');
        } else if (error.code === 'auth/invalid-email') {
          showAuthError('Invalid email format.', 'signup');
        } else if (error.code === 'auth/weak-password') {
          showAuthError('Password is too weak. Please use a stronger password.', 'signup');
        } else {
          showAuthError('Signup failed: ' + error.message, 'signup');
        }
        signupBtn.disabled = false;
        signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
      }
    }

    function showAuthError(message, formType) {
      const errorDiv = document.getElementById(formType + 'Error');
      errorDiv.querySelector('span').textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => errorDiv.classList.remove('show'), 5000);
    }

    async function logout() {
      try {
        cleanupListeners();
        await auth.signOut();
        showMessage('Logged out successfully', 'success');
        showAuthPage();
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // ===== FIREBASE DATA FUNCTIONS =====
    // Helper function to add user data to document
    function addUserData(data) {
      return {
        ...data,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: new Date().toISOString()
      };
    }

    async function testFirestoreConnection() {
      try {
        // Test with a simple query
        await db.collection('expenses').where('userId', '==', currentUser.uid).limit(1).get();
        isFirestoreReady = true;
        updateStatus('online', 'Connected ');
        showMessage(' Successfully connected to Firebase!', 'success');
        setupApp();
        
        updateDashboardFromRealtimeData();
        loadBudgets();
        loadReminders();
        
        setTimeout(() => {
          generateReport('today', 'expense', document.querySelector('#expenseReportControls .btn.active'));
          generateReport('today', 'income', document.querySelector('#incomeReportControls .btn.active'));
        }, 1000);
      } catch (error) {
        console.error('Firestore connection error:', error);
        updateStatus('offline', 'Connection failed');
        showError('Could not connect to database: ' + error.message);
      }
    }

    function setupEventListeners() {
      document.getElementById('loginBtn')?.addEventListener('click', handleLogin);
      document.getElementById('signupBtn')?.addEventListener('click', handleSignup);
      
      document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
      });
      
      document.getElementById('signupConfirmPassword')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSignup();
      });
      
      document.getElementById('themeToggle')?.addEventListener('change', toggleTheme);
      document.getElementById('themeToggleHeader')?.addEventListener('change', toggleTheme);
      
      // FIXED: Added direct onclick handlers for form submissions
      document.getElementById('cancelDelete')?.addEventListener('click', hideDeleteModal);
      document.getElementById('confirmDelete')?.addEventListener('click', deleteItem);
      document.getElementById('cancelExpenseBtn')?.addEventListener('click', cancelEditExpense);
      document.getElementById('cancelIncomeBtn')?.addEventListener('click', cancelEditIncome);
      document.getElementById('cancelBudgetBtn')?.addEventListener('click', cancelEditBudget);
      document.getElementById('cancelReminderBtn')?.addEventListener('click', cancelEditReminder);
      
      // FIXED: Add Enter key listeners for form submissions
      document.getElementById('amount')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleExpenseSubmit();
      });
      
      document.getElementById('incomeAmount')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleIncomeSubmit();
      });
      
      document.getElementById('budgetAmount')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleBudgetSubmit();
      });
      
      document.getElementById('reminderTitle')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleReminderSubmit();
      });
    }
    
    function toggleForm(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');
    }
    
    function toggleList(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');
    }

    // FIXED: setDefaultDates now only sets dates if fields are actually empty
    function setDefaultDates() {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      
      // Only set default dates if fields are truly empty (not just whitespace)
      const expenseDateField = document.getElementById('date');
      const incomeDateField = document.getElementById('incomeDate');
      const budgetMonthField = document.getElementById('budgetMonth');
      const reminderDateField = document.getElementById('reminderDueDate');
      
      if (expenseDateField && (!expenseDateField.value || expenseDateField.value.trim() === '')) {
        expenseDateField.value = todayStr;
      }
      if (incomeDateField && (!incomeDateField.value || incomeDateField.value.trim() === '')) {
        incomeDateField.value = todayStr;
      }
      if (budgetMonthField && (!budgetMonthField.value || budgetMonthField.value.trim() === '')) {
        budgetMonthField.value = currentMonth;
      }
      if (reminderDateField && (!reminderDateField.value || reminderDateField.value.trim() === '')) {
        reminderDateField.value = todayStr;
      }
      
      const fromDate = new Date(); 
      fromDate.setDate(fromDate.getDate() - 30);
      const defaultFrom = fromDate.toISOString().split('T')[0];
      
      const expenseFromField = document.getElementById('expenseFromDate');
      const expenseToField = document.getElementById('expenseToDate');
      const incomeFromField = document.getElementById('incomeFromDate');
      const incomeToField = document.getElementById('incomeToDate');
      
      if (expenseFromField && (!expenseFromField.value || expenseFromField.value.trim() === '')) {
        expenseFromField.value = defaultFrom;
      }
      if (expenseToField && (!expenseToField.value || expenseToField.value.trim() === '')) {
        expenseToField.value = todayStr;
      }
      if (incomeFromField && (!incomeFromField.value || incomeFromField.value.trim() === '')) {
        incomeFromField.value = defaultFrom;
      }
      if (incomeToField && (!incomeToField.value || incomeToField.value.trim() === '')) {
        incomeToField.value = todayStr;
      }
      
      // Set default dates for category report modal
      const categoryFromField = document.getElementById('categoryReportFromDate');
      const categoryToField = document.getElementById('categoryReportToDate');
      
      if (categoryFromField && (!categoryFromField.value || categoryFromField.value.trim() === '')) {
        categoryFromField.value = defaultFrom;
      }
      if (categoryToField && (!categoryToField.value || categoryToField.value.trim() === '')) {
        categoryToField.value = todayStr;
      }
    }
    
    function setDefaultTargetDate() {
      const nextYear = new Date();
      nextYear.setFullYear(nextYear.getFullYear() + 1);
      const targetDateField = document.getElementById('targetDate');
      if (targetDateField && (!targetDateField.value || targetDateField.value.trim() === '')) {
        targetDateField.value = nextYear.toISOString().split('T')[0];
      }
    }

    function showAbout() { document.getElementById('aboutModal').style.display = 'flex'; }
    function showPrivacy() { alert('Privacy Policy: Your data is stored securely in Firebase and isolated per user. We do not share your data with third parties.'); }
    function showTerms() { alert('Terms of Service: By using this platform, you agree to use it for personal financial tracking only.'); }
    function showContact() { alert('Contact: For support or inquiries, please contact support@financialtracker.com'); }
    
    function showSavingsCalculator() { 
      document.getElementById('savingsCalculatorModal').style.display = 'flex'; 
    }
    
    function showYearlyOverview() { 
      document.getElementById('yearlyOverviewModal').style.display = 'flex';
      loadYearlyOverview();
    }
    
    function showDebtTracker() {
      document.getElementById('debtTrackerModal').style.display = 'flex';
    }
    
    // NEW: Category Report Modal
    function showCategoryReportModal(reportType) {
      currentCategoryReportType = reportType;
      const modal = document.getElementById('categoryReportModal');
      const title = document.getElementById('categoryReportTitle');
      const label = document.getElementById('categoryReportLabel');
      const select = document.getElementById('reportCategorySelect');
      
      // Clear previous results
      document.getElementById('categoryReportResults').style.display = 'none';
      document.getElementById('categoryReportContent').innerHTML = '';
      
      if (reportType === 'expense') {
        title.textContent = 'Generate Expense Category Report';
        label.textContent = 'Select Expense Category';
        
        // Get unique categories from expenses
        const categories = [...new Set(allExpenses.map(e => e.category || 'Other'))].sort();
        
        select.innerHTML = '<option value="">-- Select Category --</option>';
        categories.forEach(category => {
          select.innerHTML += `<option value="${category}">${category}</option>`;
        });
      } else {
        title.textContent = 'Generate Income Source Report';
        label.textContent = 'Select Income Source';
        
        // Get unique sources from income
        const sources = [...new Set(allIncome.map(i => i.source || 'Other'))].sort();
        
        select.innerHTML = '<option value="">-- Select Source --</option>';
        sources.forEach(source => {
          select.innerHTML += `<option value="${source}">${source}</option>`;
        });
      }
      
      // Set default dates
      const fromDate = new Date();
      fromDate.setDate(fromDate.getDate() - 30);
      document.getElementById('categoryReportFromDate').value = fromDate.toISOString().split('T')[0];
      document.getElementById('categoryReportToDate').value = new Date().toISOString().split('T')[0];
      
      modal.style.display = 'flex';
    }
    
    // NEW: Generate category report
    async function generateCategoryReport() {
      const category = document.getElementById('reportCategorySelect').value;
      const fromDate = document.getElementById('categoryReportFromDate').value;
      const toDate = document.getElementById('categoryReportToDate').value;
      
      if (!category) {
        showError('Please select a category/source');
        return;
      }
      
      if (!fromDate || !toDate) {
        showError('Please select date range');
        return;
      }
      
      if (new Date(fromDate) > new Date(toDate)) {
        showError('From date cannot be after to date');
        return;
      }
      
      const startDate = new Date(fromDate);
      startDate.setHours(0, 0, 0, 0);
      const endDate = new Date(toDate);
      endDate.setHours(23, 59, 59, 999);
      
      try {
        let totalAmount = 0;
        let items = [];
        const isExpense = currentCategoryReportType === 'expense';
        
        const dataToFilter = isExpense ? allExpenses : allIncome;
        const filterField = isExpense ? 'category' : 'source';
        
        dataToFilter.forEach(item => {
          const itemDate = getDateFromExpense(item);
          
          if (isNaN(itemDate.getTime())) return;
          
          if (itemDate >= startDate && itemDate <= endDate) {
            if (item[filterField] === category) {
              const itemAmount = parseFloat(item.amount) || 0;
              totalAmount += itemAmount;
              items.push({ ...item });
            }
          }
        });
        
        // Sort by date descending
        items.sort((a, b) => {
          const dateA = getDateFromExpense(a);
          const dateB = getDateFromExpense(b);
          return dateB - dateA;
        });
        
        // Display results
        const resultsDiv = document.getElementById('categoryReportResults');
        const contentDiv = document.getElementById('categoryReportContent');
        
        let html = `
          <div class="report-summary" style="grid-template-columns: 1fr 1fr; margin-bottom: 20px;">
            <div class="report-summary-item" style="border: 1px solid ${isExpense ? 'var(--danger)' : 'var(--success)'};">
              <div class="label" style="color: ${isExpense ? 'var(--danger)' : 'var(--success)'};">Total ${isExpense ? 'Expenses' : 'Income'}</div>
              <div class="value" style="color: ${isExpense ? 'var(--danger)' : 'var(--success)'};">${formatCurrency(totalAmount)}</div>
            </div>
            <div class="report-summary-item">
              <div class="label">Total Transactions</div>
              <div class="value">${items.length}</div>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <h5 style="color: var(--gray); font-size: 0.9rem; margin-bottom: 10px;">Period: ${startDate.toLocaleDateString('en-UG')} to ${endDate.toLocaleDateString('en-UG')}</h5>
            <h5 style="color: var(--primary); font-size: 1rem; margin-bottom: 10px;">${isExpense ? 'Category' : 'Source'}: <strong>${category}</strong></h5>
          </div>
        `;
        
        if (items.length > 0) {
          html += `<h5 style="color: var(--gray); font-size: 0.9rem; margin-bottom: 10px;">Transaction Details</h5>`;
          html += `<div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px;">`;
          
          items.forEach(item => {
            const date = getDateFromExpense(item);
            const description = isExpense ? (item.description || '') : (item.notes || '');
            const otherField = isExpense ? '' : '';
            
            html += `
              <div class="expense-item" style="padding: 8px; border-bottom: 1px solid var(--border); margin-bottom: 6px;">
                <div class="item-content">
                  <span style="font-weight:600; font-size:0.9rem;">${date.toLocaleDateString('en-UG')}</span>
                  <div style="font-size:0.85rem; color:var(--gray); margin-top:5px;">${description}</div>
                </div>
                <div class="expense-amount ${isExpense ? '' : 'income-amount'}" style="font-size:1rem; color:${isExpense ? 'var(--danger)' : 'var(--success)'}; -webkit-text-fill-color: initial;">
                  ${formatCurrency(item.amount)}
                </div>
              </div>
            `;
          });
          
          html += `</div>`;
          
          // Add export buttons
          html += `
            <div style="margin-top: 20px; display: flex; gap: 10px;">
              <button class="btn ${isExpense ? 'btn-danger' : 'btn-success'}" onclick="downloadCategoryPDF('${category}', '${fromDate}', '${toDate}')">
                <i class="fas fa-file-pdf"></i> Download PDF
              </button>
              <button class="btn btn-primary" onclick="exportCategoryCSV('${category}', '${fromDate}', '${toDate}')">
                <i class="fas fa-file-csv"></i> Export CSV
              </button>
            </div>
          `;
        } else {
          html += `<div class="empty-state" style="padding: 20px;"><h4>No transactions found for ${category} in selected period</h4></div>`;
        }
        
        contentDiv.innerHTML = html;
        resultsDiv.style.display = 'block';
        
        // Store data for export
        window.currentCategoryReportData = {
          category,
          fromDate,
          toDate,
          totalAmount,
          items,
          isExpense,
          reportType: currentCategoryReportType
        };
        
        showMessage(` ${isExpense ? 'Category' : 'Source'} report generated for ${category}`, 'success');
      } catch (error) {
        showError('Failed to generate category report: ' + error.message);
      }
    }
    
    // NEW: Export category CSV
    function exportCategoryCSV(category, fromDate, toDate) {
      if (!window.currentCategoryReportData) {
        showError('No report data available to export.');
        return;
      }
      
      const reportData = window.currentCategoryReportData;
      
      try {
        let csvContent = '';
        const headers = reportData.isExpense ? 
          ['Date', 'Category', 'Description', 'Amount (UGX)'] : 
          ['Date', 'Source', 'Notes', 'Amount (UGX)'];
        
        csvContent += headers.join(',') + '\n';
        
        reportData.items.forEach(item => {
          const date = getDateFromExpense(item);
          const description = reportData.isExpense ? (item.description || '') : (item.notes || '');
          const amount = item.amount || 0;
          
          csvContent += `"${date.toLocaleDateString('en-UG')}","${category}","${description.replace(/"/g, '""')}",${amount}\n`;
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${reportData.isExpense ? 'expense' : 'income'}_${category}_${fromDate}_to_${toDate}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showMessage(' CSV exported successfully!', 'success');
      } catch (error) {
        showError('CSV export failed: ' + error.message);
      }
    }
    
    // NEW: Download category PDF
    function downloadCategoryPDF(category, fromDate, toDate) {
      if (!window.currentCategoryReportData) {
        showError('No report data available to download.');
        return;
      }
      
      const reportData = window.currentCategoryReportData;
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const isExpense = reportData.isExpense;
        const title = isExpense ? 'Expense Category Report' : 'Income Source Report';
        const fieldName = isExpense ? 'Category' : 'Source';
        const tableColor = isExpense ? [220, 53, 69] : [40, 167, 69];
        
        doc.setFontSize(18);
        doc.setTextColor(67, 97, 238);
        doc.text(`Financial Tracker PRO - ${title}`, 105, 20, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`${fieldName}: ${category}`, 105, 30, { align: 'center' });
        doc.text(`Period: ${fromDate} to ${toDate}`, 105, 38, { align: 'center' });
        
        let yPos = 50;
        
        doc.setFontSize(14);
        doc.setTextColor(tableColor[0], tableColor[1], tableColor[2]);
        doc.text('Summary', 20, yPos);
        yPos += 10;
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.text(`Total ${isExpense ? 'Expenses' : 'Income'}: ${formatCurrency(reportData.totalAmount)}`, 20, yPos);
        yPos += 7;
        doc.text(`Total Transactions: ${reportData.items.length}`, 20, yPos);
        yPos += 15;
        
        if (reportData.items.length > 0) {
          doc.setFontSize(14);
          doc.setTextColor(tableColor[0], tableColor[1], tableColor[2]);
          doc.text('Transaction Details', 20, yPos);
          yPos += 10;
          
          const detailTable = reportData.items.map(item => {
            const date = getDateFromExpense(item);
            const description = isExpense ? (item.description || '-') : (item.notes || '-');
            return [
              date.toLocaleDateString('en-UG'),
              category,
              description,
              formatCurrency(item.amount || 0)
            ];
          });
          
          const headers = isExpense ? 
            ['Date', 'Category', 'Description', 'Amount'] : 
            ['Date', 'Source', 'Notes', 'Amount'];
          
          doc.autoTable({
            startY: yPos,
            head: [headers],
            body: detailTable,
            headStyles: { fillColor: tableColor }
          });
        }
        
        doc.save(`${isExpense ? 'expense' : 'income'}_${category}_report_${fromDate}_to_${toDate}.pdf`);
        showMessage(' PDF Downloaded', 'success');
      } catch (error) {
        showError('PDF Error: ' + error.message);
      }
    }
    
    function showQuickAddExpense() {
      const formSection = document.getElementById('expenseFormSection');
      formSection.classList.remove('collapsed');
      formSection.scrollIntoView({ behavior: 'smooth' });
      document.getElementById('amount').focus();
    }
    
    function showQuickAddIncome() {
      const formSection = document.getElementById('incomeFormSection');
      formSection.classList.remove('collapsed');
      formSection.scrollIntoView({ behavior: 'smooth' });
      document.getElementById('incomeAmount').focus();
    }

    function loadRevealedState() {
      const savedState = localStorage.getItem('revealedBalances_' + currentUser.uid);
      if (savedState) {
        revealedBalances = JSON.parse(savedState);
        Object.keys(revealedBalances).forEach(period => {
          const element = document.getElementById(`${period}Total`) || document.getElementById(`${period}Value`);
          if (element) {
            if (revealedBalances[period]) element.classList.remove('hidden');
            else element.classList.add('hidden');
          }
        });
      }
    }
    
    function loadSavingsGoal() {
      const savedGoal = localStorage.getItem('savingsGoal_' + currentUser.uid);
      if (savedGoal) {
        savingsGoal = JSON.parse(savedGoal);
        updateSavingsGoalUI();
      }
    }
    
    function saveSavingsGoal() {
      localStorage.setItem('savingsGoal_' + currentUser.uid, JSON.stringify(savingsGoal));
    }
    
    function updateSavingsGoalUI() {
      if (savingsGoal.amount > 0) {
        document.getElementById('savingsGoalValue').textContent = formatCurrency(savingsGoal.amount);
        const progress = savingsGoal.currentSavings > 0 ? 
          Math.min(100, Math.round((savingsGoal.currentSavings / savingsGoal.amount) * 100)) : 0;
        document.getElementById('savingsGoalProgress').textContent = `${progress}% achieved`;
        
        if (revealedBalances.savingsGoal) {
          document.getElementById('savingsGoalValue').classList.remove('hidden');
        } else {
          document.getElementById('savingsGoalValue').classList.add('hidden');
        }
      }
    }
    
    function saveRevealedState() { 
      localStorage.setItem('revealedBalances_' + currentUser.uid, JSON.stringify(revealedBalances)); 
    }
    
    function toggleBalance(period) {
      const element = document.getElementById(`${period}Total`) || document.getElementById(`${period}Value`);
      const card = document.getElementById(`${period}Card`);
      if (!element || !card) return;
      card.classList.add('tapped'); 
      setTimeout(() => card.classList.remove('tapped'), 500);
      
      if (element.classList.contains('hidden')) { 
        element.classList.remove('hidden'); 
        revealedBalances[period] = true; 
        showMessage(` ${period.replace(/([A-Z])/g, ' $1')} revealed!`, 'info'); 
      } else { 
        element.classList.add('hidden'); 
        revealedBalances[period] = false; 
        showMessage(` ${period.replace(/([A-Z])/g, ' $1')} hidden`, 'info'); 
      }
      saveRevealedState();
    }
    
// Global variable to track if all balances are revealed
let allBalancesRevealed = false;

function toggleAllBalances() {
    if (!allBalancesRevealed) {
        // Reveal all balances
        Object.keys(revealedBalances).forEach(balanceId => {
            revealedBalances[balanceId] = true;
        });
        
        // Update UI
        updateBalanceVisibility();
        
        // Update button text
        const revealBtn = document.querySelector('.reveal-all-btn');
        if (revealBtn) {
            revealBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Tap to blur all balances';
            revealBtn.style.background = 'linear-gradient(135deg, var(--primary-dark), var(--primary))';
            revealBtn.style.color = 'white';
        }
        
        allBalancesRevealed = true;
        showMessage('All balances revealed', 'success');
    } else {
        // Blur all balances
        Object.keys(revealedBalances).forEach(balanceId => {
            revealedBalances[balanceId] = false;
        });
        
        // Update UI
        updateBalanceVisibility();
        
        // Update button text
        const revealBtn = document.querySelector('.reveal-all-btn');
        if (revealBtn) {
            revealBtn.innerHTML = '<i class="fas fa-eye"></i> Tap to reveal all balances';
            revealBtn.style.background = 'linear-gradient(135deg, #ff980022, #f57c0022)';
            revealBtn.style.color = 'var(--primary)';
        }
        
        allBalancesRevealed = false;
        showMessage('All balances blurred', 'info');
    }
}








// Update the existing revealAllBalances function to use toggle
function revealAllBalances() {
  // For backward compatibility, call toggleAllBalances
  if (!allBalancesRevealed) {
    toggleAllBalances();
  }
}

// Update the existing hideAllBalances function to use toggle
function hideAllBalances() {
  // For backward compatibility, call toggleAllBalances
  if (allBalancesRevealed) {
    toggleAllBalances();
  }
}







function updateBalanceVisibility() {
    const balanceCards = {
        'today': document.getElementById('todayTotal'),
        'week': document.getElementById('weekTotal'),
        'month': document.getElementById('monthTotal'),
        'year': document.getElementById('yearTotal'),
        'totalIncome': document.getElementById('totalIncomeValue'),
        'totalExpense': document.getElementById('totalExpenseValue'),
        'availableBalance': document.getElementById('availableBalanceValue'),
        'monthlyBudget': document.getElementById('monthlyBudgetValue'),
        'savingsGoal': document.getElementById('savingsGoalValue')
    };
    
    for (const [balanceId, element] of Object.entries(balanceCards)) {
        if (element) {
            // Store the original value if not already stored
            if (!element.dataset.originalValue) {
                element.dataset.originalValue = element.textContent;
            }
            
            if (revealedBalances[balanceId]) {
                // REVEAL: Show actual value
                element.classList.remove('blurred');
                element.classList.add('revealed');
                element.style.filter = 'none';
                element.style.color = '';
                element.style.textShadow = '';
                element.style.opacity = '1';
                element.style.userSelect = 'auto';
                element.style.pointerEvents = 'auto';
                
                // Restore original value
                element.textContent = element.dataset.originalValue;
                
            } else {
                // BLUR: Apply blur effect
                element.classList.add('blurred');
                element.classList.remove('revealed');
                element.style.filter = 'blur(8px)';
                element.style.color = 'transparent';
                element.style.textShadow = '0 0 12px rgba(0,0,0,0.5)';
                element.style.opacity = '0.8';
                element.style.userSelect = 'none';
                element.style.pointerEvents = 'none';
                
                // Optionally show placeholder text
                // element.textContent = '';
            }
        }
    }
}



function resetBalanceStyles() {
    const selectors = [
        '.balance-value',
        '.stat-value',
        '#todayTotal',
        '#weekTotal',
        '#monthTotal',
        '#yearTotal',
        '#totalIncomeValue',
        '#totalExpenseValue',
        '#availableBalanceValue',
        '#monthlyBudgetValue',
        '#savingsGoalValue'
    ];
    
    selectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            el.style.maxWidth = '100%';
            el.style.overflow = 'hidden';
            el.style.textOverflow = 'ellipsis';
            el.style.whiteSpace = 'nowrap';
        });
    });
}

// Call periodically or when issues occur
setInterval(resetBalanceStyles, 30000); // Every 30 seconds



    function updateStatus(status, message) {
      const dot = document.getElementById('statusDot'), text = document.getElementById('statusText');
      if (dot) dot.className = 'status-dot ' + status;
      if (text) text.textContent = message;
    }
    
    function showMessage(message, type = 'info') {
      const messageDiv = document.getElementById('statusMessage');
      const icon = type === 'success' ? 'fa-check-circle' : 
                   type === 'error' ? 'fa-exclamation-circle' : 
                   type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
      messageDiv.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
      messageDiv.className = `message ${type} show`;
      if (type === 'success') setTimeout(() => messageDiv.classList.remove('show'), 5000);
    }
    
    function showError(message) { showMessage(' ' + message, 'error'); }

    function formatCurrency(amount) { 
      return 'UGX ' + parseInt(amount || 0).toLocaleString('en-UG'); 
    }

    // FIXED: Improved date range calculation to properly handle months and years
    function getDateRange(period) {
      const today = new Date(); 
      today.setHours(0, 0, 0, 0);
      let startDate, endDate, periodLabel;
      
      switch(period) {
        case 'today': 
          startDate = new Date(today); 
          endDate = new Date(today); 
          endDate.setHours(23, 59, 59, 999); 
          periodLabel = 'Today'; 
          break;
        case 'yesterday': 
          startDate = new Date(today); 
          startDate.setDate(startDate.getDate() - 1); 
          endDate = new Date(startDate); 
          endDate.setHours(23, 59, 59, 999); 
          periodLabel = 'Yesterday'; 
          break;
        case 'week': 
          startDate = new Date(today); 
          startDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
          endDate = new Date(startDate); 
          endDate.setDate(endDate.getDate() + 6); 
          endDate.setHours(23, 59, 59, 999); 
          periodLabel = 'This Week'; 
          break;
        case 'month': 
          startDate = new Date(today.getFullYear(), today.getMonth(), 1); 
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); 
          endDate.setHours(23, 59, 59, 999); 
          periodLabel = 'This Month'; 
          break;
        case 'lastMonth':
          const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          startDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
          endDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0);
          endDate.setHours(23, 59, 59, 999);
          periodLabel = 'Last Month';
          break;
        case 'year': 
          startDate = new Date(today.getFullYear(), 0, 1); 
          endDate = new Date(today.getFullYear(), 11, 31); 
          endDate.setHours(23, 59, 59, 999); 
          periodLabel = 'This Year'; 
          break;
        default: return null;
      }
      return { startDate, endDate, periodLabel };
    }

    function setupApp() {
      document.getElementById('addBtn').disabled = false;
      document.getElementById('addIncomeBtn').disabled = false;
      document.getElementById('addBudgetBtn').disabled = false;
      document.getElementById('addReminderBtn').disabled = false;
    }

    // ===== EXPENSE FUNCTIONS =====
    async function handleExpenseSubmit() {
  if (!isFirestoreReady || !currentUser) {
    showError('Database not ready. Please wait...');
    return;
  }

  const amount = parseFloat(document.getElementById('amount').value);
  const categorySelect = document.getElementById('category');
  const categoryDisplay = categorySelect.options[categorySelect.selectedIndex].text;
  const category = getCategoryValue(categoryDisplay); // Convert display name to value
  const date = document.getElementById('date').value;
  const description = document.getElementById('description').value.trim();

  if (!amount || amount <= 0) {
    showError('Please enter a valid amount');
    return;
  }
  if (!category) {
    showError('Please select a category');
    return;
  }
  if (!date) {
    showError('Please select a date');
    return;
  }

  const addBtn = document.getElementById('addBtn');
  addBtn.disabled = true;
  addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

  try {
    const expenseData = addUserData({
      amount: amount,
      category: category, // Store as value (e.g., "Gifts" not " Gifts")
      categoryDisplay: categoryDisplay, // Also store the display version
      date: date,
      description: description,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    if (isEditingExpense && editingExpenseId) {
      await db.collection('expenses').doc(editingExpenseId).update(expenseData);
      showMessage(' Expense updated successfully!', 'success');
      cancelEditExpense();
    } else {
      await db.collection('expenses').add(expenseData);
      showMessage(' Expense added successfully!', 'success');
      clearExpenseForm();
    }
    
    // Refresh the list
    setTimeout(() => {
      if (allExpenses.length > 0) {
        loadExpensesList(allExpenses);
        populateFilterDropdowns();
      }
    }, 500);
    
  } catch (error) {
    console.error('Error saving expense:', error);
    showError('Failed to save expense: ' + error.message);
  } finally {
    addBtn.disabled = false;
    addBtn.innerHTML = '<i class="fas fa-plus"></i> ' + (isEditingExpense ? 'Update Expense' : 'Add Expense');
  }
}
    function prepareEditExpense(id, amount, category, date, description) {
      isEditingExpense = true; 
      editingExpenseId = id;
      document.getElementById('amount').value = amount; 
      document.getElementById('category').value = category;
      document.getElementById('date').value = date; 
      document.getElementById('description').value = description;
      document.getElementById('expenseFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Expense';
      document.getElementById('addBtn').innerHTML = '<i class="fas fa-save"></i> Update Expense';
      document.getElementById('cancelExpenseBtn').style.display = 'inline-flex';
      
      const formSection = document.getElementById('expenseFormSection');
      formSection.classList.remove('collapsed');
      formSection.scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEditExpense() {
      isEditingExpense = false; 
      editingExpenseId = null;
      document.getElementById('amount').value = ''; 
      document.getElementById('description').value = '';
      document.getElementById('category').value = 'Groceries'; 
      // Reset to today's date when canceling edit
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      document.getElementById('expenseFormTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add New Expense';
      document.getElementById('addBtn').innerHTML = '<i class="fas fa-plus"></i> Add Expense';
      document.getElementById('cancelExpenseBtn').style.display = 'none';
    }
	
	async function editExpense(expenseId) {
  try {
    const expenseDoc = await db.collection('expenses').doc(expenseId).get();
    if (!expenseDoc.exists) {
      showError('Expense not found');
      return;
    }

    const expense = expenseDoc.data();
    isEditingExpense = true;
    editingExpenseId = expenseId;

    // Set form values
    document.getElementById('amount').value = expense.amount || '';
    document.getElementById('date').value = expense.date || '';
    document.getElementById('description').value = expense.description || '';
    
    // Handle category selection - use stored categoryDisplay if available
    const categoryValue = expense.categoryDisplay || expense.category;
    const categorySelect = document.getElementById('category');
    
    // Find the option with matching text
    for (let i = 0; i < categorySelect.options.length; i++) {
      if (categorySelect.options[i].text === categoryValue || 
          getCategoryValue(categorySelect.options[i].text) === categoryValue) {
        categorySelect.selectedIndex = i;
        break;
      }
    }
    
    // Update UI
    document.getElementById('expenseFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Expense';
    document.getElementById('addBtn').innerHTML = '<i class="fas fa-save"></i> Update Expense';
    document.getElementById('cancelExpenseBtn').style.display = 'inline-flex';
    
    // Expand the form if collapsed
    const formSection = document.getElementById('expenseFormSection');
    if (formSection.classList.contains('collapsed')) {
      formSection.classList.remove('collapsed');
    }
    
    // Scroll to form
    formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    showMessage('Editing expense...', 'info');
  } catch (error) {
    console.error('Error fetching expense:', error);
    showError('Failed to load expense for editing: ' + error.message);
  }
}

// FIXED: Populate expense filters with unique values


function populateIncomeFilters() {
  const sourceSelect = document.getElementById('filterIncomeSource');
  const monthSelect = document.getElementById('filterIncomeMonth');
  
  // Clear existing options except the first one
  while (sourceSelect.options.length > 1) {
    sourceSelect.remove(1);
  }
  while (monthSelect.options.length > 1) {
    monthSelect.remove(1);
  }
  
  // Get unique sources from ALL income
  const sources = [...new Set(allIncome.map(inc => inc.source))].sort();
  sources.forEach(source => {
    if (source) {
      const option = document.createElement('option');
      option.value = source;
      option.textContent = getSourceDisplayName(source);
      sourceSelect.appendChild(option);
    }
  });
  
  // Get unique months from ALL income
  const months = [];
  const now = new Date();
  const currentMonthYear = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  
  // Always add current month first
  const currentDate = new Date();
  const currentDisplayMonth = currentDate.toLocaleDateString('en-US', { 
    month: 'long', 
    year: 'numeric' 
  });
  
  months.push({ 
    value: currentMonthYear, 
    display: currentDisplayMonth,
    isCurrent: true 
  });
  
  // Add months from ALL income (excluding current month if already added)
  allIncome.forEach(income => {
    if (income.date) {
      try {
        const date = new Date(income.date);
        if (!isNaN(date.getTime())) {
          const monthStr = date.getFullYear() + '-' + 
                         String(date.getMonth() + 1).padStart(2, '0');
          const displayMonth = date.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
          });
          
          if (!months.some(m => m.value === monthStr)) {
            months.push({ 
              value: monthStr, 
              display: displayMonth,
              isCurrent: monthStr === currentMonthYear 
            });
          }
        }
      } catch (e) {
        console.error('Error parsing date:', e);
      }
    }
  });
  
  // Sort months chronologically (newest first)
  months.sort((a, b) => b.value.localeCompare(a.value));
  
  // Add month options
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month.value;
    option.textContent = month.display;
    if (month.isCurrent) {
      option.selected = true;
    }
    monthSelect.appendChild(option);
  });
}














// FIXED: Populate income filters with unique values
function populateIncomeFilters() {
  const sourceSelect = document.getElementById('filterIncomeSource');
  const monthSelect = document.getElementById('filterIncomeMonth');
  
  // Clear existing options except the first one
  while (sourceSelect.options.length > 1) {
    sourceSelect.remove(1);
  }
  while (monthSelect.options.length > 1) {
    monthSelect.remove(1);
  }
  
  // Get unique sources from allIncome
  const sources = [...new Set(allIncome.map(inc => inc.source))].sort();
  sources.forEach(source => {
    if (source) {
      const option = document.createElement('option');
      option.value = source;
      option.textContent = getSourceDisplayName(source);
      sourceSelect.appendChild(option);
    }
  });
  
  // === MODIFIED: Get unique months from allIncome with current month as default ===
  const months = [];
  const currentMonthYear = getCurrentMonthYear();
  
  // Always add current month even if there are no income for it
  const currentDate = new Date();
  const currentDisplayMonth = currentDate.toLocaleDateString('en-US', { 
    month: 'long', 
    year: 'numeric' 
  });
  
  // Add current month first
  if (!months.some(m => m.value === currentMonthYear)) {
    months.push({ 
      value: currentMonthYear, 
      display: currentDisplayMonth,
      isCurrent: true 
    });
  }
  
  // Add months from existing income
  allIncome.forEach(income => {
    if (income.date) {
      try {
        const date = new Date(income.date);
        if (!isNaN(date.getTime())) {
          const monthStr = date.getFullYear() + '-' + 
                         String(date.getMonth() + 1).padStart(2, '0');
          const displayMonth = date.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
          });
          
          if (!months.some(m => m.value === monthStr)) {
            months.push({ 
              value: monthStr, 
              display: displayMonth,
              isCurrent: monthStr === currentMonthYear 
            });
          }
        }
      } catch (e) {
        console.error('Error parsing date:', e);
      }
    }
  });
  
  // Sort months chronologically (newest first)
  months.sort((a, b) => b.value.localeCompare(a.value));
  
  // Add month options
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month.value;
    option.textContent = month.display;
    if (month.isCurrent) {
      option.selected = true; // Set current month as default
    }
    monthSelect.appendChild(option);
  });
}

function searchExpenses() {
  const searchTerm = document.getElementById('searchExpenses').value.toLowerCase();
  let filteredExpenses = allExpenses; // You need to ensure 'allExpenses' is a global variable
  
  if (searchTerm) {
    filteredExpenses = filteredExpenses.filter(expense => 
      (expense.category && expense.category.toLowerCase().includes(searchTerm)) ||
      (expense.description && expense.description.toLowerCase().includes(searchTerm)) ||
      (expense.amount && expense.amount.toString().includes(searchTerm))
    );
  }
  
  // Apply the current filters on the search result
  const selectedCategory = document.getElementById('filterExpenseCategory').value;
  const selectedMonth = document.getElementById('filterExpenseMonth').value;
  
  if (selectedCategory) {
    filteredExpenses = filteredExpenses.filter(expense => expense.category === selectedCategory);
  }
  
  if (selectedMonth) {
    filteredExpenses = filteredExpenses.filter(expense => {
      const expenseDate = new Date(expense.date);
      const expenseMonth = expenseDate.getFullYear() + '-' + (expenseDate.getMonth() + 1).toString().padStart(2, '0');
      return expenseMonth === selectedMonth;
    });
  }
  
  displayExpenses(filteredExpenses);
}

// Update displayExpenses function to show message when no results
function displayExpenses(expenses) {
    const expensesList = document.getElementById('expensesList');
    
    if (!expensesList) return;
    
    if (!expenses || expenses.length === 0) {
        expensesList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p>No expenses found</p>
                <p style="font-size: 0.8rem; opacity: 0.7;">Try changing your search or filter</p>
            </div>
        `;
        return;
    }
    
    // Limit to recent 50 items for performance
    const displayExpenses = expenses.slice(0, 50);
    
    let html = '';
    
    displayExpenses.forEach(expense => {
        const date = expense.date ? new Date(expense.date).toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
        }) : 'No date';
        
        const categoryClass = getCategoryClass(expense.category);
        const categoryName = getCategoryDisplayName(expense.category);
        
        html += `
            <div class="expense-item">
                <div class="item-content">
                    <span class="category-badge ${categoryClass}">
                        <i class="${getCategoryIcon(expense.category)}"></i>
                        <span>${categoryName}</span>
                    </span>
                    <strong>${date}</strong>
                    <div>${expense.description || 'No description'}</div>
                </div>
                <div class="expense-amount">UGX ${expense.amount?.toLocaleString() || '0'}</div>
                <div class="item-actions">
                    <button class="action-btn edit" onclick="editExpense('${expense.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" onclick="showDeleteModal('${expense.id}', 'expenses')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    expensesList.innerHTML = html;
}





    // ===== INCOME FUNCTIONS =====
    async function handleIncomeSubmit() {
      if (!isFirestoreReady) { 
        showError('Database not ready. Please wait...'); 
        return; 
      }
      if (!currentUser) { 
        showError('Please login first'); 
        return; 
      }
      
      const amount = document.getElementById('incomeAmount').value.trim();
      const source = document.getElementById('incomeSource').value;
      const date = document.getElementById('incomeDate').value;
      const notes = document.getElementById('incomeNotes').value.trim();

      if (!amount || parseFloat(amount) <= 0) { 
        showError('Please enter a valid income amount'); 
        return; 
      }
      if (!date) { 
        showError('Please select an income date'); 
        return; 
      }

      const btn = document.getElementById('addIncomeBtn'), originalText = btn.innerHTML;
      try {
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        const incomeData = addUserData({ 
          amount: parseFloat(amount), 
          source, 
          date, 
          notes: notes || ''
        });

        if (isEditingIncome && editingIncomeId) {
          // Update existing income
          incomeData.updatedAt = new Date().toISOString();
          await db.collection('income').doc(editingIncomeId).update(incomeData);
          showMessage(` Income updated successfully!`, 'success');
          cancelEditIncome();
        } else {
          // Add new income
          await db.collection('income').add(incomeData);
          showMessage(` Recorded ${formatCurrency(amount)} from ${source}`, 'success');
          
          // Clear form but keep the date for adding another entry
          document.getElementById('incomeAmount').value = ''; 
          document.getElementById('incomeNotes').value = '';
          document.getElementById('incomeSource').value = 'Salary'; 
          // Keep the selected date for next entry
        }
        
        // Refresh reports
        if (currentReportPeriod.income) {
          generateReport(currentReportPeriod.income, 'income', document.querySelector(`#incomeReportControls button.active`));
        }
      } catch (error) { 
        console.error('Income submit error:', error);
        showError('Failed to save income: ' + error.message); 
      } 
      finally { 
        btn.disabled = false; 
        btn.innerHTML = originalText; 
      }
    }

    function prepareEditIncome(id, amount, source, date, notes) {
      isEditingIncome = true; 
      editingIncomeId = id;
      document.getElementById('incomeAmount').value = amount; 
      document.getElementById('incomeSource').value = source;
      document.getElementById('incomeDate').value = date; 
      document.getElementById('incomeNotes').value = notes;
      document.getElementById('incomeFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Income';
      document.getElementById('addIncomeBtn').innerHTML = '<i class="fas fa-save"></i> Update Income';
      document.getElementById('cancelIncomeBtn').style.display = 'inline-flex';
      
      const formSection = document.getElementById('incomeFormSection');
      formSection.classList.remove('collapsed');
      formSection.scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEditIncome() {
      isEditingIncome = false; 
      editingIncomeId = null;
      document.getElementById('incomeAmount').value = ''; 
      document.getElementById('incomeNotes').value = '';
      document.getElementById('incomeSource').value = 'Salary'; 
      // Reset to today's date when canceling edit
      document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('incomeFormTitle').innerHTML = '<i class="fas fa-money-bill-alt"></i> Add New Income';
      document.getElementById('addIncomeBtn').innerHTML = '<i class="fas fa-arrow-alt-circle-up"></i> Record Income';
      document.getElementById('cancelIncomeBtn').style.display = 'none';
    }
    
    // ===== BUDGET FUNCTIONS =====
    async function handleBudgetSubmit() {
      if (!isFirestoreReady) { showError('Please connect to Firebase first'); return; }
      if (!currentUser) { showError('Please login first'); return; }
      
      const amount = document.getElementById('budgetAmount').value.trim();
      const month = document.getElementById('budgetMonth').value;
      const category = document.getElementById('budgetCategory').value;
      const notes = document.getElementById('budgetNotes').value.trim();

      if (!amount || parseFloat(amount) <= 0) { showError('Please enter a valid budget amount'); return; }
      if (!month) { showError('Please select a month'); return; }

      const btn = document.getElementById('addBudgetBtn'), originalText = btn.innerHTML;
      try {
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        const budgetData = addUserData({ 
          amount: parseFloat(amount), 
          month, 
          category: category || 'All',
          notes: notes || '',
          spent: 0
        });

        if (isEditingBudget && editingBudgetId) {
          budgetData.updatedAt = new Date().toISOString();
          await db.collection('budgets').doc(editingBudgetId).update(budgetData);
          showMessage(` Budget updated successfully!`, 'success');
          cancelEditBudget();
        } else {
          await db.collection('budgets').add(budgetData);
          showMessage(` Budget of ${formatCurrency(amount)} set for ${month}`, 'success');
          document.getElementById('budgetAmount').value = ''; 
          document.getElementById('budgetNotes').value = '';
          document.getElementById('budgetCategory').value = ''; 
          // Reset to current month when adding new budget
          const today = new Date();
          document.getElementById('budgetMonth').value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
        }
      } catch (error) { showError('Operation failed: ' + error.message); } 
      finally { btn.disabled = false; btn.innerHTML = originalText; }
    }
    
    async function loadBudgets() {
      try {
        const now = new Date();
        const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        
        budgets.forEach(budget => {
          let spent = 0;
          allExpenses.forEach(expense => {
            const expenseDate = getDateFromExpense(expense);
            const expenseMonth = expenseDate.getFullYear() + '-' + String(expenseDate.getMonth() + 1).padStart(2, '0');
            
            if (expenseMonth === budget.month) {
              if (budget.category === 'All' || expense.category === budget.category) {
                spent += parseFloat(expense.amount) || 0;
              }
            }
          });
          budget.spent = spent;
          budget.remaining = budget.amount - spent;
          budget.percentage = Math.min(100, Math.round((spent / budget.amount) * 100));
        });
        
        displayBudgets();
        updateBudgetStats();
      } catch (error) {
        console.error('Error loading budgets:', error);
      }
    }
    
    function displayBudgets() {
      const container = document.getElementById('budgetsList');
      if (!budgets || budgets.length === 0) { 
        container.innerHTML = `<div class="empty-state"><i class="fas fa-chart-pie"></i><p>No budgets set yet. Add your first budget above!</p></div>`; 
        return; 
      }
      
      let html = '';
      budgets.sort((a, b) => b.month.localeCompare(a.month)).forEach(budget => {
        const monthName = new Date(budget.month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const isOverBudget = budget.spent > budget.amount;
        
        html += `
          <div class="budget-item">
            <div class="item-content">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="category-badge" style="background: var(--budget-color); color: white;">
                  <i class="fas fa-calendar"></i> ${monthName}
                </span>
                <span style="font-size: 0.8rem; color: var(--gray);">
                  ${budget.category === 'All' ? 'All Categories' : budget.category}
                </span>
              </div>
              <div style="margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                  <span>Budget: <strong>${formatCurrency(budget.amount)}</strong></span>
                  <span>Spent: <strong style="color: ${isOverBudget ? 'var(--danger)' : 'var(--primary)'}">${formatCurrency(budget.spent)}</strong></span>
                </div>
                <div class="budget-progress">
                  <div class="budget-progress-fill ${isOverBudget ? 'over' : ''}" style="width: ${Math.min(100, budget.percentage)}%"></div>
                </div>
                <div class="budget-status">
                  <span class="${budget.remaining >= 0 ? 'remaining' : 'exceeded'}">
                    ${budget.remaining >= 0 ? `Remaining: ${formatCurrency(budget.remaining)}` : `Over budget: ${formatCurrency(Math.abs(budget.remaining))}`}
                  </span>
                  <span>${budget.percentage}%</span>
                </div>
                ${budget.notes ? `<div style="margin-top: 5px; font-size: 0.8rem; color: var(--gray);">${budget.notes}</div>` : ''}
              </div>
            </div>
            <div class="item-actions">
              <button class="action-btn edit" onclick="prepareEditBudget('${budget.id}', ${budget.amount}, '${budget.month}', '${budget.category}', '${budget.notes ? budget.notes.replace(/'/g, "\\'") : ''}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete" onclick="confirmDeleteModal('${budget.id}', 'budgets', 'Budget for ${monthName} - ${formatCurrency(budget.amount)}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      populateBudgetFilterOptions();
    }
    
    function updateBudgetStats() {
      const today = new Date();
      const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      const currentBudget = budgets.find(b => b.month === currentMonth && b.category === 'All');
      
      if (currentBudget) {
        monthlyBudget = currentBudget.amount;
        document.getElementById('monthlyBudgetValue').textContent = formatCurrency(monthlyBudget);
        const status = currentBudget.remaining >= 0 ? 
          `Remaining: ${formatCurrency(currentBudget.remaining)}` : 
          `Over: ${formatCurrency(Math.abs(currentBudget.remaining))}`;
        document.getElementById('monthlyBudgetStatus').textContent = status;
        document.getElementById('monthlyBudgetStatus').style.color = currentBudget.remaining >= 0 ? 'var(--success)' : 'var(--danger)';
      } else {
        monthlyBudget = 0;
        document.getElementById('monthlyBudgetValue').textContent = formatCurrency(0);
        document.getElementById('monthlyBudgetStatus').textContent = 'Set a budget';
        document.getElementById('monthlyBudgetStatus').style.color = 'var(--budget-color)';
      }
      
      if (revealedBalances.monthlyBudget) {
        document.getElementById('monthlyBudgetValue').classList.remove('hidden');
      } else {
        document.getElementById('monthlyBudgetValue').classList.add('hidden');
      }
    }
    
    function prepareEditBudget(id, amount, month, category, notes) {
      isEditingBudget = true; editingBudgetId = id;
      document.getElementById('budgetAmount').value = amount; 
      document.getElementById('budgetMonth').value = month;
      document.getElementById('budgetCategory').value = category; 
      document.getElementById('budgetNotes').value = notes || '';
      document.getElementById('budgetFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Budget';
      document.getElementById('addBudgetBtn').innerHTML = '<i class="fas fa-save"></i> Update Budget';
      document.getElementById('cancelBudgetBtn').style.display = 'inline-flex';
      
      const formSection = document.getElementById('budgetFormSection');
      formSection.classList.remove('collapsed');
      formSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    function cancelEditBudget() {
      isEditingBudget = false; editingBudgetId = null;
      document.getElementById('budgetAmount').value = ''; 
      document.getElementById('budgetNotes').value = '';
      document.getElementById('budgetCategory').value = ''; 
      const today = new Date();
      document.getElementById('budgetMonth').value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      document.getElementById('budgetFormTitle').innerHTML = '<i class="fas fa-chart-pie"></i> Set Monthly Budget';
      document.getElementById('addBudgetBtn').innerHTML = '<i class="fas fa-plus"></i> Set Budget';
      document.getElementById('cancelBudgetBtn').style.display = 'none';
    }
    
    // ===== REMINDER FUNCTIONS =====
    async function loadReminders() {
      try {
        displayReminders();
      } catch (error) {
        console.error('Error loading reminders:', error);
      }
    }
    
    function displayReminders() {
      const container = document.getElementById('remindersList');
      if (!reminders || reminders.length === 0) { 
        container.innerHTML = `<div class="empty-state"><i class="fas fa-bell"></i><p>No reminders set yet. Add your first reminder above!</p></div>`; 
        return; 
      }
      
      let html = '';
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      reminders.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)).forEach(reminder => {
        const dueDate = new Date(reminder.dueDate);
        const isOverdue = dueDate < today && !reminder.completed;
        const isToday = dueDate.toDateString() === today.toDateString() && !reminder.completed;
        const isUpcoming = dueDate > today && !reminder.completed;
        
        let statusClass = '';
        let statusText = '';
        
        if (reminder.completed) {
          statusClass = 'completed';
          statusText = 'Completed';
        } else if (isOverdue) {
          statusClass = 'overdue';
          statusText = 'Overdue';
        } else if (isToday) {
          statusClass = 'today';
          statusText = 'Due Today';
        } else if (isUpcoming) {
          statusClass = 'upcoming';
          statusText = 'Upcoming';
        }
        
        const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        
        html += `
          <div class="reminder-item ${reminder.completed ? 'reminder-completed' : ''}">
            <div class="item-content">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; font-size: 1rem;">${reminder.title}</span>
                <span class="reminder-due ${statusClass}">${statusText}</span>
              </div>
              <div style="margin-top: 5px; display: flex; justify-content: space-between; align-items: center;">
                <span class="category-badge category-${(reminder.category || 'other').toLowerCase().replace(' ', '-')}">
                  <i class="fas fa-tag"></i> ${reminder.category || 'Other'}
                </span>
                <span style="font-size: 0.9rem; color: var(--gray);">
                  Due: ${dueDate.toLocaleDateString('en-UG')} ${!reminder.completed && daysUntil > 0 ? `(${daysUntil} days)` : ''}
                </span>
              </div>
              <div style="margin-top: 10px; font-size: 1rem; font-weight: 700; color: var(--primary);">
                ${formatCurrency(reminder.amount)}
              </div>
            </div>
            <div class="item-actions">
              ${!reminder.completed ? `
                <button class="action-btn complete" onclick="markReminderComplete('${reminder.id}')">
                  <i class="fas fa-check"></i>
                </button>
              ` : ''}
              <button class="action-btn edit" onclick="prepareEditReminder('${reminder.id}', '${reminder.title.replace(/'/g, "\\'")}', ${reminder.amount}, '${reminder.dueDate}', '${reminder.category || 'Other'}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete" onclick="confirmDeleteModal('${reminder.id}', 'reminders', 'Reminder: ${reminder.title} - ${formatCurrency(reminder.amount)}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    async function markReminderComplete(id) {
      try {
        await db.collection('reminders').doc(id).update({
          completed: true,
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showMessage(' Reminder marked as completed!', 'success');
      } catch (error) {
        showError('Failed to mark reminder as complete: ' + error.message);
      }
    }
    
    async function handleReminderSubmit() {
      if (!isFirestoreReady) { showError('Please connect to Firebase first'); return; }
      if (!currentUser) { showError('Please login first'); return; }
      
      const title = document.getElementById('reminderTitle').value.trim();
      const amount = document.getElementById('reminderAmount').value.trim();
      const dueDate = document.getElementById('reminderDueDate').value;
      const category = document.getElementById('reminderCategory').value;

      if (!title) { showError('Please enter a reminder title'); return; }
      if (!amount || parseFloat(amount) <= 0) { showError('Please enter a valid amount'); return; }
      if (!dueDate) { showError('Please select a due date'); return; }

      const btn = document.getElementById('addReminderBtn'), originalText = btn.innerHTML;
      try {
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        const reminderData = addUserData({ 
          title: title,
          amount: parseFloat(amount), 
          dueDate: dueDate,
          category: category,
          completed: false
        });

        if (isEditingReminder && editingReminderId) {
          reminderData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('reminders').doc(editingReminderId).update(reminderData);
          showMessage(` Reminder updated successfully!`, 'success');
          cancelEditReminder();
        } else {
          await db.collection('reminders').add(reminderData);
          showMessage(` Reminder "${title}" added!`, 'success');
          document.getElementById('reminderTitle').value = ''; 
          document.getElementById('reminderAmount').value = '';
          document.getElementById('reminderCategory').value = 'Rent'; 
          // Reset to today's date when adding new reminder
          document.getElementById('reminderDueDate').value = new Date().toISOString().split('T')[0];
        }
      } catch (error) { showError('Operation failed: ' + error.message); } 
      finally { btn.disabled = false; btn.innerHTML = originalText; }
    }
    
    function prepareEditReminder(id, title, amount, dueDate, category) {
      isEditingReminder = true; editingReminderId = id;
      document.getElementById('reminderTitle').value = title; 
      document.getElementById('reminderAmount').value = amount;
      document.getElementById('reminderDueDate').value = dueDate; 
      document.getElementById('reminderCategory').value = category;
      document.getElementById('reminderFormTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Reminder';
      document.getElementById('addReminderBtn').innerHTML = '<i class="fas fa-save"></i> Update Reminder';
      document.getElementById('cancelReminderBtn').style.display = 'inline-flex';
      
      const formSection = document.getElementById('reminderFormSection');
      formSection.classList.remove('collapsed');
      formSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    function cancelEditReminder() {
      isEditingReminder = false; editingReminderId = null;
      document.getElementById('reminderTitle').value = ''; 
      document.getElementById('reminderAmount').value = '';
      document.getElementById('reminderCategory').value = 'Rent'; 
      document.getElementById('reminderDueDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('reminderFormTitle').innerHTML = '<i class="fas fa-bell"></i> Add Payment Reminder';
      document.getElementById('addReminderBtn').innerHTML = '<i class="fas fa-bell"></i> Add Reminder';
      document.getElementById('cancelReminderBtn').style.display = 'none';
    }
    
    // ===== SEARCH AND FILTER FUNCTIONS - FIXED =====
function searchExpenses() {
  const searchTerm = document.getElementById('searchExpenses').value.toLowerCase();
  let filteredExpenses = allExpenses; // You need to ensure 'allExpenses' is a global variable
  
  if (searchTerm) {
    filteredExpenses = filteredExpenses.filter(expense => 
      (expense.category && expense.category.toLowerCase().includes(searchTerm)) ||
      (expense.description && expense.description.toLowerCase().includes(searchTerm)) ||
      (expense.amount && expense.amount.toString().includes(searchTerm))
    );
  }
  
  // Apply the current filters on the search result
  const selectedCategory = document.getElementById('filterExpenseCategory').value;
  const selectedMonth = document.getElementById('filterExpenseMonth').value;
  
  if (selectedCategory) {
    filteredExpenses = filteredExpenses.filter(expense => expense.category === selectedCategory);
  }
  
  if (selectedMonth) {
    filteredExpenses = filteredExpenses.filter(expense => {
      const expenseDate = new Date(expense.date);
      const expenseMonth = expenseDate.getFullYear() + '-' + (expenseDate.getMonth() + 1).toString().padStart(2, '0');
      return expenseMonth === selectedMonth;
    });
  }
  
  displayExpenses(filteredExpenses);
}
// FIXED: Income filtering function
function filterIncome() {
    const source = document.getElementById('filterIncomeSource').value;
    const month = document.getElementById('filterIncomeMonth').value;
    let filtered = allIncome;
    
    if (source) {
        filtered = filtered.filter(income => {
            // Handle source filtering
            return income.source === source || 
                   (income.source && income.source.includes(source));
        });
    }
    
    if (month) {
        filtered = filtered.filter(income => {
            if (!income.date) return false;
            
            try {
                const incomeDate = new Date(income.date);
                if (isNaN(incomeDate.getTime())) return false;
                
                // Format date as YYYY-MM for comparison
                const incomeMonth = incomeDate.getFullYear() + '-' + 
                                   String(incomeDate.getMonth() + 1).padStart(2, '0');
                return incomeMonth === month;
            } catch (e) {
                console.error('Date parsing error:', e, income);
                return false;
            }
        });
    }
    
    displayIncome(filtered);
}



// FIXED: Populate expense filters with unique values
function populateExpenseFilters() {
    const categorySelect = document.getElementById('filterExpenseCategory');
    const monthSelect = document.getElementById('filterExpenseMonth');
    
    // Clear existing options except the first one
    while (categorySelect.options.length > 1) {
        categorySelect.remove(1);
    }
    while (monthSelect.options.length > 1) {
        monthSelect.remove(1);
    }
    
    // Get unique categories from allExpenses
    const categories = [...new Set(allExpenses.map(exp => exp.category))].sort();
    categories.forEach(category => {
        if (category) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = getCategoryDisplayName(category);
            categorySelect.appendChild(option);
        }
    });
    
    // === MODIFIED: Get unique months from allExpenses with current month as default ===
    const months = [];
    const currentMonthYear = getCurrentMonthYear();
    
    // Always add current month even if there are no expenses for it
    const currentDate = new Date();
    const currentDisplayMonth = currentDate.toLocaleDateString('en-US', { 
        month: 'long', 
        year: 'numeric' 
    });
    
    // Add current month first
    if (!months.some(m => m.value === currentMonthYear)) {
        months.push({ 
            value: currentMonthYear, 
            display: currentDisplayMonth,
            isCurrent: true 
        });
    }
    
    // Add months from existing expenses
    allExpenses.forEach(expense => {
        if (expense.date) {
            try {
                const date = new Date(expense.date);
                if (!isNaN(date.getTime())) {
                    const monthStr = date.getFullYear() + '-' + 
                                   String(date.getMonth() + 1).padStart(2, '0');
                    const displayMonth = date.toLocaleDateString('en-US', { 
                        month: 'long', 
                        year: 'numeric' 
                    });
                    
                    if (!months.some(m => m.value === monthStr)) {
                        months.push({ 
                            value: monthStr, 
                            display: displayMonth,
                            isCurrent: monthStr === currentMonthYear 
                        });
                    }
                }
            } catch (e) {
                console.error('Error parsing date:', e);
            }
        }
    });
    
    // Sort months chronologically (newest first)
    months.sort((a, b) => b.value.localeCompare(a.value));
    
    // Add month options
    months.forEach(month => {
        const option = document.createElement('option');
        option.value = month.value;
        option.textContent = month.display;
        if (month.isCurrent) {
            option.selected = true; // Set current month as default
        }
        monthSelect.appendChild(option);
    });
}




// FIXED: Populate income filters with unique values
function populateIncomeFilters() {
  const sourceSelect = document.getElementById('filterIncomeSource');
  const monthSelect = document.getElementById('filterIncomeMonth');
  
  // Clear existing options except the first one
  while (sourceSelect.options.length > 1) {
    sourceSelect.remove(1);
  }
  while (monthSelect.options.length > 1) {
    monthSelect.remove(1);
  }
  
  // Get unique sources from allIncome
  const sources = [...new Set(allIncome.map(inc => inc.source))].sort();
  sources.forEach(source => {
    if (source) {
      const option = document.createElement('option');
      option.value = source;
      option.textContent = getSourceDisplayName(source);
      sourceSelect.appendChild(option);
    }
  });
  
  // === MODIFIED: Get unique months from allIncome with current month as default ===
  const months = [];
  const currentMonthYear = getCurrentMonthYear();
  
  // Always add current month even if there are no income for it
  const currentDate = new Date();
  const currentDisplayMonth = currentDate.toLocaleDateString('en-US', { 
    month: 'long', 
    year: 'numeric' 
  });
  
  // Add current month first
  if (!months.some(m => m.value === currentMonthYear)) {
    months.push({ 
      value: currentMonthYear, 
      display: currentDisplayMonth,
      isCurrent: true 
    });
  }
  
  // Add months from existing income
  allIncome.forEach(income => {
    if (income.date) {
      try {
        const date = new Date(income.date);
        if (!isNaN(date.getTime())) {
          const monthStr = date.getFullYear() + '-' + 
                         String(date.getMonth() + 1).padStart(2, '0');
          const displayMonth = date.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
          });
          
          if (!months.some(m => m.value === monthStr)) {
            months.push({ 
              value: monthStr, 
              display: displayMonth,
              isCurrent: monthStr === currentMonthYear 
            });
          }
        }
      } catch (e) {
        console.error('Error parsing date:', e);
      }
    }
  });
  
  // Sort months chronologically (newest first)
  months.sort((a, b) => b.value.localeCompare(a.value));
  
  // Add month options
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month.value;
    option.textContent = month.display;
    if (month.isCurrent) {
      option.selected = true; // Set current month as default
    }
    monthSelect.appendChild(option);
  });
}





    
    function searchBudgets() {
      const searchTerm = document.getElementById('searchBudgets').value.toLowerCase();
      const budgetItems = document.querySelectorAll('#budgetsList .budget-item');
      
      budgetItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
      });
    }
    
    function filterBudgets() {
      const month = document.getElementById('filterBudgetMonth').value;
      const budgetItems = document.querySelectorAll('#budgetsList .budget-item');
      
      budgetItems.forEach(item => {
        const itemMonth = item.querySelector('.category-badge')?.textContent || '';
        const itemMonthFormatted = formatMonthForFilter(itemMonth);
        
        item.style.display = !month || itemMonthFormatted === month ? 'flex' : 'none';
      });
    }
    
    function searchReminders() {
      const searchTerm = document.getElementById('searchReminders').value.toLowerCase();
      const reminderItems = document.querySelectorAll('#remindersList .reminder-item');
      
      reminderItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
      });
    }
    
    function filterReminders() {
      const status = document.getElementById('filterReminderStatus').value;
      const reminderItems = document.querySelectorAll('#remindersList .reminder-item');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      reminderItems.forEach(item => {
        const statusElement = item.querySelector('.reminder-due');
        const itemStatus = statusElement ? statusElement.textContent.toLowerCase() : '';
        const isCompleted = item.classList.contains('reminder-completed');
        
        let show = true;
        if (status) {
          if (status === 'completed') {
            show = isCompleted;
          } else if (status === 'today') {
            show = itemStatus.includes('today');
          } else if (status === 'overdue') {
            show = itemStatus.includes('overdue');
          } else if (status === 'upcoming') {
            show = itemStatus.includes('upcoming') && !isCompleted;
          }
        }
        
        item.style.display = show ? 'flex' : 'none';
      });
    }
    
    // FIXED: Get month name from date string
    function getMonthFromDate(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleDateString('en-US', { month: 'short' });
      } catch (e) {
        return '';
      }
    }
    
    function formatMonthForFilter(monthText) {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const shortMonths = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      for (let i = 0; i < monthNames.length; i++) {
        if (monthText.includes(monthNames[i])) {
          return shortMonths[i];
        }
      }
      return monthText.split(' ')[0]; // Return first word if no match
    }
    
    function populateBudgetFilterOptions() {
      const select = document.getElementById('filterBudgetMonth');
      const months = new Set();
      
      budgets.forEach(budget => {
        const monthName = new Date(budget.month + '-01').toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        months.add(monthName);
      });
      
      select.innerHTML = '<option value="">All Months</option>';
      months.forEach(month => {
        select.innerHTML += `<option value="${month.split(' ')[0]}">${month}</option>`;
      });
    }
    
    // ===== REPORT FUNCTIONS =====
    async function generateReport(period, reportType, buttonElement) {
      if (!isFirestoreReady) { showError('Please connect to Firebase first'); return; }
      if (!currentUser) { showError('Please login first'); return; }
      
      currentReportPeriod[reportType] = period;
      
      const controlContainer = buttonElement.closest('.report-controls');
      if (controlContainer) {
        controlContainer.querySelectorAll('.btn-report').forEach(b => b.classList.remove('active'));
        buttonElement.classList.add('active');
        document.getElementById(`${reportType}CustomRange`).style.display = 'none';
      }
      
      try { 
        const dateRange = getDateRange(period); 
        if (!dateRange) return; 
        await fetchAndDisplayReport(dateRange.startDate, dateRange.endDate, dateRange.periodLabel, reportType); 
      }
      catch (error) { showError(`Failed to generate ${reportType} report: ` + error.message); }
    }

    // FIXED: Improved date comparison logic for old data
    async function fetchAndDisplayReport(startDate, endDate, periodLabel, reportType) {
      const resultsContainer = document.getElementById(`${reportType}ReportResults`);
      const actionsContainer = document.getElementById(`${reportType}ReportActions`);
      resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating report...</p></div>';
      actionsContainer.style.display = 'none';
      
      try {
        let totalAmount = 0, count = 0, breakdown = {}, items = [];
        let summaryTitle = reportType === 'expense' ? 'Expense Breakdown' : 'Income Sources';
        let amountLabel = reportType === 'expense' ? 'Total Expenses' : 'Total Income';
        let color = reportType === 'expense' ? 'var(--danger)' : 'var(--success)';
        let breakdownColor = reportType === 'expense' ? 'var(--danger)' : 'var(--success)';

        if (reportType === 'expense') {
          allExpenses.forEach(expense => {
            const expenseDate = getDateFromExpense(expense);
            
            // Skip if invalid date
            if (isNaN(expenseDate.getTime())) return;
            
            // Compare dates correctly
            if (expenseDate >= startDate && expenseDate <= endDate) {
              const expenseAmount = parseFloat(expense.amount) || 0;
              totalAmount += expenseAmount;
              count++;
              const category = expense.category || 'Other';
              breakdown[category] = (breakdown[category] || 0) + expenseAmount;
              items.push({ id: expense.id, ...expense });
            }
          });
          
          items.sort((a, b) => {
            const dateA = getDateFromExpense(a);
            const dateB = getDateFromExpense(b);
            return dateB - dateA;
          });
        } else {
          allIncome.forEach(income => {
            const incomeDate = getDateFromExpense(income);
            
            // Skip if invalid date
            if (isNaN(incomeDate.getTime())) return;
            
            if (incomeDate >= startDate && incomeDate <= endDate) {
              const incomeAmount = parseFloat(income.amount) || 0;
              totalAmount += incomeAmount;
              count++;
              const source = income.source || 'Other';
              breakdown[source] = (breakdown[source] || 0) + incomeAmount;
              items.push({ id: income.id, ...income });
            }
          });
          
          items.sort((a, b) => {
            const dateA = getDateFromExpense(a);
            const dateB = getDateFromExpense(b);
            return dateB - dateA;
          });
        }

        const sortedBreakdown = Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
        currentReportData[reportType] = { periodLabel, startDate, endDate, totalAmount, count, breakdown: sortedBreakdown, items, reportType };

        let html = `
          <h4 style="color: ${color}; margin-bottom: 15px; font-size: 1.2rem;"><i class="fas fa-calendar-alt"></i> ${periodLabel}</h4>
          <div class="report-summary" style="grid-template-columns: 1fr 1fr;">
            <div class="report-summary-item" style="border: 1px solid ${color};"><div class="label" style="color: ${color};">${amountLabel}</div><div class="value" style="color: ${color};">${formatCurrency(totalAmount)}</div></div>
            <div class="report-summary-item"><div class="label">Total ${reportType} Transactions</div><div class="value">${count}</div></div>
          </div>
        `;

        if (sortedBreakdown.length > 0) {
          html += `<div class="category-breakdown"><h5 style="color: ${breakdownColor}; margin-bottom: 15px; display:flex; align-items:center; gap:8px;"><i class="fas fa-list-alt"></i> ${summaryTitle}</h5>`;
          sortedBreakdown.forEach(([name, amount]) => {
            const percentage = totalAmount > 0 ? Math.round((amount / totalAmount) * 100) : 0;
            const badgeClass = reportType === 'expense' ? `category-${name.toLowerCase().replace(' ', '-')}` : `category-${name.toLowerCase().replace('/', '-')}" style="background:var(--success); color:white;`;
            const fillClass = reportType === 'expense' ? '' : 'category-fill-income';
            
            html += `<div class="category-item"><div class="category-name"><span class="category-badge ${badgeClass}">${name}</span></div><div class="category-bar"><div class="category-fill ${fillClass}" style="width: ${percentage}%"></div></div><div class="category-amount" style="color:${breakdownColor};">${formatCurrency(amount)}</div><div class="category-percentage">${percentage}%</div></div>`;
          });
          html += `</div>`;
          
          html += `<div style="margin-top:20px;"><h5 style="color: var(--gray); font-size: 0.9rem; margin-bottom:10px;">${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Details</h5>`;
          items.forEach(item => { 
            const name = reportType === 'expense' ? (item.category || 'Other') : (item.source || 'Other');
            const description = reportType === 'expense' ? item.description : item.notes;
            const amountClass = reportType === 'expense' ? 'expense-amount' : 'income-amount';
            const displayDate = getFormattedDate(item);
            html += `<div class="expense-item" style="padding: 10px; border-bottom: 1px solid #eee;"><div class="item-content"><span style="font-weight:600; font-size:0.9rem;">${displayDate}</span><span style="margin-left:10px; color:var(--gray); font-size:0.85rem;">${name}</span></div><div class="expense-amount ${amountClass}" style="font-size:1rem; color:${breakdownColor}; -webkit-text-fill-color: initial;">${formatCurrency(item.amount)}</div></div>`; 
          });
          html += `</div>`;

        } else {
            html += `<div class="empty-state"><h4>No ${reportType} transactions found for ${periodLabel}</h4></div>`;
        }

        resultsContainer.innerHTML = html; 
        if (count > 0) actionsContainer.style.display = 'flex';
        showMessage(` ${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report generated for ${periodLabel}`, 'success');
      } catch (error) { 
        console.error('Report generation error:', error);
        showError('Failed to generate report: ' + error.message); 
      }
    }

    // Helper function to format date for display
    function getFormattedDate(item) {
      const date = getDateFromExpense(item);
      return date.toLocaleDateString('en-UG', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    function showCustomRange(reportType, buttonElement) { 
      const controlContainer = buttonElement.closest('.report-controls');
      if (controlContainer) {
        controlContainer.querySelectorAll('.btn-report').forEach(b => b.classList.remove('active'));
        buttonElement.classList.add('active');
      }

      document.getElementById(`${reportType}CustomRange`).style.display = 'grid'; 
    }
    
    async function generateCustomReport(reportType) {
      const fromDateInput = document.getElementById(`${reportType}FromDate`);
      const toDateInput = document.getElementById(`${reportType}ToDate`);
      const fromDate = fromDateInput.value, toDate = toDateInput.value;
      
      if (!fromDate || !toDate) { showMessage(' Please select dates', 'error'); return; }
      if (new Date(fromDate) > new Date(toDate)) { showMessage(' From date cannot be after to date', 'error'); return; }
      
      const startDate = new Date(fromDate); startDate.setHours(0,0,0,0); 
      const endDate = new Date(toDate); endDate.setHours(23,59,59,999);
      
      currentReportPeriod[reportType] = 'custom';
      
      await fetchAndDisplayReport(startDate, endDate, `Custom Range (${startDate.toLocaleDateString('en-UG')} - ${endDate.toLocaleDateString('en-UG')})`, reportType);
    }

    // ===== EXPORT FUNCTIONS =====
    function exportCSV(reportType) {
      const reportData = currentReportData[reportType];
      if (!reportData) { showError('No report data available to export.'); return; }
      
      try {
        let csvContent = '';
        const isExpense = reportType === 'expense';
        const headers = isExpense ? ['Date', 'Category', 'Description', 'Amount (UGX)'] : ['Date', 'Source', 'Notes', 'Amount (UGX)'];
        
        csvContent += headers.join(',') + '\n';
        
        reportData.items.forEach(item => {
          const date = getFormattedDate(item);
          const name = isExpense ? (item.category || 'Other') : (item.source || 'Other');
          const description = isExpense ? (item.description || '') : (item.notes || '');
          const amount = item.amount || 0;
          
          csvContent += `"${date}","${name}","${description.replace(/"/g, '""')}",${amount}\n`;
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${reportType}_report_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showMessage(' CSV exported successfully!', 'success');
      } catch (error) {
        showError('CSV export failed: ' + error.message);
      }
    }
    
    async function exportAllData() {
      if (!isFirestoreReady) { showError('Please connect to Firebase first'); return; }
      
      try {
        showMessage(' Preparing data export...', 'info');
        
        const exportData = {
          exportDate: new Date().toISOString(),
          userEmail: currentUser.email,
          userId: currentUser.uid,
          expenses: allExpenses,
          income: allIncome,
          budgets: budgets,
          reminders: reminders,
          metadata: {
            totalExpenses: allExpenses.length,
            totalIncome: allIncome.length,
            totalBudgets: budgets.length,
            totalReminders: reminders.length
          }
        };
        
        const jsonString = JSON.stringify(exportData, null, 2);
        
        const blob = new Blob([jsonString], { type: 'application/json' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `financial_data_backup_${new Date().toISOString().split('T')[0]}.json`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showMessage(' All data exported successfully!', 'success');
      } catch (error) {
        showError('Data export failed: ' + error.message);
      }
    }

    // ===== SAVINGS CALCULATOR =====
    function calculateSavingsGoal() {
      const goalAmount = parseFloat(document.getElementById('goalAmount').value) || 0;
      const targetDate = new Date(document.getElementById('targetDate').value);
      const monthlySavings = parseFloat(document.getElementById('monthlySavings').value) || 0;
      const growthRate = parseFloat(document.getElementById('growthRate').value) || 0;
      
      if (!goalAmount || !monthlySavings || targetDate <= new Date()) {
        showError('Please enter valid values for all fields');
        return;
      }
      
      const today = new Date();
      const months = Math.max(1, Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24 * 30.44)));
      
      const totalSavings = monthlySavings * months;
      const monthlyGrowth = growthRate / 12 / 100;
      let futureValue = 0;
      
      for (let i = 0; i < months; i++) {
        futureValue = (futureValue + monthlySavings) * (1 + monthlyGrowth);
      }
      
      const resultDiv = document.getElementById('savingsCalculationResult');
      const detailsDiv = document.getElementById('savingsResultDetails');
      
      detailsDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
          <div style="background: var(--light); padding: 10px; border-radius: 8px;">
            <div style="font-size: 0.8rem; color: var(--gray);">Goal Amount</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--success);">${formatCurrency(goalAmount)}</div>
          </div>
          <div style="background: var(--light); padding: 10px; border-radius: 8px;">
            <div style="font-size: 0.8rem; color: var(--gray);">Monthly Savings</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary);">${formatCurrency(monthlySavings)}</div>
          </div>
          <div style="background: var(--light); padding: 10px; border-radius: 8px;">
            <div style="font-size: 0.8rem; color: var(--gray);">Time Required</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--info);">${months} months</div>
          </div>
          <div style="background: var(--light); padding: 10px; border-radius: 8px;">
            <div style="font-size: 0.8rem; color: var(--gray);">Future Value</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--warning);">${formatCurrency(futureValue)}</div>
          </div>
        </div>
        <div style="margin-top: 10px;">
          <div style="font-weight: 600; color: ${futureValue >= goalAmount ? 'var(--success)' : 'var(--warning)'};">
            ${futureValue >= goalAmount ? ' Goal achievable!' : ' Increase monthly savings or extend timeline'}
          </div>
          ${futureValue < goalAmount ? `
            <div style="margin-top: 5px; font-size: 0.9rem;">
              Shortfall: ${formatCurrency(goalAmount - futureValue)}<br>
              Required monthly: ${formatCurrency(goalAmount / months)}
            </div>
          ` : ''}
        </div>
      `;
      
      resultDiv.style.display = 'block';
      
      window.calculatedGoal = {
        amount: goalAmount,
        targetDate: targetDate.toISOString().split('T')[0],
        monthlySavings,
        futureValue
      };
    }
    
    function setSavingsGoal() {
      if (!window.calculatedGoal) {
        showError('Please calculate first before setting a goal');
        return;
      }
      
      savingsGoal = {
        amount: window.calculatedGoal.amount,
        targetDate: window.calculatedGoal.targetDate,
        currentSavings: 0
      };
      
      saveSavingsGoal();
      updateSavingsGoalUI();
      document.getElementById('savingsCalculatorModal').style.display = 'none';
      showMessage(' Savings goal set successfully!', 'success');
    }
    
    // ===== YEARLY OVERVIEW =====
    async function loadYearlyOverview() {
      const year = document.getElementById('yearSelect').value;
      const container = document.getElementById('yearlyOverviewContent');
      
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading yearly overview...</p></div>';
      
      try {
        const monthlyExpenses = Array(12).fill(0);
        const monthlyIncome = Array(12).fill(0);
        const categories = {};
        
        allExpenses.forEach(expense => {
          const expenseDate = getDateFromExpense(expense);
          
          if (expenseDate.getFullYear() == year) {
            const month = expenseDate.getMonth();
            monthlyExpenses[month] += parseFloat(expense.amount) || 0;
            
            const category = expense.category || 'Other';
            categories[category] = (categories[category] || 0) + (parseFloat(expense.amount) || 0);
          }
        });
        
        allIncome.forEach(income => {
          const incomeDate = getDateFromExpense(income);
          
          if (incomeDate.getFullYear() == year) {
            const month = incomeDate.getMonth();
            monthlyIncome[month] += parseFloat(income.amount) || 0;
          }
        });
        
        const totalExpenses = monthlyExpenses.reduce((a, b) => a + b, 0);
        const totalIncome = monthlyIncome.reduce((a, b) => a + b, 0);
        const netSavings = totalIncome - totalExpenses;
        const savingsRate = totalIncome > 0 ? ((netSavings / totalIncome) * 100).toFixed(1) : 0;
        
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        let html = `
          <div class="report-summary" style="grid-template-columns: 1fr 1fr 1fr 1fr; margin-bottom: 25px;">
            <div class="report-summary-item" style="border: 1px solid var(--success);">
              <div class="label" style="color: var(--success);">Total Income</div>
              <div class="value" style="color: var(--success);">${formatCurrency(totalIncome)}</div>
            </div>
            <div class="report-summary-item" style="border: 1px solid var(--danger);">
              <div class="label" style="color: var(--danger);">Total Expenses</div>
              <div class="value" style="color: var(--danger);">${formatCurrency(totalExpenses)}</div>
            </div>
            <div class="report-summary-item" style="border: 1px solid ${netSavings >= 0 ? 'var(--success)' : 'var(--danger)'};">
              <div class="label" style="color: ${netSavings >= 0 ? 'var(--success)' : 'var(--danger)'};">Net Savings</div>
              <div class="value" style="color: ${netSavings >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(netSavings)}</div>
            </div>
            <div class="report-summary-item" style="border: 1px solid var(--info);">
              <div class="label" style="color: var(--info);">Savings Rate</div>
              <div class="value" style="color: var(--info);">${savingsRate}%</div>
            </div>
          </div>
          
          <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-chart-line"></i> Monthly Trends</h4>
          <div style="margin-bottom: 25px;">
        `;
        
        monthNames.forEach((month, index) => {
          const maxExpense = Math.max(...monthlyExpenses) || 1;
          const maxIncome = Math.max(...monthlyIncome) || 1;
          const expenseHeight = monthlyExpenses[index] > 0 ? Math.min(100, (monthlyExpenses[index] / maxExpense) * 100) : 0;
          const incomeHeight = monthlyIncome[index] > 0 ? Math.min(100, (monthlyIncome[index] / maxIncome) * 100) : 0;
          
          html += `
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="font-weight: 600;">${month}</span>
                <span style="font-size: 0.9rem;">
                  <span style="color: var(--success);">${formatCurrency(monthlyIncome[index])}</span> / 
                  <span style="color: var(--danger);">${formatCurrency(monthlyExpenses[index])}</span>
                </span>
              </div>
              <div style="display: flex; height: 20px; background: var(--light); border-radius: 4px; overflow: hidden;">
                <div style="width: ${incomeHeight}%; background: linear-gradient(90deg, var(--success), #2ecc71);"></div>
                <div style="width: ${expenseHeight}%; background: linear-gradient(90deg, var(--danger), #e74c3c);"></div>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
        
        if (Object.keys(categories).length > 0) {
          const sortedCategories = Object.entries(categories).sort((a, b) => b[1] - a[1]).slice(0, 8);
          
          html += `
            <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-chart-pie"></i> Top Expense Categories</h4>
            <div class="category-breakdown">
          `;
          
          sortedCategories.forEach(([name, amount]) => {
            const percentage = totalExpenses > 0 ? Math.round((amount / totalExpenses) * 100) : 0;
            
            html += `
              <div class="category-item">
                <div class="category-name"><span class="category-badge category-${name.toLowerCase().replace(' ', '-')}">${name}</span></div>
                <div class="category-bar">
                  <div class="category-fill" style="width: ${percentage}%"></div>
                </div>
                <div class="category-amount">${formatCurrency(amount)}</div>
                <div class="category-percentage">${percentage}%</div>
              </div>
            `;
          });
          
          html += `</div>`;
        }
        
        container.innerHTML = html;
        
      } catch (error) {
        container.innerHTML = `<div class="empty-state"><h4>Error loading yearly overview</h4><p>${error.message}</p></div>`;
      }
    }
    
    function downloadYearlyPDF() {
      const year = document.getElementById('yearSelect').value;
      try {
        const { jsPDF } = window.jspdf; 
        const doc = new jsPDF();
        
        doc.setFontSize(18); 
        doc.setTextColor(67, 97, 238); 
        doc.text(`Yearly Financial Overview - ${year}`, 105, 20, { align: 'center' });
        
        let yPos = 35;
        
        doc.setFontSize(12);
        doc.text('Generated on: ' + new Date().toLocaleDateString('en-UG'), 20, yPos);
        yPos += 15;
        
        doc.setFontSize(14);
        doc.text('Note: This is a simplified yearly overview. For detailed reports, use the specific report features.', 20, yPos, { maxWidth: 170 });
        yPos += 20;
        
        doc.save(`yearly_overview_${year}_${new Date().toISOString().split('T')[0]}.pdf`);
        showMessage(' Yearly overview PDF downloaded!', 'success');
      } catch (error) {
        showError('PDF download failed: ' + error.message);
      }
    }
	
	// ===== YEARLY OVERVIEW FUNCTIONS =====
let yearlyTrendChart = null; // Define this variable at the top

async function loadYearlyOverview() {
  const yearSelect = document.getElementById('yearSelect');
  const selectedYear = parseInt(yearSelect.value);
  const container = document.getElementById('yearlyOverviewContent');
  
  // Show loading state
  container.innerHTML = `<div class="loading"><div class="spinner"></div><p>Loading yearly data for ${selectedYear}...</p></div>`;
  
  try {
    // Get yearly data
    const yearlyData = getYearlyData(selectedYear); // Removed async since it's not doing async operations
    
    if (!yearlyData || yearlyData.totalIncome === 0 && yearlyData.totalExpense === 0) {
      container.innerHTML = `
        <div class="empty-state" style="padding: 30px;">
          <i class="fas fa-calendar fa-3x" style="color: var(--gray); margin-bottom: 15px;"></i>
          <h4 style="color: var(--gray); margin-bottom: 10px;">No Data Available</h4>
          <p>No financial data found for ${selectedYear}. Start adding expenses and income to see your yearly overview.</p>
        </div>
      `;
      return;
    }
    
    // Generate HTML for yearly overview
    let html = `
      <div class="report-summary" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 20px;">
        <div class="report-summary-item" style="border: 1px solid var(--success);">
          <div class="label" style="color: var(--success);">Total Income</div>
          <div class="value" style="color: var(--success); font-size: 1.4rem;">${formatCurrency(yearlyData.totalIncome)}</div>
        </div>
        <div class="report-summary-item" style="border: 1px solid var(--danger);">
          <div class="label" style="color: var(--danger);">Total Expenses</div>
          <div class="value" style="color: var(--danger); font-size: 1.4rem;">${formatCurrency(yearlyData.totalExpense)}</div>
        </div>
        <div class="report-summary-item" style="border: 1px solid var(--primary);">
          <div class="label" style="color: var(--primary);">Net Savings</div>
          <div class="value" style="color: var(--primary); font-size: 1.4rem;">${formatCurrency(yearlyData.netSavings)}</div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1rem;">
          <i class="fas fa-chart-line"></i> Yearly Trend
        </h4>
        <div style="height: 200px; position: relative;">
          <canvas id="yearlyTrendChart" style="width:100%; height:100%;"></canvas>
        </div>
      </div>
      
      <div>
        <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1rem;">
          <i class="fas fa-calendar-alt"></i> Month-by-Month Breakdown
        </h4>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
            <thead>
              <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                <th style="padding: 10px; text-align: left;">Month</th>
                <th style="padding: 10px; text-align: right; color: var(--success);">Income</th>
                <th style="padding: 10px; text-align: right; color: var(--danger);">Expenses</th>
                <th style="padding: 10px; text-align: right; color: var(--primary);">Net</th>
                <th style="padding: 10px; text-align: center;">Savings Rate</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    // Add month rows
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    let totalIncome = 0;
    let totalExpense = 0;
    
    monthNames.forEach((monthName, index) => {
      const monthData = yearlyData.monthlyData[index] || { income: 0, expense: 0 };
      const net = monthData.income - monthData.expense;
      const savingsRate = monthData.income > 0 ? 
        Math.round((net / monthData.income) * 100) : 
        (monthData.expense > 0 ? -100 : 0);
      
      totalIncome += monthData.income;
      totalExpense += monthData.expense;
      
      html += `
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: 10px; font-weight: 600;">${monthName}</td>
          <td style="padding: 10px; text-align: right; color: var(--success);">${formatCurrency(monthData.income)}</td>
          <td style="padding: 10px; text-align: right; color: var(--danger);">${formatCurrency(monthData.expense)}</td>
          <td style="padding: 10px; text-align: right; color: ${net >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(net)}</td>
          <td style="padding: 10px; text-align: center; color: ${savingsRate >= 0 ? 'var(--success)' : 'var(--danger)'};">
            ${savingsRate}%
          </td>
        </tr>
      `;
    });
    
    // Add totals row
    const yearlyNet = totalIncome - totalExpense;
    const yearlySavingsRate = totalIncome > 0 ? Math.round((yearlyNet / totalIncome) * 100) : 0;
    
    html += `
            <tr style="background: var(--light); border-top: 2px solid var(--border); font-weight: 700;">
              <td style="padding: 10px;">TOTAL</td>
              <td style="padding: 10px; text-align: right; color: var(--success);">${formatCurrency(totalIncome)}</td>
              <td style="padding: 10px; text-align: right; color: var(--danger);">${formatCurrency(totalExpense)}</td>
              <td style="padding: 10px; text-align: right; color: ${yearlyNet >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(yearlyNet)}</td>
              <td style="padding: 10px; text-align: center; color: ${yearlySavingsRate >= 0 ? 'var(--success)' : 'var(--danger)'};">${yearlySavingsRate}%</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
    
    // Add category breakdown if available
    if (Object.keys(yearlyData.topCategories).length > 0) {
      html += `
        <div style="margin-top: 25px;">
          <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 1.1rem;">
            <i class="fas fa-chart-pie"></i> Top Expense Categories
          </h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      `;
      
      let categoryCount = 0;
      for (const [category, amount] of Object.entries(yearlyData.topCategories)) {
        if (categoryCount >= 6) break; // Show top 6 categories
        const percentage = yearlyData.totalExpense > 0 ? 
          Math.round((amount / yearlyData.totalExpense) * 100) : 0;
        
        html += `
          <div style="background: var(--light); padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">
            <div style="font-weight: 600; margin-bottom: 5px;">${category}</div>
            <div style="color: var(--danger); font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${formatCurrency(amount)}</div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: ${percentage}%; background: linear-gradient(90deg, var(--danger), #ff6b6b); border-radius: 3px;"></div>
              </div>
              <div style="font-size: 0.8rem; color: var(--gray);">${percentage}%</div>
            </div>
          </div>
        `;
        categoryCount++;
      }
      
      html += `</div></div>`;
    }
    
    // Add top income sources if available
    if (Object.keys(yearlyData.topSources).length > 0) {
      html += `
        <div style="margin-top: 25px;">
          <h4 style="color: var(--success); margin-bottom: 15px; font-size: 1.1rem;">
            <i class="fas fa-money-bill-wave"></i> Top Income Sources
          </h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      `;
      
      let sourceCount = 0;
      for (const [source, amount] of Object.entries(yearlyData.topSources)) {
        if (sourceCount >= 6) break; // Show top 6 sources
        const percentage = yearlyData.totalIncome > 0 ? 
          Math.round((amount / yearlyData.totalIncome) * 100) : 0;
        
        html += `
          <div style="background: var(--light); padding: 12px; border-radius: 8px; border-left: 4px solid var(--success);">
            <div style="font-weight: 600; margin-bottom: 5px;">${source}</div>
            <div style="color: var(--success); font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${formatCurrency(amount)}</div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: ${percentage}%; background: linear-gradient(90deg, var(--success), #2ecc71); border-radius: 3px;"></div>
              </div>
              <div style="font-size: 0.8rem; color: var(--gray);">${percentage}%</div>
            </div>
          </div>
        `;
        sourceCount++;
      }
      
      html += `</div></div>`;
    }
    
    container.innerHTML = html;
    
    // Store data for PDF export
    window.currentYearlyData = yearlyData;
    window.currentYearlyData.year = selectedYear;
    window.currentYearlyData.monthNames = monthNames;
    
    // Create the yearly trend chart after a small delay to ensure DOM is ready
    setTimeout(() => {
      createYearlyTrendChart(yearlyData);
    }, 100);
    
    showMessage(` Yearly overview for ${selectedYear} loaded successfully!`, 'success');
  } catch (error) {
    console.error('Error loading yearly overview:', error);
    container.innerHTML = `
      <div class="message error show">
        <i class="fas fa-exclamation-circle"></i>
        <span>Error loading yearly data: ${error.message}</span>
      </div>
    `;
  }
}

function getYearlyData(year) {
  const monthlyData = Array(12).fill().map(() => ({ income: 0, expense: 0 }));
  const topCategories = {};
  const topSources = {};
  
  let totalIncome = 0;
  let totalExpense = 0;
  
  // Process expenses
  allExpenses.forEach(expense => {
    const expenseDate = getDateFromExpense(expense);
    if (expenseDate.getFullYear() === year) {
      const month = expenseDate.getMonth(); // 0-11
      const amount = parseFloat(expense.amount) || 0;
      
      monthlyData[month].expense += amount;
      totalExpense += amount;
      
      // Track categories
      const category = expense.category || 'Other';
      topCategories[category] = (topCategories[category] || 0) + amount;
    }
  });
  
  // Process income
  allIncome.forEach(income => {
    const incomeDate = getDateFromExpense(income);
    if (incomeDate.getFullYear() === year) {
      const month = incomeDate.getMonth(); // 0-11
      const amount = parseFloat(income.amount) || 0;
      
      monthlyData[month].income += amount;
      totalIncome += amount;
      
      // Track sources
      const source = income.source || 'Other';
      topSources[source] = (topSources[source] || 0) + amount;
    }
  });
  
  // Sort categories and sources by amount (descending)
  const sortedCategories = Object.entries(topCategories)
    .sort(([,a], [,b]) => b - a)
    .reduce((obj, [key, val]) => {
      obj[key] = val;
      return obj;
    }, {});
  
  const sortedSources = Object.entries(topSources)
    .sort(([,a], [,b]) => b - a)
    .reduce((obj, [key, val]) => {
      obj[key] = val;
      return obj;
    }, {});
  
  return {
    monthlyData,
    totalIncome,
    totalExpense,
    netSavings: totalIncome - totalExpense,
    topCategories: sortedCategories,
    topSources: sortedSources
  };
}

function createYearlyTrendChart(yearlyData) {
  const ctx = document.getElementById('yearlyTrendChart');
  if (!ctx) {
    console.error('Canvas element not found for yearly trend chart');
    return;
  }
  
  // Destroy existing chart if it exists
  if (yearlyTrendChart && typeof yearlyTrendChart.destroy === 'function') {
    try {
      yearlyTrendChart.destroy();
    } catch (e) {
      console.warn('Error destroying previous chart:', e);
    }
  }
  
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const incomeData = yearlyData.monthlyData.map(m => m.income);
  const expenseData = yearlyData.monthlyData.map(m => m.expense);
  const netData = yearlyData.monthlyData.map(m => m.income - m.expense);
  
  // Get the context
  const chartContext = ctx.getContext('2d');
  if (!chartContext) {
    console.error('Could not get canvas context');
    return;
  }
  
  try {
    yearlyTrendChart = new Chart(chartContext, {
      type: 'line',
      data: {
        labels: monthNames,
        datasets: [
          {
            label: 'Income',
            data: incomeData,
            borderColor: 'rgba(40, 167, 69, 1)',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          },
          {
            label: 'Expenses',
            data: expenseData,
            borderColor: 'rgba(220, 53, 69, 1)',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          },
          {
            label: 'Net',
            data: netData,
            borderColor: 'rgba(255, 152, 0, 1)',
            backgroundColor: 'rgba(255, 152, 0, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            borderDash: [5, 5]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: currentTheme === 'dark' ? '#ffffff' : '#333333',
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                label += formatCurrency(context.parsed.y).replace('UGX ', 'UGX ');
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              color: currentTheme === 'dark' ? '#ffffff' : '#333333'
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              color: currentTheme === 'dark' ? '#ffffff' : '#333333',
              callback: function(value) {
                if (value >= 1000000) return 'UGX ' + (value / 1000000).toFixed(1) + 'M';
                if (value >= 1000) return 'UGX ' + (value / 1000).toFixed(0) + 'K';
                return 'UGX ' + value;
              }
            }
          }
        }
      }
    });
  } catch (error) {
    console.error('Error creating yearly trend chart:', error);
    showError('Failed to create chart: ' + error.message);
  }
}

function downloadYearlyPDF() {
  if (!window.currentYearlyData) {
    showError('No yearly data available to download. Please load the yearly overview first.');
    return;
  }
  
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const year = window.currentYearlyData.year;
    const monthNames = window.currentYearlyData.monthNames || 
      ['January', 'February', 'March', 'April', 'May', 'June', 
       'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Title
    doc.setFontSize(20);
    doc.setTextColor(67, 97, 238);
    doc.text(`Financial Tracker PRO - Yearly Overview ${year}`, 105, 20, { align: 'center' });
    
    // Summary Section
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text('Yearly Summary', 20, 40);
    
    doc.setFontSize(11);
    doc.text(`Year: ${year}`, 20, 50);
    doc.text(`Generated: ${new Date().toLocaleDateString('en-UG')}`, 20, 56);
    doc.text(`User: ${currentUser.email}`, 20, 62);
    
    // Summary Boxes
    const summaryY = 75;
    doc.setDrawColor(40, 167, 69);
    doc.rect(20, summaryY, 55, 20);
    doc.setTextColor(40, 167, 69);
    doc.setFontSize(10);
    doc.text('TOTAL INCOME', 27, summaryY + 8);
    doc.setFontSize(12);
    doc.text(formatCurrency(window.currentYearlyData.totalIncome), 27, summaryY + 16);
    
    doc.setDrawColor(220, 53, 69);
    doc.rect(80, summaryY, 55, 20);
    doc.setTextColor(220, 53, 69);
    doc.setFontSize(10);
    doc.text('TOTAL EXPENSES', 87, summaryY + 8);
    doc.setFontSize(12);
    doc.text(formatCurrency(window.currentYearlyData.totalExpense), 87, summaryY + 16);
    
    doc.setDrawColor(255, 152, 0);
    doc.rect(140, summaryY, 55, 20);
    doc.setTextColor(255, 152, 0);
    doc.setFontSize(10);
    doc.text('NET SAVINGS', 147, summaryY + 8);
    doc.setFontSize(12);
    doc.text(formatCurrency(window.currentYearlyData.netSavings), 147, summaryY + 16);
    
    // Month-by-Month Table
    let yPos = 110;
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text('Month-by-Month Breakdown', 20, yPos);
    yPos += 10;
    
    const tableData = [];
    monthNames.forEach((month, index) => {
      const monthData = window.currentYearlyData.monthlyData[index] || { income: 0, expense: 0 };
      const net = monthData.income - monthData.expense;
      const savingsRate = monthData.income > 0 ? 
        Math.round((net / monthData.income) * 100) : 
        (monthData.expense > 0 ? -100 : 0);
      
      tableData.push([
        month,
        formatCurrency(monthData.income),
        formatCurrency(monthData.expense),
        formatCurrency(net),
        `${savingsRate}%`
      ]);
    });
    
    // Add totals row
    tableData.push([
      'TOTAL',
      formatCurrency(window.currentYearlyData.totalIncome),
      formatCurrency(window.currentYearlyData.totalExpense),
      formatCurrency(window.currentYearlyData.netSavings),
      window.currentYearlyData.totalIncome > 0 ? 
        `${Math.round((window.currentYearlyData.netSavings / window.currentYearlyData.totalIncome) * 100)}%` : '0%'
    ]);
    
    doc.autoTable({
      startY: yPos,
      head: [['Month', 'Income', 'Expenses', 'Net', 'Savings Rate']],
      body: tableData,
      headStyles: { fillColor: [67, 97, 238] },
      styles: { fontSize: 9 },
      columnStyles: {
        0: { cellWidth: 30 },
        1: { cellWidth: 40, halign: 'right' },
        2: { cellWidth: 40, halign: 'right' },
        3: { cellWidth: 40, halign: 'right' },
        4: { cellWidth: 25, halign: 'center' }
      },
      didDrawPage: function(data) {
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(
          `Generated by Financial Tracker PRO - ${new Date().toLocaleString()}`,
          data.settings.margin.left,
          doc.internal.pageSize.height - 10
        );
      }
    });
    
    // Add a new page for top categories if there are categories
    if (Object.keys(window.currentYearlyData.topCategories).length > 0) {
      doc.addPage();
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text('Top Expense Categories', 20, 20);
      
      let categoryY = 30;
      let count = 0;
      for (const [category, amount] of Object.entries(window.currentYearlyData.topCategories)) {
        if (count >= 10) break; // Show top 10 categories
        
        const percentage = window.currentYearlyData.totalExpense > 0 ? 
          Math.round((amount / window.currentYearlyData.totalExpense) * 100) : 0;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`${category}:`, 20, categoryY);
        
        doc.setFontSize(11);
        doc.setTextColor(220, 53, 69);
        doc.text(formatCurrency(amount), 120, categoryY);
        
        doc.setFontSize(9);
        doc.setTextColor(128, 128, 128);
        doc.text(`${percentage}%`, 180, categoryY);
        
        categoryY += 8;
        count++;
      }
    }
    
    // Add a new page for top income sources if there are sources
    if (Object.keys(window.currentYearlyData.topSources).length > 0) {
      doc.addPage();
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text('Top Income Sources', 20, 20);
      
      let sourceY = 30;
      let count = 0;
      for (const [source, amount] of Object.entries(window.currentYearlyData.topSources)) {
        if (count >= 10) break; // Show top 10 sources
        
        const percentage = window.currentYearlyData.totalIncome > 0 ? 
          Math.round((amount / window.currentYearlyData.totalIncome) * 100) : 0;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`${source}:`, 20, sourceY);
        
        doc.setFontSize(11);
        doc.setTextColor(40, 167, 69);
        doc.text(formatCurrency(amount), 120, sourceY);
        
        doc.setFontSize(9);
        doc.setTextColor(128, 128, 128);
        doc.text(`${percentage}%`, 180, sourceY);
        
        sourceY += 8;
        count++;
      }
    }
    
    // Save the PDF
    doc.save(`Yearly_Financial_Overview_${year}.pdf`);
    showMessage(' Yearly PDF report downloaded successfully!', 'success');
  } catch (error) {
    console.error('PDF generation error:', error);
    showError('Failed to generate PDF: ' + error.message);
  }
}

// Also, update the showYearlyOverview function to load data when modal is shown:
function showYearlyOverview() { 
  document.getElementById('yearlyOverviewModal').style.display = 'flex';
  // Set default year to current year
  const currentYear = new Date().getFullYear();
  document.getElementById('yearSelect').value = currentYear;
  // Load data
  setTimeout(() => loadYearlyOverview(), 100);
}

    // ===== DEBT TRACKER =====
    function calculateDebt() {
      const name = document.getElementById('debtName').value.trim();
      const totalAmount = parseFloat(document.getElementById('debtTotalAmount').value) || 0;
      const paidAmount = parseFloat(document.getElementById('debtPaidAmount').value) || 0;
      const dueDate = new Date(document.getElementById('debtDueDate').value);
      const interestRate = parseFloat(document.getElementById('debtInterestRate').value) || 0;
      
      if (!name || totalAmount <= 0) {
        showError('Please enter valid debt information');
        return;
      }
      
      const remaining = totalAmount - paidAmount;
      const today = new Date();
      const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
      const monthlyInterest = (totalAmount * interestRate) / 12 / 100;
      const totalInterest = (remaining * interestRate * daysUntilDue) / 36500;
      const progress = (paidAmount / totalAmount) * 100;
      
      const resultDiv = document.getElementById('debtCalculationResult');
      const detailsDiv = document.getElementById('debtResultDetails');
      
      detailsDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
          <div style="background: var(--light); padding: 10px; border-radius: 8px;">
            <div style="font-size: 0.8rem; color: var(--gray);">Total Debt</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--danger);">${formatCurrency(totalAmount)}</div>
          </div>
          <div style="background: var(--light); padding: 10px; border-radius: 8px;">
            <div style="font-size: 0.8rem; color: var(--gray);">Amount Paid</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--success);">${formatCurrency(paidAmount)}</div>
          </div>
          <div style="background: var(--light); padding: 10px; border-radius: 8px;">
            <div style="font-size: 0.8rem; color: var(--gray);">Remaining</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: var(--warning);">${formatCurrency(remaining)}</div>
          </div>
          <div style="background: var(--light); padding: 10px; border-radius: 8px;">
            <div style="font-size: 0.8rem; color: var(--gray);">Progress</div>
            <div style="font-size: 1.2rem; font-weight: 700; color: ${progress >= 50 ? 'var(--success)' : 'var(--warning)'};">${progress.toFixed(1)}%</div>
          </div>
        </div>
        <div style="margin-top: 10px;">
          <div style="font-weight: 600; color: var(--warning);">
            ${remaining > 0 ? ` ${formatCurrency(remaining)} remaining` : ' Debt fully paid!'}
          </div>
          ${remaining > 0 ? `
            <div style="margin-top: 5px; font-size: 0.9rem;">
              Due in: ${daysUntilDue} days<br>
              Monthly interest: ${formatCurrency(monthlyInterest)}<br>
              Total interest payable: ${formatCurrency(totalInterest)}
            </div>
          ` : ''}
        </div>
      `;
      
      resultDiv.style.display = 'block';
      
      window.currentDebt = {
        name,
        totalAmount,
        paidAmount,
        dueDate: dueDate.toISOString().split('T')[0],
        interestRate,
        remaining
      };
    }
    
    function saveDebt() {
      if (!window.currentDebt) {
        showError('Please calculate debt first before saving');
        return;
      }
      
      if (!debts) debts = [];
      debts.push(window.currentDebt);
      localStorage.setItem('debts_' + currentUser.uid, JSON.stringify(debts));
      
      document.getElementById('debtTrackerModal').style.display = 'none';
      showMessage(' Debt saved successfully!', 'success');
    }

    // ===== DASHBOARD FUNCTIONS =====
    function updateStatsUI(stats) {
      document.getElementById('totalIncomeValue').textContent = formatCurrency(stats.totalIncome);
      document.getElementById('totalExpenseValue').textContent = formatCurrency(stats.totalExpense);
      document.getElementById('availableBalanceValue').textContent = formatCurrency(stats.availableBalance);
      document.getElementById('todayTotal').textContent = formatCurrency(stats.today);
      document.getElementById('weekTotal').textContent = formatCurrency(stats.week);
      document.getElementById('monthTotal').textContent = formatCurrency(stats.month);
      document.getElementById('yearTotal').textContent = formatCurrency(stats.year);
      
      // Debug log to check values
      console.log('Stats updated:', { 
        today: stats.today, 
        week: stats.week, 
        month: stats.month, 
        year: stats.year,
        totalExpense: stats.totalExpense 
      });
      
      const calcChange = (cur, prev) => { 
        if (!prev || prev === 0) return '--'; 
        const chg = ((cur - prev) / prev * 100).toFixed(1); 
        return chg > 0 ? `+${chg}% ` : `${chg}% `; 
      };
      
      document.getElementById('monthChange').textContent = calcChange(stats.month, previousStats.month); 
      previousStats = stats;
    }

    function updateCharts(categories, weeklyData) {
      const pieCtx = document.getElementById('pieChart')?.getContext('2d');
      const barCtx = document.getElementById('barChart')?.getContext('2d');
      
      if (!pieCtx || !barCtx) return;
      
      const categoryColors = ['#ff9800', '#f093fb', '#f5576c', '#4ecdc4', '#ffb74d', '#06d6a0', '#a78bfa', '#f97316'];
      
      if (pieChart) pieChart.destroy();
      if (Object.keys(categories).length > 0) {
        pieChart = new Chart(pieCtx, { 
          type: 'doughnut', 
          data: { 
            labels: Object.keys(categories), 
            datasets: [{ 
              data: Object.values(categories), 
              backgroundColor: categoryColors, 
              borderWidth: 2 
            }] 
          }, 
          options: { 
            responsive: true, 
            cutout: '70%',
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          } 
        });
      }
      
      if (barChart) barChart.destroy();
      barChart = new Chart(barCtx, { 
        type: 'bar', 
        data: { 
          labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], 
          datasets: [{ 
            label: 'Expenses', 
            data: weeklyData, 
            backgroundColor: 'rgba(255, 152, 0, 0.7)',
            borderColor: 'rgba(255, 152, 0, 1)',
            borderWidth: 1
          }] 
        }, 
        options: { 
          responsive: true, 
          scales: { 
            y: { 
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'UGX ' + value.toLocaleString('en-UG');
                }
              }
            } 
          },
          plugins: {
            legend: {
              display: false
            }
          }
        } 
      });
    }

    // FIXED: Load expenses list with proper date formatting
    function loadExpensesList(expenses) {
      const container = document.getElementById('expensesList');
      if (!expenses || expenses.length === 0) { 
        container.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No expenses found.</p></div>`; 
        return; 
      }
      
      let html = ''; 
      expenses.slice(0, 30).forEach(expense => {
        const date = getFormattedDate(expense);
        const descSafe = (expense.description || '').replace(/'/g, "\\'");
        const category = expense.category || 'Other';
        const categoryClass = category.toLowerCase().replace(' ', '-').replace('/', '-');
        
        html += `
          <div class="expense-item">
            <div class="item-content">
              <span class="category-badge category-${categoryClass}">
                <i class="fas fa-tag"></i> ${category}
              </span>
              <strong>${date}</strong>
              <div style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
                ${expense.description || ''}
              </div>
            </div>
            <div class="expense-amount">${formatCurrency(expense.amount)}</div>
            <div class="item-actions">
              <button class="action-btn edit" onclick="prepareEditExpense('${expense.id}', ${expense.amount}, '${category}', '${expense.date || ''}', '${descSafe}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete" onclick="confirmDeleteModal('${expense.id}', 'expenses', '${category} - ${formatCurrency(expense.amount)}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      populateCategoryFilter();
      populateMonthFilter('expense');
    }
    
	function loadExpensesList(expensesArray) {
  const expensesList = document.getElementById('expensesList');
  if (!expensesList) return;
  
  if (!expensesArray || expensesArray.length === 0) {
    expensesList.innerHTML = '<div class="empty-state"><i class="fas fa-receipt"></i><p>No expenses found. Add your first expense above!</p></div>';
    return;
  }
  
  // Sort by date (newest first)
  const sortedExpenses = [...expensesArray].sort((a, b) => {
    const dateA = new Date(a.date || a.timestamp?.toDate?.() || a.createdAt?.toDate?.());
    const dateB = new Date(b.date || b.timestamp?.toDate?.() || b.createdAt?.toDate?.());
    return dateB - dateA;
  });
  
  let html = '';
  
  sortedExpenses.forEach(expense => {
    const amount = parseFloat(expense.amount) || 0;
    // Use categoryDisplay if available, otherwise convert category value to display name
    const categoryDisplay = expense.categoryDisplay || getCategoryDisplayName(expense.category) || expense.category || 'Other';
    const description = expense.description || 'No description';
    const date = expense.date ? new Date(expense.date).toLocaleDateString('en-US', { 
      weekday: 'short', 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    }) : 'Unknown date';
    
    // Determine category badge class - use the actual value for CSS class
    const categoryValue = expense.category || 'Other';
    const categoryClass = 'category-' + categoryValue.toLowerCase().replace(/\s+/g, '-');
    
    html += `
      <div class="expense-item" id="expense-${expense.id}">
        <div class="item-content">
          <strong>${date}</strong>
          <div>${description}</div>
          <span class="category-badge ${categoryClass}"><i class="fas fa-tag"></i> ${categoryDisplay}</span>
        </div>
        <div class="expense-amount">UGX ${amount.toLocaleString('en-US')}</div>
        <div class="item-actions">
          <button class="action-btn edit" onclick="editExpense('${expense.id}')" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="action-btn delete" onclick="showDeleteModal('${expense.id}', 'expenses')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
  });
  
  expensesList.innerHTML = html;
}
	
    // FIXED: Load income list with proper date formatting
    function loadIncomeList(income) {
      const container = document.getElementById('incomeList');
      if (!income || income.length === 0) { 
        container.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>No income records found.</p></div>`; 
        return; 
      }
      
      let html = ''; 
      income.slice(0, 20).forEach(inc => {
        const date = getFormattedDate(inc);
        const notesSafe = (inc.notes || '').replace(/'/g, "\\'");
        const source = inc.source || 'Other';
        const sourceClass = source.toLowerCase().replace('/', '-');
        
      html += `
  <div class="income-item"> <!-- CHANGED FROM expense-item TO income-item -->
    <div class="item-content">
      <span class="category-badge category-${sourceClass}" style="background:var(--success); color:white;">
        <i class="fas fa-briefcase"></i> ${source}
      </span>
      <strong>${date}</strong>
      <div style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">
        ${inc.notes || ''}
      </div>
    </div>
    <div class="expense-amount income-amount">${formatCurrency(inc.amount)}</div>
    <div class="item-actions">
      <button class="action-btn edit" onclick="prepareEditIncome('${inc.id}', ${inc.amount}, '${source}', '${inc.date || ''}', '${notesSafe}')">
        <i class="fas fa-edit"></i>
      </button>
      <button class="action-btn delete" onclick="confirmDeleteModal('${inc.id}', 'income', '${source} - ${formatCurrency(inc.amount)}')">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  </div>
`;
      });
      
      container.innerHTML = html;
      
      populateSourceFilter();
      populateMonthFilter('income');
    }
    
    function populateCategoryFilter() {
      const select = document.getElementById('filterExpenseCategory');
      const categories = new Set();
      
      allExpenses.forEach(expense => {
        categories.add(expense.category || 'Other');
      });
      
      select.innerHTML = '<option value="">All Categories</option>';
      categories.forEach(category => {
        select.innerHTML += `<option value="${category}">${category}</option>`;
      });
    }
    
    function populateSourceFilter() {
      const select = document.getElementById('filterIncomeSource');
      const sources = new Set();
      
      allIncome.forEach(income => {
        sources.add(income.source || 'Other');
      });
      
      select.innerHTML = '<option value="">All Sources</option>';
      sources.forEach(source => {
        select.innerHTML += `<option value="${source}">${source}</option>`;
      });
    }
    
    // FIXED: Populate month filter with actual months from data
    function populateMonthFilter(type) {
      const select = document.getElementById(`filter${type.charAt(0).toUpperCase() + type.slice(1)}Month`);
      const months = new Set();
      
      const items = type === 'expense' ? allExpenses : allIncome;
      items.forEach(item => {
        const date = getDateFromExpense(item);
        if (!isNaN(date.getTime())) {
          const month = date.toLocaleDateString('en-US', { month: 'short' });
          months.add(month);
        }
      });
      
      select.innerHTML = '<option value="">All Months</option>';
      months.forEach(month => {
        select.innerHTML += `<option value="${month}">${month}</option>`;
      });
    }

    // ===== DELETE FUNCTIONS =====
    function confirmDeleteModal(id, collection, description) {
      itemToDeleteId = id; collectionToDelete = collection;
      document.getElementById('deleteExpenseDetails').textContent = description;
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function hideDeleteModal() { 
      document.getElementById('deleteModal').style.display = 'none'; 
      itemToDeleteId = null; 
      collectionToDelete = null; 
    }
    
    async function deleteItem() {
      if (!itemToDeleteId || !collectionToDelete || !isFirestoreReady) { 
        hideDeleteModal(); 
        return; 
      }
      
      try {
        await db.collection(collectionToDelete).doc(itemToDeleteId).delete();
        showMessage(' Item deleted successfully', 'success');
        
        if (collectionToDelete === 'expenses' && itemToDeleteId === editingExpenseId) cancelEditExpense();
        if (collectionToDelete === 'income' && itemToDeleteId === editingIncomeId) cancelEditIncome();
        if (collectionToDelete === 'budgets' && itemToDeleteId === editingBudgetId) cancelEditBudget();
        if (collectionToDelete === 'reminders' && itemToDeleteId === editingReminderId) cancelEditReminder();
        
        hideDeleteModal(); 
      } catch (error) { 
        showError('Failed to delete: ' + error.message); 
        hideDeleteModal(); 
      }
    }

    // ===== PDF DOWNLOAD FUNCTIONS =====
    function downloadPDF(reportType) {
      const reportData = currentReportData[reportType];
      if (!reportData) { showError('No report data available to download.'); return; }
      
      try {
        const { jsPDF } = window.jspdf; 
        const doc = new jsPDF();
        const isExpense = reportType === 'expense';
        const title = isExpense ? 'Expense Report' : 'Income Report';
        const totalLabel = isExpense ? 'Total Expenses' : 'Total Income';
        const breakdownTitle = isExpense ? 'Category Breakdown' : 'Source Breakdown';
        const detailHeaders = isExpense ? ['Date', 'Category', 'Description', 'Amount'] : ['Date', 'Source', 'Notes', 'Amount'];
        const tableColor = isExpense ? [220, 53, 69] : [40, 167, 69];

        doc.setFontSize(18); 
        doc.setTextColor(67, 97, 238); 
        doc.text(`Financial Tracker PRO - ${title}`, 105, 20, { align: 'center' });
        
        doc.setFontSize(12); 
        doc.setTextColor(0,0,0); 
        doc.text(reportData.periodLabel, 105, 30, { align: 'center' });
        
        let yPos = 45; 
        
        doc.setFontSize(14); 
        doc.setTextColor(tableColor[0], tableColor[1], tableColor[2]); 
        doc.text('Summary', 20, yPos); 
        yPos += 10;
        
        doc.setFontSize(11); 
        doc.setTextColor(0,0,0);
        doc.text(`${totalLabel}: ${formatCurrency(reportData.totalAmount)}`, 20, yPos); 
        yPos += 7;
        doc.text(`Total Transactions: ${reportData.count}`, 20, yPos); 
        yPos += 15;
        
        if (reportData.breakdown.length > 0) {
            doc.setFontSize(14); 
            doc.setTextColor(tableColor[0], tableColor[1], tableColor[2]); 
            doc.text(breakdownTitle, 20, yPos); 
            yPos += 10;
            
            const breakdownTable = reportData.breakdown.map(([name, amount]) => {
                const percentage = reportData.totalAmount > 0 ? ((amount / reportData.totalAmount) * 100).toFixed(1) + '%' : '0%';
                return [name, formatCurrency(amount), percentage];
            });
            
            doc.autoTable({ 
              startY: yPos, 
              head: [['Name', 'Amount', 'Percentage']], 
              body: breakdownTable, 
              headStyles: { fillColor: tableColor } 
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
        }

        if (reportData.items.length > 0) {
            doc.setFontSize(14); 
            doc.setTextColor(67, 97, 238); 
            doc.text('Detailed Transactions', 20, yPos); 
            yPos += 10;
            
            const detailTable = reportData.items.map(item => {
                const name = isExpense ? (item.category || 'Other') : (item.source || 'Other');
                const description = isExpense ? (item.description || '-') : (item.notes || '-');
                const displayDate = getFormattedDate(item);
                return [
                  displayDate, 
                  name, 
                  description, 
                  formatCurrency(item.amount || 0)
                ];
            });
            
            doc.autoTable({ 
              startY: yPos, 
              head: [detailHeaders], 
              body: detailTable, 
              headStyles: { fillColor: tableColor } 
            });
        }
        
        doc.save(`${reportType}_report_${new Date().toISOString().split('T')[0]}.pdf`); 
        showMessage(' PDF Downloaded', 'success');
      } catch (error) { 
        showError('PDF Error: ' + error.message); 
      }
    }

    // Auto-refresh dashboard every 60 seconds
    setInterval(() => { 
      if (isFirestoreReady && !isEditingExpense && !isEditingIncome && currentUser) {
        updateDashboardFromRealtimeData();
        loadReminders();
      } 
    }, 60000);
    
    // Handle window resize for better mobile experience
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function() {
        // Force reflow on charts
        if (pieChart) {
          pieChart.resize();
        }
        if (barChart) {
          barChart.resize();
        }
      }, 250);
    });
  </script>
</body>
</html>